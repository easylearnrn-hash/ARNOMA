<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Portal - ARNOMA</title>
    <link rel="icon" type="image/png" href="/richyfesta-logo.png" />
    <link rel="apple-touch-icon" href="/richyfesta-logo.png" />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        position: relative;
      }

      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
          radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
          radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.15) 0%, transparent 50%);
        pointer-events: none;
        z-index: 0;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
      }

      .header {
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 32px 40px;
        border-radius: 20px;
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.4);
        margin-bottom: 32px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 24px;
        animation: slideInLeft 0.6s ease-out;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        animation: shimmer 3s infinite;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 24px;
      }

      .logo {
        width: 150px;
        height: 150px;
        filter: drop-shadow(0 0 10px rgba(102, 126, 234, 0.8));
        animation: float 3s ease-in-out infinite;
        transition: all 0.3s ease;
      }

      .logo:hover {
        filter: drop-shadow(0 0 20px rgba(102, 126, 234, 1));
        transform: scale(1.05);
      }

      .header-title h1 {
        font-size: 42px;
        font-weight: 700;
        color: #ffffff;
        margin: 0;
        line-height: 1.3;
        text-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
        display: flex !important;
        flex-direction: column !important;
        gap: 8px;
        align-items: flex-start;
      }

      .header-title h1 .title-line {
        font-size: 28px !important;
        font-weight: 600;
        display: block;
      }

      .header-title h1 .name-line {
        font-size: 42px !important;
        font-weight: 700;
        display: block;
      }

      .logout-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
        display: none;
      }

      .logout-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
      }

      .logout-btn:hover::before {
        left: 100%;
      }

      .logout-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
      }

      .logout-btn:active {
        transform: translateY(-1px) scale(0.95);
      }

      /* Account Dropdown */
      .account-dropdown {
        position: relative;
      }

      .account-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.08));
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .account-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.22), rgba(255, 255, 255, 0.12));
        border-color: rgba(255, 255, 255, 0.35);
      }

      .dropdown-arrow {
        font-size: 10px;
        transition: transform 0.3s ease;
      }

      .account-dropdown.open .dropdown-arrow {
        transform: rotate(180deg);
      }

      .account-menu {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.08));
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.22);
        border-radius: 12px;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
        min-width: 180px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
      }

      .account-dropdown.open .account-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .account-menu-item {
        width: 100%;
        padding: 14px 18px;
        background: transparent;
        border: none;
        color: white;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
        text-align: left;
      }

      .account-menu-item:first-child {
        border-radius: 12px 12px 0 0;
      }

      .account-menu-item:last-child {
        border-radius: 0 0 12px 12px;
      }

      .account-menu-item:hover {
        background: rgba(239, 68, 68, 0.15);
        padding-left: 22px;
      }

      .content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
      }

      .full-width-card {
        grid-column: 1 / -1;
      }

      .classroom-item {
        padding: 24px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        border-left: 3px solid #4285f4;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        margin-bottom: 16px;
        animation: slideInLeft 0.5s ease-out backwards;
        position: relative;
        overflow: hidden;
      }

      .classroom-item::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        transform: translate(-50%, -50%);
        transition:
          width 0.6s,
          height 0.6s;
      }

      .classroom-item:hover::after {
        width: 300px;
        height: 300px;
      }

      .classroom-item:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateX(8px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        border-color: rgba(255, 255, 255, 0.25);
        border-left-width: 4px;
      }

      .classroom-item.announcement {
        border-left-color: #fbbc04;
      }

      .classroom-item.material {
        border-left-color: #34a853;
      }

      .classroom-item.locked {
        border-left-color: #94a3b8;
        opacity: 0.7;
      }

      .classroom-item.locked:hover {
        opacity: 0.9;
      }

      .classroom-text.blurred {
        filter: blur(5px);
        user-select: none;
        pointer-events: none;
      }

      .classroom-badge.locked {
        background: rgba(148, 163, 184, 0.2);
        color: #94a3b8;
      }

      .classroom-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
      }

      .classroom-title {
        font-weight: 700;
        color: #ffffff;
        font-size: 16px;
        margin-bottom: 5px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .classroom-course {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 600;
      }

      .classroom-date {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        white-space: nowrap;
      }

      .classroom-text {
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        line-height: 1.5;
        margin-top: 10px;
      }

      .classroom-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-top: 10px;
      }

      .classroom-badge.announcement {
        background: rgba(251, 188, 4, 0.2);
        color: #fbbc04;
      }

      .classroom-badge.material {
        background: rgba(52, 168, 83, 0.2);
        color: #34a853;
      }

      .classroom-list {
        max-height: 560px;
        overflow-y: auto;
        padding: 4px;
      }

      .classroom-list::-webkit-scrollbar {
        width: 8px;
      }

      .classroom-list::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
      }

      .classroom-list::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
      }

      .classroom-list::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* Systems Progress Carousel */
      .systems-carousel-container {
        position: relative;
        padding: 24px 56px;
        margin: 24px 0;
      }

      .systems-carousel {
        display: flex;
        gap: 20px;
        overflow-x: auto;
        scroll-behavior: smooth;
        padding: 16px 0;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .systems-carousel::-webkit-scrollbar {
        display: none;
      }

      .system-card {
        --glass-bg: rgba(255, 255, 255, 0.08);
        min-width: 200px;
        height: 240px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        border-radius: 18px;
        padding: 24px;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.18);
        flex-shrink: 0;
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        box-shadow: 0 10px 40px rgba(15, 27, 71, 0.18);
      }

      .system-card::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(160deg, rgba(255, 255, 255, 0.22) 0%, transparent 45%);
        opacity: 0.6;
        pointer-events: none;
      }

      .system-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--status-color), transparent);
        opacity: 0.8;
        border-radius: 18px 18px 0 0;
      }

      .system-card:hover {
        transform: translateY(-4px) scale(1.015);
        box-shadow: 0 18px 48px rgba(15, 27, 71, 0.25);
        border-color: rgba(255, 255, 255, 0.28);
      }

      .system-card:active {
        transform: translateY(-1px) scale(1.01);
        box-shadow: 0 10px 28px rgba(15, 27, 71, 0.22);
        transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .system-card.completed {
        --status-color: #34a853;
        background: linear-gradient(135deg, rgba(52, 168, 83, 0.15), rgba(52, 168, 83, 0.05));
        border-color: rgba(52, 168, 83, 0.4);
      }

      .system-card.current {
        --status-color: #fbbc04;
        background: linear-gradient(135deg, rgba(251, 188, 4, 0.22), rgba(251, 188, 4, 0.08));
        border-color: rgba(251, 188, 4, 0.45);
        border-width: 1.5px;
        min-width: 250px;
        height: 270px;
        transform: scale(1.08);
        z-index: 10;
        box-shadow:
          0 22px 55px rgba(251, 188, 4, 0.32),
          0 0 0 3px rgba(251, 188, 4, 0.14),
          inset 0 1px 0 rgba(255, 255, 255, 0.25);
        animation:
          pulse 2.4s ease-in-out infinite,
          float 3s ease-in-out infinite;
        will-change: transform, box-shadow;
      }

      .system-card.current::before {
        opacity: 0.95;
      }

      .system-card.current .system-icon {
        width: 70px;
        height: 70px;
        font-size: 38px;
        background: rgba(251, 188, 4, 0.2);
        border-color: rgba(251, 188, 4, 0.4);
      }

      .system-card.current .system-name {
        font-size: 18px;
      }

      .system-card.current .system-progress {
        font-size: 15px;
        font-weight: 600;
      }

      .system-card.current:hover {
        transform: translateY(-5px) scale(1.1);
        box-shadow:
          0 26px 68px rgba(251, 188, 4, 0.38),
          0 0 0 4px rgba(251, 188, 4, 0.18),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
      }

      .system-card.current:active {
        transform: translateY(-3px) scale(1.08);
        box-shadow:
          0 18px 52px rgba(251, 188, 4, 0.32),
          0 0 0 3px rgba(251, 188, 4, 0.16),
          inset 0 1px 0 rgba(255, 255, 255, 0.26);
        transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .system-card.partial {
        --status-color: #4285f4;
        background: linear-gradient(135deg, rgba(66, 133, 244, 0.15), rgba(66, 133, 244, 0.05));
        border-color: rgba(66, 133, 244, 0.4);
      }

      .system-card.not-started {
        --status-color: #ea4335;
        background: linear-gradient(135deg, rgba(234, 67, 53, 0.15), rgba(234, 67, 53, 0.05));
        border-color: rgba(234, 67, 53, 0.4);
        opacity: 0.7;
      }

      .system-card.selected {
        border-color: rgba(255, 255, 255, 0.6);
        box-shadow:
          0 8px 32px rgba(102, 126, 234, 0.3),
          0 0 0 2px rgba(102, 126, 234, 0.2);
      }

      .system-card.selected:not(.current) {
        transform: scale(1.05);
      }

      .system-card.current.selected {
        transform: scale(1.08);
      }

      /* Futuristic Notification Badge */
      .system-notification {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
        animation: scaleIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      }

      .system-notification.unlocked {
        background: linear-gradient(135deg, #34a853, #0f9d58);
        box-shadow:
          0 4px 20px rgba(52, 168, 83, 0.6),
          0 0 0 3px rgba(52, 168, 83, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.4);
      }

      .system-notification.locked {
        background: linear-gradient(135deg, #ea4335, #c5221f);
        box-shadow:
          0 4px 20px rgba(234, 67, 53, 0.6),
          0 0 0 3px rgba(234, 67, 53, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.4);
      }

      .notification-count {
        font-size: 13px;
        font-weight: 800;
        color: white;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        position: relative;
        z-index: 2;
      }

      .notification-lock {
        font-size: 12px;
        position: absolute;
        bottom: -4px;
        right: -4px;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid rgba(255, 255, 255, 0.3);
      }

      .notification-pulse {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border-radius: 50%;
        background: inherit;
        animation: notificationPulse 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
        opacity: 0.7;
      }

      @keyframes notificationPulse {
        0% {
          transform: scale(1);
          opacity: 0.7;
        }
        50% {
          transform: scale(1.3);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 0;
        }
      }

      .system-icon {
        width: 60px;
        height: 60px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        margin-bottom: 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s;
      }

      .system-card:hover .system-icon {
        transform: rotate(10deg) scale(1.1);
        background: rgba(255, 255, 255, 0.2);
      }

      .system-name {
        font-size: 16px;
        font-weight: 700;
        color: white;
        margin-bottom: 8px;
        line-height: 1.3;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .system-progress {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 12px;
      }

      .system-bar {
        width: 100%;
        height: 6px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        overflow: hidden;
        position: relative;
      }

      .system-bar-fill {
        height: 100%;
        background: var(--status-color);
        border-radius: 10px;
        transition: width 0.6s ease;
        box-shadow: 0 0 10px var(--status-color);
      }

      .system-status {
        position: absolute;
        bottom: 15px;
        right: 15px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--status-color);
        box-shadow: 0 0 20px var(--status-color);
      }

      .system-card.current .system-status {
        animation: glow 1.5s ease-in-out infinite;
      }

      .carousel-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
      }

      .carousel-nav:hover {
        background: rgba(102, 126, 234, 0.3);
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      }

      .carousel-nav.prev {
        left: 0;
      }

      .carousel-nav.next {
        right: 0;
      }

      .progress-legend {
        display: flex;
        justify-content: center;
        gap: 32px;
        margin-top: 24px;
        flex-wrap: wrap;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.8);
      }

      .legend-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        box-shadow: 0 0 10px currentColor;
      }

      .legend-dot.completed {
        background: #34a853;
      }

      .legend-dot.current {
        background: #fbbc04;
        animation: pulse 2s ease-in-out infinite;
      }

      .legend-dot.partial {
        background: #4285f4;
      }

      .legend-dot.not-started {
        background: #ea4335;
      }

      .connect-google-btn {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #4285f4, #34a853);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .connect-google-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(66, 133, 244, 0.3);
      }

      .card {
        position: relative;
        background: linear-gradient(155deg, rgba(255, 255, 255, 0.22), rgba(255, 255, 255, 0.06));
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border: 1px solid rgba(255, 255, 255, 0.22);
        padding: 32px;
        border-radius: 22px;
        box-shadow: 0 12px 42px rgba(12, 22, 54, 0.25);
        animation: scaleIn 0.5s ease-out;
        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
      }

      .card::before {
        content: '';
        position: absolute;
        top: -45%;
        left: -30%;
        width: 70%;
        height: 160%;
        background: linear-gradient(130deg, rgba(255, 255, 255, 0.35), transparent 60%);
        opacity: 0.45;
        transform: rotate(8deg);
        pointer-events: none;
        transition:
          transform 0.6s ease,
          opacity 0.6s ease;
      }

      .card:hover {
        transform: translateY(-6px);
        box-shadow: 0 18px 56px rgba(12, 22, 54, 0.3);
        border-color: rgba(255, 255, 255, 0.32);
      }

      .card:hover::before {
        transform: rotate(2deg) translateX(12px);
        opacity: 0.65;
      }

      .card-title {
        font-size: 22px;
        color: #ffffff;
        font-weight: 700;
        margin: 0 0 24px 0;
        padding: 0 0 20px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        letter-spacing: 0.3px;
      }

      .card-title-left {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 22px;
      }

      .card-title-left span {
        font-size: 24px;
        line-height: 1;
      }

      .unified-expand-btn {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 14px 32px;
        border-radius: 16px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        letter-spacing: 0.5px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      .unified-expand-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
        transition: left 0.6s;
      }

      .unified-expand-btn:hover::before {
        left: 100%;
      }

      .unified-expand-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
        box-shadow: 0 6px 24px rgba(102, 126, 234, 0.3);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .unified-expand-btn:active {
        transform: translateY(0) scale(0.98);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .show-all-notes-btn {
        margin-left: auto;
        padding: 10px 22px;
        background: rgba(255, 255, 255, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        color: #ffffff;
        font-size: 13px;
        font-weight: 600;
        letter-spacing: 0.3px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 8px;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }

      .show-all-notes-btn:hover {
        background: rgba(255, 255, 255, 0.18);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
      }

      .show-all-notes-btn:active {
        transform: translateY(1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .expand-icon {
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 14px;
        font-weight: bold;
      }

      .expand-icon.expanded {
        transform: rotate(180deg);
      }

      .collapsible-content {
        display: flex;
        flex-direction: column;
        gap: 16px;
        max-height: 0;
        overflow: hidden;
        transition:
          max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          opacity 0.3s ease,
          margin-top 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          visibility 0s linear 0.4s;
        opacity: 0;
        margin-top: 0;
        visibility: hidden;
      }

      .collapsible-content.expanded {
        max-height: 1000px;
        opacity: 1;
        margin-top: 16px;
        visibility: visible;
        transition-delay: 0s;
      }

      .profile-info {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .info-row {
        display: grid;
        grid-template-columns: 140px 1fr;
        align-items: center;
        gap: 20px;
        padding: 18px 22px;
        background: linear-gradient(140deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.04));
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 14px;
        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        animation: slideInRight 0.5s ease-out backwards;
        min-height: 62px;
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        box-shadow: 0 8px 24px rgba(15, 27, 71, 0.18);
        position: relative;
        overflow: hidden;
      }

      .info-row::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 40%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.18));
        opacity: 0;
        transition: opacity 0.35s ease;
        pointer-events: none;
      }

      .info-row:nth-child(1) {
        animation-delay: 0.1s;
      }
      .info-row:nth-child(2) {
        animation-delay: 0.2s;
      }
      .info-row:nth-child(3) {
        animation-delay: 0.3s;
      }
      .info-row:nth-child(4) {
        animation-delay: 0.4s;
      }
      .info-row:nth-child(5) {
        animation-delay: 0.5s;
      }

      .info-row:hover {
        transform: translateX(6px);
        box-shadow: 0 14px 34px rgba(102, 126, 234, 0.28);
        border-color: rgba(255, 255, 255, 0.32);
      }

      .info-row:hover::after {
        opacity: 0.35;
      }

      .info-label {
        font-weight: 600;
        color: rgba(255, 255, 255, 0.75);
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .info-value {
        font-weight: 700;
        color: #ffffff;
        font-size: 16px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: right;
        word-break: break-word;
        overflow-wrap: break-word;
      }

      .payment-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: 480px;
        overflow-y: auto;
        padding: 4px;
        margin-top: 16px;
      }

      .payment-list::-webkit-scrollbar {
        width: 8px;
      }

      .payment-list::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
      }

      .payment-list::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
      }

      .payment-list::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .payment-item {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 18px;
        padding: 20px 24px;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.04));
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 16px;
        border-left: 3px solid rgba(255, 255, 255, 0.38);
        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        animation: slideInRight 0.4s ease-out backwards;
        position: relative;
        overflow: hidden;
        min-height: 74px;
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        box-shadow: 0 12px 32px rgba(12, 22, 54, 0.22);
      }

      .payment-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.16), transparent);
        transition: left 0.5s;
      }

      .payment-item:hover::before {
        left: 100%;
      }

      .payment-item:hover {
        transform: translateX(8px);
        box-shadow: 0 18px 44px rgba(0, 0, 0, 0.22);
        border-color: rgba(255, 255, 255, 0.32);
      }

      .payment-item.paid {
        border-left-color: #22c55e;
      }

      .payment-item.unpaid {
        border-left-color: #ef4444;
      }

      .payment-item.absent {
        border-left-color: #f59e0b;
      }

      .payment-date {
        font-weight: 700;
        color: #ffffff;
        font-size: 16px;
        margin-bottom: 8px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .payment-status {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.9);
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 12px;
      }

      .status-badge.paid {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
      }

      .status-badge.unpaid {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
      }

      .status-badge.absent {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
      }

      .payment-amount {
        font-weight: 700;
        font-size: 18px;
        color: #667eea;
      }

      .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .stat-card {
        padding: 26px 22px;
        background: linear-gradient(150deg, rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.05));
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-align: center;
        animation: scaleIn 0.5s ease-out backwards;
        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 118px;
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 36px rgba(12, 22, 54, 0.2);
      }

      .stat-card::after {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at top, rgba(255, 255, 255, 0.25), transparent 60%);
        opacity: 0;
        transition: opacity 0.35s ease;
        pointer-events: none;
      }

      .stat-card:nth-child(1) {
        animation-delay: 0.1s;
      }
      .stat-card:nth-child(2) {
        animation-delay: 0.2s;
      }
      .stat-card:nth-child(3) {
        animation-delay: 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 18px 48px rgba(102, 126, 234, 0.28);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .stat-card:hover::after {
        opacity: 0.6;
      }

      .stat-label {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #ffffff;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        line-height: 1;
      }

      .login-screen {
        max-width: 450px;
        margin: 80px auto;
        background: rgba(255, 255, 255, 0.95);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        animation:
          scaleIn 0.5s ease-out,
          glow 3s infinite;
        border: 2px solid rgba(102, 126, 234, 0.3);
      }

      .step-indicator {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 30px;
      }

      .step-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #e2e8f0;
        transition: all 0.3s;
      }

      .step-dot.active {
        background: #667eea;
        width: 30px;
        border-radius: 5px;
      }

      .auth-step {
        display: none;
      }

      .auth-step.active {
        display: block;
        animation: fadeIn 0.3s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Futuristic Animations */
      @keyframes shimmer {
        0% {
          background-position: -1000px 0;
        }
        100% {
          background-position: 1000px 0;
        }
      }

      @keyframes glow {
        0%,
        100% {
          box-shadow:
            0 0 20px rgba(102, 126, 234, 0.3),
            0 0 40px rgba(102, 126, 234, 0.2);
        }
        50% {
          box-shadow:
            0 0 30px rgba(102, 126, 234, 0.5),
            0 0 60px rgba(102, 126, 234, 0.3);
        }
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(30px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes slideInLeft {
        from {
          opacity: 0;
          transform: translateX(-30px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes scaleIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      @keyframes borderGlow {
        0%,
        100% {
          border-color: rgba(255, 255, 255, 0.3);
        }
        50% {
          border-color: rgba(102, 126, 234, 0.8);
        }
      }

      @keyframes unlock {
        0% {
          transform: scale(1) rotate(0deg);
        }
        25% {
          transform: scale(1.2) rotate(-10deg);
        }
        75% {
          transform: scale(1.2) rotate(10deg);
        }
        100% {
          transform: scale(1) rotate(0deg);
          opacity: 0;
        }
      }

      .login-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .login-logo {
        width: 180px;
        height: 180px;
        margin-bottom: 40px;
        filter: drop-shadow(0 0 15px rgba(102, 126, 234, 0.8));
      }

      .login-title {
        font-size: 28px;
        color: #667eea;
        margin-bottom: 10px;
      }

      .login-subtitle {
        color: #64748b;
        font-size: 14px;
      }

      .input-group {
        margin-bottom: 20px;
      }

      .input-label {
        display: block;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .input-field {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.2s;
      }

      .input-field:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .login-btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .login-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        transform: translate(-50%, -50%);
        transition:
          width 0.6s,
          height 0.6s;
      }

      .login-btn:hover::before {
        width: 400px;
        height: 400px;
      }

      .login-btn:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
      }

      .login-btn:active {
        transform: translateY(-1px) scale(0.98);
      }

      .error-message {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-size: 14px;
        text-align: center;
      }

      .loading {
        text-align: center;
        padding: 50px;
        color: white;
        font-size: 18px;
        animation: pulse 2s ease-in-out infinite;
      }

      .loading::after {
        content: '';
        display: block;
        width: 50px;
        height: 50px;
        margin: 20px auto;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .content {
          grid-template-columns: 1fr;
        }

        .summary-stats {
          grid-template-columns: 1fr;
        }

        .header {
          text-align: center;
        }

        .header-left {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading" style="display: none">
      <div>Loading your portal...</div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" style="display: none">
      <div class="login-screen">
        <div class="login-header">
          <img src="richyfesta-logo.png" alt="ARNOMA" class="login-logo" />
          <h2 class="login-title">Student Portal</h2>
          <p class="login-subtitle">Sign in to access your account</p>
        </div>

        <div class="step-indicator">
          <div class="step-dot active" id="step1Dot"></div>
          <div class="step-dot" id="step2Dot"></div>
          <div class="step-dot" id="step3Dot"></div>
        </div>

        <div id="authError" class="error-message" style="display: none"></div>

        <!-- Step 1: Email Verification -->
        <div id="step1" class="auth-step active">
          <form id="emailForm">
            <div class="input-group">
              <label class="input-label">Your Email Address</label>
              <input type="email" id="studentEmail" class="input-field" placeholder="student@email.com" required />
            </div>
            <button type="submit" class="login-btn">Continue</button>
          </form>
        </div>

        <!-- Step 2: OTP Verification -->
        <div id="step2" class="auth-step">
          <p style="text-align: center; color: #64748b; margin-bottom: 20px">
            We've sent a verification code to
            <br />
            <strong id="displayEmail"></strong>
          </p>
          <form id="otpForm">
            <div class="input-group">
              <label class="input-label">Enter 6-Digit Code</label>
              <input
                type="text"
                id="otpCode"
                class="input-field"
                placeholder="000000"
                maxlength="6"
                required
                style="text-align: center; font-size: 24px; letter-spacing: 8px"
              />
            </div>
            <button type="submit" class="login-btn">Verify Code</button>
            <button
              type="button"
              class="login-btn"
              onclick="resendOTP()"
              style="background: linear-gradient(135deg, #64748b, #475569); margin-top: 10px"
            >
              Resend Code
            </button>
          </form>
        </div>

        <!-- Step 3: Set Password (First Time) or Login (Returning) -->
        <div id="step3" class="auth-step">
          <div id="setPasswordSection">
            <p style="text-align: center; color: #64748b; margin-bottom: 20px">
              Welcome! Please set a password for your account.
            </p>
            <form id="setPasswordForm">
              <div class="input-group">
                <label class="input-label">Create Password</label>
                <input type="password" id="newPassword" class="input-field" placeholder="Min 8 characters" required />
              </div>
              <div class="input-group">
                <label class="input-label">Confirm Password</label>
                <input
                  type="password"
                  id="confirmPassword"
                  class="input-field"
                  placeholder="Re-enter password"
                  required
                />
              </div>
              <button type="submit" class="login-btn">Complete Setup</button>
            </form>
          </div>

          <div id="loginPasswordSection" style="display: none">
            <p style="text-align: center; color: #64748b; margin-bottom: 20px">
              Welcome back! Enter your password to continue.
            </p>
            <form id="passwordForm">
              <div class="input-group">
                <label class="input-label">Password</label>
                <input
                  type="password"
                  id="loginPassword"
                  class="input-field"
                  placeholder="Enter your password"
                  required
                />
              </div>
              <button type="submit" class="login-btn">Sign In</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Portal Content -->
    <div id="portalContent" style="display: block">
      <div class="container">
        <div class="header">
          <div class="header-left">
            <img src="richyfesta-logo.png" alt="ARNOMA" class="logo" />
            <div class="header-title">
              <h1 id="welcomeMessage">
                <span class="title-line">Welcome Mr. Nurse</span>
                <span class="name-line">Test Student</span>
              </h1>
            </div>
          </div>
          <div class="account-dropdown">
            <button class="account-btn" onclick="toggleAccountDropdown()">
              <span>ðŸ‘¤ My Account</span>
              <span class="dropdown-arrow">â–¼</span>
            </button>
            <div class="account-menu" id="accountMenu">
              <button class="account-menu-item" onclick="logout()">
                <span>ðŸšª</span>
                <span>Sign Out</span>
              </button>
            </div>
          </div>
        </div>

        <div class="content">
          <!-- Profile Card -->
          <div class="card">
            <h2 class="card-title">
              <div class="card-title-left">
                <span>ðŸ‘¤</span>
                My Profile
              </div>
            </h2>
            <div class="profile-info">
              <div class="info-row">
                <span class="info-label">Full Name</span>
                <span class="info-value" id="studentName">-</span>
              </div>
              <div class="info-row">
                <span class="info-label">Group</span>
                <span class="info-value" id="studentGroup">-</span>
              </div>
              <div class="info-row">
                <span class="info-label">Schedule</span>
                <span class="info-value" id="studentSchedule">-</span>
              </div>
            </div>
            <div class="collapsible-content" id="profileDetails">
              <div class="info-row">
                <span class="info-label">Email</span>
                <span class="info-value" id="studentEmail">-</span>
              </div>
              <div class="info-row">
                <span class="info-label">Class Fee</span>
                <span class="info-value" id="studentFee">-</span>
              </div>
            </div>
          </div>

          <!-- Payment History Card -->
          <div class="card">
            <h2 class="card-title">
              <div class="card-title-left">
                <span>ðŸ’³</span>
                Payment History
              </div>
            </h2>

            <div class="summary-stats">
              <div class="stat-card" style="border-color: #ef4444">
                <div class="stat-label">Unpaid</div>
                <div class="stat-value" style="color: #ef4444" id="totalUnpaid">$0</div>
              </div>
              <div class="stat-card" style="border-color: #22c55e">
                <div class="stat-label">This Month</div>
                <div class="stat-value" style="color: #22c55e" id="thisMonth">$0</div>
              </div>
            </div>

            <div class="collapsible-content" id="paymentDetails">
              <div class="summary-stats" style="margin-top: 15px">
                <div class="stat-card">
                  <div class="stat-label">Total Paid</div>
                  <div class="stat-value" id="totalPaid">$0</div>
                </div>
              </div>

              <div class="payment-list" id="paymentList">
                <!-- Payment items will be populated here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Unified Expand/Collapse Button -->
        <div class="content">
          <div style="grid-column: 1 / -1; display: flex; justify-content: center">
            <button class="unified-expand-btn" onclick="toggleAllSections()">
              <span id="unifiedBtnText">Expand Details</span>
              <span class="expand-icon" id="unifiedIcon">â–¼</span>
            </button>
          </div>
        </div>

        <!-- Systems Progress Carousel -->
        <div class="content">
          <div class="card full-width-card" style="overflow: visible">
            <h2 class="card-title">
              <div class="card-title-left">
                <span>ðŸŽ¯</span>
                NCLEX Systems Progress
              </div>
            </h2>

            <div class="systems-carousel-container">
              <button class="carousel-nav prev" onclick="scrollCarousel(-1)">â€¹</button>
              <div class="systems-carousel" id="systemsCarousel">
                <!-- System cards will be populated here -->
              </div>
              <button class="carousel-nav next" onclick="scrollCarousel(1)">â€º</button>
            </div>

            <div class="progress-legend">
              <div class="legend-item">
                <span class="legend-dot completed"></span>
                <span>Completed</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot current"></span>
                <span>Current</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot partial"></span>
                <span>In Progress</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot not-started"></span>
                <span>Not Started</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Student Wall - Google Classroom Stream -->
        <div class="content">
          <div class="card full-width-card">
            <h2 class="card-title">
              <div class="card-title-left">
                <span>ðŸ“°</span>
                Class Wall - Latest Updates
              </div>
              <button class="unified-expand-btn" onclick="refreshClassroomWall()" style="padding: 10px 20px">
                <span>Refresh</span>
              </button>
            </h2>

            <div id="classroomWall" class="classroom-list">
              <!-- Stream items will be populated here -->
            </div>
          </div>
        </div>

        <!-- Google Classroom Updates Section -->
        <div class="content">
          <div class="card full-width-card">
            <h2 class="card-title">
              <div class="card-title-left">
                <span>ðŸ“š</span>
                Class Materials & Notes
              </div>
            </h2>

            <div id="classroomContent">
              <!-- Notes list -->
              <div id="classroomList" class="classroom-list">
                <!-- Items will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: 'AIzaSyBeoU4ORswhCK1MSenezaTDWOeNIRkq_vE',
        authDomain: 'autoemail-ca4d7.firebaseapp.com',
        projectId: 'autoemail-ca4d7',
        storageBucket: 'autoemail-ca4d7.firebasestorage.app',
        messagingSenderId: '214684273965',
        appId: '1:214684273965:web:5f2b418f068e588f4317a4',
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      const functions = firebase.functions();

      // Set persistence to LOCAL (stays logged in after browser close)
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

      // Google Classroom API Configuration
      const GOOGLE_CLIENT_ID = '503155871883-q4mr96hfcq2vt42acnrve8eini85hpju.apps.googleusercontent.com';
      const SCOPES =
        'https://www.googleapis.com/auth/classroom.courses.readonly https://www.googleapis.com/auth/classroom.announcements.readonly https://www.googleapis.com/auth/classroom.coursework.me.readonly';
      const CLASSROOM_COURSE_CODE = 'oxvkmfvb'; // Your classroom join code
      const CLASSROOM_COURSE_ID = '820037404513'; // Extracted from URL

      let currentStudent = {
        id: 'demo-001',
        name: 'Test Student',
        email: 'student@demo.com',
        group: 'NCLEX Prep - Evening',
        schedule: 'Monday 8:00 PM, Wednesday 8:00 PM',
        payPerClass: 50,
        hasPassword: true,
      };
      let currentEmail = 'student@demo.com';
      let generatedOTP = null;
      let googleAccessToken = null;

      // Initialize app and check auth state
      (async function () {
        const loadingScreen = document.getElementById('loadingScreen');
        const loginScreen = document.getElementById('loginScreen');
        const portalContent = document.getElementById('portalContent');

        // Skip auth for now, load portal directly with demo student
        console.log('ðŸš€ Loading portal with demo student...');
        await loginToPortal();
      })();

      // Step 1: Email Form Submission
      document.getElementById('emailForm').addEventListener('submit', async e => {
        e.preventDefault();
        const email = document.getElementById('studentEmail').value.toLowerCase().trim();

        try {
          showError('');
          // Check if student exists in database
          const dbDoc = await db.collection('database').doc('students').get();

          if (!dbDoc.exists) {
            showError('Database not found. Please contact your administrator.');
            return;
          }

          const data = dbDoc.data();
          const students = data.students || [];
          const student = students.find(s => s.email && s.email.toLowerCase() === email);

          if (!student) {
            showError('Email not found. Please contact your administrator.');
            return;
          }

          currentEmail = email;
          currentStudent = student;

          // Send OTP
          await sendOTP(email);

          // Move to step 2
          goToStep(2);
          document.getElementById('displayEmail').textContent = email;
        } catch (error) {
          console.error('Error:', error);
          showError('An error occurred. Please try again.');
        }
      });

      // Step 2: OTP Form Submission
      document.getElementById('otpForm').addEventListener('submit', async e => {
        e.preventDefault();
        const enteredOTP = document.getElementById('otpCode').value;

        if (enteredOTP === generatedOTP) {
          // Check if student has a password set
          const hasPassword = currentStudent.hasPassword || false;

          if (hasPassword) {
            // Show login password form
            document.getElementById('setPasswordSection').style.display = 'none';
            document.getElementById('loginPasswordSection').style.display = 'block';
          } else {
            // Show set password form
            document.getElementById('setPasswordSection').style.display = 'block';
            document.getElementById('loginPasswordSection').style.display = 'none';
          }

          goToStep(3);
        } else {
          showError('Invalid code. Please try again.');
        }
      });

      // Step 3a: Set Password Form
      document.getElementById('setPasswordForm').addEventListener('submit', async e => {
        e.preventDefault();
        const password = document.getElementById('newPassword').value;
        const confirm = document.getElementById('confirmPassword').value;

        if (password.length < 8) {
          showError('Password must be at least 8 characters.');
          return;
        }

        if (password !== confirm) {
          showError('Passwords do not match.');
          return;
        }

        try {
          // Create Firebase auth account
          const userCredential = await auth.createUserWithEmailAndPassword(currentEmail, password);

          // Update student record
          const dbDoc = await db.collection('database').doc('students').get();
          const students = dbDoc.data().students || [];
          const index = students.findIndex(s => s.email && s.email.toLowerCase() === currentEmail);
          if (index !== -1) {
            students[index].hasPassword = true;
            students[index].uid = userCredential.user.uid;
            await db.collection('database').doc('students').update({ students });
          }

          // Login successful
          await loginToPortal();
        } catch (error) {
          console.error('Error:', error);
          showError('Error setting password. Please try again.');
        }
      });

      // Step 3b: Login Password Form
      document.getElementById('passwordForm').addEventListener('submit', async e => {
        e.preventDefault();
        const password = document.getElementById('loginPassword').value;

        try {
          await auth.signInWithEmailAndPassword(currentEmail, password);
          await loginToPortal();
        } catch (error) {
          console.error('Error:', error);
          showError('Invalid password. Please try again.');
        }
      });

      // Send OTP via email
      async function sendOTP(email) {
        // Generate 6-digit OTP
        generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();

        try {
          // Call Firebase function to send OTP email
          const sendOTPEmail = firebase.functions().httpsCallable('sendOTPEmail');
          await sendOTPEmail({
            email: email,
            otp: generatedOTP,
            studentName: currentStudent.name,
          });

          console.log('âœ… OTP email sent successfully to:', email);
        } catch (error) {
          console.error('âŒ Error sending OTP email:', error);
          // Fallback: Show alert with OTP for demo
          alert(`Email service unavailable. Your verification code is: ${generatedOTP}`);
        }
      }

      // Resend OTP
      async function resendOTP() {
        await sendOTP(currentEmail);
      }

      // Navigate between steps
      function goToStep(step) {
        document.querySelectorAll('.auth-step').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.step-dot').forEach(el => el.classList.remove('active'));

        document.getElementById('step' + step).classList.add('active');
        document.getElementById('step' + step + 'Dot').classList.add('active');
      }

      // Show error message
      function showError(message) {
        const errorDiv = document.getElementById('authError');
        if (message) {
          errorDiv.textContent = message;
          errorDiv.style.display = 'block';
        } else {
          errorDiv.style.display = 'none';
        }
      }

      // Login to portal
      async function loginToPortal() {
        const loadingScreen = document.getElementById('loadingScreen');
        const loginScreen = document.getElementById('loginScreen');
        const portalContent = document.getElementById('portalContent');

        loginScreen.style.display = 'none';
        loadingScreen.style.display = 'block';
        loadingScreen.innerHTML = '<div style="color: white;">Loading your portal...</div>';

        try {
          // Load student data
          const payments = await loadPaymentHistory(currentStudent);
          await loadStudentData(currentStudent, payments);

          // Load systems progress
          loadSystemsProgress();

          // Show loading message for classroom content
          const classroomList = document.getElementById('classroomList');
          const classroomWall = document.getElementById('classroomWall');
          if (classroomList) {
            classroomList.innerHTML =
              '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">Connecting to Google Classroom...</div>';
          }
          if (classroomWall) {
            classroomWall.innerHTML =
              '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">Loading latest updates...</div>';
          }

          loadingScreen.style.display = 'none';
          portalContent.style.display = 'block';

          // Auto-connect to Google Classroom and load content
          console.log('ðŸš€ Initiating Google Classroom connection...');
          setTimeout(async () => {
            await initGoogleClassroom();
          }, 1000);
        } catch (error) {
          console.error('Error loading portal:', error);
          loadingScreen.innerHTML = '<div style="color: red;">Error loading portal. Please refresh.</div>';
        }
      }

      // Generate mock payment history
      function generateMockPayments() {
        const payments = [];
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth();

        console.log(`ðŸ’° Generating mock payment history starting from ${currentDate.toLocaleDateString()}`);

        // Generate 12 months of payment history
        for (let i = 0; i < 12; i++) {
          const month = currentMonth - i;
          const year = month < 0 ? currentYear - 1 : currentYear;
          const adjustedMonth = month < 0 ? 12 + month : month;

          // 2-4 classes per month
          const classesPerMonth = 2 + Math.floor(Math.random() * 3);
          for (let j = 0; j < classesPerMonth; j++) {
            const day = 5 + j * 7;
            if (day <= 28) {
              const date = new Date(year, adjustedMonth, day);
              const rand = Math.random();

              let status, amount;
              if (rand > 0.85) {
                status = 'absent';
                amount = 0;
              } else if (rand > 0.75) {
                status = 'unpaid';
                amount = 50;
              } else {
                status = 'paid';
                amount = 50;
              }

              payments.push({ date, status, amount, day });
            }
          }
        }

        const sorted = payments.sort((a, b) => b.date - a.date);
        const paidCount = sorted.filter(p => p.status === 'paid').length;
        const unpaidCount = sorted.filter(p => p.status === 'unpaid').length;
        const absentCount = sorted.filter(p => p.status === 'absent').length;

        console.log(
          `âœ… Generated ${sorted.length} payments: ${paidCount} paid, ${unpaidCount} unpaid, ${absentCount} absent`
        );

        return sorted;
      }

      // Load payment history from Firestore
      async function loadPaymentHistory(student) {
        const payments = [];
        const currentYear = new Date().getFullYear();

        // If this is a demo student, use mock payments
        if (student.id === 'demo-001' || student.email === 'student@demo.com') {
          console.log('ðŸ“Š Demo student detected - generating mock payment history');
          return generateMockPayments();
        }

        for (let month = 1; month <= 12; month++) {
          const docId = `events-${currentYear}-${month}`;
          try {
            const eventDoc = await db.collection('calendar').doc(docId).get();
            if (eventDoc.exists) {
              const eventData = eventDoc.data() || {};

              Object.entries(eventData).forEach(([key, value]) => {
                if (key.includes(student.id)) {
                  const dayMatch = key.match(/day(\d+)/);
                  if (dayMatch) {
                    const day = parseInt(dayMatch[1]);
                    const date = new Date(currentYear, month - 1, day);

                    let status = 'unknown';
                    let amount = 0;

                    if (value.type === 'event' && value.amount) {
                      status = 'paid';
                      amount = value.amount;
                    } else if (value.type === 'notpaid') {
                      status = 'unpaid';
                      amount = student.payPerClass || 0;
                    } else if (value.type === 'absence') {
                      status = 'absent';
                    }

                    payments.push({ date, status, amount, day });
                  }
                }
              });
            }
          } catch (error) {
            console.error(`Error loading month ${month}:`, error);
          }
        }

        // If no payments found, fall back to mock payments
        if (payments.length === 0) {
          console.log('âš ï¸ No payment history found in Firestore - generating mock data for testing');
          return generateMockPayments();
        }

        return payments.sort((a, b) => b.date - a.date);
      }

      // Load student data
      function loadStudentData(student, payments) {
        // Update welcome message
        const welcomeMessage = document.getElementById('welcomeMessage');
        if (welcomeMessage) {
          welcomeMessage.innerHTML = `
          <span class="title-line">Welcome Mr. Nurse</span>
          <span class="name-line">${student.name}</span>
        `;
        }

        // Update profile info
        document.getElementById('studentName').textContent = student.name || '-';
        document.getElementById('studentEmail').textContent = student.email || '-';
        document.getElementById('studentGroup').textContent = student.group || '-';
        document.getElementById('studentSchedule').textContent = student.schedule || 'Not scheduled';
        document.getElementById('studentFee').textContent = student.payPerClass ? `$${student.payPerClass}` : '-';

        // Calculate payment statistics
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();

        let totalPaid = 0;
        let totalUnpaid = 0;
        let thisMonthTotal = 0;

        payments.forEach(payment => {
          if (payment.status === 'paid') {
            totalPaid += payment.amount;
            if (payment.date.getMonth() === currentMonth && payment.date.getFullYear() === currentYear) {
              thisMonthTotal += payment.amount;
            }
          } else if (payment.status === 'unpaid') {
            totalUnpaid += payment.amount;
          }
        });

        // Update summary stats
        document.getElementById('totalPaid').textContent = `$${totalPaid}`;
        document.getElementById('totalUnpaid').textContent = `$${totalUnpaid}`;
        document.getElementById('thisMonth').textContent = `$${thisMonthTotal}`;

        // Display payment list
        const paymentList = document.getElementById('paymentList');
        paymentList.innerHTML = '';

        if (payments.length === 0) {
          paymentList.innerHTML =
            '<div style="text-align: center; color: #64748b; padding: 40px;">No payment records found.</div>';
          return;
        }

        payments.forEach(payment => {
          const item = document.createElement('div');
          item.className = `payment-item ${payment.status}`;

          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const dateStr = `${monthNames[payment.date.getMonth()]} ${payment.date.getDate()}, ${payment.date.getFullYear()}`;

          let statusText =
            payment.status === 'paid'
              ? 'Paid'
              : payment.status === 'unpaid'
                ? 'Not Paid'
                : payment.status === 'absent'
                  ? 'Absent'
                  : 'Unknown';

          item.innerHTML = `
          <div class="payment-date">${dateStr}</div>
          <div class="payment-status">
            <span class="status-badge ${payment.status}">${statusText}</span>
            ${payment.amount > 0 ? `<span class="payment-amount">$${payment.amount}</span>` : ''}
          </div>
        `;

          paymentList.appendChild(item);
        });
      }

      // Toggle all sections at once
      function toggleAllSections() {
        const profileDetails = document.getElementById('profileDetails');
        const paymentDetails = document.getElementById('paymentDetails');
        const icon = document.getElementById('unifiedIcon');
        const btnText = document.getElementById('unifiedBtnText');

        const isExpanded = profileDetails.classList.contains('expanded');

        if (isExpanded) {
          profileDetails.classList.remove('expanded');
          paymentDetails.classList.remove('expanded');
          icon.classList.remove('expanded');
          btnText.textContent = 'Expand Details';
        } else {
          profileDetails.classList.add('expanded');
          paymentDetails.classList.add('expanded');
          icon.classList.add('expanded');
          btnText.textContent = 'Collapse Details';
        }
      }

      // Toggle account dropdown
      function toggleAccountDropdown() {
        const dropdown = document.querySelector('.account-dropdown');
        dropdown.classList.toggle('open');
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', e => {
        const dropdown = document.querySelector('.account-dropdown');
        if (dropdown && !dropdown.contains(e.target)) {
          dropdown.classList.remove('open');
        }
      });

      // Logout function
      async function logout() {
        try {
          await auth.signOut();
          currentStudent = null;
          currentEmail = null;
          window.location.reload();
        } catch (error) {
          console.error('Logout error:', error);
          window.location.reload();
        }
      }

      // Google Classroom Integration
      let isGoogleConnected = false;
      let googleClient = null;

      // Initialize Google Classroom
      async function initGoogleClassroom() {
        try {
          // Auto-connect using student's email
          await connectGoogleClassroom();
        } catch (error) {
          console.error('âŒ Google Classroom init error:', error);
          // Fallback to demo data
          console.log('ðŸ“Š Loading demo data instead...');
          const payments = await loadPaymentHistory(currentStudent);
          const demoNotes = generateDemoNotes(payments);
          allSystemNotes = demoNotes;
          displayNotes(demoNotes);
          displayClassroomWall(demoNotes);
          updateSystemNotifications();
        }
      }

      // Connect to Google Classroom
      async function connectGoogleClassroom() {
        console.log('ðŸ”„ Initializing Google Classroom connection...');
        console.log('ðŸ“§ Current email:', currentEmail);

        try {
          // Initialize Google API client
          console.log('â³ Loading Google API client library...');
          await new Promise(resolve => {
            gapi.load('client:auth2', resolve);
          });

          console.log('âœ… Google API client library loaded');

          console.log('â³ Initializing Google API with credentials...');
          await gapi.client.init({
            apiKey: firebaseConfig.apiKey,
            clientId: GOOGLE_CLIENT_ID,
            discoveryDocs: ['https://classroom.googleapis.com/$discovery/rest?version=v1'],
            scope: SCOPES,
          });

          console.log('âœ… Google API client initialized successfully');

          // Sign in with student's email
          const auth2 = gapi.auth2.getAuthInstance();
          console.log('ðŸ” Checking sign-in status...');
          console.log('   Is signed in:', auth2.isSignedIn.get());

          if (!auth2.isSignedIn.get()) {
            console.log('ðŸ” Not signed in - requesting authorization...');
            console.log('   This will open a Google popup - please allow it');

            try {
              await auth2.signIn({
                prompt: 'consent',
                login_hint: currentEmail,
              });
              console.log('âœ… Google sign-in completed');
            } catch (signInError) {
              console.error('âŒ Sign-in failed:', signInError);
              if (signInError.error === 'popup_closed_by_user') {
                console.log('â„¹ï¸ User closed the sign-in popup');
              }
              throw signInError;
            }
          } else {
            console.log('âœ… Already signed in to Google');
          }

          const currentUser = auth2.currentUser.get();
          const profile = currentUser.getBasicProfile();
          console.log('ðŸ‘¤ Signed in as:', profile.getEmail());

          console.log('âœ… Google Classroom authorization complete');
          isGoogleConnected = true;

          // Hide connect button
          const connectBtn = document.getElementById('connectClassroomBtn');
          if (connectBtn) connectBtn.style.display = 'none';

          // Load real classroom data
          console.log('ðŸ“š Loading classroom data...');
          await loadRealClassroomUpdates();
        } catch (error) {
          console.error('âŒ Google Classroom connection error:', error);
          console.error('   Error type:', error.error);
          console.error('   Error details:', error.details);

          // Show connect button on error
          const connectBtn = document.getElementById('connectClassroomBtn');
          if (connectBtn) {
            connectBtn.style.display = 'flex';
            connectBtn.innerHTML = '<span>ðŸ”— Retry Google Classroom Connection</span>';
          }

          // Fall back to demo data
          console.log('ðŸ“Š Falling back to demo data...');
          const payments = await loadPaymentHistory(currentStudent);
          const demoNotes = generateDemoNotes(payments);
          allSystemNotes = demoNotes;
          displayNotes(demoNotes);
          displayClassroomWall(demoNotes);
          updateSystemNotifications();
        }
      }

      // Manual connect function (called by button)
      async function manualConnectClassroom() {
        const connectBtn = document.getElementById('connectClassroomBtn');
        if (connectBtn) {
          connectBtn.innerHTML = '<span>ðŸ”„ Connecting...</span>';
          connectBtn.disabled = true;
        }

        await connectGoogleClassroom();

        if (connectBtn) {
          connectBtn.disabled = false;
        }
      }

      // Load real classroom updates from Google Classroom API
      async function loadRealClassroomUpdates() {
        console.log('ðŸ“š Loading Classroom data...');

        try {
          // First load payment history to check what's paid
          const payments = await loadPaymentHistory(currentStudent);
          console.log(`ðŸ’³ Loaded ${payments.length} payment records`);

          const updates = [];

          // Get courses
          console.log('ðŸ“– Fetching courses...');
          const coursesResponse = await gapi.client.classroom.courses.list({
            courseStates: ['ACTIVE'],
            pageSize: 10,
          });

          let courses = coursesResponse.result.courses || [];

          // Filter to only our specific classroom if it exists
          if (CLASSROOM_COURSE_ID) {
            const targetCourse = courses.find(c => c.id === CLASSROOM_COURSE_ID);
            if (targetCourse) {
              courses = [targetCourse]; // Only use your specific course
              console.log(`âœ… Found target course: ${targetCourse.name}`);
            }
          }

          console.log(`âœ… Processing ${courses.length} course(s)`);

          if (courses.length === 0) {
            console.log('â„¹ï¸ No courses found, showing demo data');
            const demoNotes = generateDemoNotes(payments);
            allSystemNotes = demoNotes;
            displayNotes(demoNotes);
            updateSystemNotifications();
            return;
          }

          // Process each course
          for (const course of courses) {
            console.log(`ðŸ“• Processing course: ${course.name}`);

            // Get announcements
            try {
              const announcementsResponse = await gapi.client.classroom.courses.announcements.list({
                courseId: course.id,
                pageSize: 10,
                orderBy: 'updateTime desc',
              });

              const announcements = announcementsResponse.result.announcements || [];
              console.log(`  ðŸ“¢ Found ${announcements.length} announcements`);

              announcements.forEach(announcement => {
                const postDate = new Date(announcement.creationTime);
                const isPaid = checkIfPaid(postDate, payments);
                const system = detectSystemFromContent(announcement.text || '', course.name);

                updates.push({
                  type: 'announcement',
                  course: course.name,
                  title: announcement.text
                    ? announcement.text.substring(0, 60) + (announcement.text.length > 60 ? '...' : '')
                    : 'New Announcement',
                  text: isPaid
                    ? announcement.text || 'View content details'
                    : 'Complete payment to unlock this content',
                  date: postDate,
                  isPaid: isPaid,
                  attachments: isPaid ? extractMaterials(announcement.materials || []) : [],
                  system: system,
                  read: false,
                });
              });
            } catch (e) {
              console.log(`  âš ï¸ Could not load announcements: ${e.message}`);
            }

            // Get coursework
            try {
              const courseworkResponse = await gapi.client.classroom.courses.courseWork.list({
                courseId: course.id,
                pageSize: 10,
                orderBy: 'updateTime desc',
              });

              const coursework = courseworkResponse.result.courseWork || [];
              console.log(`  ðŸ“ Found ${coursework.length} coursework items`);

              coursework.forEach(work => {
                const postDate = new Date(work.creationTime);
                const isPaid = checkIfPaid(postDate, payments);
                const system = detectSystemFromContent(work.title || '', work.description || '', course.name);

                updates.push({
                  type: 'material',
                  course: course.name,
                  title: work.title || 'Course Material',
                  text: isPaid ? work.description || 'New material posted' : 'Complete payment to unlock this content',
                  date: postDate,
                  isPaid: isPaid,
                  link: isPaid ? work.alternateLink : null,
                  attachments: isPaid ? extractMaterials(work.materials || []) : [],
                  system: system,
                  read: false,
                });
              });
            } catch (e) {
              console.log(`  âš ï¸ Could not load coursework: ${e.message}`);
            }
          }

          // Sort by date (newest first)
          updates.sort((a, b) => b.date - a.date);

          const lockedCount = updates.filter(u => !u.isPaid).length;
          const unlockedCount = updates.filter(u => u.isPaid).length;
          console.log(`âœ… Loaded ${updates.length} total updates (${unlockedCount} unlocked, ${lockedCount} locked)`);

          // Store globally and display
          allSystemNotes = updates;
          displayNotes(updates);
          updateSystemNotifications();

          // Also populate the classroom wall with all updates (no system filter)
          console.log('ðŸŽ¯ Populating classroom wall with updates...');
          displayClassroomWall(updates);
        } catch (error) {
          console.error('âŒ Error loading classroom updates:', error);
          console.error('âŒ Full error details:', error.message, error.stack);

          // Fall back to demo data
          const payments = await loadPaymentHistory(currentStudent);
          const demoNotes = generateDemoNotes(payments);
          allSystemNotes = demoNotes;
          displayNotes(demoNotes);
          updateSystemNotifications();
          displayClassroomWall(demoNotes);
        }
      }

      // Display classroom wall (stream view)
      function displayClassroomWall(updates) {
        const wallContainer = document.getElementById('classroomWall');
        if (!wallContainer) {
          console.error('âŒ Classroom wall container not found');
          return;
        }

        console.log(`ðŸ“° Displaying ${updates?.length || 0} updates on classroom wall`);

        wallContainer.innerHTML = '';

        if (!updates || updates.length === 0) {
          wallContainer.innerHTML = `
          <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 20px;">ðŸ“­</div>
            <div style="color: rgba(255,255,255,0.9); font-size: 18px; font-weight: 600; margin-bottom: 10px;">
              No updates yet
            </div>
            <div style="color: rgba(255,255,255,0.6); font-size: 14px;">
              Waiting for Google Classroom connection...
            </div>
            <div style="color: rgba(255,255,255,0.5); font-size: 12px; margin-top: 10px;">
              Click Refresh or check browser console for connection status
            </div>
          </div>
        `;
          return;
        }

        console.log(
          'ðŸ“° Rendering wall items:',
          updates.map(u => ({ title: u.title, date: u.date, isPaid: u.isPaid }))
        );

        // Show all updates in chronological order
        updates.forEach((update, index) => {
          const item = document.createElement('div');
          item.className = `classroom-item ${update.type || 'material'} ${update.isPaid ? '' : 'locked'}`;
          item.style.animationDelay = `${index * 0.05}s`;

          const dateStr =
            update.date instanceof Date
              ? update.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
              : 'Recent';

          const badgeIcon = update.type === 'announcement' ? 'ðŸ“¢' : 'ðŸ“„';
          const badgeText = update.type === 'announcement' ? 'Announcement' : 'Material';
          const lockIcon = update.isPaid ? '' : 'ðŸ”’ ';

          item.innerHTML = `
          <div class="classroom-header">
            <div>
              <div class="classroom-title">${lockIcon}${update.title}</div>
              <div class="classroom-course">${update.course || 'Your Class'} â€¢ ${update.system || 'General'}</div>
            </div>
            <div class="classroom-date">${dateStr}</div>
          </div>
          <div class="classroom-text ${update.isPaid ? '' : 'blurred'}">${update.text}</div>
          <span class="classroom-badge ${update.type} ${update.isPaid ? '' : 'locked'}">${badgeIcon} ${badgeText}</span>
        `;

          wallContainer.appendChild(item);
        });

        console.log(`âœ… Classroom wall populated with ${updates.length} items`);
      }

      // Refresh classroom wall
      async function refreshClassroomWall() {
        console.log('ðŸ”„ Refreshing classroom wall...');
        const btn = event?.target?.closest('button');
        if (btn) {
          btn.innerHTML = '<span>Loading...</span>';
          btn.disabled = true;
        }

        try {
          await initGoogleClassroom();
        } catch (error) {
          console.error('âŒ Error refreshing classroom wall:', error);
        }

        if (btn) {
          btn.innerHTML = '<span>Refresh</span>';
          btn.disabled = false;
        }
      }

      // Detect NCLEX system from content
      function detectSystemFromContent(...texts) {
        const content = texts.join(' ').toLowerCase();

        // System keyword mapping
        const systemKeywords = {
          'Cardiovascular System': ['cardio', 'heart', 'blood pressure', 'cardiac', 'circulation', 'ecg', 'ekg'],
          'Endocrine System': ['endocrine', 'diabetes', 'thyroid', 'hormone', 'insulin', 'glucose'],
          'Gastrointestinal System': ['gastro', 'digestive', 'stomach', 'intestine', 'bowel', 'gi tract'],
          'Respiratory System': ['respiratory', 'lung', 'breathing', 'oxygen', 'copd', 'asthma', 'pneumonia'],
          Pharmacology: ['pharmacology', 'medication', 'drug', 'medicine', 'prescription', 'dosage'],
          'Medical Terminology': ['terminology', 'medical terms', 'vocabulary', 'definitions'],
          'Human Anatomy': ['anatomy', 'body systems', 'physiology', 'skeletal', 'muscular'],
          'Medication Suffixes & Classes': ['suffix', 'drug class', 'medication class', '-pril', '-olol', '-statin'],
          Renal: ['renal', 'kidney', 'urinary', 'nephro', 'dialysis'],
          'Fluids, Electrolytes, Nutrition': ['fluid', 'electrolyte', 'sodium', 'potassium', 'hydration', 'nutrition'],
          'Eye Disorders': ['eye', 'vision', 'ophthalm', 'glaucoma', 'cataract'],
          EENT: ['ear', 'nose', 'throat', 'eent', 'hearing'],
          'Burns and Skin': ['burn', 'skin', 'dermat', 'wound', 'integumentary'],
          'Reproductive System': ['reproductive', 'gynecology', 'obstetric', 'pregnancy'],
          'Maternal Health': ['maternal', 'pregnancy', 'prenatal', 'postpartum', 'labor'],
          Pediatrics: ['pediatric', 'child', 'infant', 'newborn', 'adolescent'],
          'Medical-Surgical Care': ['med-surg', 'surgical', 'post-op', 'perioperative'],
          'Mental Health': ['mental health', 'psychiatric', 'psych', 'depression', 'anxiety'],
          'Autoimmune Disorders': ['autoimmune', 'lupus', 'arthritis', 'immune system'],
          Neurology: ['neuro', 'brain', 'stroke', 'seizure', 'cns', 'nervous system'],
          Cancer: ['cancer', 'oncology', 'chemotherapy', 'tumor', 'malignancy'],
          'Musculoskeletal Disorders': ['musculoskeletal', 'bone', 'fracture', 'joint', 'orthopedic'],
          'Psycho-Social Aspects': ['psychosocial', 'coping', 'grief', 'cultural', 'spiritual'],
          'Nursing Skills and Fundamentals': ['nursing skills', 'fundamentals', 'vital signs', 'assessment', 'basics'],
        };

        // Check each system's keywords
        for (const [system, keywords] of Object.entries(systemKeywords)) {
          for (const keyword of keywords) {
            if (content.includes(keyword)) {
              return system;
            }
          }
        }

        // Default to current system or first completed system
        return nclexSystems.find(s => s.status === 'current')?.name || 'Cardiovascular System';
      }

      // Extract materials from Google Classroom items
      function extractMaterials(materials) {
        const attachments = [];

        materials.forEach(material => {
          if (material.driveFile && material.driveFile.driveFile) {
            attachments.push({
              title: material.driveFile.driveFile.title || 'Attachment',
              url: material.driveFile.driveFile.alternateLink,
              thumbnailUrl: material.driveFile.driveFile.thumbnailUrl,
              type: material.driveFile.driveFile.mimeType?.includes('video') ? 'video' : 'file',
            });
          } else if (material.link) {
            attachments.push({
              title: material.link.title || 'Link',
              url: material.link.url,
              type: 'link',
            });
          } else if (material.youtubeVideo) {
            attachments.push({
              title: material.youtubeVideo.title || 'Video',
              url: `https://www.youtube.com/watch?v=${material.youtubeVideo.id}`,
              thumbnailUrl: material.youtubeVideo.thumbnailUrl,
              type: 'video',
            });
          }
        });

        return attachments;
      }

      // Get relative time
      function getRelativeTime(timestamp) {
        const now = new Date();
        const date = new Date(timestamp);
        const diff = now - date;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));

        if (hours < 1) return 'Just now';
        if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        if (days < 7) return `${days} day${days > 1 ? 's' : ''} ago`;
        return date.toLocaleDateString();
      }

      // Display classroom updates
      function displayClassroomUpdates(updates) {
        const classroomList = document.getElementById('classroomList');
        classroomList.innerHTML = '';

        if (updates.length === 0) {
          classroomList.innerHTML =
            '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">No recent updates found.</div>';
          return;
        }

        updates.forEach(update => {
          const item = document.createElement('div');
          item.className = `classroom-item ${update.type}`;

          const badgeText = update.type === 'announcement' ? 'ðŸ“¢ Announcement' : 'ðŸ“„ Material';

          item.innerHTML = `
          <div class="classroom-header">
            <div>
              <div class="classroom-title">${update.title}</div>
              <div class="classroom-course">${update.course}</div>
            </div>
            <div class="classroom-date">${update.date}</div>
          </div>
          <div class="classroom-text">${update.text}</div>
          <span class="classroom-badge ${update.type}">${badgeText}</span>
        `;

          classroomList.appendChild(item);
        });
      }

      // Load classroom updates (notes linked to payment status)
      async function loadClassroomUpdates(payments) {
        const classroomList = document.getElementById('classroomList');
        classroomList.innerHTML =
          '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">Loading your notes...</div>';

        try {
          // Check if student has a classroomEmail configured
          const classroomEmail = currentStudent?.classroomEmail;

          if (!classroomEmail) {
            // No classroom email configured - show demo notes
            const notes = generateDemoNotes(payments);
            displayNotes(notes);
            updateSystemNotifications();
            return;
          }

          // Student has classroomEmail - fetch from Google Classroom
          // Get access token (will be from a service account you control)
          let accessToken = localStorage.getItem('classroomAccessToken');

          if (!accessToken) {
            // Try to get service account token
            accessToken = await getServiceAccountToken();
            if (!accessToken) {
              // Fallback to demo notes if service account not set up
              const notes = generateDemoNotes(payments);
              displayNotes(notes);
              updateSystemNotifications();
              return;
            }
          }

          // Fetch courses where the student's classroomEmail is enrolled
          const [allCourses, announcements, coursework] = await Promise.all([
            fetchGoogleClassroomData('courses', accessToken, classroomEmail),
            fetchGoogleClassroomData('announcements', accessToken, classroomEmail),
            fetchGoogleClassroomData('coursework', accessToken, classroomEmail),
          ]);

          // The courses returned are already filtered to what this fake email has access to
          const courses = allCourses;

          if (courses.length === 0) {
            classroomList.innerHTML =
              '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">No notes available yet.</div>';
            return;
          }

          // Get the IDs of courses this student is enrolled in
          const courseIds = courses.map(c => c.id);

          // Combine and organize notes
          const notes = [];

          // Add announcements (only from filtered courses)
          if (announcements && announcements.length > 0) {
            announcements.forEach(announcement => {
              // Only include if from a matching course
              if (!courseIds.includes(announcement.courseId)) return;

              const creationDate = new Date(announcement.creationTime);
              const isPaid = checkIfPaid(creationDate, payments);

              // Extract attachments from announcements
              const attachments = [];
              if (announcement.materials && announcement.materials.length > 0) {
                announcement.materials.forEach(material => {
                  if (material.driveFile) {
                    attachments.push({
                      title: material.driveFile.driveFile?.title || 'Attachment',
                      url: material.driveFile.driveFile?.alternateLink,
                      thumbnailUrl: material.driveFile.driveFile?.thumbnailUrl,
                      type: material.driveFile.driveFile?.type || 'file',
                    });
                  } else if (material.link) {
                    attachments.push({
                      title: material.link.title || 'Link',
                      url: material.link.url,
                      type: 'link',
                    });
                  } else if (material.youtubeVideo) {
                    attachments.push({
                      title: material.youtubeVideo.title || 'Video',
                      url: `https://www.youtube.com/watch?v=${material.youtubeVideo.id}`,
                      thumbnailUrl: material.youtubeVideo.thumbnailUrl,
                      type: 'video',
                    });
                  }
                });
              }

              notes.push({
                date: creationDate,
                title: announcement.text?.substring(0, 50) + '...' || 'Announcement',
                text: announcement.text || 'No description available',
                isPaid: isPaid,
                course: getCourseNameById(announcement.courseId, courses),
                type: 'announcement',
                attachments: attachments,
              });
            });
          }

          // Add coursework/materials (only from filtered courses)
          if (coursework && coursework.length > 0) {
            coursework.forEach(work => {
              // Only include if from a matching course
              if (!courseIds.includes(work.courseId)) return;

              const creationDate = new Date(work.creationTime);
              const isPaid = checkIfPaid(creationDate, payments);

              // Extract attachments (materials)
              const attachments = [];
              if (work.materials && work.materials.length > 0) {
                work.materials.forEach(material => {
                  if (material.driveFile) {
                    attachments.push({
                      title: material.driveFile.driveFile?.title || 'Attachment',
                      url: material.driveFile.driveFile?.alternateLink,
                      thumbnailUrl: material.driveFile.driveFile?.thumbnailUrl,
                      type: material.driveFile.driveFile?.type || 'file',
                    });
                  } else if (material.link) {
                    attachments.push({
                      title: material.link.title || 'Link',
                      url: material.link.url,
                      type: 'link',
                    });
                  } else if (material.youtubeVideo) {
                    attachments.push({
                      title: material.youtubeVideo.title || 'Video',
                      url: `https://www.youtube.com/watch?v=${material.youtubeVideo.id}`,
                      thumbnailUrl: material.youtubeVideo.thumbnailUrl,
                      type: 'video',
                    });
                  }
                });
              }

              notes.push({
                date: creationDate,
                title: work.title || 'Course Material',
                text: work.description || 'New material posted',
                isPaid: isPaid,
                course: getCourseNameById(work.courseId, courses),
                type: 'material',
                link: work.alternateLink,
                attachments: attachments,
              });
            });
          }

          // Sort by date (newest first)
          notes.sort((a, b) => b.date - a.date);

          // Take only the most recent 30 notes
          const recentNotes = notes.slice(0, 30);

          displayNotes(recentNotes);
          updateSystemNotifications();
        } catch (error) {
          console.error('Error loading notes:', error);

          // If token expired, clear it and retry
          if (error.message.includes('401') || error.message.includes('403')) {
            localStorage.removeItem('classroomAccessToken');
            // Auto-retry once
            const newToken = await autoConnectClassroom();
            if (newToken) {
              loadClassroomUpdates(payments);
            } else {
              classroomList.innerHTML =
                '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">Unable to load notes. Please refresh the page.</div>';
            }
          } else {
            classroomList.innerHTML =
              '<div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">Unable to load notes. Please try again later.</div>';
          }
        }
      }

      // Generate demo notes based on payment history
      function generateDemoNotes(payments) {
        const demoNotes = [];

        // NCLEX systems for note categorization
        const systemsList = [
          'Cardiovascular System',
          'Endocrine System',
          'Gastrointestinal System',
          'Respiratory System',
          'Pharmacology',
          'Medical Terminology',
          'Human Anatomy',
          'Medication Suffixes & Classes',
        ];

        const noteTypes = [
          {
            title: 'NCLEX Practice Questions',
            text: "Complete set of practice questions covering today's topics with detailed explanations and rationales.",
          },
          {
            title: 'Pharmacology Review',
            text: 'Comprehensive medication guide including drug classes, mechanisms of action, and nursing considerations.',
          },
          {
            title: 'Lab Values & Diagnostics',
            text: 'Essential laboratory values reference sheet with normal ranges and clinical significance.',
          },
          {
            title: 'Patient Care Study',
            text: 'Real-world case study demonstrating critical thinking and prioritization skills for NCLEX preparation.',
          },
          {
            title: 'Systems Review Notes',
            text: 'Detailed notes on body systems, pathophysiology, and key nursing interventions for exam success.',
          },
        ];

        console.log(`ðŸ“ Generating demo notes for ${payments.length} payment records`);

        // Generate notes for each payment that's not absent
        payments.forEach((payment, index) => {
          if (payment.status === 'absent') {
            console.log(`â­ï¸ Skipping absent date: ${payment.date.toLocaleDateString()}`);
            return;
          }

          const isPaid = payment.status === 'paid';
          const randomSystem = systemsList[Math.floor(Math.random() * systemsList.length)];
          const randomNote = noteTypes[Math.floor(Math.random() * noteTypes.length)];

          demoNotes.push({
            date: new Date(payment.date),
            title: `${randomNote.title} - ${payment.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`,
            text: isPaid ? randomNote.text : 'Unlock this content by completing payment for this class session.',
            isPaid: isPaid,
            course: currentStudent?.group || 'NCLEX Prep - Evening',
            type: index % 3 === 0 ? 'announcement' : 'material',
            system: randomSystem,
            read: index > 5 ? true : false, // First 5 notes are unread
            attachments: isPaid
              ? [
                  {
                    title: `${randomNote.title}.pdf`,
                    url: '#',
                    thumbnailUrl: null,
                    type: 'file',
                  },
                ]
              : [],
          });
        });

        console.log(
          `âœ… Generated ${demoNotes.length} demo notes (${demoNotes.filter(n => n.isPaid).length} unlocked, ${demoNotes.filter(n => !n.isPaid).length} locked)`
        );

        // Store globally for filtering
        allSystemNotes = demoNotes;

        return demoNotes;
      }

      // Filter notes by system and update UI
      function filterNotesBySystem(systemName) {
        selectedSystem = systemName;
        const filteredNotes = allSystemNotes.filter(note => note.system === systemName);

        document.querySelectorAll('.system-card').forEach(card => {
          if (card.dataset.systemName === systemName) {
            card.classList.add('selected');
          } else {
            card.classList.remove('selected');
          }
        });

        const escapedName = typeof CSS !== 'undefined' && CSS.escape ? CSS.escape(systemName) : systemName;
        const targetCard = document.querySelector(`.system-card[data-system-name="${escapedName}"]`);
        if (targetCard) {
          centerSystemCard(targetCard);
        }

        updateNotesHeader(systemName);
        displayNotes(filteredNotes);

        filteredNotes.forEach(note => {
          note.read = true;
        });

        updateSystemNotifications();

        const classroomList = document.getElementById('classroomList');
        if (classroomList) {
          classroomList.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      // Show all notes (clear filter)
      function showAllNotes() {
        selectedSystem = null;

        updateNotesHeader(null);
        document.querySelectorAll('.system-card').forEach(c => c.classList.remove('selected'));

        displayNotes(allSystemNotes);
        updateSystemNotifications();
      }

      function updateNotesHeader(systemName) {
        const titleElement = document.querySelector('#classroomContent').previousElementSibling;
        if (!titleElement || !titleElement.classList.contains('card-title')) return;

        titleElement.innerHTML = '';

        const left = document.createElement('div');
        left.className = 'card-title-left';

        if (systemName) {
          const systemEmoji = nclexSystems.find(s => s.name === systemName)?.icon || 'ðŸ“š';
          left.innerHTML = `<span>${systemEmoji}</span>${systemName} - Notes`;

          const button = document.createElement('button');
          button.className = 'show-all-notes-btn';
          button.type = 'button';
          button.textContent = 'â† Show All Notes';
          button.addEventListener('click', showAllNotes);

          titleElement.appendChild(left);
          titleElement.appendChild(button);
        } else {
          left.innerHTML = `<span>ðŸ“š</span>Class Materials & Notes`;
          titleElement.appendChild(left);
        }
      }

      function updateSystemNotifications() {
        document.querySelectorAll('.system-card').forEach(card => {
          const systemName = card.dataset.systemName;
          if (!systemName) return;
          const systemNotes = allSystemNotes.filter(note => note.system === systemName);
          const unreadNotes = systemNotes.filter(note => !note.read);
          const lockedNotes = unreadNotes.filter(note => !note.isPaid);
          const unlockedUnreadNotes = unreadNotes.filter(note => note.isPaid);

          card.querySelectorAll('.system-notification').forEach(notification => notification.remove());

          let badgeMarkup = '';
          if (unlockedUnreadNotes.length > 0) {
            badgeMarkup = `
            <div class="system-notification unlocked">
              <span class="notification-count">${unlockedUnreadNotes.length}</span>
              <div class="notification-pulse"></div>
            </div>
          `;
          } else if (lockedNotes.length > 0) {
            badgeMarkup = `
            <div class="system-notification locked">
              <span class="notification-count">${lockedNotes.length}</span>
              <span class="notification-lock">ðŸ”’</span>
              <div class="notification-pulse"></div>
            </div>
          `;
          }

          if (badgeMarkup) {
            card.insertAdjacentHTML('afterbegin', badgeMarkup);
          }
        });
      }

      // Helper function to check if a date is paid
      function checkIfPaid(date, payments) {
        if (!payments || payments.length === 0) return false;

        const payment = payments.find(
          p =>
            p.date.getDate() === date.getDate() &&
            p.date.getMonth() === date.getMonth() &&
            p.date.getFullYear() === date.getFullYear()
        );

        return payment && payment.status === 'paid';
      }

      // Helper function to get course name by ID
      function getCourseNameById(courseId, courses) {
        if (!courses) return 'Your Class';
        const course = courses.find(c => c.id === courseId);
        return course ? course.name : 'Your Class';
      }

      // Fetch data from Google Classroom API
      async function fetchGoogleClassroomData(type, accessToken, studentEmail) {
        let endpoint = '';
        let allResults = [];

        try {
          if (type === 'courses') {
            // Fetch courses where this specific student email is enrolled
            endpoint = `https://classroom.googleapis.com/v1/courses?studentId=${encodeURIComponent(studentEmail)}&courseStates=ACTIVE`;
            const response = await fetch(endpoint, {
              headers: { Authorization: `Bearer ${accessToken}` },
            });

            if (!response.ok) throw new Error(`${response.status}`);
            const data = await response.json();
            return data.courses || [];
          } else if (type === 'announcements') {
            // First get courses for this student
            const courses = await fetchGoogleClassroomData('courses', accessToken, studentEmail);

            // Fetch announcements from their courses
            for (const course of courses) {
              endpoint = `https://classroom.googleapis.com/v1/courses/${course.id}/announcements?orderBy=updateTime%20desc`;
              const response = await fetch(endpoint, {
                headers: { Authorization: `Bearer ${accessToken}` },
              });

              if (response.ok) {
                const data = await response.json();
                if (data.announcements) {
                  allResults.push(...data.announcements.map(a => ({ ...a, courseId: course.id })));
                }
              }
            }

            return allResults;
          } else if (type === 'coursework') {
            // First get courses for this student
            const courses = await fetchGoogleClassroomData('courses', accessToken, studentEmail);

            // Fetch coursework from their courses
            for (const course of courses) {
              endpoint = `https://classroom.googleapis.com/v1/courses/${course.id}/courseWork?orderBy=updateTime%20desc`;
              const response = await fetch(endpoint, {
                headers: { Authorization: `Bearer ${accessToken}` },
              });

              if (response.ok) {
                const data = await response.json();
                if (data.courseWork) {
                  allResults.push(...data.courseWork.map(w => ({ ...w, courseId: course.id })));
                }
              }
            }

            return allResults;
          }
        } catch (error) {
          console.error(`Error fetching ${type}:`, error);
          throw error;
        }

        return allResults;
      }

      // Get service account token from Firebase Cloud Function
      async function getServiceAccountToken() {
        try {
          // Call your Firebase function to get service account access token
          const getToken = functions.httpsCallable('getClassroomServiceToken');
          const result = await getToken();

          if (result.data && result.data.accessToken) {
            const token = result.data.accessToken;
            // Cache for 50 minutes (tokens expire in 60)
            localStorage.setItem('classroomAccessToken', token);
            localStorage.setItem('tokenExpiry', Date.now() + 50 * 60 * 1000);
            return token;
          }
        } catch (error) {
          console.error('Error getting service account token:', error);
        }
        return null;
      }

      // Check if cached token is still valid
      function getCachedToken() {
        const token = localStorage.getItem('classroomAccessToken');
        const expiry = localStorage.getItem('tokenExpiry');

        if (token && expiry && Date.now() < parseInt(expiry)) {
          return token;
        }

        // Token expired or doesn't exist
        localStorage.removeItem('classroomAccessToken');
        localStorage.removeItem('tokenExpiry');
        return null;
      }

      // NCLEX Systems Data
      const nclexSystems = [
        { name: 'Medical Terminology', icon: 'ðŸ“–', status: 'completed', progress: 100 },
        { name: 'Human Anatomy', icon: 'ðŸ«€', status: 'completed', progress: 100 },
        { name: 'Medication Suffixes & Classes', icon: 'ðŸ’Š', status: 'completed', progress: 100 },
        { name: 'Cardiovascular System', icon: 'â¤ï¸', status: 'current', progress: 65 },
        { name: 'Endocrine System', icon: 'ðŸ§ª', status: 'partial', progress: 45 },
        { name: 'Gastrointestinal System', icon: 'ðŸ½ï¸', status: 'partial', progress: 30 },
        { name: 'Respiratory System', icon: 'ðŸ«', status: 'not-started', progress: 0 },
        { name: 'Renal', icon: 'ðŸ©º', status: 'not-started', progress: 0 },
        { name: 'Fluids, Electrolytes, Nutrition', icon: 'ðŸ’§', status: 'not-started', progress: 0 },
        { name: 'Eye Disorders', icon: 'ðŸ‘ï¸', status: 'not-started', progress: 0 },
        { name: 'EENT', icon: 'ðŸ‘‚', status: 'not-started', progress: 0 },
        { name: 'Burns and Skin', icon: 'ðŸ”¥', status: 'not-started', progress: 0 },
        { name: 'Reproductive System', icon: 'ðŸ§¬', status: 'not-started', progress: 0 },
        { name: 'Maternal Health', icon: 'ðŸ¤°', status: 'not-started', progress: 0 },
        { name: 'Pediatrics', icon: 'ðŸ‘¶', status: 'not-started', progress: 0 },
        { name: 'Medical-Surgical Care', icon: 'âš•ï¸', status: 'not-started', progress: 0 },
        { name: 'Mental Health', icon: 'ðŸ§ ', status: 'not-started', progress: 0 },
        { name: 'Autoimmune Disorders', icon: 'ðŸ¦ ', status: 'not-started', progress: 0 },
        { name: 'Neurology', icon: 'ðŸ§¬', status: 'not-started', progress: 0 },
        { name: 'Cancer', icon: 'ðŸŽ—ï¸', status: 'not-started', progress: 0 },
        { name: 'Musculoskeletal Disorders', icon: 'ðŸ¦´', status: 'not-started', progress: 0 },
        { name: 'Psycho-Social Aspects', icon: 'ðŸ’­', status: 'not-started', progress: 0 },
        { name: 'Nursing Skills and Fundamentals', icon: 'âš¡', status: 'not-started', progress: 0 },
        { name: 'Pharmacology', icon: 'ðŸ’‰', status: 'not-started', progress: 0 },
      ];

      // Global variable to store all notes
      let allSystemNotes = [];
      let selectedSystem = null;

      // Load systems progress carousel
      function loadSystemsProgress() {
        const carousel = document.getElementById('systemsCarousel');
        carousel.innerHTML = '';

        nclexSystems.forEach((system, index) => {
          const card = document.createElement('div');
          card.className = `system-card ${system.status}`;
          card.dataset.systemName = system.name;
          card.style.animationDelay = `${index * 0.05}s`;

          if (selectedSystem === system.name) {
            card.classList.add('selected');
          }

          const systemNotes = allSystemNotes.filter(note => note.system === system.name);
          const unreadNotes = systemNotes.filter(note => !note.read);
          const lockedNotes = unreadNotes.filter(note => !note.isPaid);
          const unlockedUnreadNotes = unreadNotes.filter(note => note.isPaid);

          let notificationBadge = '';
          if (unlockedUnreadNotes.length > 0) {
            notificationBadge = `
            <div class="system-notification unlocked">
              <span class="notification-count">${unlockedUnreadNotes.length}</span>
              <div class="notification-pulse"></div>
            </div>
          `;
          } else if (lockedNotes.length > 0) {
            notificationBadge = `
            <div class="system-notification locked">
              <span class="notification-count">${lockedNotes.length}</span>
              <span class="notification-lock">ðŸ”’</span>
              <div class="notification-pulse"></div>
            </div>
          `;
          }

          card.innerHTML = `
          ${notificationBadge}
          <div class="system-icon">${system.icon}</div>
          <div class="system-name">${system.name}</div>
          <div class="system-progress">${system.progress}% Complete</div>
          <div class="system-bar">
            <div class="system-bar-fill" style="width: ${system.progress}%"></div>
          </div>
          <div class="system-status"></div>
        `;

          card.addEventListener('click', () => {
            centerSystemCard(card);
            filterNotesBySystem(system.name);
          });

          carousel.appendChild(card);
        });

        setTimeout(() => {
          const escapedName =
            selectedSystem && typeof CSS !== 'undefined' && CSS.escape ? CSS.escape(selectedSystem) : selectedSystem;
          const focusCard =
            selectedSystem && escapedName
              ? carousel.querySelector(`.system-card[data-system-name="${escapedName}"]`)
              : carousel.querySelector('.system-card.current');
          if (focusCard) {
            centerSystemCard(focusCard);
          }
        }, 300);
      }

      function centerSystemCard(card) {
        const carousel = document.getElementById('systemsCarousel');
        if (!carousel || !card) return;

        const container = carousel.parentElement;
        if (!container) return;

        const containerWidth = container.getBoundingClientRect().width;
        const cardWidth = card.getBoundingClientRect().width;
        const target = card.offsetLeft - containerWidth / 2 + cardWidth / 2;
        const maxScroll = carousel.scrollWidth - carousel.clientWidth;
        const clamped = Math.max(0, Math.min(target, maxScroll));

        carousel.scrollTo({
          left: clamped,
          behavior: 'smooth',
        });
      }

      // Carousel navigation
      function scrollCarousel(direction) {
        const carousel = document.getElementById('systemsCarousel');
        const scrollAmount = 220; // card width + gap
        carousel.scrollBy({
          left: direction * scrollAmount,
          behavior: 'smooth',
        });
      }

      // Display notes with lock/unlock status
      function displayNotes(notes) {
        const classroomList = document.getElementById('classroomList');
        classroomList.innerHTML = '';

        if (notes.length === 0) {
          const emptyMessage = document.createElement('div');
          emptyMessage.style.cssText = 'text-align: center; color: rgba(255,255,255,0.7); padding: 40px;';
          emptyMessage.textContent = 'No notes available yet.';
          classroomList.appendChild(emptyMessage);
          return;
        }

        notes.forEach(note => {
          const item = document.createElement('div');
          item.className = `classroom-item ${note.type || 'material'} ${note.isPaid ? '' : 'locked'}`;

          // Determine the badge icon and text
          let badgeIcon = 'ðŸ“„';
          let badgeText = 'Note';

          if (!note.isPaid) {
            badgeIcon = 'ðŸ”’';
            badgeText = 'Locked';
          } else if (note.type === 'announcement') {
            badgeIcon = 'ðŸ“¢';
            badgeText = 'Announcement';
          } else if (note.type === 'material') {
            badgeIcon = 'ðŸ“š';
            badgeText = 'Material';
          }

          // Build attachments HTML with watermark
          let attachmentsHTML = '';
          if (note.attachments && note.attachments.length > 0 && note.isPaid) {
            attachmentsHTML = '<div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px;">';
            note.attachments.forEach(attachment => {
              const icon = attachment.type === 'video' ? 'ðŸŽ¥' : attachment.type === 'link' ? 'ðŸ”—' : 'ðŸ“Ž';

              attachmentsHTML += `
              <div style="
                position: relative;
                flex: 0 0 auto;
                width: 120px;
                height: 120px;
                border-radius: 12px;
                overflow: hidden;
                background: rgba(102,126,234,0.1);
                border: 1px solid rgba(102,126,234,0.3);
                cursor: pointer;
                transition: all 0.3s ease;
              " onclick="window.open('${attachment.url}', '_blank')"
                 onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 8px 20px rgba(102,126,234,0.4)'"
                 onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">

                ${
                  attachment.thumbnailUrl
                    ? `
                  <img src="${attachment.thumbnailUrl}" style="
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                  " />
                `
                    : `
                  <div style="
                    width: 100%;
                    height: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 40px;
                  ">${icon}</div>
                `
                }

                <!-- Watermark overlay -->
                <div style="
                  position: absolute;
                  top: 0;
                  left: 0;
                  right: 0;
                  bottom: 0;
                  background: rgba(0,0,0,0.1);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                ">
                  <img src="/richyfesta-logo.png" style="
                    width: 40px;
                    height: 40px;
                    opacity: 0.5;
                    filter: brightness(0) invert(1);
                  " />
                </div>

                <!-- Attachment title -->
                <div style="
                  position: absolute;
                  bottom: 0;
                  left: 0;
                  right: 0;
                  padding: 8px 6px;
                  background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
                  color: white;
                  font-size: 11px;
                  font-weight: 500;
                  text-overflow: ellipsis;
                  overflow: hidden;
                  white-space: nowrap;
                ">${attachment.title}</div>
              </div>
            `;
            });
            attachmentsHTML += '</div>';
          }

          item.innerHTML = `
          <div class="classroom-header">
            <div>
              <div class="classroom-title">
                ${note.isPaid ? '' : 'ðŸ”’ '}${note.title}
              </div>
              <div class="classroom-course">${note.course}</div>
            </div>
            <div class="classroom-date">${note.date.toLocaleDateString()}</div>
          </div>
          <div class="classroom-text ${note.isPaid ? '' : 'blurred'}">${note.text}</div>
          <span class="classroom-badge ${note.isPaid ? note.type || 'material' : 'locked'}">${badgeIcon} ${badgeText}</span>
          ${attachmentsHTML}
        `;

          // Add click handler for locked notes
          if (!note.isPaid) {
            item.style.cursor = 'pointer';
            item.addEventListener('click', () => {
              alert('This note is locked. Please complete payment for this class to unlock.');
            });
          }

          classroomList.appendChild(item);
        });
      }
    </script>
  </body>
</html>
