<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARNOMA - Student Management</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- Supabase Configuration -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.1"></script>
  <script>
    // Supabase Client Initialization
    const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    console.log('✅ Supabase client initialized');
    
    // Global data caches for performance
    window.paymentsCache = [];
    window.studentsCache = [];
    window.groupsCache = [];
    
    // ============================================================================
    // LOS ANGELES TIMEZONE UTILITIES
    // ============================================================================
    const LA_TIMEZONE = 'America/Los_Angeles';
    
    // Get current date/time in LA timezone
    function getNowLA() {
      return new Date(new Date().toLocaleString('en-US', { timeZone: LA_TIMEZONE }));
    }
    
    // Get today's date string in LA timezone (YYYY-MM-DD)
    function getTodayLA() {
      const now = getNowLA();
      return now.toISOString().slice(0, 10);
    }
    
    // Convert any date to LA timezone
    function toLA(date) {
      return new Date(date.toLocaleString('en-US', { timeZone: LA_TIMEZONE }));
    }
    
    // Format date in LA timezone
    function formatDateLA(date, options = {}) {
      return new Date(date).toLocaleString('en-US', { 
        timeZone: LA_TIMEZONE,
        ...options 
      });
    }
  </script>

  <!-- BEGIN POPUP BACK & EXIT FIX -->
  <script>
    // Global Popup Management System
    // Ensures all popups have Back button, click-outside-to-close, and instant responsiveness
    window.PopupManager = {
      activePopups: new Set(),
      listenerRegistry: new WeakMap(),
      
      // Register a popup for management
      register(popupId, options = {}) {
        const popup = document.getElementById(popupId);
        if (!popup || popup.dataset.popupInitialized === 'true') return;
        
        popup.dataset.popupInitialized = 'true';
        const config = {
          hasBackButton: options.hasBackButton !== false,
          hasCloseButton: options.hasCloseButton !== false,
          closeOnOutsideClick: options.closeOnOutsideClick !== false,
          onClose: options.onClose || null,
          onBack: options.onBack || null,
          parent: options.parent || null
        };
        
        // Store config
        popup._popupConfig = config;
        
        // Add back button if enabled
        if (config.hasBackButton) {
          this.addBackButton(popup, config.onBack);
        }
        
        // Setup click-outside-to-close
        if (config.closeOnOutsideClick) {
          this.setupOutsideClick(popup);
        }
        
        // Ensure all buttons are immediately responsive
        this.optimizeButtons(popup);
      },
      
      // Add back button to popup header
      addBackButton(popup, onBackCallback) {
        const header = popup.querySelector('[style*="justify-content: space-between"]') || 
                       popup.querySelector('h3')?.parentElement;
        if (!header || header.querySelector('.popup-back-btn')) return;
        
        const backBtn = document.createElement('button');
        backBtn.className = 'popup-back-btn';
        backBtn.innerHTML = '← Back';
        backBtn.style.cssText = `
          background: none;
          border: none;
          color: var(--secondary, #94a3b8);
          opacity: 0.8;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          padding: 8px 12px;
          margin-right: auto;
          transition: all 0.2s ease;
          pointer-events: auto;
          position: absolute;
          left: 16px;
          top: 20px;
          z-index: 1;
        `;
        
        backBtn.onmouseover = () => {
          backBtn.style.opacity = '1';
          backBtn.style.textShadow = '0 0 8px rgba(148,163,184,0.6)';
        };
        backBtn.onmouseout = () => {
          backBtn.style.opacity = '0.8';
          backBtn.style.textShadow = 'none';
        };
        
        backBtn.onclick = (e) => {
          e.stopPropagation();
          if (onBackCallback) {
            onBackCallback();
          } else {
            this.close(popup.id);
          }
        };
        
        header.style.position = 'relative';
        header.insertBefore(backBtn, header.firstChild);
      },
      
      // Setup click-outside-to-close
      setupOutsideClick(popup) {
        // Find or create backdrop
        let backdrop = document.getElementById(popup.id + 'Backdrop');
        if (!backdrop) {
          backdrop = popup.previousElementSibling;
          if (!backdrop || !backdrop.style.background?.includes('rgba')) {
            backdrop = null;
          }
        }
        
        if (backdrop) {
          // Remove old listener if exists
          const oldListener = this.listenerRegistry.get(backdrop);
          if (oldListener) {
            backdrop.removeEventListener('click', oldListener);
          }
          
          // Add new debounced listener
          const closeHandler = this.debounce((e) => {
            e.stopPropagation();
            this.close(popup.id);
          }, 150);
          
          backdrop.addEventListener('click', closeHandler, { once: false });
          this.listenerRegistry.set(backdrop, closeHandler);
          
          // Ensure backdrop is clickable
          backdrop.style.cursor = 'pointer';
          backdrop.style.pointerEvents = 'auto';
        }
      },
      
      // Optimize all buttons in popup for instant response
      optimizeButtons(popup) {
        const buttons = popup.querySelectorAll('button, [onclick]');
        buttons.forEach(btn => {
          // Ensure immediate pointer events
          btn.style.pointerEvents = 'auto';
          btn.style.transition = btn.style.transition || 'all 0.2s ease';
          
          // Remove any existing duplicate listeners
          const clone = btn.cloneNode(true);
          btn.parentNode?.replaceChild(clone, btn);
        });
      },
      
      // Debounce helper (prevents double-clicks)
      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },
      
      // Open popup with fade-in
      open(popupId) {
        const popup = document.getElementById(popupId);
        if (!popup) return;
        
        this.activePopups.add(popupId);
        popup.style.display = 'block';
        popup.style.opacity = '0';
        popup.style.transition = 'opacity 0.25s ease';
        
        // Trigger fade-in
        requestAnimationFrame(() => {
          popup.style.opacity = '1';
        });
        
        // Show backdrop if exists
        const backdrop = document.getElementById(popupId + 'Backdrop');
        if (backdrop) {
          backdrop.style.display = 'block';
          backdrop.style.opacity = '0';
          backdrop.style.transition = 'opacity 0.25s ease';
          requestAnimationFrame(() => {
            backdrop.style.opacity = '1';
          });
        }
      },
      
      // Close popup with fade-out
      close(popupId) {
        const popup = document.getElementById(popupId);
        if (!popup) return;
        
        const config = popup._popupConfig;
        
        // Fade out
        popup.style.opacity = '0';
        const backdrop = document.getElementById(popupId + 'Backdrop');
        if (backdrop) {
          backdrop.style.opacity = '0';
        }
        
        // Hide after transition
        setTimeout(() => {
          popup.style.display = 'none';
          if (backdrop) backdrop.style.display = 'none';
          this.activePopups.delete(popupId);
          
          // Call onClose callback
          if (config?.onClose) {
            config.onClose();
          }
        }, 250);
      },
      
      // Close all popups
      closeAll() {
        this.activePopups.forEach(id => this.close(id));
      }
    };
  </script>
  <!-- END POPUP BACK & EXIT FIX -->
  
  <style>
    :root {
      --primary: #3b82f6;
      --secondary: #94a3b8;
      --ink: #0f172a;
      --ink-dim: #64748b;
      --stroke: rgba(148, 163, 184, 0.2);
      --text: #f8fafc;
      --background: #0f1419;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #0b0b10;
      color: #e5e7eb;
      min-height: 100vh;
      padding: 20px;
      margin: 0;
    }
    
    .container {
      max-width: 1540px;
      margin: 0 auto;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 18px;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 8px 28px rgba(0,0,0,0.35);
      overflow: hidden;
      transition: 0.25s ease-in-out;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 700;
      color: white;
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    
    .header-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-btn {
      width: 36px;
      height: 36px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      padding: 0;
    }
    
    .control-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.1);
    }
    
    .control-btn.spinning {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    
    .gmail-btn {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    
    .gmail-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    
    .gmail-btn.connected {
      background: rgba(34, 197, 94, 0.2);
      border-color: rgba(34, 197, 94, 0.4);
      color: #22c55e;
    }
    
    #autoRefreshToggle.auto-refresh-active {
      background: rgba(34, 197, 94, 0.2);
      border-color: rgba(34, 197, 94, 0.4);
      color: #22c55e;
    }
    
    .stats {
      font-size: 13px;
      color: rgba(255,255,255,0.9);
      font-weight: 600;
      margin-left: 8px;
    }
    
    .filter-dropdown {
      padding: 8px 12px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-left: 8px;
    }
    
    .content {
      padding: 20px;
      max-height: calc(90vh - 100px);
      overflow-y: auto;
    }
    
    .date-section {
      margin-bottom: 24px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .date-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      background: rgba(15, 23, 42, 0.8);
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
    }
    
    .date-title {
      font-size: 15px;
      font-weight: 600;
      color: #e2e8f0;
      letter-spacing: 0.3px;
    }
    
    .date-total {
      font-size: 14px;
      font-weight: 600;
      color: #94a3b8;
    }
    
    .payments-table {
      background: transparent;
      border: none;
      overflow: hidden;
    }
    
    .table-header {
      display: grid;
      grid-template-columns: 100px 1fr 1fr 100px 1fr 180px 1fr 40px;
      gap: 16px;
      padding: 14px 20px;
      background: rgba(30, 41, 59, 0.4);
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
      font-size: 11px;
      font-weight: 700;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .table-row {
      display: grid;
      grid-template-columns: 100px 1fr 1fr 100px 1fr 180px 1fr 40px;
      gap: 16px;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.3);
      font-size: 13px;
      color: #e2e8f0;
      transition: background 0.15s ease;
    }
    
    .table-row:hover {
      background: rgba(51, 65, 85, 0.25);
    }
    
    .table-row:last-child {
      border-bottom: none;
    }
    
    .unmatched-badge {
      padding: 4px 10px;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 4px;
      color: #ef4444;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-left: 8px;
      white-space: nowrap;
    }
    
    .amount-usd {
      color: #22c55e;
      font-weight: 700;
    }
    
    .amount-amd {
      color: #94a3b8;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--secondary);
    }
    
    .empty-icon {
      font-size: 48px;
      margin-bottom: 10px;
      opacity: 0.5;
    }
    
    /* BEGIN PAYMENT RECORDS ORDER & HIGHLIGHT FIX */
    .payment-row-new {
      animation: blinkGreenTint 1.5s ease-in-out infinite;
      box-shadow: 0 0 8px rgba(0, 255, 160, 0.3);
    }
    
    @keyframes blinkGreenTint {
      0%, 100% { 
        background: rgba(0, 255, 140, 0.12); 
        border-color: rgba(0, 255, 160, 0.3);
      }
      50% { 
        background: rgba(0, 255, 140, 0.25); 
        border-color: rgba(0, 255, 160, 0.5);
      }
    }
    /* END PAYMENT RECORDS ORDER & HIGHLIGHT FIX */
    
    /* BEGIN BULK ADD STUDENTS FEATURE */
    #bulkAddStudentsModal {
      transition: opacity 0.25s ease;
    }
    
    #bulkAddStudentsModal textarea {
      transition: border-color 0.2s ease;
    }
    
    #bulkAddStudentsModal textarea:focus {
      outline: none;
      border-color: rgba(59, 130, 246, 0.5);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    /* END BULK ADD STUDENTS FEATURE */
    
    /* BEGIN DROPDOWN VISIBILITY FIX */
    select, option {
      color: #e8e8f0 !important;
      background-color: rgba(30, 30, 40, 0.9) !important;
    }

    select option:hover,
    select option:focus,
    select:focus {
      background-color: rgba(90, 90, 120, 0.95) !important;
      color: #ffffff !important;
    }

    select option:checked {
      background-color: rgba(100, 100, 160, 0.9) !important;
      color: #ffffff !important;
    }
    /* END DROPDOWN VISIBILITY FIX */
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
    
    #paymentActionsPopup.active {
      display: block !important;
    }
    
    /* Overlay for popup */
    #paymentActionsPopup::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: -1;
    }
    
    /* Month Total Stats */
    .month-total-section {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1));
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 8px;
      padding: 0;
      margin: 20px;
      overflow: hidden;
    }
    
    .month-total-header-row {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px 20px;
    }
    
    .month-total-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .month-total-values {
      padding: 0 20px 16px 20px;
      transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
      max-height: 200px;
      opacity: 1;
      overflow: hidden;
    }

    .month-total-values.collapsed {
      max-height: 0;
      opacity: 0;
      padding: 0 20px;
    }

    .month-total-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      width: 100%;
    }

    .month-total-stats {
      display: flex;
      align-items: center;
      gap: 32px;
      margin-left: auto;
    }
    
    .month-total-item {
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    
    .month-total-toggle {
      background: transparent;
      border: none;
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: transform 0.2s ease, opacity 0.2s ease;
      width: auto;
      height: auto;
    }
    
    .month-total-toggle:hover {
      opacity: 0.7;
      transform: scale(1.1);
    }
    
    .month-total-toggle span {
      font-size: 18px;
      font-weight: 700;
    }
    
    .month-total-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--secondary);
      font-weight: 600;
    }
    
    .month-total-value {
      font-size: 18px;
      font-weight: 700;
      color: #22c55e;
    }
    
    .month-selector {
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15));
      border: 1px solid rgba(138, 180, 255, 0.4);
      border-radius: 10px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      outline: none;
      appearance: none;
      padding-right: 32px;
      background-image: 
        linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15)),
        url('data:image/svg+xml;charset=UTF-8,<svg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 1.5L6 6.5L11 1.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
      background-repeat: no-repeat, no-repeat;
      background-position: center, right 10px center;
    }
    
    .month-selector:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(139, 92, 246, 0.25));
      border-color: rgba(138, 180, 255, 0.6);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      transform: translateY(-1px);
    }
    
    .month-selector:focus {
      border-color: rgba(138, 180, 255, 0.8);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    
    .month-selector option {
      background: #1a1f2e;
      color: white;
      padding: 10px;
    }
    
    /* Student Manager Styles */
    .group-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(138, 180, 255, 0.3);
    }
    
    .group-btn.active {
      background: rgba(138, 180, 255, 0.4) !important;
      border-color: #8ab4ff !important;
      color: white !important;
    }
    
    /* Group Manager Styles */
    .group-day-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
    }
    
    .group-day-btn.active {
      background: rgba(168, 85, 247, 0.4) !important;
      border-color: #a855f7 !important;
      color: white !important;
    }

    /* Group Manager Styles */
    .group-card {
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(30px);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 4px 16px rgba(0,0,0,.1);
      transition: all 0.2s;
    }

    .group-card:hover {
      border-color: rgba(138,180,255,0.4);
      box-shadow: 0 8px 24px rgba(138,180,255,0.2);
    }

    .group-title {
      font-size: 22px;
      font-weight: 700;
      background: linear-gradient(135deg, #8ab4ff, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px;
    }

    .schedule-display {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0;
    }

    .schedule-item {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 6px 10px;
      background: rgba(255,255,255,.04);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 10px;
      font-size: 13px;
      transition: all 0.2s;
    }

    .schedule-item:hover {
      background: rgba(255,255,255,.08);
      border-color: rgba(138,180,255,.3);
    }

    .schedule-item.upcoming-green {
      background: rgba(34,197,94,.15) !important;
      border-color: rgba(34,197,94,.4) !important;
      color: #4ade80 !important;
      box-shadow: 0 4px 14px rgba(34,197,94,.25);
    }

    .schedule-item.upcoming-orange {
      background: rgba(251,191,36,.15) !important;
      border-color: rgba(251,191,36,.4) !important;
      color: #fbbf24 !important;
      box-shadow: 0 4px 14px rgba(251,191,36,.3);
    }

    .schedule-item.upcoming-red {
      background: rgba(239,68,68,.18) !important;
      border-color: rgba(239,68,68,.45) !important;
      color: #f87171 !important;
      box-shadow: 0 4px 18px rgba(239,68,68,.35);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }

    .group-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .group-actions button {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      border: none;
      background: rgba(138,180,255,.15);
      color: #8ab4ff;
      border: 1px solid rgba(138,180,255,.3);
    }

    .group-actions button:hover {
      background: rgba(138,180,255,.25);
      transform: translateY(-1px);
    }

    .schedule-editor {
      margin-top: 16px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(138,180,255,.08), rgba(168,85,247,.08));
      border: 2px solid rgba(138,180,255,.3);
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(138,180,255,.15);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .slot-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .slot-row select,
    .slot-row input[type="time"] {
      flex: 1;
      padding: 8px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 6px;
      color: white;
      font-size: 13px;
    }

    .slot-row button {
      padding: 8px 10px;
      background: rgba(244,67,54,.15);
      color: #f44336;
      border: 1px solid #f44336;
      border-radius: 6px;
      font-weight: 700;
      cursor: pointer;
      font-size: 14px;
    }

    #toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 30000;
      transition: opacity 0.3s;
    }

    #toast.show {
      opacity: 1 !important;
      pointer-events: auto !important;
    }

    /* Student Manager Styles */
    .student-card, .student-item {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 14px;
      padding: 20px;
      backdrop-filter: blur(30px);
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
    }

    .student-card:hover, .student-item:hover {
      transform: translateY(-2px);
      border-color: #8ab4ff;
      box-shadow: 0 8px 24px rgba(138,180,255,0.2);
    }

    .student-item.editing {
      border-color: #4ade80;
      box-shadow: 0 8px 24px rgba(74,222,128,.3);
    }

    .student-view {
      cursor: pointer;
    }

    .student-edit {
      display: none;
    }

    .student-item.editing .student-view {
      display: none;
    }

    .student-item.editing .student-edit {
      display: block;
    }

    .student-name {
      font-weight: 700;
      font-size: 20px;
      color: #f3f4f6;
      margin-bottom: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .student-name:hover {
      color: #8ab4ff;
    }

    .student-group {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 16px;
    }

    /* BEGIN FEATURE 2 - Instant Group Switch Buttons */
    .group-buttons {
      display: flex;
      gap: 6px;
      justify-content: center;
      margin: 12px 0;
      flex-wrap: wrap;
    }

    .group-btn {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.25s ease;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,0.7);
      min-width: 36px;
    }

    .group-btn:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.3);
      color: rgba(255,255,255,0.9);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(138,180,255,0.2);
    }

    .group-btn.active {
      background: linear-gradient(90deg, #8ab4ff, #a855f7);
      border-color: rgba(168,85,247,0.5);
      color: white;
      box-shadow: 0 4px 16px rgba(138,180,255,0.4);
    }

    .group-btn.active:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(138,180,255,0.6);
    }
    /* END FEATURE 2 */

    .student-status {
      font-size: 0.85rem;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .price-pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.85rem;
      background: linear-gradient(135deg, #8ab4ff, #a855f7);
      color: #fff;
      font-weight: 700;
      margin-top: 8px;
    }

    .status-pill-single {
      padding: 6px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      border: 1px solid;
    }

    .status-active {
      background: rgba(76,175,80,.15);
      border-color: rgba(76,175,80,.4);
      color: #4caf50;
    }

    .status-paused {
      background: rgba(255,152,0,.15);
      border-color: rgba(255,152,0,.4);
      color: #ff9800;
    }

    .status-graduated {
      background: rgba(33,150,243,.15);
      border-color: rgba(33,150,243,.4);
      color: #2196f3;
    }

    .mini-toggle {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .mini-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,.1);
      transition: 0.3s;
      border-radius: 24px;
      border: 2px solid rgba(255,255,255,.2);
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #8ab4ff;
      border-color: #8ab4ff;
    }

    input:checked + .slider:before {
      transform: translateX(20px);
    }

    .inline-form-group {
      margin-bottom: 16px;
    }

    .inline-form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #f3f4f6;
      font-size: 12px;
    }

    .inline-form-group input,
    .inline-form-group textarea {
      width: 100%;
      padding: 10px;
      background: rgba(255,255,255,.08);
      border: 2px solid rgba(255,255,255,.2);
      border-radius: 8px;
      color: #f3f4f6;
      font-size: 14px;
      font-family: inherit;
    }

    .inline-form-group input:focus,
    .inline-form-group textarea:focus {
      outline: none;
      border-color: #8ab4ff;
      background: rgba(138,180,255,.12);
    }

    .inline-form-group textarea {
      min-height: 60px;
      resize: vertical;
    }

    .inline-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    .action-btn {
      flex: 1;
      padding: 10px;
      border: 2px solid;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .edit-btn {
      background: rgba(138,180,255,.15);
      border-color: #8ab4ff;
      color: #8ab4ff;
    }

    .edit-btn:hover {
      background: rgba(138,180,255,.25);
    }

    .waiting-btn {
      background: rgba(168,85,247,.15);
      border-color: #a855f7;
      color: #a855f7;
    }

    .waiting-btn:hover {
      background: rgba(168,85,247,.25);
    }

    .delete-btn {
      background: rgba(244,67,54,.15);
      border-color: #f44336;
      color: #f44336;
    }

    .delete-btn:hover {
      background: rgba(244,67,54,.25);
    }

    .group-select-btn.selected {
      background: #8ab4ff !important;
      color: white !important;
      border-color: #8ab4ff !important;
    }

    .student-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255,255,255,.1);
    }

    .student-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,.05);
    }

    .info-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 600;
    }

    .info-value {
      font-size: 15px;
      color: #8ab4ff;
      font-weight: 700;
    }

    .info-column {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,.05);
    }

    .info-text {
      font-size: 13px;
      color: #f3f4f6;
      word-break: break-word;
    }

    .aliases-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .alias-badge {
      font-size: 11px;
      padding: 4px 10px;
      background: rgba(138,180,255,.15);
      border: 1px solid rgba(138,180,255,.3);
      border-radius: 6px;
      color: #8ab4ff;
      font-weight: 600;
    }

    /* ========== BEGIN FLOATING NAV STYLES ========== */
    .floating-nav {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      gap: 8px;
      background: linear-gradient(135deg, rgba(30, 30, 46, 0.95), rgba(42, 42, 62, 0.95));
      backdrop-filter: blur(16px);
      border: 1px solid rgba(138, 180, 255, 0.25);
      border-radius: 20px;
      padding: 10px 14px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .floating-nav .nav-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.12);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 18px;
      font-weight: 400;
      position: relative;
    }

    .floating-nav .nav-btn:hover {
      background: linear-gradient(135deg, rgba(138, 180, 255, 0.2), rgba(168, 85, 247, 0.2));
      color: #fff;
      border-color: rgba(138, 180, 255, 0.4);
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 20px rgba(138, 180, 255, 0.4);
    }

    .floating-nav .nav-btn:active {
      transform: scale(0.96);
    }

    .floating-nav .nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none !important;
    }

    /* BEGIN CLASS COUNTDOWN TIMER */
    /* Class Countdown Overlay - Legacy (kept for backward compatibility) */
    #classCountdownOverlay {
      position: fixed;
      bottom: 80px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(30, 30, 46, 0.95), rgba(42, 42, 62, 0.95));
      backdrop-filter: blur(16px);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      z-index: 9998;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(138, 180, 255, 0.3);
      animation: slideInUp 0.3s ease;
    }

    /* Enhanced Class Countdown Timer Panel - Liquid Glass Popup Style */
    #enhancedCountdownTimer {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 560px;
      max-height: 760px;
      padding: 0;
      border-radius: 18px;
      background: rgba(30, 30, 40, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', system-ui, sans-serif;
      font-size: 13px;
      z-index: 9999;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      user-select: none;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Time-based color tints */
    #enhancedCountdownTimer.time-safe {
      background: rgba(30, 30, 40, 0.95);
      border-color: rgba(0, 255, 160, 0.3);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8), 0 0 20px rgba(0, 255, 160, 0.15);
    }

    #enhancedCountdownTimer.time-upcoming {
      background: rgba(40, 38, 30, 0.95);
      border-color: rgba(255, 220, 50, 0.35);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8), 0 0 20px rgba(255, 220, 50, 0.2);
      transition: all 0.8s ease-in-out;
    }

    #enhancedCountdownTimer.time-warning {
      background: rgba(45, 35, 30, 0.95);
      border-color: rgba(255, 160, 50, 0.4);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8), 0 0 24px rgba(255, 160, 50, 0.25);
      transition: all 0.8s ease-in-out;
    }

    #enhancedCountdownTimer.time-critical {
      background: rgba(50, 30, 30, 0.95);
      border-color: rgba(255, 100, 100, 0.5);
      transition: all 1s ease-in-out;
    }

    /* Gradual blinking for critical state (<6h) */
    #enhancedCountdownTimer.time-critical.pulse-slow {
      animation: redPulseSlow 2.5s ease-in-out infinite;
    }

    #enhancedCountdownTimer.time-critical.pulse-medium {
      animation: redPulseMedium 1.5s ease-in-out infinite;
    }

    #enhancedCountdownTimer.time-critical.pulse-fast {
      animation: redPulseFast 1s ease-in-out infinite;
    }

    @keyframes redPulseSlow {
      0%, 100% {
        border-color: rgba(255, 100, 100, 0.5);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8), 0 0 24px rgba(255, 100, 100, 0.3);
      }
      50% {
        border-color: rgba(255, 100, 100, 0.7);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8), 0 0 32px rgba(255, 100, 100, 0.4);
      }
    }

    @keyframes redPulseMedium {
      0%, 100% {
        border-color: rgba(255, 80, 80, 0.6);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8), 0 0 28px rgba(255, 80, 80, 0.35);
      }
      50% {
        border-color: rgba(255, 80, 80, 0.8);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8), 0 0 36px rgba(255, 80, 80, 0.5);
      }
    }

    @keyframes redPulseFast {
      0%, 100% {
        border-color: rgba(255, 60, 60, 0.7);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8), 0 0 32px rgba(255, 60, 60, 0.4);
      }
      50% {
        border-color: rgba(255, 60, 60, 0.9);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.8), 0 0 40px rgba(255, 60, 60, 0.6);
      }
    }

    #enhancedCountdownTimer:hover {
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
      border-color: rgba(138, 180, 255, 0.4);
    }

    #enhancedCountdownTimer .timer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      flex-shrink: 0;
    }

    #enhancedCountdownTimer .timer-icon {
      font-size: 14px;
      margin-right: 5px;
      opacity: 0.9;
    }

    #enhancedCountdownTimer .timer-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--secondary);
      opacity: 0.9;
      letter-spacing: 0.2px;
      flex: 1;
    }

    #enhancedCountdownTimer .timer-close {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.5);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      padding: 0;
      line-height: 1;
      font-weight: 300;
    }

    #enhancedCountdownTimer .timer-close:hover {
      background: rgba(239, 68, 68, 0.12);
      border-color: rgba(239, 68, 68, 0.3);
      color: rgba(239, 68, 68, 0.9);
      transform: scale(1.05);
    }

    /* Classes List Container */
    #enhancedCountdownTimer .timer-classes-list {
      overflow-y: auto;
      max-height: 600px;
      padding: 12px;
      flex: 1;
    }

    #enhancedCountdownTimer .timer-classes-list::-webkit-scrollbar {
      width: 6px;
    }

    #enhancedCountdownTimer .timer-classes-list::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }

    #enhancedCountdownTimer .timer-classes-list::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }

    #enhancedCountdownTimer .timer-classes-list::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    #enhancedCountdownTimer .timer-no-classes {
      padding: 60px 20px;
      text-align: center;
      color: rgba(255, 255, 255, 0.6);
      font-size: 14px;
      line-height: 1.6;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
    }

    /* Individual Class Item */
    #enhancedCountdownTimer .timer-class-item {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 10px;
      transition: transform 0.2s ease;
    }

    #enhancedCountdownTimer .timer-class-item:last-child {
      margin-bottom: 0;
    }

    #enhancedCountdownTimer .timer-class-item:hover {
      transform: translateX(-2px);
    }
    
    #enhancedCountdownTimer .timer-class-item:not(.class-critical):hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.2);
    }

    /* Next Class Highlight */
    #enhancedCountdownTimer .timer-class-item.next-class {
      background: rgba(138, 180, 255, 0.12);
      border-color: rgba(138, 180, 255, 0.3);
      box-shadow: 0 2px 8px rgba(138, 180, 255, 0.2);
    }

    /* State-based styling - Per-Class Card Tinting */
    /* >24h - Safe green tint */
    #enhancedCountdownTimer .timer-class-item.class-safe {
      border-color: rgba(0, 255, 160, 0.5);
      background: rgba(0, 255, 160, 0.22);
      box-shadow: 0 0 12px rgba(0, 255, 160, 0.3);
    }

    /* 12-24h - Yellow tint */
    #enhancedCountdownTimer .timer-class-item.class-upcoming {
      border-color: rgba(255, 220, 60, 0.55);
      background: rgba(255, 220, 60, 0.25);
      box-shadow: 0 0 14px rgba(255, 220, 60, 0.35);
    }

    /* 6-12h - Orange tint */
    #enhancedCountdownTimer .timer-class-item.class-warning {
      border-color: rgba(255, 160, 40, 0.6);
      background: rgba(255, 160, 40, 0.28);
      box-shadow: 0 0 16px rgba(255, 160, 40, 0.4);
    }

    /* <6h - Red tint with pulse animation */
    #enhancedCountdownTimer .timer-class-item.class-critical {
      border-color: rgba(255, 100, 100, 0.7);
      background: linear-gradient(135deg, rgba(80, 20, 20, 0.5), rgba(120, 30, 30, 0.4));
      background-color: rgba(200, 60, 60, 0.45) !important;
      box-shadow: 0 0 18px rgba(255, 100, 100, 0.5);
      animation: pulseRed 2s ease-in-out infinite !important;
    }

    /* Pulse animation for red (<6h) classes */
    @keyframes pulseRed {
      0%, 100% {
        border-color: rgba(255, 100, 100, 0.7);
        box-shadow: 0 0 18px rgba(255, 80, 80, 0.5);
        transform: scale(1);
      }
      50% {
        border-color: rgba(255, 120, 120, 1);
        box-shadow: 0 0 32px rgba(255, 80, 80, 0.8), 0 0 16px rgba(255, 40, 40, 0.6);
        transform: scale(1.01);
      }
    }

    /* Legacy state classes for backward compatibility */
    #enhancedCountdownTimer .timer-class-item.warning {
      border-color: rgba(251, 191, 36, 0.5);
      background: rgba(251, 191, 36, 0.12);
      box-shadow: 0 0 12px rgba(251, 191, 36, 0.2);
    }

    #enhancedCountdownTimer .timer-class-item.urgent {
      border-color: rgba(239, 68, 68, 0.6);
      background: rgba(239, 68, 68, 0.15);
      box-shadow: 0 0 16px rgba(239, 68, 68, 0.25);
    }

    #enhancedCountdownTimer .timer-class-item.in-progress {
      border-color: rgba(16, 185, 129, 0.5);
      background: rgba(16, 185, 129, 0.12);
      box-shadow: 0 0 12px rgba(16, 185, 129, 0.2);
    }

    /* Class Item Header */
    #enhancedCountdownTimer .timer-class-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    #enhancedCountdownTimer .timer-class-icon {
      font-size: 12px;
      flex-shrink: 0;
    }

    #enhancedCountdownTimer .timer-class-group {
      font-size: 15px;
      font-weight: 600;
      color: #fff;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #enhancedCountdownTimer .timer-class-countdown {
      font-size: 14px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.85);
      flex-shrink: 0;
    }

    /* Class Item Details */
    #enhancedCountdownTimer .timer-class-details {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
      flex-wrap: wrap;
    }

    #enhancedCountdownTimer .timer-class-day {
      font-weight: 500;
      color: rgba(255, 255, 255, 0.7);
    }

    #enhancedCountdownTimer .timer-class-separator {
      opacity: 0.5;
    }

    #enhancedCountdownTimer .timer-class-time {
      font-size: 11px;
    }

    @keyframes scaleInFade {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    @keyframes slideInUpFade {
      from {
        opacity: 0;
        transform: translateY(25px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    /* END CLASS COUNTDOWN TIMER */
    /* Responsive adjustments */
    @media (max-width: 600px) {
      .floating-nav {
        bottom: 12px;
        right: 12px;
        padding: 8px 10px;
        gap: 6px;
      }
      .floating-nav .nav-btn {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }
      #classCountdownOverlay,
      #enhancedCountdownTimer {
        width: calc(100vw - 32px);
        max-width: 380px;
        max-height: 70vh;
      }
      #enhancedCountdownTimer .timer-class-group {
        font-size: 13px;
      }
      #enhancedCountdownTimer .timer-class-countdown {
        font-size: 12px;
      }
      #enhancedCountdownTimer .timer-class-details {
        font-size: 10px;
      }
    }

    /* Refresh animation */
    body.refreshing {
      animation: refreshPulse 0.8s ease;
    }

    @keyframes refreshPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.95; }
    }
    /* ========== END FLOATING NAV STYLES ========== */
  </style>
</head>
<body>
  <!-- ========== BEGIN FLOATING NAV HTML ========== -->
  <!-- Floating Navigation Bar -->
  <div id="floatingNav" class="floating-nav" style="display:none;">
    <button id="navTopBtn" class="nav-btn" title="Scroll to Top">↑</button>
    <button id="navUndoBtn" class="nav-btn" title="Undo">←</button>
    <button id="navRedoBtn" class="nav-btn" title="Redo">→</button>
    <button id="navRefreshBtn" class="nav-btn" title="Refresh">↻</button>
    <button id="navTimerBtn" class="nav-btn" title="Class Countdown Timer">◷</button>
    <button id="navQuickViewBtn" class="nav-btn" title="Quick View – Group Schedules">◈</button>
  </div>
  <!-- ========== END FLOATING NAV HTML ========== -->

  <!-- Payment Actions Popup Backdrop -->
  <div id="paymentActionsBackdrop" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); z-index: 9999; backdrop-filter: blur(6px);" onclick="closePaymentActionsPopup()"></div>
  
  <!-- Payment Actions Popup Modal -->
  <div id="paymentActionsPopup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%); border: 2px solid rgba(138,180,255,.3); border-radius: 16px; padding: 24px; min-width: 400px; max-width: 500px; max-height: 85vh; overflow-y: auto; backdrop-filter: blur(20px); box-shadow: 0 20px 60px rgba(0,0,0,0.8); z-index: 10000;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: -24px; background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%); padding: 0 0 12px 0; z-index: 1;">
      <h3 style="margin: 0; color: white; font-size: 18px; font-weight: 700;">Payment Actions</h3>
      <button onclick="closePaymentActionsPopup()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; opacity: 0.7; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
    </div>
    
    <div style="margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
      <div style="margin-bottom: 8px;"><strong style="color: white;">Payer:</strong> <span id="popupPayerName" style="color: #94a3b8;">—</span></div>
      <div style="margin-bottom: 8px;"><strong style="color: white;">Amount:</strong> <span id="popupPaymentAmount" style="color: #22c55e;">—</span></div>
      <div><strong style="color: white;">Message:</strong> <span id="popupPaymentMessage" style="color: #94a3b8;">—</span></div>
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 10px;">
      <button onclick="showCreateAliasForm()" style="width: 100%; padding: 14px; background: transparent; border: 2px solid #22c55e; border-radius: 12px; color: #22c55e; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(34,197,94,0.1)'" onmouseout="this.style.background='transparent'">
        Create Payer Alias
      </button>
      <button onclick="showChangeDateForm()" style="width: 100%; padding: 14px; background: transparent; border: 2px solid #3b82f6; border-radius: 12px; color: #3b82f6; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(59,130,246,0.1)'" onmouseout="this.style.background='transparent'">
        Change Email Date
      </button>
      <button onclick="deleteThisPayment()" style="width: 100%; padding: 14px; background: transparent; border: 2px solid #dc2626; border-radius: 12px; color: #dc2626; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(220,38,38,0.1)'" onmouseout="this.style.background='transparent'">
        🗑️ Delete This Payment
      </button>
      <button onclick="ignoreThisPayment()" style="width: 100%; padding: 14px; background: transparent; border: 2px solid #f59e0b; border-radius: 12px; color: #f59e0b; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(245,158,11,0.1)'" onmouseout="this.style.background='transparent'">
        Ignore This Payment
      </button>
      <button onclick="ignoreAllFromPayer()" style="width: 100%; padding: 14px; background: transparent; border: 2px solid #ef4444; border-radius: 12px; color: #ef4444; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(239,68,68,0.1)'" onmouseout="this.style.background='transparent'">
        Ignore All From Payer
      </button>
      <button onclick="linkPaymentToStudent()" style="width: 100%; padding: 14px; background: transparent; border: 2px solid #8b5cf6; border-radius: 12px; color: #8b5cf6; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(139,92,246,0.1)'" onmouseout="this.style.background='transparent'">
        👤 Link to Student
      </button>
    </div>
    
    <!-- Create Alias Form (hidden by default) -->
    <div id="createAliasForm" style="display: none; margin-top: 20px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
      <h4 style="margin: 0 0 12px 0; color: white; font-size: 14px;">Create Payer Alias</h4>
      <input type="text" id="aliasStudentName" placeholder="Student name..." style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; margin-bottom: 12px;" onkeydown="if(event.key==='Enter'){saveAlias();}">
      <div style="display: flex; gap: 8px;">
        <button onclick="saveAlias()" style="flex: 1; padding: 10px; background: #22c55e; border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">Save</button>
        <button onclick="hideCreateAliasForm()" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
      </div>
    </div>
    
    <!-- Change Date Form (hidden by default) -->
    <div id="changeDateForm" style="display: none; margin-top: 20px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
      <h4 style="margin: 0 0 12px 0; color: white; font-size: 14px;">Change Email Date</h4>
      <input type="date" id="newEmailDate" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; margin-bottom: 12px;" onkeydown="if(event.key==='Enter'){saveNewDate();}">
      <div style="display: flex; gap: 8px;">
        <button onclick="saveNewDate()" style="flex: 1; padding: 10px; background: #3b82f6; border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">Save</button>
        <button onclick="hideChangeDateForm()" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Full Sync Date Range Modal -->
  <div id="fullSyncModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(145deg, rgba(20, 20, 30, 0.98), rgba(30, 30, 45, 0.98)); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 32px; min-width: 500px; backdrop-filter: blur(20px); box-shadow: 0 20px 60px rgba(0,0,0,0.5); z-index: 10001;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h3 style="margin: 0; color: white; font-size: 20px; font-weight: 700;">Full Payment Sync</h3>
      <button onclick="closeFullSyncDatePicker()" style="background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; opacity: 0.9;">&times;</button>
    </div>
    
    <div style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(192, 57, 43, 0.05)); border-left: 4px solid #e74c3c; border-radius: 8px;">
      <div style="font-weight: 700; color: white; margin-bottom: 6px; font-size: 14px;">Complete Historical Sync</div>
      <div style="font-size: 13px; color: #94a3b8; line-height: 1.6;">
        Fetches ALL Zelle payment emails from your Gmail within the specified date range. All payments will be saved automatically to Supabase.
      </div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="display: block; font-weight: 600; color: white; margin-bottom: 8px; font-size: 14px;">From Date *</label>
      <input type="date" id="fullSyncFromDate" value="2024-07-01" style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 14px;">
    </div>
    
    <div style="margin-bottom: 24px;">
      <label style="display: block; font-weight: 600; color: white; margin-bottom: 8px; font-size: 14px;">To Date *</label>
      <input type="date" id="fullSyncToDate" style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 14px;">
    </div>
    
    <div style="display: flex; gap: 12px;">
      <button onclick="closeFullSyncDatePicker()" style="flex: 1; padding: 14px; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
      <button onclick="performFullSync()" style="flex: 2; padding: 14px; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer;">
        Start Full Sync
      </button>
    </div>
  </div>

  <!-- ============================== -->
  <!-- 🧱 STUDENT MANAGER MODULE -->
  <!-- ============================== -->
  <div id="studentManagerModal" onclick="closeStudentManagerOnOutsideClick(event)" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 20000; backdrop-filter: blur(4px);">
    <div onclick="event.stopPropagation()" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 1400px; max-height: 90vh; background: rgba(15,23,42,0.95); backdrop-filter: blur(24px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; overflow: hidden; box-shadow: 0 24px 80px rgba(0,0,0,0.8);">
      
      <!-- Header -->
      <div style="background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1); padding: 20px 24px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
          <h1 style="margin: 0; background: linear-gradient(135deg, #8ab4ff, #a855f7); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-size: 28px; font-weight: 900;">👩‍⚕️ Student Manager</h1>
          <div style="display: flex; gap: 12px; align-items: center;">
            <button onclick="openAddStudent()" style="padding: 10px 18px; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; border-radius: 10px; color: white; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);">
              + Add Student
            </button>
            <!-- BEGIN BULK ADD STUDENTS FEATURE -->
            <button onclick="openBulkAddStudents()" style="padding: 10px 18px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 10px; color: white; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
              📋 Bulk Add
            </button>
            <!-- END BULK ADD STUDENTS FEATURE -->
            <button onclick="openWaitingList()" style="padding: 10px 18px; background: rgba(168,85,247,.2); border: 2px solid #a855f7; color: #a855f7; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer;">
              Waiting List
            </button>
            <button onclick="findDuplicates()" style="padding: 10px 18px; background: rgba(251,146,60,.2); border: 2px solid #fb923c; color: #fb923c; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer;">
              Find Duplicates
            </button>
            <button onclick="syncWithCloud()" style="padding: 10px 18px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 14px; font-weight: 700; cursor: pointer;">
              ☁️ Sync Cloud
            </button>
            <button onclick="closeStudentManager()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); width: 36px; height: 36px; border-radius: 50%; color: white; font-size: 24px; cursor: pointer;">&times;</button>
          </div>
        </div>
        
        <!-- Filter Controls -->
        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
          <input type="text" id="studentSearchInput" placeholder="🔍 Search by name, group, phone, email, notes..." oninput="filterStudents()" style="flex: 1; min-width: 250px; padding: 10px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 14px;">
          
          <select id="filterGroup" onchange="filterStudents()" style="padding: 10px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 14px; font-weight: 600; min-width: 150px;">
            <option value="">All Groups</option>
            <option value="no-group">No Group</option>
          </select>
          
          <select id="filterStatus" onchange="filterStudents()" style="padding: 10px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 14px; font-weight: 600; min-width: 150px;">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="paused">Paused</option>
            <option value="graduated">Graduated</option>
          </select>
          
          <select id="filterPayment" onchange="filterStudents()" style="padding: 10px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 14px; font-weight: 600; min-width: 150px;">
            <option value="">All Payment Status</option>
            <option value="unpaid">Unpaid Classes</option>
          </select>
          
          <select id="sortPrice" onchange="filterStudents()" style="padding: 10px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 14px; font-weight: 600; min-width: 150px;">
            <option value="">Sort by Price</option>
            <option value="highest">Price: Highest First</option>
            <option value="lowest">Price: Lowest First</option>
          </select>
          
          <button onclick="clearFilters()" style="padding: 10px 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 14px; font-weight: 600; cursor: pointer;">
            Clear Filters
          </button>
        </div>
      </div>

      <!-- Students Grid -->
      <div id="studentGrid" style="padding: 24px; overflow-y: auto; max-height: calc(90vh - 200px); display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;"></div>
    </div>
  </div>

  <!-- Add/Edit Student Modal -->
  <div id="studentModal" onclick="if(event.target.id==='studentModal'){closeStudentModal();}" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 25000; backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 20px;">
    <div onclick="event.stopPropagation()" style="background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%); border: 2px solid rgba(138,180,255,.3); border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 id="modalTitle" style="margin: 0; font-size: 24px; color: var(--primary);">Add New Student</h2>
        <span onclick="closeStudentModal()" style="font-size: 28px; color: #6b7280; cursor: pointer; transition: all 0.2s;">&times;</span>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #f3f4f6; font-size: 14px;">Student Name *</label>
        <input type="text" id="studentName" placeholder="Enter full name" style="width: 100%; padding: 12px; background: rgba(255,255,255,.05); border: 2px solid rgba(255,255,255,.2); border-radius: 8px; color: #f3f4f6; font-size: 14px;" onkeydown="if(event.key==='Enter'){saveStudent();}">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #f3f4f6; font-size: 14px;">Group(s)</label>
        <div id="groupBtns" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
          <button class="group-select-btn" onclick="toggleGroup(this, 'A')" style="padding: 8px 16px; background: rgba(255,255,255,.05); color: #6b7280; border: 2px solid rgba(255,255,255,.2); border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 14px;">A</button>
          <button class="group-select-btn" onclick="toggleGroup(this, 'B')" style="padding: 8px 16px; background: rgba(255,255,255,.05); color: #6b7280; border: 2px solid rgba(255,255,255,.2); border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 14px;">B</button>
          <button class="group-select-btn" onclick="toggleGroup(this, 'C')" style="padding: 8px 16px; background: rgba(255,255,255,.05); color: #6b7280; border: 2px solid rgba(255,255,255,.2); border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 14px;">C</button>
          <button class="group-select-btn" onclick="toggleGroup(this, 'D')" style="padding: 8px 16px; background: rgba(255,255,255,.05); color: #6b7280; border: 2px solid rgba(255,255,255,.2); border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 14px;">D</button>
          <button class="group-select-btn" onclick="toggleGroup(this, 'E')" style="padding: 8px 16px; background: rgba(255,255,255,.05); color: #6b7280; border: 2px solid rgba(255,255,255,.2); border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 14px;">E</button>
          <button class="group-select-btn" onclick="toggleGroup(this, 'F')" style="padding: 8px 16px; background: rgba(255,255,255,.05); color: #6b7280; border: 2px solid rgba(255,255,255,.2); border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-size: 14px;">F</button>
        </div>
        <input type="text" id="customGroups" placeholder="Or enter custom groups (comma-separated, optional)" style="width: 100%; padding: 12px; background: rgba(255,255,255,.05); border: 2px solid rgba(255,255,255,.2); border-radius: 8px; color: #f3f4f6; font-size: 14px;" onkeydown="if(event.key==='Enter'){saveStudent();}">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #f3f4f6; font-size: 14px;">Pay Per Class</label>
        <input type="number" id="studentPay" placeholder="50" style="width: 100%; padding: 12px; background: rgba(255,255,255,.05); border: 2px solid rgba(255,255,255,.2); border-radius: 8px; color: #f3f4f6; font-size: 14px;" onkeydown="if(event.key==='Enter'){saveStudent();}">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #f3f4f6; font-size: 14px;">Phone</label>
        <input type="tel" id="studentPhone" placeholder="(555) 123-4567" style="width: 100%; padding: 12px; background: rgba(255,255,255,.05); border: 2px solid rgba(255,255,255,.2); border-radius: 8px; color: #f3f4f6; font-size: 14px;" onkeydown="if(event.key==='Enter'){saveStudent();}">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #f3f4f6; font-size: 14px;">Email</label>
        <input type="email" id="studentEmail" placeholder="student@example.com" style="width: 100%; padding: 12px; background: rgba(255,255,255,.05); border: 2px solid rgba(255,255,255,.2); border-radius: 8px; color: #f3f4f6; font-size: 14px;" onkeydown="if(event.key==='Enter'){saveStudent();}">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #f3f4f6; font-size: 14px;">Aliases (comma-separated)</label>
        <input type="text" id="studentAliases" placeholder="Nick, Nickname" style="width: 100%; padding: 12px; background: rgba(255,255,255,.05); border: 2px solid rgba(255,255,255,.2); border-radius: 8px; color: #f3f4f6; font-size: 14px;" onkeydown="if(event.key==='Enter'){saveStudent();}">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #f3f4f6; font-size: 14px;">Notes</label>
        <textarea id="studentNotes" placeholder="Additional notes..." style="width: 100%; min-height: 100px; padding: 12px; background: rgba(255,255,255,.05); border: 2px solid rgba(255,255,255,.2); border-radius: 8px; color: #f3f4f6; font-size: 14px; resize: vertical;"></textarea>
      </div>
      
      <div style="display: flex; gap: 12px; margin-top: 24px;">
        <button onclick="saveStudentFromModal()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);">Save Student</button>
        <button onclick="closeStudentModal()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- BEGIN BULK ADD STUDENTS FEATURE -->
  <!-- Bulk Add Students Modal -->
  <div id="bulkAddStudentsModal" onclick="if(event.target.id==='bulkAddStudentsModal'){closeBulkAddStudents();}" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 25000; backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 20px;">
    <div onclick="event.stopPropagation()" style="background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%); border: 2px solid rgba(59,130,246,0.4); border-radius: 18px; padding: 30px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.8);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; font-size: 24px; background: linear-gradient(135deg, #3b82f6, #2563eb); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900;">📋 Bulk Add Students — Paste or Type Below</h2>
        <span onclick="closeBulkAddStudents()" style="font-size: 28px; color: #6b7280; cursor: pointer; transition: color 0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='#6b7280'">&times;</span>
      </div>
      
      <div style="margin-bottom: 16px; padding: 12px; background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 8px; color: #94a3b8; font-size: 13px; line-height: 1.6;">
        <strong style="color: #3b82f6;">Flexible Format:</strong> One student per line — comma-separated or labeled<br>
        <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; color: #e5e7eb; font-size: 12px;">Name, Email, Phone, Group, $Amount</code><br>
        <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; color: #e5e7eb; font-size: 12px;">Name (Alias), Email, Phone, Group, $Amount</code>
      </div>
      
      <div style="margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 6px; color: #6b7280; font-size: 12px;">
        <strong style="color: #94a3b8;">Examples:</strong><br>
        <span style="font-family: monospace; color: #8ab4ff;">Hasmik Antonova (Level Up), Hasmik.Antonova@gmail.com, 909-555-4321, A, $100</span><br>
        <span style="font-family: monospace; color: #8ab4ff;">Varduni Nerseyan, Varduni1982@yahoo.com, (818)299-7867, E, $100</span>
      </div>
      
      <textarea 
        id="bulkStudentInput" 
        placeholder="Paste student records here (one per line)..." 
        style="width: 100%; min-height: 250px; padding: 14px; background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.15); border-radius: 10px; color: white; font-size: 13px; font-family: monospace; resize: vertical; line-height: 1.8;"
      ></textarea>
      
      <div id="bulkAddValidationMessage" style="margin-top: 12px; padding: 10px; border-radius: 8px; display: none;"></div>
      
      <div style="display: flex; gap: 12px; margin-top: 20px;">
        <button onclick="processBulkAddStudents()" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'">Add Students</button>
        <button onclick="closeBulkAddStudents()" style="flex: 1; padding: 14px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.12)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'">Cancel</button>
      </div>
    </div>
  </div>
  <!-- END BULK ADD STUDENTS FEATURE -->

  <!-- Waiting List Modal -->
  <div id="waitingListModal" onclick="if(event.target.id==='waitingListModal'){closeWaitingList();}" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 25000; backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 20px;">
    <div onclick="event.stopPropagation()" style="background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%); border: 2px solid rgba(138,180,255,.3); border-radius: 16px; padding: 30px; max-width: 1000px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; font-size: 24px; color: var(--primary);">Student Waiting List</h2>
        <span onclick="closeWaitingList()" style="font-size: 28px; color: #6b7280; cursor: pointer;">&times;</span>
      </div>
      <button onclick="openAddWaitingList()" style="margin-bottom: 20px; width: 100%; padding: 12px; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer;">
        + Add to Waiting List
      </button>
      <div id="waitingListContent" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;"></div>
    </div>
  </div>

  <!-- Add Waiting List Student Modal -->
  <div id="addWaitingListModal" onclick="if(event.target.id==='addWaitingListModal'){closeAddWaitingList();}" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 26000; backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 20px;">
    <div onclick="event.stopPropagation()" style="background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%); border: 2px solid rgba(138,180,255,.3); border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; font-size: 24px; color: var(--primary);">Add to Waiting List</h2>
        <span onclick="closeAddWaitingList()" style="font-size: 28px; color: #6b7280; cursor: pointer;">&times;</span>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #f3f4f6; font-size: 14px;">Full Name *</label>
        <input type="text" id="waitingListFullName" placeholder="Enter full name" style="width: 100%; padding: 12px; background: rgba(255,255,255,.05); border: 2px solid rgba(255,255,255,.2); border-radius: 8px; color: #f3f4f6; font-size: 14px;" onkeydown="if(event.key==='Enter'){saveWaitingListStudent();}">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #f3f4f6; font-size: 14px;">Email *</label>
        <input type="email" id="waitingListEmail" placeholder="Enter email address" style="width: 100%; padding: 12px; background: rgba(255,255,255,.05); border: 2px solid rgba(255,255,255,.2); border-radius: 8px; color: #f3f4f6; font-size: 14px;" onkeydown="if(event.key==='Enter'){saveWaitingListStudent();}">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #f3f4f6; font-size: 14px;">Phone Number *</label>
        <input type="tel" id="waitingListPhone" placeholder="Enter phone number" style="width: 100%; padding: 12px; background: rgba(255,255,255,.05); border: 2px solid rgba(255,255,255,.2); border-radius: 8px; color: #f3f4f6; font-size: 14px;" onkeydown="if(event.key==='Enter'){saveWaitingListStudent();}">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #f3f4f6; font-size: 14px;">Preferred Language</label>
        <input type="text" id="waitingListLanguage" placeholder="e.g., English, Spanish, Armenian" style="width: 100%; padding: 12px; background: rgba(255,255,255,.05); border: 2px solid rgba(255,255,255,.2); border-radius: 8px; color: #f3f4f6; font-size: 14px;" onkeydown="if(event.key==='Enter'){saveWaitingListStudent();}">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #f3f4f6; font-size: 14px;">Preferred Start Date</label>
        <input type="date" id="waitingListStartDate" style="width: 100%; padding: 12px; background: rgba(255,255,255,.05); border: 2px solid rgba(255,255,255,.2); border-radius: 8px; color: #f3f4f6; font-size: 14px;" onkeydown="if(event.key==='Enter'){saveWaitingListStudent();}">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #f3f4f6; font-size: 14px;">Notes</label>
        <textarea id="waitingListNotes" placeholder="Any additional information..." style="width: 100%; min-height: 100px; padding: 12px; background: rgba(255,255,255,.05); border: 2px solid rgba(255,255,255,.2); border-radius: 8px; color: #f3f4f6; font-size: 14px; resize: vertical;"></textarea>
      </div>
      
      <div style="display: flex; gap: 12px; margin-top: 24px;">
        <button onclick="saveWaitingListStudent()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer;">Add to List</button>
        <button onclick="closeAddWaitingList()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Duplicate Students Modal -->
  <div id="duplicatesModal" onclick="if(event.target.id==='duplicatesModal'){closeDuplicatesModal();}" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 25000; backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 20px;">
    <div onclick="event.stopPropagation()" style="background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%); border: 2px solid rgba(138,180,255,.3); border-radius: 16px; padding: 30px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; font-size: 24px; color: var(--primary);">Duplicate Students</h2>
        <span onclick="closeDuplicatesModal()" style="font-size: 28px; color: #6b7280; cursor: pointer;">&times;</span>
      </div>
      <div id="duplicatesContent"></div>
    </div>
  </div>

  <!-- Group Manager Modal -->
  <div id="groupManagerModal" onclick="closeGroupManagerOnOutsideClick(event)" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 20000; backdrop-filter: blur(4px);">
    <div onclick="event.stopPropagation()" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 1200px; max-height: 90vh; background: rgba(15,23,42,0.95); backdrop-filter: blur(24px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; overflow: hidden; box-shadow: 0 24px 80px rgba(0,0,0,0.8);">
      
      <!-- Header -->
      <div style="background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1); padding: 20px 24px; display: flex; align-items: center; justify-content: space-between;">
        <h1 style="margin: 0; background: linear-gradient(135deg, #8ab4ff, #a855f7); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-size: 28px; font-weight: 900;">📚 Group Manager</h1>
        <div style="display: flex; gap: 12px; align-items: center;">
          <!-- BEGIN QUICK VIEW BUTTON -->
          <button id="quickViewBtn" onclick="openQuickView()" style="padding: 10px 18px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 10px; color: white; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
            📅 Quick View
          </button>
          <!-- END QUICK VIEW BUTTON -->
          <button id="addGroupBtn" onclick="addNewGroup()" style="padding: 10px 18px; background: linear-gradient(135deg, #8ab4ff, #a855f7); border: none; border-radius: 10px; color: white; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(138, 180, 255, 0.3);">
            + Add Group
          </button>
          <button onclick="closeGroupManager()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); width: 36px; height: 36px; border-radius: 50%; color: white; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
      </div>

      <!-- Groups Grid -->
      <div id="groupGrid" style="padding: 24px; overflow-y: auto; max-height: calc(90vh - 90px); display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;"></div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" style="position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #8ab4ff, #a855f7); color: white; padding: 10px 16px; border-radius: 10px; font-weight: 700; box-shadow: 0 6px 16px rgba(0,0,0,0.3); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 30000;"></div>

  <!-- Countdown Panel -->
  <div id="countdownPanel" style="display: none; position: fixed; background: rgba(17,24,39,0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; padding: 12px 16px; font-size: 0.9rem; color: white; z-index: 25000; box-shadow: 0 8px 24px rgba(0,0,0,0.6);"></div>

  <!-- Custom Confirm Dialog -->
  <div id="customConfirmModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); z-index: 30000; backdrop-filter: blur(6px); align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%); border: 2px solid rgba(138,180,255,.3); border-radius: 16px; padding: 32px; max-width: 480px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.8); animation: modalSlideIn 0.2s ease-out;">
      <div style="text-align: center; margin-bottom: 24px;">
        <div id="confirmIcon" style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
        <h3 id="confirmTitle" style="margin: 0 0 12px 0; font-size: 20px; font-weight: 700; color: white;">Confirm Action</h3>
        <p id="confirmMessage" style="margin: 0; color: #94a3b8; font-size: 15px; line-height: 1.6; white-space: pre-line;"></p>
      </div>
      <div style="display: flex; gap: 12px;">
        <button id="confirmCancelBtn" style="flex: 1; padding: 14px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s;">
          Cancel
        </button>
        <button id="confirmOkBtn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);">
          Confirm
        </button>
      </div>
    </div>
  </div>

  <!-- Custom Alert Dialog -->
  <div id="customAlertModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); z-index: 30000; backdrop-filter: blur(6px); align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%); border: 2px solid rgba(138,180,255,.3); border-radius: 16px; padding: 32px; max-width: 420px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.8); animation: modalSlideIn 0.2s ease-out;">
      <div style="text-align: center; margin-bottom: 24px;">
        <div id="alertIcon" style="font-size: 48px; margin-bottom: 16px;">ℹ️</div>
        <h3 id="alertTitle" style="margin: 0 0 12px 0; font-size: 20px; font-weight: 700; color: white;">Notice</h3>
        <p id="alertMessage" style="margin: 0; color: #94a3b8; font-size: 15px; line-height: 1.6; white-space: pre-line;"></p>
      </div>
      <button id="alertOkBtn" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);">
        OK
      </button>
    </div>
  </div>

  <!-- Custom Prompt Dialog -->
  <div id="customPromptModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); z-index: 30000; backdrop-filter: blur(6px); align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%); border: 2px solid rgba(138,180,255,.3); border-radius: 16px; padding: 32px; max-width: 460px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.8); animation: modalSlideIn 0.2s ease-out;">
      <div style="margin-bottom: 24px;">
        <div style="text-align: center; font-size: 42px; margin-bottom: 16px;">✏️</div>
        <h3 id="promptTitle" style="margin: 0 0 12px 0; font-size: 20px; font-weight: 700; color: white; text-align: center;">Input Required</h3>
        <p id="promptMessage" style="margin: 0 0 16px 0; color: #94a3b8; font-size: 14px; line-height: 1.6; text-align: center; white-space: pre-line;"></p>
        <input type="text" id="promptInput" style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 15px; transition: all 0.2s;" placeholder="Enter value...">
      </div>
      <div style="display: flex; gap: 12px;">
        <button id="promptCancelBtn" style="flex: 1; padding: 14px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s;">
          Cancel
        </button>
        <button id="promptOkBtn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);">
          Submit
        </button>
      </div>
    </div>
  </div>

  <!-- BEGIN QUICK VIEW MODAL -->
  <div id="quickViewModal" onclick="if(event.target.id==='quickViewModal')closeQuickView()" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 21000; backdrop-filter: blur(6px); align-items: center; justify-content: center;">
    <div onclick="event.stopPropagation()" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 1100px; max-height: 80vh; background: rgba(15,23,42,0.98); backdrop-filter: blur(24px); border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; overflow: hidden; box-shadow: 0 24px 80px rgba(0,0,0,0.9); display: flex; flex-direction: column;">
      
      <!-- Header -->
      <div style="background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1); padding: 20px 24px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
        <h1 style="margin: 0; background: linear-gradient(135deg, #10b981, #059669); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-size: 26px; font-weight: 900;">📅 Quick View — Group Schedules</h1>
        <button onclick="closeQuickView()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); width: 36px; height: 36px; border-radius: 50%; color: white; font-size: 24px; cursor: pointer; flex-shrink: 0;">&times;</button>
      </div>

      <!-- Tabs -->
      <div style="background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.1); padding: 16px 24px; display: flex; gap: 12px; flex-shrink: 0;">
        <button id="tabByGroup" onclick="switchQuickViewTab('byGroup')" style="padding: 10px 20px; background: linear-gradient(135deg, #8ab4ff, #a855f7); border: none; border-radius: 10px; color: white; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(138, 180, 255, 0.3); transition: all 0.2s;">
          By Group
        </button>
        <button id="tabByWeekday" onclick="switchQuickViewTab('byWeekday')" style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: rgba(255,255,255,0.7); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
          By Weekday (LA)
        </button>
        <button id="tabByWeekdayYerevan" onclick="switchQuickViewTab('byWeekdayYerevan')" style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: rgba(255,255,255,0.7); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
          By Weekday (Yerevan)
        </button>
      </div>

      <!-- Content -->
      <div id="quickViewContent" style="padding: 24px; overflow-y: auto; flex: 1;"></div>
    </div>
  </div>
  <!-- END QUICK VIEW MODAL -->

  <!-- Hidden File Input for Backup Import -->
  <input type="file" id="backupFileInput" accept=".json" style="display: none;">

  <div class="container">
    <div class="header">
      <h1>
        Payment Records
      </h1>
      <select id="paymentFilterDropdown" class="filter-dropdown">
        <option value="all">All Payments</option>
        <option value="matched">Matched Only</option>
        <option value="unmatched">Unmatched Only</option>
        <option value="ignored">Ignored</option>
      </select>
      <div class="header-controls">
        <button id="fullSyncBtn" class="gmail-btn" onclick="openFullSyncDatePicker()" title="Full sync - choose date range to fetch all payments">
          <span id="fullSyncBtnText">Full Sync</span>
        </button>
        <button id="gmailBtn" class="gmail-btn" onclick="toggleGmailConnection()">
          <span id="gmailBtnText">Gmail</span>
        </button>
        <button id="autoRefreshToggle" class="control-btn" onclick="toggleAutoRefresh()" title="Toggle 30-second auto-refresh (currently OFF)" style="font-size: 11px; font-weight: 700;">
          30s
        </button>
        <button id="earningsForecastBtn" class="control-btn" onclick="openEarningsForecast()" title="Earning Forecast">
          $
        </button>
        <button id="syncBtn" class="control-btn" onclick="syncToCloud()" title="Sync to Supabase Cloud">
          ☁️
        </button>
        <button id="calendarBtn" class="control-btn" onclick="openSmartCalendar()" title="Smart Payment Calendar">
          📅
        </button>
        <div style="position: relative;">
          <button id="settingsBtn" class="control-btn" onclick="toggleSettingsMenu()" title="Settings">
            ⚙️
          </button>
          <div id="settingsMenu" style="display: none; position: absolute; top: 44px; right: 0; background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%); border: 2px solid rgba(138,180,255,.3); border-radius: 12px; min-width: 250px; backdrop-filter: blur(20px); box-shadow: 0 8px 32px rgba(0,0,0,0.6); z-index: 1000; overflow: hidden;">
            <div style="padding: 12px 18px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 11px; font-weight: 700; color: #8ab4ff; text-transform: uppercase; letter-spacing: 1px;">Navigation</div>
            <div onclick="openStudentManager()" style="padding: 14px 18px; cursor: pointer; color: white; font-size: 14px; font-weight: 600; transition: all 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05);" onmouseover="this.style.background='rgba(138,180,255,0.15)'" onmouseout="this.style.background='transparent'">
              👥 Student Manager
            </div>
            <div onclick="openGroupManager()" style="padding: 14px 18px; cursor: pointer; color: white; font-size: 14px; font-weight: 600; transition: all 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05);" onmouseover="this.style.background='rgba(168,85,247,0.15)'" onmouseout="this.style.background='transparent'">
              📅 Group Manager
            </div>
            
            <div style="padding: 12px 18px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 11px; font-weight: 700; color: #8ab4ff; text-transform: uppercase; letter-spacing: 1px; margin-top: 8px;">Data Management</div>
            <div onclick="exportFullBackup()" style="padding: 14px 18px; cursor: pointer; color: white; font-size: 14px; font-weight: 600; transition: all 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05);" onmouseover="this.style.background='rgba(34,197,94,0.15)'" onmouseout="this.style.background='transparent'">
              💾 Export Full Backup
            </div>
            <div onclick="triggerImportBackup()" style="padding: 14px 18px; cursor: pointer; color: white; font-size: 14px; font-weight: 600; transition: all 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05);" onmouseover="this.style.background='rgba(59,130,246,0.15)'" onmouseout="this.style.background='transparent'">
              📥 Restore From Backup
            </div>
            <div onclick="restoreLastAutoBackup()" style="padding: 14px 18px; cursor: pointer; color: white; font-size: 14px; font-weight: 600; transition: all 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05);" onmouseover="this.style.background='rgba(245,158,11,0.15)'" onmouseout="this.style.background='transparent'">
              ⏮️ Restore Last Auto Backup
            </div>
            <div onclick="restoreFromCloud()" style="padding: 14px 18px; cursor: pointer; color: white; font-size: 14px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='rgba(59,130,246,0.15)'" onmouseout="this.style.background='transparent'">
              ☁️ Reload from Supabase Cloud
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Month Total Stats -->
    <div class="month-total-section">
      <div class="month-total-header-row" onclick="toggleMonthTotals()" style="cursor: pointer;">
        <button type="button" class="month-total-toggle" id="monthTotalsToggle" title="Expand totals">
          <span id="monthTotalsToggleIcon">▾</span>
        </button>
      </div>
      <div class="month-total-values" id="monthTotalsData">
        <div class="month-total-content">
          <div class="month-total-item">
            <select id="monthSelector" class="month-selector" onchange="updateMonthTotals()" onclick="event.stopPropagation();">
              <!-- Will be populated dynamically -->
            </select>
          </div>
          <div class="month-total-stats">
            <div class="month-total-item">
              <div class="month-total-label">PAYMENTS:</div>
              <div class="month-total-value" id="monthTotalCount">0</div>
            </div>
            <div class="month-total-item">
              <div class="month-total-label">USD:</div>
              <div class="month-total-value" id="monthTotalUSD">0 $</div>
            </div>
            <div class="month-total-item">
              <div class="month-total-label">AMD:</div>
              <div class="month-total-value" style="color: #94a3b8;" id="monthTotalAMD">0 ֏</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="content" id="paymentEmailsContent">
      <!-- Payment records will be rendered here -->
    </div>
  </div>

  <!-- BEGIN EARNING FORECAST MODAL -->
  <div id="earningsForecastModal" onclick="if(event.target.id==='earningsForecastModal'){closeEarningsForecast();}" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 25000; backdrop-filter: blur(6px); opacity: 0; transition: opacity 0.25s ease;">
    <div onclick="event.stopPropagation()" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: linear-gradient(135deg, rgba(15,23,42,0.98) 0%, rgba(30,30,50,0.98) 100%); backdrop-filter: blur(24px); border: 2px solid rgba(138,180,255,.3); border-radius: 20px; padding: 32px; box-shadow: 0 24px 80px rgba(0,0,0,0.9);">
      
      <!-- Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0; background: linear-gradient(135deg, #a3ffda, #22c55e); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-size: 24px; font-weight: 900;">💰 Earning Forecast Overview</h2>
        <button onclick="closeEarningsForecast()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); width: 36px; height: 36px; border-radius: 50%; color: white; font-size: 24px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">&times;</button>
      </div>

      <!-- Content -->
      <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 24px;">
        
        <!-- Active Students Count - Clickable -->
        <div onclick="openStudentBreakdown()" style="margin-bottom: 20px; padding: 16px; background: rgba(138,180,255,0.1); border: 1px solid rgba(138,180,255,0.3); border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(138,180,255,0.2)'; this.style.borderColor='rgba(138,180,255,0.5)'" onmouseout="this.style.background='rgba(138,180,255,0.1)'; this.style.borderColor='rgba(138,180,255,0.3)'">
          <div style="font-size: 12px; font-weight: 700; color: #8ab4ff; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Active Students <span style="font-size: 10px; opacity: 0.7;">(click for details)</span></div>
          <div id="forecastActiveCount" style="font-size: 32px; font-weight: 900; color: white;">0</div>
        </div>

        <!-- Projected Earnings -->
        <div style="margin-bottom: 20px;">
          <div style="font-size: 14px; font-weight: 700; color: #a3ffda; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">📊 Projected Earnings</div>
          
          <div style="display: flex; gap: 12px; margin-bottom: 12px;">
            <div style="flex: 1; padding: 16px; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 12px;">
              <div style="font-size: 11px; font-weight: 700; color: #22c55e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Weekly</div>
              <div id="forecastWeekly" style="font-size: 24px; font-weight: 900; color: white;">0 $</div>
            </div>
            
            <div style="flex: 1; padding: 16px; background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.4); border-radius: 12px;">
              <div style="font-size: 11px; font-weight: 700; color: #22c55e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Monthly</div>
              <div id="forecastMonthly" style="font-size: 24px; font-weight: 900; color: white;">0 $</div>
            </div>
          </div>
        </div>

        <!-- Actual Earnings -->
        <div style="padding: 20px; background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(168,85,247,0.15)); border: 2px solid rgba(138,180,255,0.4); border-radius: 12px;">
          <div style="font-size: 14px; font-weight: 700; color: #8ab4ff; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">💵 Actual Received (This Month)</div>
          <div id="forecastActual" style="font-size: 32px; font-weight: 900; color: white;">0 $</div>
        </div>

        <!-- Footer Note -->
        <div style="margin-top: 20px; text-align: center; font-size: 11px; color: #94a3b8; font-style: italic;">
          Updates automatically as students or payments change
        </div>
      </div>
    </div>
  </div>
  <!-- END EARNING FORECAST MODAL -->

  <!-- BEGIN STUDENT BREAKDOWN MODAL -->
  <div id="studentBreakdownModal" onclick="if(event.target.id==='studentBreakdownModal'){closeStudentBreakdown();}" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 26000; backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.25s ease;">
    <div onclick="event.stopPropagation()" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 700px; max-height: 85vh; background: linear-gradient(135deg, rgba(15,23,42,0.98) 0%, rgba(30,30,50,0.98) 100%); backdrop-filter: blur(24px); border: 2px solid rgba(138,180,255,.3); border-radius: 20px; padding: 32px; box-shadow: 0 24px 80px rgba(0,0,0,0.9); overflow-y: auto;">
      
      <!-- Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; position: sticky; top: 0; background: linear-gradient(135deg, rgba(15,23,42,0.98) 0%, rgba(30,30,50,0.98) 100%); padding-bottom: 16px; z-index: 10;">
        <h2 style="margin: 0; background: linear-gradient(135deg, #8ab4ff, #a855f7); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-size: 22px; font-weight: 900;">👥 Student Earning Breakdown</h2>
        <button onclick="closeStudentBreakdown()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); width: 36px; height: 36px; border-radius: 50%; color: white; font-size: 24px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">&times;</button>
      </div>

      <!-- Student List -->
      <div id="studentBreakdownList" style="display: flex; flex-direction: column; gap: 12px;">
        <!-- Will be populated dynamically -->
      </div>

      <!-- Total Summary -->
      <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(22,163,74,0.15)); border: 2px solid rgba(34,197,94,0.4); border-radius: 12px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div style="font-size: 14px; font-weight: 700; color: #22c55e; text-transform: uppercase;">Total Weekly</div>
          <div id="breakdownTotalWeekly" style="font-size: 24px; font-weight: 900; color: white;">0 $</div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div style="font-size: 14px; font-weight: 700; color: #22c55e; text-transform: uppercase;">Total Monthly</div>
          <div id="breakdownTotalMonthly" style="font-size: 24px; font-weight: 900; color: white;">0 $</div>
        </div>
      </div>
    </div>
  </div>
  <!-- END STUDENT BREAKDOWN MODAL -->

  <!-- SMART CALENDAR PAYMENT SYSTEM -->
  <div id="smartCalendarModal" onclick="if(event.target.id==='smartCalendarModal'){closeSmartCalendar();}" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 27000; backdrop-filter: blur(10px); opacity: 0; transition: opacity 0.3s ease;">
    <div onclick="event.stopPropagation()" style="position: relative; margin: 2% auto; max-width: 1200px; max-height: 92vh; background: linear-gradient(135deg, rgba(30,30,46,0.98) 0%, rgba(42,42,62,0.98) 100%); border: 2px solid rgba(138,180,255,0.3); border-radius: 20px; backdrop-filter: blur(20px); box-shadow: 0 20px 60px rgba(0,0,0,0.6); overflow: hidden; display: flex; flex-direction: column;">
      
      <!-- Header -->
      <div style="padding: 24px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, rgba(138,180,255,0.1) 0%, rgba(168,85,247,0.1) 100%);">
        <div style="display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 28px;">📅</span>
          <div>
            <h2 style="margin: 0; font-size: 22px; font-weight: 900; color: white; letter-spacing: -0.5px;">Smart Payment Calendar</h2>
            <p style="margin: 4px 0 0 0; font-size: 12px; color: #94a3b8;">Track scheduled classes, payments, and balances</p>
          </div>
        </div>
        <button onclick="closeSmartCalendar()" style="width: 36px; height: 36px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(239,68,68,0.2)'; this.style.borderColor='rgba(239,68,68,0.4)';" onmouseout="this.style.background='rgba(255,255,255,0.05)'; this.style.borderColor='rgba(255,255,255,0.1)';">×</button>
      </div>

      <!-- Calendar Navigation -->
      <div style="padding: 20px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2);">
        <button onclick="changeCalendarMonth(-1)" style="padding: 10px 18px; background: rgba(138,180,255,0.1); border: 1px solid rgba(138,180,255,0.3); border-radius: 10px; color: white; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(138,180,255,0.2)'" onmouseout="this.style.background='rgba(138,180,255,0.1)'">
          ← Previous
        </button>
        <div style="text-align: center;">
          <div id="calendarMonthYear" style="font-size: 20px; font-weight: 900; color: white; letter-spacing: -0.5px;">December 2024</div>
          <div id="calendarSubtitle" style="font-size: 12px; color: #94a3b8; margin-top: 4px;">Loading schedule...</div>
        </div>
        <button onclick="changeCalendarMonth(1)" style="padding: 10px 18px; background: rgba(138,180,255,0.1); border: 1px solid rgba(138,180,255,0.3); border-radius: 10px; color: white; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(138,180,255,0.2)'" onmouseout="this.style.background='rgba(138,180,255,0.1)'">
          Next →
        </button>
      </div>

      <!-- Calendar Grid -->
      <div style="flex: 1; overflow-y: auto; padding: 24px 30px;">
        <!-- Day Headers -->
        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 12px;">
          <div style="text-align: center; font-size: 11px; font-weight: 700; color: #8ab4ff; text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 0;">Sun</div>
          <div style="text-align: center; font-size: 11px; font-weight: 700; color: #8ab4ff; text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 0;">Mon</div>
          <div style="text-align: center; font-size: 11px; font-weight: 700; color: #8ab4ff; text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 0;">Tue</div>
          <div style="text-align: center; font-size: 11px; font-weight: 700; color: #8ab4ff; text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 0;">Wed</div>
          <div style="text-align: center; font-size: 11px; font-weight: 700; color: #8ab4ff; text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 0;">Thu</div>
          <div style="text-align: center; font-size: 11px; font-weight: 700; color: #8ab4ff; text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 0;">Fri</div>
          <div style="text-align: center; font-size: 11px; font-weight: 700; color: #8ab4ff; text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 0;">Sat</div>
        </div>
        
        <!-- Calendar Cells -->
        <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; min-height: 400px;">
          <!-- Generated dynamically -->
        </div>
      </div>

      <!-- Legend -->
      <div style="padding: 20px 30px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); display: flex; gap: 24px; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="width: 12px; height: 12px; background: #22c55e; border-radius: 50%; display: inline-block;"></span>
          <span style="font-size: 12px; color: #94a3b8;">🟢 Paid</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="width: 12px; height: 12px; background: #eab308; border-radius: 50%; display: inline-block;"></span>
          <span style="font-size: 12px; color: #94a3b8;">🟡 Deposit Active</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="width: 12px; height: 12px; background: #ef4444; border-radius: 50%; display: inline-block;"></span>
          <span style="font-size: 12px; color: #94a3b8;">🔴 Unpaid</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="width: 12px; height: 12px; background: #64748b; border-radius: 50%; display: inline-block;"></span>
          <span style="font-size: 12px; color: #94a3b8;">⚪ Absent</span>
        </div>
      </div>

    </div>
  </div>
  <!-- END SMART CALENDAR -->

  <script>
    // ============================================================================
    // STORAGE & DATA MANAGEMENT
    // ============================================================================
    
    const STORAGE_KEYS = {
      PAYMENTS: 'firestone:payments:v3',
      GMAIL_TOKEN: 'firestone:gmail:token',
      GMAIL_EXPIRY: 'firestone:gmail:expiry',
      GMAIL_LAST_CHECK: 'firestone:gmail:last-check'
    };
    
    const UI_STATE_KEYS = {
      MONTH_TOTALS_COLLAPSED: 'firestone:payments:monthTotalsCollapsed'
    };
    
    let monthTotalsCollapsed = localStorage.getItem(UI_STATE_KEYS.MONTH_TOTALS_COLLAPSED) === 'true';
    
    // Timing constants
    const TIMING = {
      NEW_PAYMENT_INDICATOR: 60000,  // 60 seconds
      AUTO_REFRESH_INTERVAL: 30000,  // 30 seconds
      API_DELAY: 100,                // 100ms between API calls
      FULL_SYNC_API_DELAY: 50        // 50ms for full sync
    };
    
    let gmailAccessToken = localStorage.getItem(STORAGE_KEYS.GMAIL_TOKEN);
    let gmailTokenExpiry = localStorage.getItem(STORAGE_KEYS.GMAIL_EXPIRY);
    
    // ============================================================================
    // SUPABASE DATA OPERATIONS - Replace localStorage with cloud database
    // ============================================================================
    
    const PaymentStore = {
      getAll: function() {
        return window.paymentsCache || [];
      },
      fetchAll: async function() {
        try {
          const { data, error } = await supabase
            .from('payments')
            .select('*')
            .order('date', { ascending: false });
          
          if (error) {
            console.error('❌ Error loading payments from Supabase:', error);
            return window.paymentsCache || [];
          }
          
          window.paymentsCache = data || [];
          return window.paymentsCache;
        } catch (err) {
          console.error('❌ Exception loading payments:', err);
          return window.paymentsCache || [];
        }
      },
      save: async function(payments) {
        try {
          // For bulk save, we'll upsert all payments
          // Supabase upsert uses 'id' as conflict resolution by default
          const { data, error } = await supabase
            .from('payments')
            .upsert(payments, { onConflict: 'id' })
            .select();
          
          if (error) {
            console.error('❌ Error saving payments to Supabase:', error);
            return;
          }
          
          window.paymentsCache = data || payments;
          dispatchPaymentsUpdated(payments);
          
          // Auto-backup on every save
          try {
            const backupData = {
              timestamp: new Date().toISOString(),
              payments: payments,
              payment_count: payments.length,
              source: 'auto-save'
            };
            await createAutoBackup(backupData);
          } catch (error) {
            console.error('Auto-backup failed:', error);
          }
        } catch (err) {
          console.error('❌ Exception saving payments:', err);
        }
      }
    };
    
    // Supabase helper functions for individual operations
    async function addPayment(paymentData) {
      const { data, error } = await supabase
        .from('payments')
        .insert([paymentData])
        .select();
      
      if (error) {
        console.error('❌ Error adding payment:', error);
        return null;
      }
      
      return data[0];
    }
    
    async function updatePayment(id, updates) {
      const { data, error } = await supabase
        .from('payments')
        .update(updates)
        .eq('id', id)
        .select();
      
      if (error) {
        console.error('❌ Error updating payment:', error);
        return null;
      }
      
      return data[0];
    }
    
    async function deletePayment(id) {
      const { error } = await supabase
        .from('payments')
        .delete()
        .eq('id', id);
      
      if (error) {
        console.error('❌ Error deleting payment:', error);
        return false;
      }
      
      return true;
    }
    
    async function loadStudents() {
      const { data, error } = await supabase
        .from('students')
        .select('*')
        .order('name', { ascending: true });
      
      if (error) {
        console.error('❌ Error loading students:', error);
        return window.studentsCache || [];
      }
      
      window.studentsCache = data || [];
      return window.studentsCache;
    }
    
    async function saveStudent(studentData) {
      // Check if this is an update (has a numeric Supabase ID) or insert
      const isUpdate = studentData.id && typeof studentData.id === 'number';
      
      // Prepare payload - map local field names to Supabase columns
      const payload = {
        name: studentData.name,
        group_name: studentData.group || studentData.group_name || null,
        price_per_class: studentData.price_per_class ?? studentData.payPerClass ?? null
      };
      
      // Add optional fields only if they exist
      if (studentData.email) payload.email = studentData.email;
      if (studentData.phone) payload.phone = studentData.phone;
      if (studentData.notes) payload.notes = studentData.notes;
      
      // Handle aliases - convert array to comma-separated string if needed
      if (studentData.aliases) {
        payload.aliases = Array.isArray(studentData.aliases) 
          ? studentData.aliases.join(', ') 
          : studentData.aliases;
      }
      
      // CRITICAL: Never include 'id' in payload for INSERT
      // Only use it in UPDATE .eq() clause
      if (payload.id) {
        delete payload.id;
      }
      
      try {
        let result;
        
        if (isUpdate) {
          // Update existing record by numeric ID
          result = await supabase
            .from('students')
            .update(payload)
            .eq('id', studentData.id)
            .select();
        } else {
          // Insert new record - let Supabase generate ID
          console.log('📝 Inserting new student:', payload);
          result = await supabase
            .from('students')
            .insert([payload])
            .select();
        }
        
        const { data, error } = result;
        
        if (error) {
          console.error('❌ Error saving student:', error);
          console.error('Error details:', error.message, error.details, error.hint);
          console.error('Payload sent:', payload);
          return null;
        }
        
        console.log('✅ Student saved successfully:', data[0]);
        return data[0];
      } catch (err) {
        console.error('❌ Exception saving student:', err);
        return null;
      }
    }
    
    async function deleteStudentRecord(id) {
      try {
        const { error } = await supabase
          .from('students')
          .delete()
          .eq('id', id);
        
        if (error) {
          throw error;
        }
        
        console.log('✅ Student deleted from Supabase:', id);
        return true;
      } catch (error) {
        console.error('❌ Error deleting student:', error);
        return false;
      }
    }
    
    async function loadGroupsFromSupabase() {
      console.log('🔍 loadGroupsFromSupabase() called');
      const { data, error } = await supabase
        .from('groups')
        .select('*')
        .order('updated_at', { ascending: false });
      
      console.log('🔍 Supabase response - data:', data, 'error:', error);
      
      if (error) {
        console.error('❌ Error loading groups:', error);
        return window.groupsCache || [];
      }
      
      console.log('📊 Raw groups from Supabase:', data);
      
      // Map group_name back to name for app compatibility
      const mappedData = (data || []).map(group => ({
        id: group.id,
        name: group.group_name,
        schedule: group.schedule,
        color: group.color,
        created_at: group.created_at,
        updated_at: group.updated_at
      }));
      
      // De-duplicate by name, keeping the most recently updated/created row
      const deduped = [];
      const seen = new Set();
      const sorted = [...mappedData].sort((a, b) => {
        const aTime = new Date(a.updated_at || a.created_at || 0).getTime();
        const bTime = new Date(b.updated_at || b.created_at || 0).getTime();
        return bTime - aTime; // newest first
      });
      for (const g of sorted) {
        if (!g.name) continue;
        const key = String(g.name).trim().toUpperCase();
        if (!seen.has(key)) {
          deduped.push(g);
          seen.add(key);
        }
      }
      
      console.log('📊 Mapped groups:', mappedData);
      console.log('🧹 Deduped groups (by name):', deduped);
      
      window.groupsCache = deduped;
      return window.groupsCache;
    }
    
  async function saveGroup(groupData) {
      // Map 'name' to 'group_name' for Supabase
      const payload = {
        group_name: groupData.name || groupData.group_name,
        schedule: groupData.schedule,
        color: groupData.color
      };
      
      let data, error;
      
      if (groupData.id) {
        // UPDATE existing group - use eq() to match by id
        ({ data, error } = await supabase
          .from('groups')
          .update(payload)
          .eq('id', groupData.id)
          .select());
      } else {
        // INSERT new group - check if name exists first
        const { data: existing, error: checkError } = await supabase
          .from('groups')
          .select('id')
          .eq('group_name', payload.group_name)
          .maybeSingle();
        
        if (checkError) {
          console.error('Error checking for existing group:', checkError);
        }
        
        if (existing) {
          // Group with this name already exists, update it
          ({ data, error } = await supabase
            .from('groups')
            .update(payload)
            .eq('id', existing.id)
            .select());
        } else {
          // Insert new group
          ({ data, error } = await supabase
            .from('groups')
            .insert([payload])
            .select());
        }
      }
      
      if (error) {
        console.error('❌ Error saving group:', error);
        return null;
      }
      
      return data[0];
    }
    
    async function deleteGroupById(id) {
      const { error } = await supabase
        .from('groups')
        .delete()
        .eq('id', id);
      
      if (error) {
        console.error('❌ Error deleting group:', error);
        return false;
      }
      
      return true;
    }
    
    // ============================================================================
    // PAYMENT-STUDENT LINKING & ALIAS RESOLUTION SYSTEM
    // ============================================================================
    
    // Dispatch events for cross-module communication
    function dispatchPaymentsUpdated(payments) {
      window.dispatchEvent(new CustomEvent('payments:updated', {
        detail: { changed: payments.map(p => p.id) }
      }));
    }
    
    function dispatchStudentsUpdatedFromPayments() {
      window.dispatchEvent(new CustomEvent('students:updated', {
        detail: { source: 'payment-linking' }
      }));
    }
    
  // Server sync hook (placeholder for external integrations)
    async function syncWithServer({ paymentsChanged = [], studentsChanged = [] }) {
  // Future: Trigger GitHub automation or other webhooks
      console.log('📡 Sync with server:', { paymentsChanged, studentsChanged });
    }
    
    // Normalize string for alias matching
    function normalizeForMatching(str) {
      if (!str) return '';
      return String(str).toLowerCase().trim().replace(/\s+/g, ' ');
    }
    
    // Resolve payment to student using alias system
    function resolvePaymentToStudent(payment, studentCache) {
      const students = Array.isArray(studentCache) ? studentCache : loadStudents();
      
      // Priority 1: Manual link (check both linkedStudentId and studentId)
      const manualStudentId = payment.linkedStudentId || payment.studentId;
      if (manualStudentId && payment.manuallyLinked) {
        const student = students.find(s => s.id === manualStudentId);
        if (student) {
          return {
            studentId: student.id,
            studentName: student.name,
            studentEmail: student.email,
            studentGroup: student.group || student.groups || '',
            source: 'manual'
          };
        }
      }
      
      // Priority 2: Direct name match (NEW - AUTOMATIC MATCHING)
      const payerNorm = normalizeForMatching(payment.payerNameRaw || payment.payerName);
      const emailNorm = normalizeForMatching(payment.payerEmailRaw || payment.studentEmail);
      
      const directNameMatches = students.filter(student => 
        normalizeForMatching(student.name) === payerNorm
      );
      
      if (directNameMatches.length === 1) {
        return {
          studentId: directNameMatches[0].id,
          studentName: directNameMatches[0].name,
          studentEmail: directNameMatches[0].email,
          studentGroup: directNameMatches[0].group || directNameMatches[0].groups || '',
          source: 'direct'
        };
      } else if (directNameMatches.length > 1) {
        return {
          studentId: null,
          studentName: payment.payerNameRaw || payment.payerName || 'Unmatched',
          studentEmail: null,
          studentGroup: '',
          source: 'conflict',
          conflicts: directNameMatches
        };
      }
      
      // Priority 3: Alias or Email resolution
      const matches = [];
      
      students.forEach(student => {
        // Check aliases
        if (student.aliases && Array.isArray(student.aliases)) {
          const aliasMatch = student.aliases.some(alias => 
            normalizeForMatching(alias) === payerNorm
          );
          if (aliasMatch) {
            matches.push(student);
            return;
          }
        }
        
        // Check email match
        if (emailNorm && normalizeForMatching(student.email) === emailNorm) {
          matches.push(student);
          return;
        }
      });
      
      if (matches.length === 1) {
        return {
          studentId: matches[0].id,
          studentName: matches[0].name,
          studentEmail: matches[0].email,
          studentGroup: matches[0].group || matches[0].groups || '',
          source: 'alias'
        };
      } else if (matches.length > 1) {
        return {
          studentId: null,
          studentName: payment.payerNameRaw || payment.payerName || 'Unmatched',
          studentEmail: null,
          studentGroup: '',
          source: 'conflict',
          conflicts: matches
        };
      }
      
      // Priority 4: No match - unmatched
      return {
        studentId: null,
        studentName: payment.payerNameRaw || payment.payerName || 'Unmatched',
        studentEmail: payment.payerEmailRaw || null,
        studentGroup: '',
        source: 'none'
      };
    }
    
    // Recompute resolution for all payments
    function recomputePaymentResolutions() {
      const payments = PaymentStore.getAll();
      const students = loadStudents();
      let updated = false;
      
      payments.forEach(payment => {
        const resolution = resolvePaymentToStudent(payment, students);
        
        // Update derived fields
        const oldDerivedId = payment.derivedStudentId;
        const oldResolved = payment.resolvedStudentName;
        const oldGroup = payment.derivedStudentGroup;
        
        payment.derivedStudentId = resolution.studentId;
        payment.resolvedStudentName = resolution.studentName;
        payment.derivedStudentGroup = resolution.studentGroup;
        payment.resolutionSource = resolution.source;
        
        if (resolution.source === 'conflict') {
          payment.conflictCandidates = resolution.conflicts.map(s => s.id);
        } else {
          delete payment.conflictCandidates;
        }
        
        if (oldDerivedId !== payment.derivedStudentId || oldResolved !== payment.resolvedStudentName || oldGroup !== payment.derivedStudentGroup) {
          updated = true;
        }
      });
      
      if (updated) {
        PaymentStore.save(payments);
      }
    }
    
    // Show payment context menu
    function showPaymentContextMenu(event, paymentId) {
      try {
        event.preventDefault();
        event.stopPropagation();
        
        // Close any existing menus
        const existingMenu = document.getElementById('paymentContextMenu');
        if (existingMenu) existingMenu.remove();
        
        const payments = PaymentStore.getAll();
        const payment = payments.find(p => p.id === paymentId);
        if (!payment) {
          console.error('Payment not found:', paymentId);
          return;
        }
        
        const resolution = resolvePaymentToStudent(payment, loadStudents());
        
        const menu = document.createElement('div');
        menu.id = 'paymentContextMenu';
        menu.style.cssText = `
          position: fixed;
          left: ${event.clientX}px;
          top: ${event.clientY}px;
          background: rgba(15,20,35,0.98);
          border: 1px solid rgba(255,255,255,0.2);
          border-radius: 10px;
          box-shadow: 0 8px 24px rgba(0,0,0,0.8);
          backdrop-filter: blur(20px);
          z-index: 10000;
          min-width: 220px;
          padding: 6px;
          animation: slideDownFade 0.2s ease;
        `;
        
        const menuItems = [];
        
        // Link to Existing Student
        menuItems.push({
          icon: '🔗',
          label: 'Link to Existing Student',
          action: () => showLinkToStudentModal(paymentId)
        });
        
        // Add Alias (only if resolved to a student)
        if (resolution.studentId) {
          menuItems.push({
            icon: '📝',
            label: 'Add Alias to This Student',
            action: () => showAddAliasModal(paymentId, resolution.studentId)
          });
        }
        
        // Add New Student
        menuItems.push({
          icon: '➕',
          label: 'Add New Student',
          action: () => showAddNewStudentFromPayment(paymentId)
        });
        
        // Unlink Student (only if manually linked)
        if (payment.linkedStudentId) {
          menuItems.push({
            icon: '🔓',
            label: 'Unlink Student',
            action: () => unlinkPaymentFromStudent(paymentId)
          });
        }
        
        // Resolve Conflict (if multiple matches)
        if (resolution.source === 'conflict' && resolution.conflicts) {
          menuItems.push({
            icon: '⚠️',
            label: `Resolve Conflict (${resolution.conflicts.length} matches)`,
            action: () => showResolveConflictModal(paymentId, resolution.conflicts)
          });
        }
        
        // Store actions in window for onclick access
        window.paymentMenuActions = menuItems.map(item => item.action);
        
        menu.innerHTML = menuItems.map((item, idx) => `
          <div onclick="event.stopPropagation(); window.paymentMenuActions[${idx}](); document.getElementById('paymentContextMenu')?.remove();" style="
            padding: 10px 14px;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
          " onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
            <span style="font-size: 16px;">${item.icon}</span>
            <span>${item.label}</span>
          </div>
        `).join('');
        
        document.body.appendChild(menu);
        
        // Close menu on outside click
        setTimeout(() => {
          document.addEventListener('click', function closeMenu(e) {
            if (!menu.contains(e.target)) {
              menu.remove();
              document.removeEventListener('click', closeMenu);
            }
          });
        }, 100);
        
        // Adjust position if menu goes off screen
        const rect = menu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
          menu.style.left = (window.innerWidth - rect.width - 10) + 'px';
        }
        if (rect.bottom > window.innerHeight) {
          menu.style.top = (window.innerHeight - rect.height - 10) + 'px';
        }
      } catch (error) {
        console.error('Error showing payment context menu:', error);
        showNotification('❌ Error opening menu', 'error');
      }
    }
    
    // Link payment to existing student
    function showLinkToStudentModal(paymentId) {
      const modal = document.createElement('div');
      modal.id = 'linkStudentModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(8px);
        z-index: 11000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
      `;
      
      const students = loadStudents();
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: rgba(15,20,35,0.98);
        border: 2px solid rgba(59,130,246,0.4);
        border-radius: 16px;
        padding: 28px;
        max-width: 480px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0,0,0,0.8);
      `;
      
      modalContent.innerHTML = `
        <h3 style="margin: 0 0 20px 0; color: white; font-size: 20px; font-weight: 700;">
          🔗 Link to Existing Student
        </h3>
        
        <input type="text" id="studentSearchInput" placeholder="Search by name or email..." style="width: 100%; padding: 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-size: 14px; margin-bottom: 16px;">
        
        <div id="studentListContainer" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
          ${students.map(student => `
            <div class="student-select-item" data-student-id="${escapeHtml(student.id)}" data-payment-id="${escapeHtml(paymentId)}" style="padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;">
              <div style="color: white; font-weight: 600; margin-bottom: 4px;">${escapeHtml(student.name)}</div>
              <div style="color: #94a3b8; font-size: 12px;">${escapeHtml(student.email || '—')}</div>
              ${student.groups && student.groups.length > 0 ? `<div style="color: #3b82f6; font-size: 11px; margin-top: 4px;">Group: ${escapeHtml(student.groups.join(', '))}</div>` : ''}
            </div>
          `).join('')}
        </div>
        
        <button id="closeLinkModalBtn" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 14px; font-weight: 600; cursor: pointer;">
          Cancel
        </button>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // Add event listeners
      const searchInput = document.getElementById('studentSearchInput');
      if (searchInput) {
        searchInput.addEventListener('input', filterStudentList);
      }
      
      const studentItems = document.querySelectorAll('.student-select-item');
      studentItems.forEach(item => {
        item.addEventListener('click', function() {
          const studentId = this.getAttribute('data-student-id');
          const paymentId = this.getAttribute('data-payment-id');
          selectStudentForLink(paymentId, studentId);
        });
        
        item.addEventListener('mouseover', function() {
          this.style.background = 'rgba(59,130,246,0.15)';
          this.style.borderColor = 'rgba(59,130,246,0.4)';
        });
        
        item.addEventListener('mouseout', function() {
          this.style.background = 'rgba(255,255,255,0.05)';
          this.style.borderColor = 'rgba(255,255,255,0.1)';
        });
      });
      
      const closeBtn = document.getElementById('closeLinkModalBtn');
      if (closeBtn) {
        closeBtn.addEventListener('click', closeLinkStudentModal);
      }
      
      // Close on background click
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeLinkStudentModal();
        }
      });
    }
    
    // BEGIN LINKING & SEARCH FIX
    function closeLinkStudentModal() {
      const modal = document.getElementById('linkStudentModal');
      if (modal) {
        modal.style.opacity = '0';
        setTimeout(() => {
          modal.remove();
        }, 200);
      }
    }
    
    function filterStudentList() {
      const searchInput = document.getElementById('studentSearchInput');
      if (!searchInput) return;
      
      const searchTerm = searchInput.value.toLowerCase().trim();
      const studentItems = document.querySelectorAll('.student-select-item');
      
      let visibleCount = 0;
      
      studentItems.forEach(item => {
        // Get student name and email from the text content
        const textContent = item.textContent.toLowerCase();
        const matches = !searchTerm || textContent.includes(searchTerm);
        
        if (matches) {
          item.style.display = 'block';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });
      
      // Show "no results" message if nothing matches
      const container = document.getElementById('studentListContainer');
      if (container) {
        let noResultsMsg = container.querySelector('.no-results-message');
        
        if (visibleCount === 0 && searchTerm) {
          if (!noResultsMsg) {
            noResultsMsg = document.createElement('div');
            noResultsMsg.className = 'no-results-message';
            noResultsMsg.style.cssText = 'padding: 20px; text-align: center; color: #94a3b8; font-size: 14px;';
            noResultsMsg.textContent = 'No students match your search';
            container.appendChild(noResultsMsg);
          }
        } else if (noResultsMsg) {
          noResultsMsg.remove();
        }
      }
    }
    // END LINKING & SEARCH FIX
    
    // BEGIN LINKING & SEARCH FIX
    function selectStudentForLink(paymentId, studentId) {
      try {
        const payments = PaymentStore.getAll();
        const payment = payments.find(p => p.id === paymentId);
        
        if (!payment) {
          showNotification('❌ Payment not found', 'error');
          closeLinkStudentModal();
          return;
        }
        
        const students = loadStudents();
        const student = students.find(s => s.id === studentId);
        
        if (!student) {
          showNotification('❌ Student not found', 'error');
          closeLinkStudentModal();
          return;
        }
        
        // BEGIN CRITICAL BUG FIX - Payment ↔ Student Linking Logic
        // Update payment with manual link fields (resolver will compute derived fields)
        // - linkedStudentId: primary field for manual linking
        // - manuallyLinked: flag to activate manual resolution path
        // - resolutionSource: tracks how this link was created
        // - linkedAt: audit timestamp
        payment.linkedStudentId = studentId; // ✅ Primary manual link field
        payment.manuallyLinked = true;
        payment.linkedAt = new Date().toISOString();
        payment.resolutionSource = 'manual';
        
        // Recompute resolution to update derived fields
        const resolution = resolvePaymentToStudent(payment, students);
        payment.derivedStudentId = resolution.studentId;
        payment.resolvedStudentName = resolution.studentName;
        payment.derivedStudentGroup = resolution.studentGroup;
        // END CRITICAL BUG FIX
        
        // Remove any conflict markers
        delete payment.conflictCandidates;
        
        // Save to localStorage
        PaymentStore.save(payments);
        
        // Trigger update event
        window.dispatchEvent(new CustomEvent('payments:updated', {
          detail: { payments: [payment] }
        }));
        
        // Sync to server
        syncWithServer({ paymentsChanged: [payment] });
        
        showNotification('✅ Payment linked to student', 'success');
        renderPaymentEmailsView();
      } catch (error) {
        console.error('Error linking payment to student:', error);
        showNotification('❌ Failed to link payment', 'error');
      }
      
      closeLinkStudentModal();
    }
    // END LINKING & SEARCH FIX
    
    
    // Add alias to student
    async function showAddAliasModal(paymentId, studentId) {
      const payments = PaymentStore.getAll();
      const payment = payments.find(p => p.id === paymentId);
      const students = loadStudents();
      const student = students.find(s => s.id === studentId);
      
      if (!payment || !student) return;
      
      const payerName = payment.payerNameRaw || payment.payerName;
      
      const confirmed = await customConfirm(
        `Add alias "${payerName}" to ${student.name}?`,
        {
          title: 'Add Alias',
          icon: '🏷️',
          okText: 'Add Alias'
        }
      );
      
      if (confirmed) {
        if (!student.aliases) student.aliases = [];
        
        // Check if alias already exists (case-insensitive)
        const exists = student.aliases.some(a => normalizeForMatching(a) === normalizeForMatching(payerName));
        
        if (!exists) {
          student.aliases.push(payerName);
          saveStudents(students);
          syncWithServer({ studentsChanged: [student] });
          
          // Recompute all payment resolutions
          recomputePaymentResolutions();
          renderPaymentEmailsView();
          
          showNotification(`✅ Added alias "${payerName}" to ${student.name}`, 'success');
        } else {
          showNotification('⚠️ Alias already exists', 'warning');
        }
      }
    }
    
    // Add new student from payment
    function showAddNewStudentFromPayment(paymentId) {
      const payments = PaymentStore.getAll();
      const payment = payments.find(p => p.id === paymentId);
      if (!payment) return;
      
      const payerName = payment.payerNameRaw || payment.payerName || '';
      const payerEmail = payment.payerEmailRaw || payment.studentEmail || '';
      
      // Pre-fill add student form
      openStudentManager();
      
      setTimeout(() => {
        const nameInput = document.getElementById('studentName');
        const emailInput = document.getElementById('studentEmail');
        const notesInput = document.getElementById('studentNotes');
        
        if (nameInput) nameInput.value = payerName;
        if (emailInput) emailInput.value = payerEmail;
        if (notesInput) notesInput.value = `Created from payment ${payment.id} on ${new Date().toLocaleDateString()}`;
        
        // Store payment ID for linking after save
        window._linkPaymentAfterCreate = paymentId;
      }, 500);
    }
    
    // Unlink payment from student
    function unlinkPaymentFromStudent(paymentId) {
      const payments = PaymentStore.getAll();
      const payment = payments.find(p => p.id === paymentId);
      
      if (payment) {
        delete payment.linkedStudentId;
        
        // Re-resolve using aliases
        const resolution = resolvePaymentToStudent(payment);
        payment.resolvedStudentName = resolution.studentName;
        payment.resolutionSource = resolution.source;
        
        PaymentStore.save(payments);
        syncWithServer({ paymentsChanged: [payment] });
        
        showNotification('🔓 Student unlinked', 'success');
        renderPaymentEmailsView();
      }
    }
    
    // Resolve alias conflict
    function showResolveConflictModal(paymentId, conflicts) {
      showLinkToStudentModal(paymentId); // Reuse the link modal
    }
    
    // Listen for student updates to recompute aliases
    window.addEventListener('students:updated', function() {
      recomputePaymentResolutions();
      const modal = document.getElementById('groupManagerModal');
      if (!modal || modal.style.display !== 'block') {
        // Only re-render if not in group manager
        renderPaymentEmailsView();
      }
    });
    
    // ============================================================================
    
    // Utility functions
    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }
    
    function cleanPaymentMemoText(text) {
      if (!text) return '';
      return String(text)
        .replace(/[^\x20-\x7E\n\r\t]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    }
    
    function buildPaymentDuplicateKey(payment) {
      if (!payment) return null;
      const amount = parseFloat(payment.amount);
      const payer = (payment.payerName || payment.senderName || '').toLowerCase().trim();
      const dateSource = payment.emailDate || payment.date || payment.createdAt;
      const date = dateSource ? new Date(dateSource) : null;
      if (!payer || Number.isNaN(amount) || !date || Number.isNaN(date.getTime())) {
        return null;
      }
      const dateKey = date.toISOString().split('T')[0];
      return `${dateKey}|${amount.toFixed(2)}|${payer}`;
    }

    /**
     * Global Currency Formatter
     * Formats any numeric amount with comma thousand separators and currency symbol
     * @param {number|string} amount - The amount to format
     * @param {string} symbol - Currency symbol (default: '$')
     * @returns {string} Formatted currency string in "x,xxx $" format
     * @example
     *   formatCurrency(1000) → "1,000 $"
     *   formatCurrency(25000, '֏') → "25,000 ֏"
     *   formatCurrency(-1200) → "-1,200 $"
     */
    function formatCurrency(amount, symbol = '$') {
      const num = parseFloat(amount) || 0;
      const formatted = Math.abs(num).toLocaleString('en-US', { 
        minimumFractionDigits: 0, 
        maximumFractionDigits: 0 
      });
      const sign = num < 0 ? '-' : '';
      return `${sign}${formatted} ${symbol}`;
    }

    function formatDualCurrencyHTML(amountUSD, colorUSD = '#22c55e', colorAMD = '#94a3b8') {
      const usd = parseFloat(amountUSD) || 0;
      const amd = Math.round(usd * 387.5);
      return `<span class="amount-usd" style="color: ${colorUSD};">${formatCurrency(usd, '$')}</span> <span class="amount-amd" style="color: ${colorAMD};">— ${formatCurrency(amd, '֏')}</span>`;
    }

    function updateMonthTotalsVisibility() {
      const totalsContainer = document.getElementById('monthTotalsData');
      const toggleIcon = document.getElementById('monthTotalsToggleIcon');
      const toggleBtn = document.getElementById('monthTotalsToggle');
      
      if (!totalsContainer || !toggleIcon || !toggleBtn) return;
      
      if (monthTotalsCollapsed) {
        totalsContainer.classList.add('collapsed');
        toggleIcon.textContent = '▸';
        toggleBtn.title = 'Expand totals';
      } else {
        totalsContainer.classList.remove('collapsed');
        toggleIcon.textContent = '▾';
        toggleBtn.title = 'Collapse totals';
      }
    }

    function toggleMonthTotals() {
      monthTotalsCollapsed = !monthTotalsCollapsed;
      localStorage.setItem(UI_STATE_KEYS.MONTH_TOTALS_COLLAPSED, monthTotalsCollapsed.toString());
      updateMonthTotalsVisibility();
    }
    
    function updatePaymentProjectionStats(count, amount) {
      const countEl = document.getElementById('totalPaymentsCount');
      const amountEl = document.getElementById('totalPaymentsAmount');
      
      if (countEl) countEl.textContent = count;
      if (amountEl) amountEl.innerHTML = formatDualCurrencyHTML(amount);
    }
    
    function populateMonthSelector() {
      const paymentLog = PaymentStore.getAll();
      const selector = document.getElementById('monthSelector');
      if (!selector) return;
      
      // Get all unique months from payments
      const monthsSet = new Set();
      paymentLog.forEach(payment => {
        const emailDate = payment.emailDate || payment.transactionDate || payment.createdAt || payment.date;
        if (!emailDate) return;
        
        const paymentDate = new Date(emailDate);
        if (isNaN(paymentDate.getTime())) return;
        
        const monthKey = `${paymentDate.getFullYear()}-${String(paymentDate.getMonth()).padStart(2, '0')}`;
        monthsSet.add(monthKey);
      });
      
      // Convert to array and sort (newest first)
      const months = Array.from(monthsSet).sort().reverse();
      
      // Build options
      const now = new Date();
      const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth()).padStart(2, '0')}`;
      
      let html = '<option value="current">This Month</option>';
      
      months.forEach(monthKey => {
        if (monthKey === currentMonthKey) return; // Skip current month (already added)
        
        const [year, month] = monthKey.split('-');
        const date = new Date(parseInt(year), parseInt(month), 1);
        const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        html += `<option value="${monthKey}">${monthName}</option>`;
      });
      
      html += '<option value="ytd">Year to Date</option>';
      html += '<option value="all" selected>All Time</option>';
      
      selector.innerHTML = html;
    }
    
    function updateMonthTotals() {
      const paymentLog = PaymentStore.getAll();
      const selector = document.getElementById('monthSelector');
      const selectedPeriod = selector ? selector.value : 'current';
      
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      let periodCount = 0;
      let periodTotal = 0;
      
      paymentLog.forEach(payment => {
        const isIgnored = payment.ignoredOnce || payment.ignorePermanently;
        if (isIgnored) return;
        
        const emailDate = payment.emailDate || payment.transactionDate || payment.createdAt || payment.date;
        if (!emailDate) return;
        
        const paymentDate = new Date(emailDate);
        if (isNaN(paymentDate.getTime())) return;
        
        let includePayment = false;
        
        if (selectedPeriod === 'current') {
          // This month only
          includePayment = paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear;
        } else if (selectedPeriod === 'ytd') {
          // Year to date
          includePayment = paymentDate.getFullYear() === currentYear;
        } else if (selectedPeriod === 'all') {
          // All time
          includePayment = true;
        } else if (selectedPeriod.includes('-')) {
          // Specific month (format: YYYY-MM)
          const [targetYear, targetMonth] = selectedPeriod.split('-').map(Number);
          includePayment = paymentDate.getMonth() === targetMonth && paymentDate.getFullYear() === targetYear;
        }
        
        if (includePayment) {
          periodCount++;
          periodTotal += parseFloat(payment.amount) || 0;
        }
      });
      
      // Update display with null checks
      const countEl = document.getElementById('monthTotalCount');
      const usdEl = document.getElementById('monthTotalUSD');
      const amdEl = document.getElementById('monthTotalAMD');
      
      if (countEl) countEl.textContent = periodCount.toLocaleString('en-US');
      if (usdEl) usdEl.textContent = formatCurrency(periodTotal, '$');
      if (amdEl) amdEl.textContent = formatCurrency(Math.round(periodTotal * 387.5), '֏');

      updateMonthTotalsVisibility();
    }
    
    // Main render function
    function renderPaymentEmailsView() {
      if (paymentRenderRAF !== null) {
        cancelAnimationFrame(paymentRenderRAF);
      }
      paymentRenderRAF = requestAnimationFrame(() => {
        paymentRenderRAF = null;
        renderPaymentEmailsViewImmediate();
      });
    }

    function renderPaymentEmailsViewImmediate() {
      const renderToken = ++paymentRenderToken;
      const container = document.getElementById('paymentEmailsContent');
      if (!container) return;

      updateMonthTotalsVisibility();

      const paymentLog = PaymentStore.getAll();

      const filterDropdown = document.getElementById('paymentFilterDropdown');
      const filterValue = filterDropdown ? filterDropdown.value : 'all';

      let filteredPayments = paymentLog;
      if (filterValue === 'matched') {
        filteredPayments = paymentLog.filter(p => p.studentId && !p.ignoredOnce && !p.ignorePermanently);
      } else if (filterValue === 'unmatched') {
        filteredPayments = paymentLog.filter(p => !p.studentId && !p.ignoredOnce && !p.ignorePermanently);
      } else if (filterValue === 'ignored') {
        filteredPayments = paymentLog.filter(p => p.ignoredOnce || p.ignorePermanently);
      }

      if (filteredPayments.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">📧</div>
            <p>No ${filterValue === 'all' ? '' : filterValue + ' '}payment records found</p>
          </div>
        `;
        updatePaymentProjectionStats(0, 0);
        updateMonthTotals();
        return;
      }

      let totalCount = 0;
      let totalAmount = 0;
      filteredPayments.forEach(payment => {
        if (!payment.ignoredOnce && !payment.ignorePermanently) {
          totalCount += 1;
          totalAmount += parseFloat(payment.amount) || 0;
        }
      });

      updatePaymentProjectionStats(totalCount, totalAmount);
      updateMonthTotals();

      const paymentsByDate = {};
      filteredPayments.forEach(payment => {
        const emailDate = payment.emailDate || payment.transactionDate || payment.createdAt || payment.date;
        if (!emailDate) {
          return;
        }

        const date = new Date(emailDate);
        if (Number.isNaN(date.getTime())) {
          return;
        }

        const dateKey = date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        if (!paymentsByDate[dateKey]) {
          paymentsByDate[dateKey] = {
            date,
            payments: [],
            total: 0
          };
        }

        paymentsByDate[dateKey].payments.push(payment);

        if (!payment.ignoredOnce && !payment.ignorePermanently) {
          paymentsByDate[dateKey].total += parseFloat(payment.amount) || 0;
        }
      });

      const sortedDates = Object.keys(paymentsByDate).sort((a, b) => {
        return paymentsByDate[b].date - paymentsByDate[a].date;
      });

      if (sortedDates.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">📧</div>
            <p>No payments with valid timestamps found</p>
          </div>
        `;
        addClickToMarkPaymentsViewed();
        return;
      }

      // BEGIN PAYMENT RECORDS ORDER & HIGHLIGHT FIX
      // Sort payments within each date group - NEWEST FIRST
      Object.values(paymentsByDate).forEach(dateGroup => {
        dateGroup.payments.sort((a, b) => {
          // Primary: Use emailDate/transactionDate (actual payment timestamp)
          const dateA = new Date(a.emailDate || a.transactionDate || a.createdAt || 0);
          const dateB = new Date(b.emailDate || b.transactionDate || b.createdAt || 0);
          
          const timeDiff = dateB - dateA;
          if (timeDiff !== 0) return timeDiff;
          
          // Secondary: If timestamps identical, use createdAt
          const createdA = new Date(a.createdAt || 0);
          const createdB = new Date(b.createdAt || 0);
          return createdB - createdA;
        });
      });
      // END PAYMENT RECORDS ORDER & HIGHLIGHT FIX

      container.innerHTML = `
        <div class="loading-state" style="padding: 32px; text-align: center; color: #94a3b8;">
          Rendering payments…
        </div>
      `;

      const studentsCache = loadStudents();
      const resolutionCache = new Map();

      const getResolutionForPayment = (payment) => {
        const cacheKey = payment.id || `${payment.payerNameRaw || payment.payerName || ''}_${payment.amount || ''}_${payment.emailDate || payment.transactionDate || payment.createdAt || ''}`;
        if (resolutionCache.has(cacheKey)) {
          return resolutionCache.get(cacheKey);
        }
        const resolution = resolvePaymentToStudent(payment, studentsCache);
        resolutionCache.set(cacheKey, resolution);
        return resolution;
      };

      const DATE_CHUNK_SIZE = 2;
      let dateIndex = 0;

      const renderNextChunk = () => {
        if (renderToken !== paymentRenderToken) {
          return;
        }

        if (dateIndex === 0) {
          container.innerHTML = '';
        }

        const chunkDates = sortedDates.slice(dateIndex, dateIndex + DATE_CHUNK_SIZE);
        let chunkHtml = '';

        chunkDates.forEach(dateKey => {
          const dateData = paymentsByDate[dateKey];
          let rowsHtml = '';

          dateData.payments.forEach(payment => {
            const rawTimestamp = payment.emailDate || payment.transactionDate || payment.createdAt || '';
            let displayTime = '—';
            if (rawTimestamp) {
              const timestampDate = new Date(rawTimestamp);
              if (!Number.isNaN(timestampDate.getTime())) {
                displayTime = timestampDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
              }
            }

            const amountUSD = parseFloat(payment.amount) || 0;
            const resolution = getResolutionForPayment(payment);
            const groupDisplay = resolution.studentGroup || payment.derivedStudentGroup || payment.group || payment.studentGroup || '—';
            const payerNameRaw = payment.payerNameRaw || payment.payerName || '—';
            const studentNameResolved = resolution.studentName;
            const resolutionBadge = resolution.source === 'conflict' ? '<span style="background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.4); padding: 2px 5px; border-radius: 4px; color: #ef4444; font-size: 9px; font-weight: 700; margin-left: 4px; cursor: pointer;" onclick="event.stopPropagation(); showPaymentContextMenu(event, \'${payment.id}\')">CONFLICT</span>' : '';

            const messageText = cleanPaymentMemoText(payment.message || payment.note || payment.memo || '');
            const messageDisplay = messageText ? messageText : '—';
            const isIgnored = payment.ignoredOnce || payment.ignorePermanently;
            const rowOpacity = isIgnored ? 'opacity: 0.4;' : '';
            const isNew = payment.createdAt && (Date.now() - new Date(payment.createdAt).getTime()) < TIMING.NEW_PAYMENT_INDICATOR;
            const newIndicatorClass = isNew && !payment.viewed ? 'payment-row-new' : '';

            const amountAMD = Math.round(amountUSD * 387.5);
            
            rowsHtml += `
              <div class="${newIndicatorClass}" style="display: grid; grid-template-columns: 110px 200px 200px 80px 180px 1fr 40px; gap: 12px; padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; color: #e5e7eb; transition: background 0.2s; ${rowOpacity}" onmouseover="this.style.background='rgba(255,255,255,.03)'" onmouseout="this.style.background='transparent'">
                <div style="color: #94a3b8;">${displayTime}</div>
                <div 
                  ondblclick="showPaymentActionsPopup(event, '${payment.id}', '${escapeHtml(payerNameRaw).replace(/'/g, "\\'")}', ${amountUSD.toFixed(2)}, '${escapeHtml(messageText || '').replace(/'/g, "\\'")}', '${escapeHtml(studentNameResolved).replace(/'/g, "\\'")}', '${escapeHtml(resolution.studentId || '').replace(/'/g, "\\'")}');"
                  style="cursor: pointer; transition: 0.2s; color: white; font-weight: 400;"
                  onmouseover="this.style.color='var(--primary)'; this.style.fontWeight='700';"
                  onmouseout="this.style.color='white'; this.style.fontWeight='400';"
                  title="Double-click for actions"
                >${escapeHtml(payerNameRaw)}</div>
                <div style="font-weight: 600; color: white;">
                  ${!resolution.studentId && resolution.source === 'none' ? 'Unmatched' : 
                    resolution.studentId ? 
                    `<span 
                      onclick="event.stopPropagation(); openStudentEditFromPayment('${resolution.studentId}');" 
                      style="cursor: pointer; transition: 0.2s;"
                      onmouseover="this.style.color='var(--primary)'; this.style.textDecoration='underline';"
                      onmouseout="this.style.color='white'; this.style.textDecoration='none';"
                      title="Click to edit student"
                    >${escapeHtml(studentNameResolved)}${resolutionBadge}</span>` : 
                    escapeHtml(studentNameResolved)}
                  ${!resolution.studentId && resolution.source === 'none' ? '<div style="margin-top: 4px;"><span style="padding: 3px 8px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; color: #ef4444; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Unmatched</span></div>' : ''}
                </div>
                <div style="font-weight: 600; color: #3b82f6; text-align: center;">${escapeHtml(groupDisplay)}</div>
                <div><span style="color: #22c55e; font-weight: 700;">${formatCurrency(amountUSD, '$')}</span> <span style="color: #94a3b8; font-size: 12.7px;">— ${formatCurrency(amountAMD, '֏')}</span></div>
                <div style="color: var(--secondary); font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(messageDisplay)}">${escapeHtml(messageDisplay)}</div>
                <div 
                  onclick="event.stopPropagation(); showPaymentContextMenu(event, '${payment.id}')"
                  style="display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0.5; font-size: 18px; font-weight: bold; transition: opacity 0.2s;"
                  onmouseover="this.style.opacity='1'"
                  onmouseout="this.style.opacity='0.5'"
                  title="Open menu"
                >⋮</div>
              </div>
            `;
          });

          chunkHtml += `
            <div style="margin-bottom: 32px;">
              <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05)); border-left: 4px solid #3b82f6; border-radius: 8px; margin-bottom: 12px;">
                <span style="font-size: 16px; font-weight: 700; color: white;">${dateKey}</span>
                <span style="margin-left: auto; font-size: 14px; font-weight: 700; color: #e5e7eb;">
                  Total: <span style="color: #3b82f6; font-weight: 700;">${formatCurrency(dateData.total, '$')}</span> <span style="color: #94a3b8; font-size: 12.7px;">— ${formatCurrency(Math.round(dateData.total * 387.5), '֏')}</span>
                </span>
              </div>
              <div style="background: transparent; border: 1px solid rgba(255,255,255,0.1); border-radius: 18px; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); box-shadow: 0 8px 28px rgba(0,0,0,0.35); overflow: hidden; transition: 0.25s ease-in-out;" onmouseover="this.style.borderColor='rgba(255,255,255,0.25)';" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';">
                <div style="display: grid; grid-template-columns: 110px 200px 200px 80px 180px 1fr 40px; gap: 12px; padding: 12px 16px; background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 12px; font-weight: 700; color: #94a3b8;">
                  <div>DATE</div>
                  <div>PAYER NAME</div>
                  <div>STUDENT NAME</div>
                  <div style="text-align:center;">GROUP</div>
                  <div>AMOUNT (USD — AMD)</div>
                  <div>MESSAGE</div>
                  <div style="text-align: center;">⋮</div>
                </div>
                ${rowsHtml}
              </div>
            </div>
          `;
        });

        if (chunkHtml) {
          container.insertAdjacentHTML('beforeend', chunkHtml);
        }

        dateIndex += DATE_CHUNK_SIZE;

        if (dateIndex < sortedDates.length) {
          requestAnimationFrame(renderNextChunk);
        } else {
          addClickToMarkPaymentsViewed();
        }
      };

      requestAnimationFrame(renderNextChunk);
    }
    
    function addClickToMarkPaymentsViewed() {
      // BEGIN PAYMENT RECORDS ORDER & HIGHLIGHT FIX
      // Remove any existing listener first
      const container = document.getElementById('paymentRecordsContainer');
      const oldListener = container?._clickListener;
      if (oldListener) {
        container.removeEventListener('click', oldListener);
      }
      
      // Add new listener - click ANYWHERE in the payment records container
      const markAllPaymentsAsViewed = function() {
        const newPaymentRows = document.querySelectorAll('.payment-row-new');
        if (newPaymentRows.length === 0) return;
        
        // Mark all payments as viewed
        const payments = PaymentStore.getAll();
        let hasChanges = false;
        
        payments.forEach(payment => {
          if (!payment.viewed && payment.createdAt && (Date.now() - new Date(payment.createdAt).getTime()) < TIMING.NEW_PAYMENT_INDICATOR) {
            payment.viewed = true;
            hasChanges = true;
          }
        });
        
        if (hasChanges) {
          PaymentStore.save(payments);
          
          // Remove animation class immediately
          newPaymentRows.forEach(row => {
            row.classList.remove('payment-row-new');
            row.style.animation = 'none';
            row.style.boxShadow = 'none';
          });
          
          // Remove this listener after first acknowledgment
          if (container) {
            container.removeEventListener('click', markAllPaymentsAsViewed);
            container._clickListener = null;
          }
        }
      };
      
      // Store reference and attach to container
      if (container) {
        container._clickListener = markAllPaymentsAsViewed;
        container.addEventListener('click', markAllPaymentsAsViewed, { once: false });
      }
      // END PAYMENT RECORDS ORDER & HIGHLIGHT FIX
    }
    
    // Legacy function for compatibility
    function markAllPaymentsAsViewed() {
      const newPaymentRows = document.querySelectorAll('.payment-row-new');
      if (newPaymentRows.length === 0) return;
      
      const payments = PaymentStore.getAll();
      let hasChanges = false;
      
      payments.forEach(payment => {
        if (!payment.viewed && payment.createdAt && (Date.now() - new Date(payment.createdAt).getTime()) < TIMING.NEW_PAYMENT_INDICATOR) {
          payment.viewed = true;
          hasChanges = true;
        }
      });
      
      if (hasChanges) {
        PaymentStore.save(payments);
        newPaymentRows.forEach(row => {
          row.classList.remove('payment-row-new');
          row.style.animation = 'none';
          row.style.boxShadow = 'none';
        });
      }
    }
    
    // ============================================================================
    // GMAIL INTEGRATION
    // ============================================================================
    
    const GMAIL_CLIENT_ID = '67231383915-4kpdv0k6u517admvhl7lejku7qtbsjj.apps.googleusercontent.com';
    const GMAIL_SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';
    
    // BEGIN PAYMENT RECORDS ORDER & HIGHLIGHT FIX
    // Gmail connection stability - check and refresh token automatically
    async function ensureGmailTokenValid() {
      if (!gmailAccessToken) return false;
      
      // Check if token is about to expire (within 5 minutes)
      const expiry = parseInt(gmailTokenExpiry || '0');
      const now = Date.now();
      const fiveMinutes = 5 * 60 * 1000;
      
      if (expiry && (expiry - now) < fiveMinutes) {
        console.log('Gmail token expiring soon, attempting silent refresh...');
        
        // Token expired or expiring - need to re-authenticate
        // Note: Google OAuth2 implicit flow doesn't support refresh tokens
        // User must re-authenticate when token expires
        gmailAccessToken = null;
        localStorage.removeItem(STORAGE_KEYS.GMAIL_TOKEN);
        localStorage.removeItem(STORAGE_KEYS.GMAIL_EXPIRY);
        updateGmailButtonState(false);
        
        showNotification('⚠️ Gmail connection expired. Please reconnect.', 'warning');
        return false;
      }
      
      return true;
    }
    
    // Auto-check token validity every 2 minutes
    setInterval(async () => {
      if (gmailAccessToken) {
        await ensureGmailTokenValid();
      }
    }, 2 * 60 * 1000);
    // END PAYMENT RECORDS ORDER & HIGHLIGHT FIX
    
    async function toggleGmailConnection() {
      if (gmailAccessToken) {
        // Disconnect
        const confirmed = await customConfirm(
          'Disconnect Gmail? This will stop automatic payment email checking.',
          {
            title: 'Disconnect Gmail',
            icon: '🔌',
            okText: 'Disconnect',
            type: 'danger'
          }
        );
        
        if (confirmed) {
          localStorage.removeItem(STORAGE_KEYS.GMAIL_TOKEN);
          localStorage.removeItem(STORAGE_KEYS.GMAIL_EXPIRY);
          gmailAccessToken = null;
          updateGmailButtonState(false);
          showNotification('Gmail disconnected', 'info');
        }
      } else {
        // Connect
        initiateGmailAuth();
      }
    }
    
    function initiateGmailAuth() {
      const redirectUri = 'https://www.richyfesta.com';
      // BEGIN PAYMENT RECORDS ORDER & HIGHLIGHT FIX
      // Request offline access for longer-lived tokens (implicit flow limitation: token still expires in ~1 hour)
      // Note: For truly persistent auth, backend OAuth2 flow with refresh tokens is required
      const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
        `client_id=${GMAIL_CLIENT_ID}&` +
        `redirect_uri=${encodeURIComponent(redirectUri)}&` +
        `response_type=token&` +
        `scope=${encodeURIComponent(GMAIL_SCOPES)}&` +
        `prompt=consent`; // Force consent screen to get maximum token lifetime
      // END PAYMENT RECORDS ORDER & HIGHLIGHT FIX
      
      console.log('🔐 Initiating Gmail OAuth with redirect URI:', redirectUri);
      console.log('📋 Full auth URL:', authUrl);
      window.location.href = authUrl;
    }
    
    function handleOAuthCallback() {
      const hash = window.location.hash;
      if (hash && hash.includes('access_token')) {
        const params = new URLSearchParams(hash.substring(1));
        const token = params.get('access_token');
        const expiresIn = parseInt(params.get('expires_in') || '3600');
        
        if (token) {
          gmailAccessToken = token;
          const expiry = Date.now() + (expiresIn * 1000);
          localStorage.setItem(STORAGE_KEYS.GMAIL_TOKEN, token);
          localStorage.setItem(STORAGE_KEYS.GMAIL_EXPIRY, expiry.toString());
          gmailTokenExpiry = expiry.toString();
          
          updateGmailButtonState(true);
          showNotification('✅ Gmail connected successfully!', 'success');
          
          // Clear hash from URL
          window.history.replaceState(null, '', window.location.pathname);
          
          // Auto-fetch payments
          setTimeout(() => refreshPayments(), 1000);
        }
      }
    }
    
    function updateGmailButtonState(connected) {
      const btn = document.getElementById('gmailBtn');
      const text = document.getElementById('gmailBtnText');
      if (!btn || !text) {
        console.error('Gmail button elements not found');
        return;
      }
      
      if (connected) {
        btn.classList.add('connected');
        text.textContent = 'Gmail';
      } else {
        btn.classList.remove('connected');
        text.textContent = 'Gmail';
      }
    }
    
    async function refreshPayments() {
      // BEGIN PAYMENT RECORDS ORDER & HIGHLIGHT FIX
      // Check token validity before attempting sync
      const isValid = await ensureGmailTokenValid();
      if (!isValid || !gmailAccessToken) {
        showNotification('⚠️ Please connect Gmail first', 'warning');
        return;
      }
      // END PAYMENT RECORDS ORDER & HIGHLIGHT FIX
      
      const btn = document.getElementById('refreshBtn');
      if (!btn) {
        console.error('refreshBtn element not found');
        return;
      }
      btn.classList.add('spinning');
      btn.disabled = true;
      
      try {
        showNotification('🔍 Checking for new payment emails...', 'info');
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const afterDate = Math.floor(today.getTime() / 1000);
        
        const query = `from:usbank@notifications.usbank.com subject:Zelle after:${afterDate}`;
        const searchUrl = `https://gmail.googleapis.com/gmail/v1/users/me/messages?q=${encodeURIComponent(query)}&maxResults=100`;
        
        const searchResponse = await fetch(searchUrl, {
          headers: { 'Authorization': `Bearer ${gmailAccessToken}` }
        });
        
        if (!searchResponse.ok) {
          if (searchResponse.status === 401) {
            localStorage.removeItem(STORAGE_KEYS.GMAIL_TOKEN);
            localStorage.removeItem(STORAGE_KEYS.GMAIL_EXPIRY);
            gmailAccessToken = null;
            updateGmailButtonState(false);
            showNotification('🔒 Gmail session expired. Please reconnect.', 'error');
            return;
          }
          throw new Error(`Gmail API error: ${searchResponse.status}`);
        }
        
        const searchData = await searchResponse.json();
        
        if (!searchData.messages || searchData.messages.length === 0) {
          showNotification('📭 No new payment emails found', 'info');
          return;
        }
        
        console.log(`✅ Found ${searchData.messages.length} payment emails`);
        
        const existingPayments = PaymentStore.getAll();
        const existingEmailIds = new Set();
        const existingCompositeKeys = new Set();
        existingPayments.forEach(existingPayment => {
          const idsToTrack = [existingPayment.emailId, existingPayment.gmailId].filter(Boolean);
          idsToTrack.forEach(id => existingEmailIds.add(id));
          const compositeKey = buildPaymentDuplicateKey(existingPayment);
          if (compositeKey) existingCompositeKeys.add(compositeKey);
        });
        
        const payments = [];
        
        for (const message of searchData.messages) {
          const messageUrl = `https://gmail.googleapis.com/gmail/v1/users/me/messages/${message.id}`;
          const messageResponse = await fetch(messageUrl, {
            headers: { 'Authorization': `Bearer ${gmailAccessToken}` }
          });
          
          if (messageResponse.ok) {
            const messageData = await messageResponse.json();
            const payment = parseZelleEmail(messageData);
            if (payment) {
              const idsToCheck = [payment.emailId, payment.gmailId].filter(Boolean);
              const isExistingId = idsToCheck.some(id => existingEmailIds.has(id));
              if (isExistingId) {
                continue;
              }
              const compositeKey = buildPaymentDuplicateKey(payment);
              if (compositeKey && existingCompositeKeys.has(compositeKey)) {
                continue;
              }
              idsToCheck.forEach(id => existingEmailIds.add(id));
              if (compositeKey) existingCompositeKeys.add(compositeKey);
              payments.push(payment);
            }
          }
          
          await new Promise(resolve => setTimeout(resolve, TIMING.API_DELAY));
        }
        
        if (payments.length > 0) {
          // Save new payments at the beginning (so newest are first)
          const allPayments = [...payments, ...existingPayments];
          PaymentStore.save(allPayments);
          
          // Recompute resolutions to populate group information
          recomputePaymentResolutions();
          
          // Data automatically synced to Supabase via PaymentStore.save()
          console.log('✅ Payments auto-saved to Supabase cloud');
          
          showNotification(`✅ Added ${payments.length} new payment${payments.length > 1 ? 's' : ''}!`, 'success');
          renderPaymentEmailsView();
        } else {
          showNotification('✅ All payments already synced', 'success');
        }
        
      } catch (error) {
        console.error('Error refreshing payments:', error);
        showNotification('❌ Error: ' + error.message, 'error');
      } finally {
        btn.classList.remove('spinning');
        btn.disabled = false;
      }
    }
    
    function parseZelleEmail(messageData) {
      try {
        const headers = messageData.payload.headers;
        const dateHeader = headers.find(h => h.name === 'Date');
        const emailDate = dateHeader ? new Date(dateHeader.value) : new Date();
        
        let bodyText = '';
        if (messageData.payload.body && messageData.payload.body.data) {
          bodyText = atob(messageData.payload.body.data.replace(/-/g, '+').replace(/_/g, '/'));
        } else if (messageData.payload.parts) {
          const textPart = messageData.payload.parts.find(p => p.mimeType === 'text/plain');
          if (textPart && textPart.body && textPart.body.data) {
            bodyText = atob(textPart.body.data.replace(/-/g, '+').replace(/_/g, '/'));
          }
        }
        
        // Clean up body text - remove extra whitespace and normalize
        bodyText = bodyText.replace(/\r\n/g, '\n').replace(/\s+/g, ' ').trim();
        
        // Extract amount: "A new payment of $50.00 from..."
        const amountMatch = bodyText.match(/(?:payment of|received)\s*\$?([\d,]+\.\d{2})/i);
        const amount = amountMatch ? parseFloat(amountMatch[1].replace(/,/g, '')) : 0;
        
        // Extract payer name: "from Zg Consulting, I.Nc. was deposited"
        const payerMatch = bodyText.match(/from\s+([^.]+?)\s+was deposited/i);
        const payerName = payerMatch ? payerMatch[1].trim() : 'Unknown';
        
        // Use actual email timestamp (when notification was received)
        // Don't use "Received date" from email body as it's often the processing date, not actual receipt time
        let receivedDate = emailDate; // Always use the actual email timestamp with correct time
        
        // Extract message/student name: "Message from Zg Consulting, I.Nc.: Gayane Zadourian"
        const messageMatch = bodyText.match(/Message from[^:]+:\s*([^\n.]+?)(?:\s*\.{3}|\s*The money|\s*$)/i);
        const studentMessage = messageMatch ? messageMatch[1].trim() : '';
        
        if (!amount) return null;
        
        // Try to match student from Student Manager
        const students = loadStudents();
        let matchedStudent = null;
        let studentEmail = '';
        let groupId = '';
        
        if (studentMessage) {
          // Try exact name match first
          matchedStudent = students.find(s => 
            s.name.toLowerCase() === studentMessage.toLowerCase()
          );
          
          // Try partial match if exact fails
          if (!matchedStudent) {
            matchedStudent = students.find(s => 
              s.name.toLowerCase().includes(studentMessage.toLowerCase()) ||
              studentMessage.toLowerCase().includes(s.name.toLowerCase())
            );
          }
          
          if (matchedStudent) {
            studentEmail = matchedStudent.email || '';
            groupId = matchedStudent.groupId || '';
          }
        }
        
        // Use student name as payer name (student name takes priority)
        const finalPayerName = studentMessage || payerName || 'Unknown';
        const finalStudentName = matchedStudent ? matchedStudent.name : (studentMessage || 'Unmatched');
        
        // BEGIN CRITICAL BUG FIX - parseZelleEmail() resolutionSource
        // Create payment with raw data preserved
        const payment = {
          id: `payment-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
          emailId: messageData.id.substring(0, 16),
          gmailId: messageData.id,
          amount,
          
          // Raw immutable data from email
          payerNameRaw: payerName,  // EXACT from email "from Zg Consulting..."
          payerEmailRaw: null,       // No email in Zelle notification
          
          // Legacy fields (kept for compatibility)
          payerName: finalPayerName,
          senderName: finalPayerName,
          studentName: finalStudentName,
          studentEmail: studentEmail,
          groupId: groupId,
          memo: studentMessage,
          message: studentMessage,
          
          // Linking fields - Don't set linkedStudentId for memo matches
          // This allows the proper automatic resolution system to handle it
          linkedStudentId: null,  // Let resolver handle automatic matching
          derivedStudentId: matchedStudent ? matchedStudent.id : null,
          resolvedStudentName: finalStudentName,
          resolutionSource: matchedStudent ? 'memo-match' : 'none',  // ✅ Fixed: 'memo-match' not 'manual'
          
          emailDate: receivedDate.toISOString(),
          date: receivedDate.toISOString(),
          createdAt: new Date().toISOString(),
          status: matchedStudent ? 'unapplied' : 'unmatched',
          isMatched: !!matchedStudent
        };
        // END CRITICAL BUG FIX
        
        return payment;
      } catch (error) {
        console.error('Error parsing Zelle email:', error);
        return null;
      }
    }
    
    // ============================================================================
    // ============================================================================
    // CLOUD SYNC (AUTOMATIC VIA SUPABASE)
    // ============================================================================
    
    // Supabase automatically syncs all data changes - no manual sync needed!
    // PaymentStore.save() now directly writes to Supabase cloud database
    
    async function syncToCloud() {
      // This function is kept for UI compatibility but sync is automatic
      showNotification('✅ All data auto-syncs to Supabase cloud!', 'success');
    }
    
    async function loadFromCloud() {
      try {
  const payments = await PaymentStore.fetchAll();
        console.log(`📥 Loaded ${payments.length} payments from Supabase`);
        renderPaymentEmailsView();
      } catch (error) {
        console.error('Error loading from cloud:', error);
        showNotification('❌ Failed to load data from cloud', 'error');
      }
    }
    
    // ============================================================================
    // PAYMENT ACTIONS POPUP
    // ============================================================================
    
  let currentPaymentPopupData = null;
  let paymentRenderRAF = null;
  let paymentRenderToken = 0;
  let lastPopupOpenTime = 0; // Debounce double-click
    
    // BEGIN POPUP BACK & EXIT FIX
    function showPaymentActionsPopup(event, paymentId, payerName, amount, message, studentName, studentId) {
      if (event) event.stopPropagation();
      
      // Debounce: prevent multiple rapid opens
      const now = Date.now();
      if (now - lastPopupOpenTime < 300) return;
      lastPopupOpenTime = now;
      
      // Store payment data
      currentPaymentPopupData = {
        paymentId: paymentId,
        payerName: payerName,
        amount: amount,
        message: message,
        studentName: studentName,
        studentId: studentId
      };
      
      // Update display with null checks
      const payerNameEl = document.getElementById('popupPayerName');
      const amountEl = document.getElementById('popupPaymentAmount');
      const messageEl = document.getElementById('popupPaymentMessage');
      const popup = document.getElementById('paymentActionsPopup');
      
      if (!payerNameEl || !amountEl || !messageEl || !popup) {
        console.error('Payment popup elements not found');
        showNotification('❌ UI error: Popup elements missing', 'error');
        return;
      }
      
      payerNameEl.textContent = payerName || '—';
      amountEl.innerHTML = formatDualCurrencyHTML(amount);
      messageEl.textContent = message || 'No message';
      
      // Register with PopupManager for Back button and click-outside
      if (window.PopupManager) {
        window.PopupManager.register('paymentActionsPopup', {
          hasBackButton: false, // No back button needed (top-level popup)
          closeOnOutsideClick: true,
          onClose: () => {
            currentPaymentPopupData = null;
            const aliasForm = document.getElementById('createAliasForm');
            const dateForm = document.getElementById('changeDateForm');
            if (aliasForm) aliasForm.style.display = 'none';
            if (dateForm) dateForm.style.display = 'none';
          }
        });
      }
      
      // Show backdrop and modal with fade-in
      const backdrop = document.getElementById('paymentActionsBackdrop');
      if (backdrop) {
        backdrop.style.display = 'block';
        backdrop.style.opacity = '0';
        backdrop.style.transition = 'opacity 0.25s ease';
        requestAnimationFrame(() => {
          backdrop.style.opacity = '1';
        });
      }
      
      popup.classList.add('active');
      popup.style.display = 'block';
      popup.style.opacity = '0';
      popup.style.transition = 'opacity 0.25s ease';
      requestAnimationFrame(() => {
        popup.style.opacity = '1';
      });
    }
    // END POPUP BACK & EXIT FIX
    
    function closePaymentActionsPopup() {
      const popup = document.getElementById('paymentActionsPopup');
      const backdrop = document.getElementById('paymentActionsBackdrop');
      
      // Fade out
      if (popup) {
        popup.style.opacity = '0';
      }
      if (backdrop) {
        backdrop.style.opacity = '0';
      }
      
      // Hide after transition
      setTimeout(() => {
        if (popup) {
          popup.classList.remove('active');
          popup.style.display = 'none';
        }
        if (backdrop) {
          backdrop.style.display = 'none';
        }
        
        currentPaymentPopupData = null;
        
        // Hide any open forms
        const aliasForm = document.getElementById('createAliasForm');
        const dateForm = document.getElementById('changeDateForm');
        if (aliasForm) aliasForm.style.display = 'none';
        if (dateForm) dateForm.style.display = 'none';
      }, 250);
    }
    
    async function ignoreThisPayment() {
      if (!currentPaymentPopupData) {
        showNotification('❌ No payment selected', 'error');
        return;
      }
      
      const confirmed = await customConfirm(
        `Ignore this payment from "${currentPaymentPopupData.payerName}"?\n\nIt will be excluded from totals.`,
        {
          title: 'Ignore Payment',
          icon: '⚠️',
          okText: 'Ignore',
          type: 'danger'
        }
      );
      
      if (!confirmed) return;
      
      try {
        const payments = PaymentStore.getAll();
        const payment = payments.find(p => p.id === currentPaymentPopupData.paymentId);
        
        if (!payment) {
          showNotification('❌ Payment not found', 'error');
          return;
        }
        
        // Mark as ignored
        payment.ignoredOnce = true;
        payment.ignoredAt = new Date().toISOString();
        
        await PaymentStore.save(payments);
        
        // Auto-synced to Supabase cloud
        console.log('✅ Payment ignored and synced to Supabase');
        
        showNotification('🚫 Payment ignored', 'success');
        closePaymentActionsPopup();
        renderPaymentEmailsView();
        
      } catch (error) {
        console.error('Error ignoring payment:', error);
        showNotification('❌ Failed to ignore payment', 'error');
      }
    }
    
    async function deleteThisPayment() {
      if (!currentPaymentPopupData) {
        showNotification('❌ No payment selected', 'error');
        return;
      }
      
      const confirmed = await customConfirm(
        `Delete this payment from "${currentPaymentPopupData.payerName}"?\n\nAmount: ${formatCurrency(currentPaymentPopupData.amount, '$')}\n\nThis action cannot be undone!`,
        {
          title: 'Delete Payment',
          icon: '🗑️',
          okText: 'Delete',
          type: 'danger'
        }
      );
      
      if (!confirmed) return;
      
      try {
        let payments = PaymentStore.getAll();
        const paymentIndex = payments.findIndex(p => p.id === currentPaymentPopupData.paymentId);
        
        if (paymentIndex === -1) {
          showNotification('❌ Payment not found', 'error');
          return;
        }
        
        // Remove the payment
        payments.splice(paymentIndex, 1);
        await PaymentStore.save(payments);
        
        // Auto-synced to Supabase cloud
        console.log('✅ Payment deleted and synced to Supabase');
        
        showNotification('🗑️ Payment deleted', 'success');
        closePaymentActionsPopup();
        renderPaymentEmailsView();
        
      } catch (error) {
        console.error('Error deleting payment:', error);
        showNotification('❌ Failed to delete payment', 'error');
      }
    }
    
    function showCreateAliasForm() {
      const form = document.getElementById('createAliasForm');
      const input = document.getElementById('aliasStudentName');
      if (form) form.style.display = 'block';
      if (input) {
        input.value = '';
        input.focus();
      }
    }
    
    function hideCreateAliasForm() {
      const form = document.getElementById('createAliasForm');
      if (form) form.style.display = 'none';
    }
    
    async function saveAlias() {
      const studentName = document.getElementById('aliasStudentName').value.trim();
      if (!studentName) {
        showNotification('⚠️ Please enter a student name', 'warning');
        return;
      }
      
      if (!currentPaymentPopupData) {
        showNotification('❌ No payment selected', 'error');
        return;
      }
      
      try {
        const payerName = currentPaymentPopupData.payerName;
        
        // Find the student in Student Manager
        const students = loadStudents();
        const student = students.find(s => 
          s.name.toLowerCase().trim() === studentName.toLowerCase().trim()
        );
        
        // BEGIN CRITICAL BUG FIX - saveAlias() Logic Flow
        if (student) {
          // Initialize aliases array if needed
          if (!student.aliases) {
            student.aliases = [];
          }
          
          // Check if alias already exists
          const aliasExists = student.aliases.some(a => 
            a.toLowerCase().trim() === payerName.toLowerCase().trim()
          );
          
          if (aliasExists) {
            showNotification('⚠️ Alias already exists for this student', 'warning');
            return;
          }
          
          // Add new alias
          student.aliases.push(payerName);
          
          // Save students using the proper function
          saveStudents();
        } else {
          showNotification('❌ Student not found', 'error');
          return;
        }
        // END CRITICAL BUG FIX
        
        // Create alias mapping (for backward compatibility)
        const aliases = JSON.parse(localStorage.getItem('payment-aliases') || '{}');
        const normalizedPayer = payerName.toLowerCase().trim();
        aliases[normalizedPayer] = studentName;
        localStorage.setItem('payment-aliases', JSON.stringify(aliases));
        
        // Update all payments from this payer
        const payments = PaymentStore.getAll();
        let updatedCount = 0;
        
        payments.forEach(payment => {
          if (payment.payerName && payment.payerName.toLowerCase().trim() === normalizedPayer) {
            payment.studentName = studentName;
            payment.aliasMatched = true;
            updatedCount++;
          }
        });
        
        PaymentStore.save(payments);
        
        // Recompute to update group information
        recomputePaymentResolutions();
        
        showNotification(`✅ Alias created! Updated ${updatedCount} payment${updatedCount > 1 ? 's' : ''}`, 'success');
        closePaymentActionsPopup();
        renderPaymentEmailsView();
        
      } catch (error) {
        console.error('Error saving alias:', error);
        showNotification('❌ Failed to save alias', 'error');
      }
    }
    
    function showChangeDateForm() {
      const form = document.getElementById('changeDateForm');
      if (!form) {
        console.error('changeDateForm element not found');
        return;
      }
      form.style.display = 'block';
      
      if (currentPaymentPopupData) {
        const payments = PaymentStore.getAll();
        const payment = payments.find(p => p.id === currentPaymentPopupData.paymentId);
        if (payment && payment.emailDate) {
          const date = new Date(payment.emailDate);
          const dateInput = document.getElementById('newEmailDate');
          if (dateInput) {
            dateInput.value = date.toISOString().split('T')[0];
          }
        }
      }
    }
    
    function hideChangeDateForm() {
      const form = document.getElementById('changeDateForm');
      if (form) form.style.display = 'none';
    }
    
    async function saveNewDate() {
      const newDateStr = document.getElementById('newEmailDate').value;
      if (!newDateStr) {
        showNotification('⚠️ Please select a date', 'warning');
        return;
      }
      
      if (!currentPaymentPopupData) {
        showNotification('❌ No payment selected', 'error');
        return;
      }
      
      // Validate date is reasonable (not too far in future, not before 2020)
      const newDate = new Date(newDateStr + 'T12:00:00');
      const minDate = new Date('2020-01-01');
      const maxDate = new Date();
      maxDate.setDate(maxDate.getDate() + 365); // Allow up to 1 year in future
      
      if (newDate < minDate) {
        showNotification('⚠️ Date cannot be before 2020', 'warning');
        return;
      }
      
      if (newDate > maxDate) {
        showNotification('⚠️ Date cannot be more than 1 year in the future', 'warning');
        return;
      }
      
      try {
        const payments = PaymentStore.getAll();
        const payment = payments.find(p => p.id === currentPaymentPopupData.paymentId);
        
        if (!payment) {
          showNotification('❌ Payment not found', 'error');
          return;
        }
        
        // Store original date if not already stored
        if (!payment.originalEmailDate) {
          payment.originalEmailDate = payment.emailDate;
        }
        
        // Update the email date
        payment.emailDate = newDate.toISOString();
        payment.dateModified = true;
        payment.dateModifiedAt = new Date().toISOString();
        
        PaymentStore.save(payments);
        
        showNotification(`✅ Date changed to ${newDate.toLocaleDateString()}`, 'success');
        closePaymentActionsPopup();
        renderPaymentEmailsView();
        
      } catch (error) {
        console.error('Error changing date:', error);
        showNotification('❌ Failed to change date', 'error');
      }
    }
    
    async function ignoreAllFromPayer() {
      if (!currentPaymentPopupData) {
        showNotification('❌ No payment selected', 'error');
        return;
      }
      
      const payerName = currentPaymentPopupData.payerName;
      
      const confirmed = await customConfirm(
        `Ignore ALL payments from "${payerName}"?\n\nThis will affect all payments from this payer.`,
        {
          title: 'Ignore All Payments',
          icon: '🚫',
          okText: 'Ignore All',
          type: 'danger'
        }
      );
      
      if (!confirmed) return;
      
      try {
        const payments = PaymentStore.getAll();
        const normalizedPayer = payerName.toLowerCase().trim();
        let ignoredCount = 0;
        
        payments.forEach(payment => {
          if (payment.payerName && payment.payerName.toLowerCase().trim() === normalizedPayer) {
            payment.ignorePermanently = true;
            payment.ignoredAt = new Date().toISOString();
            ignoredCount++;
          }
        });
        
        PaymentStore.save(payments);
        
        showNotification(`🚫 Ignored ${ignoredCount} payment${ignoredCount !== 1 ? 's' : ''} from "${payerName}"`, 'success');
        closePaymentActionsPopup();
        renderPaymentEmailsView();
        
      } catch (error) {
        console.error('Error ignoring payer:', error);
        showNotification('❌ Failed to ignore payments', 'error');
      }
    }
    
    // BEGIN POPUP BACK & EXIT FIX
    async function linkPaymentToStudent() {
      if (!currentPaymentPopupData) {
        showNotification('❌ No payment selected', 'error');
        return;
      }
      
      // Get list of students
      const students = loadStudents();
      
      if (!students || students.length === 0) {
        showNotification('⚠️ No students found. Create students first.', 'warning');
        return;
      }
      
      // Create student list items for search
      const studentListHTML = students
        .map(s => `<div class="student-search-item" data-student-id="${s.id}" data-student-name="${s.name.toLowerCase()}" data-student-email="${(s.email || '').toLowerCase()}" onclick="selectStudentFromSearch('${s.id}')" style="padding: 12px 14px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; border-radius: 6px; margin-bottom: 4px; pointer-events: auto;" onmouseover="this.style.background='rgba(138,180,255,0.15)'" onmouseout="this.style.background='transparent'">
          <div style="color: white; font-weight: 600; font-size: 14px;">${s.name}</div>
          ${s.email ? `<div style="color: #94a3b8; font-size: 12px; margin-top: 2px;">${s.email}</div>` : ''}
        </div>`)
        .join('');
      
      const modalHTML = `
        <div id="linkStudentModalBackdrop" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; backdrop-filter: blur(6px); cursor: pointer;" onclick="closeLinkStudentModal()"></div>
        <div id="linkStudentModal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%); border: 2px solid rgba(138,180,255,.3); border-radius: 16px; padding: 24px; min-width: 400px; max-width: 500px; z-index: 10001; box-shadow: 0 20px 60px rgba(0,0,0,0.8); opacity: 0; transition: opacity 0.25s ease;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; position: relative;">
            <button onclick="closeLinkStudentModal()" style="background: none; border: none; color: #94a3b8; opacity: 0.8; font-size: 14px; font-weight: 600; cursor: pointer; padding: 8px 12px; margin-right: auto; transition: all 0.2s ease; pointer-events: auto; position: absolute; left: 0; top: 0;" onmouseover="this.style.opacity='1'; this.style.textShadow='0 0 8px rgba(148,163,184,0.6)'" onmouseout="this.style.opacity='0.8'; this.style.textShadow='none'">← Back</button>
            <h3 style="margin: 0; color: white; font-size: 18px; font-weight: 700; flex: 1; text-align: center;">Link to Student</h3>
            <button onclick="closeLinkStudentModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; opacity: 0.7; transition: opacity 0.2s; pointer-events: auto;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>
          </div>
          <p style="margin: 0 0 12px 0; color: #94a3b8; font-size: 14px;">Search and select a student to link this payment to:</p>
          
          <input type="text" id="linkStudentSearchInput" placeholder="Search students by name..." style="width: 100%; padding: 12px 14px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-size: 14px; margin-bottom: 16px; outline: none; pointer-events: auto;" oninput="filterStudentSearch()" onkeydown="if(event.key==='Escape'){closeLinkStudentModal();}" autofocus>
          
          <div id="studentSearchResults" style="max-height: 320px; overflow-y: auto; margin-bottom: 16px; padding: 4px; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
            ${studentListHTML}
          </div>
          
          <div style="display: flex; gap: 10px;">
            <button onclick="closeLinkStudentModal()" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; pointer-events: auto;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">Cancel</button>
          </div>
        </div>
      `;
      
      // Remove any existing modal
      const existingModal = document.getElementById('linkStudentModal');
      const existingBackdrop = document.getElementById('linkStudentModalBackdrop');
      if (existingModal) existingModal.remove();
      if (existingBackdrop) existingBackdrop.remove();
      
      // Add modal to page
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Register with PopupManager
      if (window.PopupManager) {
        window.PopupManager.register('linkStudentModal', {
          hasBackButton: false,  // We have our own back button in the HTML
          closeOnOutsideClick: true,
          onBack: closeLinkStudentModal,
          parent: 'paymentActionsPopup'
        });
      }
      
      // Fade in
      requestAnimationFrame(() => {
        const modal = document.getElementById('linkStudentModal');
        const backdrop = document.getElementById('linkStudentModalBackdrop');
        if (backdrop) {
          backdrop.style.display = 'block';
          backdrop.style.opacity = '0';
          requestAnimationFrame(() => {
            backdrop.style.opacity = '1';
          });
        }
        if (modal) {
          modal.style.opacity = '1';
        }
      });
      
      // Focus search input
      setTimeout(() => {
        const input = document.getElementById('linkStudentSearchInput');
        if (input) input.focus();
      }, 100);
    }
    // END POPUP BACK & EXIT FIX
    
    // BEGIN SEARCH FIX - Search by name AND email
    function filterStudentSearch() {
      const input = document.getElementById('linkStudentSearchInput');
      const filter = input ? input.value.toLowerCase().trim() : '';
      const items = document.querySelectorAll('.student-search-item');
      
      let visibleCount = 0;
      items.forEach(item => {
        const studentName = item.getAttribute('data-student-name') || '';
        const studentEmail = item.getAttribute('data-student-email') || '';
        const textContent = item.textContent.toLowerCase();
        
        // Search in name, email, or visible text
        const matches = !filter || 
                       studentName.includes(filter) || 
                       studentEmail.includes(filter) ||
                       textContent.includes(filter);
        
        if (matches) {
          item.style.display = 'block';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });
      
      // Show message if no results
      const resultsContainer = document.getElementById('studentSearchResults');
      if (resultsContainer && visibleCount === 0 && filter) {
        if (!document.getElementById('noStudentsMessage')) {
          resultsContainer.insertAdjacentHTML('beforeend', '<div id="noStudentsMessage" style="padding: 20px; text-align: center; color: #94a3b8; font-size: 14px;">No students match your search</div>');
        }
      } else {
        const noMsg = document.getElementById('noStudentsMessage');
        if (noMsg) noMsg.remove();
      }
    }
    // END SEARCH FIX
    
    function selectStudentFromSearch(studentId) {
      confirmLinkStudent(studentId);
    }
    
    function closeLinkStudentModal() {
      const modal = document.getElementById('linkStudentModal');
      const backdrop = document.getElementById('linkStudentModalBackdrop');
      
      if (modal && backdrop) {
        // BEGIN POPUP BACK & EXIT FIX
        // Fade out before removing
        modal.style.opacity = '0';
        backdrop.style.opacity = '0';
        
        setTimeout(() => {
          modal.remove();
          backdrop.remove();
          window.PopupManager?.activePopups?.delete('linkStudentModal');
        }, 250);
        // END POPUP BACK & EXIT FIX
      }
    }
    
    async function confirmLinkStudent(studentId) {
      if (!studentId) {
        showNotification('⚠️ Please select a student', 'warning');
        return;
      }
      
      if (!currentPaymentPopupData) {
        showNotification('❌ No payment selected', 'error');
        closeLinkStudentModal();
        return;
      }
      
      try {
        const students = loadStudents();
        const student = students.find(s => s.id === studentId);
        
        if (!student) {
          showNotification('❌ Student not found', 'error');
          return;
        }
        
        // BEGIN CRITICAL BUG FIX - Payment ↔ Student Linking Logic
        // Update payment with student link using correct field names:
        // - linkedStudentId: for manual linking (checked first by resolver)
        // - manuallyLinked: flag to trigger manual resolution path
        // - linkedAt: timestamp for audit trail
        const payments = PaymentStore.getAll();
        const payment = payments.find(p => p.id === currentPaymentPopupData.paymentId);
        
        if (!payment) {
          showNotification('❌ Payment not found', 'error');
          return;
        }
        
        payment.linkedStudentId = student.id; // ✅ Correct field for manual linking
        payment.manuallyLinked = true;
        payment.linkedAt = new Date().toISOString();
        payment.resolutionSource = 'manual';
        
        // Add payer name to student's alias if not already there
        const payerName = payment.payerName || payment.fromName || '';
        if (payerName && payerName.trim()) {
          const currentAliases = student.aliases || [];
          const normalizedPayerName = payerName.trim().toLowerCase();
          const normalizedStudentName = student.name.toLowerCase();
          
          // Only add if payer name is different from student name and not already in aliases
          const aliasExists = currentAliases.some(alias => 
            alias.toLowerCase() === normalizedPayerName
          );
          
          if (normalizedPayerName !== normalizedStudentName && !aliasExists) {
            student.aliases = [...currentAliases, payerName.trim()];
            saveStudents(students); // Save updated student data
            console.log(`✅ Added "${payerName}" to ${student.name}'s aliases`);
          }
        }
        
        // Compute derived fields immediately (before saving)
        const resolution = resolvePaymentToStudent(payment, students);
        payment.derivedStudentId = resolution.studentId;
        payment.resolvedStudentName = resolution.studentName;
        payment.derivedStudentGroup = resolution.studentGroup;
        
        PaymentStore.save(payments);
        // END CRITICAL BUG FIX
        
        // Recompute payment resolutions
        recomputePaymentResolutions();
        
        showNotification(`✅ Payment linked to ${student.name}`, 'success');
        closeLinkStudentModal();
        closePaymentActionsPopup();
        renderPaymentEmailsView();
        
      } catch (error) {
        console.error('Error linking payment:', error);
        showNotification('❌ Failed to link payment', 'error');
      }
    }
    
    // Open student edit from payment record click
    function openStudentEditFromPayment(studentId) {
      if (!studentId) return;
      
      // Open Student Manager modal
      openStudentManager();
      
      // Wait for modal to render, then trigger edit
      setTimeout(() => {
        const studentCard = document.querySelector(`[data-student-id="${studentId}"]`);
        if (studentCard) {
          // Scroll into view
          studentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Highlight the card briefly
          studentCard.style.transition = 'all 0.3s ease';
          studentCard.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.5)';
          studentCard.style.transform = 'scale(1.02)';
          
          // Toggle into edit mode
          setTimeout(() => {
            toggleInlineEdit(studentId);
            
            // Remove highlight after edit opens
            setTimeout(() => {
              studentCard.style.boxShadow = '';
              studentCard.style.transform = '';
            }, 500);
          }, 300);
        } else {
          showNotification('⚠️ Student not found', 'warning');
        }
      }, 300);
    }
    
    // Close popup when clicking outside
    document.addEventListener('click', function(event) {
      const popup = document.getElementById('paymentActionsPopup');
      if (popup && popup.classList.contains('active') && !popup.contains(event.target)) {
        closePaymentActionsPopup();
      }
      
      const fullSyncModal = document.getElementById('fullSyncModal');
      if (fullSyncModal && fullSyncModal.style.display === 'block' && event.target === fullSyncModal) {
        closeFullSyncDatePicker();
      }
    });
    
    // ============================================================================
    // FULL SYNC FUNCTIONALITY
    // ============================================================================
    
    function openFullSyncDatePicker() {
      const modal = document.getElementById('fullSyncModal');
      if (!modal) {
        console.error('fullSyncModal element not found');
        showNotification('❌ UI error: Modal not found', 'error');
        return;
      }
      
      // BEGIN POPUP BACK & EXIT FIX
      // Register with PopupManager
      window.PopupManager.register('fullSyncModal', {
        hasBackButton: false, // Top-level modal
        closeOnOutsideClick: true,
        onClose: closeFullSyncDatePicker
      });
      
      // Fade in animation
      modal.style.opacity = '0';
      modal.style.display = 'block';
      
      requestAnimationFrame(() => {
        modal.style.opacity = '1';
      });
      // END POPUP BACK & EXIT FIX
      
      // Set default dates
      const today = new Date();
      const toDateInput = document.getElementById('fullSyncToDate');
      if (toDateInput) {
        toDateInput.value = today.toISOString().split('T')[0];
      }
      
      // Default from date is July 1, 2024 (already set in HTML)
    }
    
    function closeFullSyncDatePicker() {
      const modal = document.getElementById('fullSyncModal');
      if (!modal) return;
      
      // BEGIN POPUP BACK & EXIT FIX
      // Fade out before hiding
      modal.style.opacity = '0';
      
      setTimeout(() => {
        modal.style.display = 'none';
        window.PopupManager?.activePopups?.delete('fullSyncModal');
      }, 250);
      // END POPUP BACK & EXIT FIX
    }
    
    async function performFullSync() {
      const fromDateStr = document.getElementById('fullSyncFromDate').value;
      const toDateStr = document.getElementById('fullSyncToDate').value;
      
      if (!fromDateStr || !toDateStr) {
        showNotification('⚠️ Please select both dates', 'warning');
        return;
      }
      
      // BEGIN PAYMENT RECORDS ORDER & HIGHLIGHT FIX
      // Check token validity before attempting full sync
      const isValid = await ensureGmailTokenValid();
      if (!isValid || !gmailAccessToken) {
        showNotification('⚠️ Please connect Gmail first', 'warning');
        closeFullSyncDatePicker();
        return;
      }
      // END PAYMENT RECORDS ORDER & HIGHLIGHT FIX
      
      const fromDate = new Date(fromDateStr);
      const toDate = new Date(toDateStr);
      
      if (fromDate > toDate) {
        showNotification('⚠️ From date must be before To date', 'warning');
        return;
      }
      
      closeFullSyncDatePicker();
      
      const btn = document.getElementById('fullSyncBtn');
      const text = document.getElementById('fullSyncBtnText');
      
      if (!btn || !text) {
        console.error('Full sync button elements not found');
        showNotification('❌ UI error: Button elements missing', 'error');
        return;
      }
      
      btn.disabled = true;
      text.textContent = 'Syncing...';
      
      try {
        showNotification(`🔍 Fetching payments from ${fromDate.toLocaleDateString()} to ${toDate.toLocaleDateString()}...`, 'info');
        
        const fromTime = Math.floor(fromDate.getTime() / 1000);
        const toTime = Math.floor(toDate.getTime() / 1000) + 86400; // Include entire end day
        
        const query = `from:usbank@notifications.usbank.com subject:Zelle after:${fromTime} before:${toTime}`;
        
        let allMessages = [];
        let pageToken = null;
        let pageCount = 0;
        
        // Paginate through all results
        do {
          pageCount++;
          const searchUrl = `https://gmail.googleapis.com/gmail/v1/users/me/messages?q=${encodeURIComponent(query)}&maxResults=500${pageToken ? `&pageToken=${pageToken}` : ''}`;
          
          const searchResponse = await fetch(searchUrl, {
            headers: { 'Authorization': `Bearer ${gmailAccessToken}` }
          });
          
          if (!searchResponse.ok) {
            if (searchResponse.status === 401) {
              localStorage.removeItem(STORAGE_KEYS.GMAIL_TOKEN);
              localStorage.removeItem(STORAGE_KEYS.GMAIL_EXPIRY);
              gmailAccessToken = null;
              updateGmailButtonState(false);
              throw new Error('Gmail session expired. Please reconnect.');
            }
            throw new Error(`Gmail API error: ${searchResponse.status}`);
          }
          
          const searchData = await searchResponse.json();
          
          if (searchData.messages) {
            allMessages = allMessages.concat(searchData.messages);
            text.textContent = `Found ${allMessages.length}...`;
          }
          
          pageToken = searchData.nextPageToken;
          
        } while (pageToken);
        
        if (allMessages.length === 0) {
          showNotification('📭 No payments found in this date range', 'info');
          btn.disabled = false;
          text.textContent = 'Full Sync';
          return;
        }
        
        console.log(`✅ Found ${allMessages.length} payment emails`);
        text.textContent = `Processing ${allMessages.length}...`;
        
        const existingPayments = PaymentStore.getAll();
        const existingEmailIds = new Set();
        const existingCompositeKeys = new Set();
        existingPayments.forEach(existingPayment => {
          const idsToTrack = [existingPayment.emailId, existingPayment.gmailId].filter(Boolean);
          idsToTrack.forEach(id => existingEmailIds.add(id));
          const compositeKey = buildPaymentDuplicateKey(existingPayment);
          if (compositeKey) existingCompositeKeys.add(compositeKey);
        });
        
        const payments = [];
        
        for (let i = 0; i < allMessages.length; i++) {
          const message = allMessages[i];
          
          if (i % 10 === 0) {
            text.textContent = `Processing ${i + 1}/${allMessages.length}...`;
          }
          
          const messageUrl = `https://gmail.googleapis.com/gmail/v1/users/me/messages/${message.id}`;
          const messageResponse = await fetch(messageUrl, {
            headers: { 'Authorization': `Bearer ${gmailAccessToken}` }
          });
          
          if (messageResponse.ok) {
            const messageData = await messageResponse.json();
            const payment = parseZelleEmail(messageData);
            if (payment) {
              const idsToCheck = [payment.emailId, payment.gmailId].filter(Boolean);
              const isExistingId = idsToCheck.some(id => existingEmailIds.has(id));
              if (isExistingId) {
                continue;
              }
              const compositeKey = buildPaymentDuplicateKey(payment);
              if (compositeKey && existingCompositeKeys.has(compositeKey)) {
                continue;
              }
              idsToCheck.forEach(id => existingEmailIds.add(id));
              if (compositeKey) existingCompositeKeys.add(compositeKey);
              payments.push(payment);
            }
          }
          
          await new Promise(resolve => setTimeout(resolve, TIMING.FULL_SYNC_API_DELAY));
        }
        
        if (payments.length > 0) {
          const allPayments = [...existingPayments, ...payments];
          PaymentStore.save(allPayments);
          
          // Recompute resolutions to populate group information
          recomputePaymentResolutions();
          
          const totalAmount = payments.reduce((sum, p) => sum + p.amount, 0);
          showNotification(`✅ Added ${payments.length} new payment${payments.length > 1 ? 's' : ''}!\n💰 Total: ${formatCurrency(totalAmount, '$')}`, 'success');
          renderPaymentEmailsView();
        } else {
          showNotification('✅ All payments already synced', 'success');
        }
        
      } catch (error) {
        console.error('Error during full sync:', error);
        showNotification('❌ Full sync failed: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        text.textContent = 'Full Sync';
      }
    }
    
    // ============================================================================
    // AUTO-REFRESH FUNCTIONALITY
    // ============================================================================
    
    let autoRefreshInterval = null;
    let autoRefreshEnabled = localStorage.getItem('paymentEmailAutoRefresh') === 'true';
    
    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      localStorage.setItem('paymentEmailAutoRefresh', autoRefreshEnabled.toString());
      
      const toggleBtn = document.getElementById('autoRefreshToggle');
      if (!toggleBtn) {
        console.error('autoRefreshToggle button not found');
        return;
      }
      
      if (autoRefreshEnabled) {
        toggleBtn.classList.add('auto-refresh-active');
        toggleBtn.title = 'Auto-refresh ON (every 30s) - Click to disable';
        startAutoRefresh();
        showNotification('✅ Auto-refresh enabled (every 30 seconds)', 'success');
      } else {
        toggleBtn.classList.remove('auto-refresh-active');
        toggleBtn.title = 'Auto-refresh OFF - Click to enable';
        stopAutoRefresh();
        showNotification('⏸️ Auto-refresh disabled', 'info');
      }
    }
    
    function startAutoRefresh() {
      stopAutoRefresh();
      autoRefreshInterval = setInterval(() => {
        console.log('🔄 Auto-refreshing payments...');
        refreshPayments();
      }, TIMING.AUTO_REFRESH_INTERVAL);
    }
    
    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
    }
    
    // ============================================================================
    // NOTIFICATIONS SYSTEM
    // ============================================================================

    // Notification stub (removed notification center)
    function showNotification(message, type = 'info') {
      const icon = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️' }[type] || 'ℹ️';
      console.log(`${icon} ${message}`);
    }
    
    // ============================================================================
    // SETTINGS MENU
    // ============================================================================
    
    function toggleSettingsMenu() {
      const menu = document.getElementById('settingsMenu');
      if (!menu) return;
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    }
    
    // Close settings menu when clicking outside
    document.addEventListener('click', function(e) {
      const settingsBtn = document.getElementById('settingsBtn');
      const menu = document.getElementById('settingsMenu');
      
      if (settingsBtn && menu && !settingsBtn.contains(e.target) && !menu.contains(e.target)) {
        menu.style.display = 'none';
      }
    });
    
    // ============================================================================
    // BACKUP & RESTORE SYSTEM
    // ============================================================================
    
    /**
     * Export Full Backup
     * Creates a comprehensive JSON backup of all app data
     */
    function exportFullBackup() {
      try {
        // Close settings menu
        const menu = document.getElementById('settingsMenu');
        if (menu) menu.style.display = 'none';
        
        // Gather all data from localStorage
        const backup = {
          version: '2.0',
          timestamp: new Date().toISOString(),
          students: JSON.parse(localStorage.getItem('students:v2') || '[]'),
          groups: JSON.parse(localStorage.getItem('group-manager:v2') || '[]'),
          payments: JSON.parse(localStorage.getItem('payments:v2') || '[]'),
          waitingList: JSON.parse(localStorage.getItem('waiting-list:v2') || '[]'),
          settings: JSON.parse(localStorage.getItem('settings:v2') || '{}'),
          gmailConnection: JSON.parse(localStorage.getItem('gmail-connection') || 'null'),
          exchangeRate: localStorage.getItem('exchangeRate') || '400',
          lastSync: localStorage.getItem('lastSyncTime') || null
        };
        
        // Convert to JSON string with formatting
        const jsonString = JSON.stringify(backup, null, 2);
        
        // Create blob and download
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // Create filename with timestamp
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
        a.download = `ARNOMA_Backup_${timestamp}.json`;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Create auto-backup in localStorage (keep last 5)
        createAutoBackup(backup);
        
        showNotificationSimple('✅ Backup exported successfully', 'success');
        
      } catch (error) {
        console.error('Error exporting backup:', error);
        showNotificationSimple('❌ Failed to export backup', 'error');
      }
    }
    
    /**
     * Trigger Import Backup
     * Opens file selector for backup restoration
     */
    function triggerImportBackup() {
      try {
        // Close settings menu
        const menu = document.getElementById('settingsMenu');
        if (menu) menu.style.display = 'none';
        
        const fileInput = document.getElementById('backupFileInput');
        if (!fileInput) {
          showNotificationSimple('❌ File input not found', 'error');
          return;
        }
        
        // Set up file input handler
        fileInput.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          try {
            const text = await file.text();
            await importFullBackup(text);
          } catch (error) {
            console.error('Error reading backup file:', error);
            showNotificationSimple('❌ Failed to read backup file', 'error');
          }
          
          // Reset file input
          fileInput.value = '';
        };
        
        // Trigger file selection
        fileInput.click();
        
      } catch (error) {
        console.error('Error triggering import:', error);
        showNotificationSimple('❌ Failed to open file selector', 'error');
      }
    }
    
    /**
     * Import Full Backup
     * Restores all app data from a backup file
     */
    async function importFullBackup(jsonData) {
      try {
        // Confirm before overwriting
        const confirmed = await customConfirm(
          'Restoring a backup will overwrite all current data.\n\nThis action cannot be undone.\n\nContinue?',
          {
            title: 'Restore Backup',
            icon: '⚠️',
            okText: 'Restore',
            type: 'danger'
          }
        );
        
        if (!confirmed) return;
        
        // Parse JSON
        let data;
        try {
          data = JSON.parse(jsonData);
        } catch (parseError) {
          showNotificationSimple('❌ Invalid backup file format', 'error');
          return;
        }
        
        // Validate backup structure
        if (!data.version || !data.timestamp) {
          showNotificationSimple('❌ Invalid backup file: missing version info', 'error');
          return;
        }
        
        if (!data.students && !data.groups && !data.payments) {
          showNotificationSimple('❌ Invalid backup file: no data found', 'error');
          return;
        }
        
        // Create automatic backup of current state before restore
        const currentBackup = {
          version: '2.0',
          timestamp: new Date().toISOString(),
          students: JSON.parse(localStorage.getItem('students:v2') || '[]'),
          groups: JSON.parse(localStorage.getItem('group-manager:v2') || '[]'),
          payments: JSON.parse(localStorage.getItem('payments:v2') || '[]'),
          waitingList: JSON.parse(localStorage.getItem('waiting-list:v2') || '[]'),
          settings: JSON.parse(localStorage.getItem('settings:v2') || '{}')
        };
        localStorage.setItem('lastAutoBackup:v2', JSON.stringify(currentBackup));
        
        // Restore data to localStorage
        if (data.students) {
          localStorage.setItem('students:v2', JSON.stringify(data.students));
        }
        
        if (data.groups) {
          localStorage.setItem('group-manager:v2', JSON.stringify(data.groups));
        }
        
        if (data.payments) {
          localStorage.setItem('payments:v2', JSON.stringify(data.payments));
          PaymentStore.save(data.payments); // Update PaymentStore
        }
        
        if (data.waitingList) {
          localStorage.setItem('waiting-list:v2', JSON.stringify(data.waitingList));
        }
        
        if (data.settings) {
          localStorage.setItem('settings:v2', JSON.stringify(data.settings));
        }
        
        if (data.gmailConnection !== undefined) {
          localStorage.setItem('gmail-connection', JSON.stringify(data.gmailConnection));
        }
        
        if (data.exchangeRate) {
          localStorage.setItem('exchangeRate', data.exchangeRate);
        }
        
        if (data.lastSync) {
          localStorage.setItem('lastSyncTime', data.lastSync);
        }
        
        // Dispatch update events
        window.dispatchEvent(new CustomEvent('students:updated', { detail: data.students || [] }));
        window.dispatchEvent(new CustomEvent('groups:updated', { detail: data.groups || [] }));
        window.dispatchEvent(new CustomEvent('payments:updated', { detail: data.payments || [] }));
        
        // Reload all views
        if (typeof loadStudents === 'function') {
          students = loadStudents();
        }
        
        if (typeof loadGroups === 'function') {
          groups = loadGroups();
        }
        
        if (typeof loadWaitingList === 'function') {
          waitingList = loadWaitingList();
        }
        
        // Re-render all views
        if (typeof renderPaymentEmailsView === 'function') {
          renderPaymentEmailsView();
        }
        
        if (typeof renderStudents === 'function') {
          renderStudents();
        }
        
        if (typeof renderGroups === 'function') {
          renderGroups();
        }
        
        // Update month selector and totals
        if (typeof populateMonthSelector === 'function') {
          populateMonthSelector();
        }
        
        if (typeof updateMonthTotals === 'function') {
          updateMonthTotals();
        }
        
        // Show success message
        showNotificationSimple('✅ Backup restored successfully! All data reloaded.', 'success');
        
        // Optional: Reload page after a short delay for clean state
        setTimeout(() => {
          if (confirm('Reload page to ensure all components are properly initialized?')) {
            window.location.reload();
          }
        }, 1500);
        
      } catch (error) {
        console.error('Error importing backup:', error);
        showNotificationSimple('❌ Failed to restore backup: ' + error.message, 'error');
      }
    }
    
    /**
     * Create Auto Backup
     * Stores automatic backups in localStorage (keeps last 5)
     */
    function createAutoBackup(backupData) {
      try {
        // Get existing auto backups
        const autoBackupsRaw = localStorage.getItem('autoBackups:v2');
        let autoBackups = autoBackupsRaw ? JSON.parse(autoBackupsRaw) : [];
        
        // Add new backup
        autoBackups.push({
          timestamp: backupData.timestamp,
          data: backupData
        });
        
        // Keep only last 5 backups
        if (autoBackups.length > 5) {
          autoBackups = autoBackups.slice(-5);
        }
        
        // Save back to localStorage
        localStorage.setItem('autoBackups:v2', JSON.stringify(autoBackups));
        
        // Also save as lastAutoBackup for quick access
        localStorage.setItem('lastAutoBackup:v2', JSON.stringify(backupData));
      } catch (error) {
        console.error('Error creating auto backup:', error);
      }
    }
    /**
     * Create Auto Backup
     * All data is already in Supabase, so this just logs the backup event
     */
    async function createAutoBackup(backupData) {
      try {
        // Store backup metadata in localStorage for quick access
        localStorage.setItem('lastAutoBackup:v2', JSON.stringify(backupData));
        
        console.log('✅ Auto-backup completed (data already in Supabase)');
      } catch (error) {
        console.error('Error creating auto-backup metadata:', error);
      }
    }
    
    /**
     * Restore from Cloud
     * Reloads all data from Supabase
     */
    async function restoreFromCloud() {
      try {
        showNotification('🔄 Loading data from Supabase...', 'info');
        
        const confirmed = await customConfirm(
          'Reload all data from Supabase cloud?\n\n' +
          'This will refresh your local view with the latest cloud data.',
          {
            title: 'Restore from Cloud',
            icon: '☁️',
            okText: 'Reload',
            type: 'info'
          }
        );
        
        if (!confirmed) return;
        
        // Reload data from Supabase
        const students = await loadStudents();
  const payments = await PaymentStore.fetchAll();
        
        showNotification(`✅ Loaded ${students.length} students and ${payments.length} payments from cloud`, 'success');
        
        // Refresh UI
        window.location.reload();
        
      } catch (error) {
        console.error('Error restoring from cloud:', error);
        showNotification('❌ Failed to restore from cloud', 'error');
      }
    }
    
    /**
     * Restore Last Auto Backup
     * Restores the most recent automatic backup
     */
    async function restoreLastAutoBackup() {
      try {
        // Close settings menu
        const menu = document.getElementById('settingsMenu');
        if (menu) menu.style.display = 'none';
        
        // Get last auto backup
        const lastBackupRaw = localStorage.getItem('lastAutoBackup:v2');
        
        if (!lastBackupRaw) {
          showNotificationSimple('❌ No auto backup found', 'error');
          return;
        }
        
        const lastBackup = JSON.parse(lastBackupRaw);
        
        // Show backup info
        const backupDate = new Date(lastBackup.timestamp).toLocaleString('en-US', { 
          month: 'short', 
          day: 'numeric', 
          year: 'numeric', 
          hour: 'numeric', 
          minute: '2-digit',
          hour12: true 
        });
        const confirmed = await customConfirm(
          `Restore automatic backup from:\n${backupDate}\n\nThis will overwrite all current data.\n\nContinue?`,
          {
            title: 'Restore Auto Backup',
            icon: '⏮️',
            okText: 'Restore',
            type: 'danger'
          }
        );
        
        if (!confirmed) return;
        
        // Use the import function to restore
        await importFullBackup(JSON.stringify(lastBackup));
        
      } catch (error) {
        console.error('Error restoring auto backup:', error);
        showNotificationSimple('❌ Failed to restore auto backup', 'error');
      }
    }
    
    /**
     * Initialize Daily Auto Backup
     * Automatically creates backups once per day
     */
    function initializeDailyAutoBackup() {
      try {
        // Check last auto backup date
        const lastAutoBackupDate = localStorage.getItem('lastAutoBackupDate');
        const today = getTodayLA(); // YYYY-MM-DD in LA timezone
        
        // If no backup today, create one
        if (lastAutoBackupDate !== today) {
          performDailyAutoBackup();
        }
        
        // Set up interval to check daily (every hour)
        setInterval(() => {
          const currentDate = new Date().toISOString().slice(0, 10);
          const lastBackupDate = localStorage.getItem('lastAutoBackupDate');
          
          if (lastBackupDate !== currentDate) {
            performDailyAutoBackup();
          }
        }, 60 * 60 * 1000); // Check every hour
        
      } catch (error) {
        console.error('Error initializing daily auto backup:', error);
      }
    }
    
    /**
     * Perform Daily Auto Backup
     * Creates a silent backup in localStorage
     */
    function performDailyAutoBackup() {
      try {
        // Gather all data
        const backup = {
          version: '2.0',
          timestamp: new Date().toISOString(),
          students: JSON.parse(localStorage.getItem('students:v2') || '[]'),
          groups: JSON.parse(localStorage.getItem('group-manager:v2') || '[]'),
          payments: JSON.parse(localStorage.getItem('payments:v2') || '[]'),
          waitingList: JSON.parse(localStorage.getItem('waiting-list:v2') || '[]'),
          settings: JSON.parse(localStorage.getItem('settings:v2') || '{}'),
          gmailConnection: JSON.parse(localStorage.getItem('gmail-connection') || 'null'),
          exchangeRate: localStorage.getItem('exchangeRate') || '400',
          lastSync: localStorage.getItem('lastSyncTime') || null
        };
        
        // Store auto backup
        createAutoBackup(backup);
        
        // Update last backup date
        const today = getTodayLA();
        localStorage.setItem('lastAutoBackupDate', today);
        
        console.log('Daily auto backup completed:', today);
        
      } catch (error) {
        console.error('Error performing daily auto backup:', error);
      }
    }
    
    // ============================================================================
    // CUSTOM DIALOG SYSTEM (Replaces browser confirm/alert/prompt)
    // ============================================================================
    
    // Custom Confirm Dialog
    function customConfirm(message, options = {}) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customConfirmModal');
        const messageEl = document.getElementById('confirmMessage');
        const titleEl = document.getElementById('confirmTitle');
        const iconEl = document.getElementById('confirmIcon');
        const okBtn = document.getElementById('confirmOkBtn');
        const cancelBtn = document.getElementById('confirmCancelBtn');
        
        // Set content
        messageEl.textContent = message;
        titleEl.textContent = options.title || 'Confirm Action';
        iconEl.textContent = options.icon || '⚠️';
        okBtn.textContent = options.okText || 'Confirm';
        cancelBtn.textContent = options.cancelText || 'Cancel';
        
        // Style OK button based on type
        if (options.type === 'danger') {
          okBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
          okBtn.style.boxShadow = '0 4px 12px rgba(239, 68, 68, 0.4)';
        } else {
          okBtn.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
          okBtn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
        }
        
        // Show modal
        modal.style.display = 'flex';
        
        // Handle button clicks
        const handleOk = () => {
          modal.style.display = 'none';
          cleanup();
          resolve(true);
        };
        
        const handleCancel = () => {
          modal.style.display = 'none';
          cleanup();
          resolve(false);
        };
        
        const cleanup = () => {
          okBtn.removeEventListener('click', handleOk);
          cancelBtn.removeEventListener('click', handleCancel);
        };
        
        okBtn.addEventListener('click', handleOk);
        cancelBtn.addEventListener('click', handleCancel);
        
        // ESC key support
        const handleEsc = (e) => {
          if (e.key === 'Escape') {
            handleCancel();
            document.removeEventListener('keydown', handleEsc);
          }
        };
        document.addEventListener('keydown', handleEsc);
      });
    }
    
    // Custom Alert Dialog
    function customAlert(message, options = {}) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customAlertModal');
        const messageEl = document.getElementById('alertMessage');
        const titleEl = document.getElementById('alertTitle');
        const iconEl = document.getElementById('alertIcon');
        const okBtn = document.getElementById('alertOkBtn');
        
        // Set content
        messageEl.textContent = message;
        titleEl.textContent = options.title || 'Notice';
        iconEl.textContent = options.icon || 'ℹ️';
        okBtn.textContent = options.okText || 'OK';
        
        // Show modal
        modal.style.display = 'flex';
        
        // Handle button click
        const handleOk = () => {
          modal.style.display = 'none';
          okBtn.removeEventListener('click', handleOk);
          resolve();
        };
        
        okBtn.addEventListener('click', handleOk);
        
        // ESC key support
        const handleEsc = (e) => {
          if (e.key === 'Escape') {
            handleOk();
            document.removeEventListener('keydown', handleEsc);
          }
        };
        document.addEventListener('keydown', handleEsc);
      });
    }
    
    // Custom Prompt Dialog
    function customPrompt(message, defaultValue = '', options = {}) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customPromptModal');
        const messageEl = document.getElementById('promptMessage');
        const titleEl = document.getElementById('promptTitle');
        const inputEl = document.getElementById('promptInput');
        const okBtn = document.getElementById('promptOkBtn');
        const cancelBtn = document.getElementById('promptCancelBtn');
        
        // Set content
        messageEl.textContent = message;
        titleEl.textContent = options.title || 'Input Required';
        inputEl.value = defaultValue;
        inputEl.placeholder = options.placeholder || 'Enter value...';
        okBtn.textContent = options.okText || 'Submit';
        cancelBtn.textContent = options.cancelText || 'Cancel';
        
        // Show modal and focus input
        modal.style.display = 'flex';
        setTimeout(() => inputEl.focus(), 100);
        
        // Handle button clicks
        const handleOk = () => {
          const value = inputEl.value.trim();
          modal.style.display = 'none';
          cleanup();
          resolve(value || null);
        };
        
        const handleCancel = () => {
          modal.style.display = 'none';
          cleanup();
          resolve(null);
        };
        
        const cleanup = () => {
          okBtn.removeEventListener('click', handleOk);
          cancelBtn.removeEventListener('click', handleCancel);
          inputEl.removeEventListener('keypress', handleEnter);
        };
        
        const handleEnter = (e) => {
          if (e.key === 'Enter') handleOk();
        };
        
        okBtn.addEventListener('click', handleOk);
        cancelBtn.addEventListener('click', handleCancel);
        inputEl.addEventListener('keypress', handleEnter);
        
        // ESC key support
        const handleEsc = (e) => {
          if (e.key === 'Escape') {
            handleCancel();
            document.removeEventListener('keydown', handleEsc);
          }
        };
        document.addEventListener('keydown', handleEsc);
      });
    }
    
    // Override browser dialogs (optional - for consistency)
    window.confirm = customConfirm;
    window.alert = customAlert;
    window.prompt = customPrompt;
    
    // ============================================================================
    // 👩‍⚕️ STUDENT MANAGER - ENHANCED VERSION WITH ALL FEATURES
    // ============================================================================
    
    const STORAGE_KEY = 'students:v2';
    const WAITING_LIST_KEY = 'waiting-list';
    const STUDENT_STATUSES = {
      ACTIVE: 'active',
      PAUSED: 'paused',
      GRADUATED: 'graduated'
    };

    // Students will be loaded from Supabase on initialization
    let students = [];
    let waitingList = JSON.parse(localStorage.getItem(WAITING_LIST_KEY) || '[]');
    let selectedStudent = null;
    let editingStudentId = null;
    
    // Initialize students from Supabase when page loads
    (async function initializeStudents() {
      try {
        students = await loadStudents();
        console.log(`✅ Loaded ${students.length} students from Supabase`);
      } catch (error) {
        console.error('Error loading students on init:', error);
        students = [];
      }
    })();

    // ===== UTILITY FUNCTIONS =====
    function generateId() {
      return 'student_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function showNotificationSimple(message, type = 'info') {
      // Notification toast removed - only log to console
      const icon = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️' }[type] || 'ℹ️';
      console.log(`${icon} ${message}`);
    }

    function normalizeStatus(status) {
      if (!status) return STUDENT_STATUSES.ACTIVE;
      const lower = status.toLowerCase();
      if (lower === 'pause' || lower === 'paused') return STUDENT_STATUSES.PAUSED;
      if (lower === 'graduate' || lower === 'graduated') return STUDENT_STATUSES.GRADUATED;
      return STUDENT_STATUSES.ACTIVE;
    }

    function getStatusDetails(status) {
      const normalized = normalizeStatus(status);
      switch (normalized) {
        case STUDENT_STATUSES.PAUSED:
          return { label: 'Paused', color: '#ff9800', bg: 'rgba(255,152,0,.15)', border: 'rgba(255,152,0,.4)' };
        case STUDENT_STATUSES.GRADUATED:
          return { label: 'Graduated', color: '#2196f3', bg: 'rgba(33,150,243,.15)', border: 'rgba(33,150,243,.4)' };
        default:
          return { label: 'Active', color: '#4caf50', bg: 'rgba(76,175,80,.15)', border: 'rgba(76,175,80,.4)' };
      }
    }

    // ===== SAVE/LOAD FUNCTIONS =====
    async function saveStudents() {
      try {
        // Save all students to Supabase
        for (const student of students) {
          await saveStudent(student);
        }
        
        // Update global cache
        window.studentsCache = students;
        
        // Dispatch event for cross-module communication
        window.dispatchEvent(new CustomEvent("students:updated", { detail: students }));
        
        // Auto-backup on every student save
        try {
          const payments = await PaymentStore.fetchAll();
          const backupData = {
            timestamp: new Date().toISOString(),
            students: students,
            payments: payments,
            student_count: students.length,
            payment_count: payments.length,
            source: 'student-save'
          };
          await createAutoBackup(backupData);
        } catch (error) {
          console.error('Auto-backup from student save failed:', error);
        }
        
        console.log('Saved', students.length, 'students to Supabase');
      } catch (e) {
        console.error('Error saving students:', e);
      }
    }

    function saveWaitingList() {
      try {
        localStorage.setItem(WAITING_LIST_KEY, JSON.stringify(waitingList));
        console.log('Saved', waitingList.length, 'waiting list students');
      } catch (e) {
        console.error('Error saving waiting list:', e);
      }
    }

    async function loadStudentsFromDB() {
      try {
        const loadedStudents = await loadStudents();
        students = loadedStudents;
        return students;
      } catch (error) {
        console.error('Error loading students:', error);
        return [];
      }
    }

    // ===== CLOUD SYNC (AUTOMATIC VIA SUPABASE) =====
    async function syncWithCloud() {
      try {
        showNotificationSimple('Syncing with Supabase...');

        // Save all students to Supabase cloud database
        await saveStudents();

        showNotificationSimple('✅ Synced with Supabase', 'success');
      } catch (error) {
        console.error('Supabase sync error:', error);
        showNotificationSimple('Sync failed', 'error');
      }
    }

    // ===== OPEN/CLOSE STUDENT MANAGER =====
    function openStudentManager() {
      const menu = document.getElementById('settingsMenu');
      if (menu) menu.style.display = 'none';
      
      const modal = document.getElementById('studentManagerModal');
      
      // BEGIN POPUP BACK & EXIT FIX
      // Register with PopupManager
      window.PopupManager.register('studentManagerModal', {
        hasBackButton: false, // Top-level modal
        closeOnOutsideClick: true,
        onClose: closeStudentManager
      });
      
      // Fade in animation
      modal.style.opacity = '0';
      modal.style.display = 'block';
      
      requestAnimationFrame(() => {
        modal.style.opacity = '1';
      });
      // END POPUP BACK & EXIT FIX
      
      loadGroupsForStudentManager();
      renderStudents();
    }

    function closeStudentManager() {
      const modal = document.getElementById('studentManagerModal');
      
      // BEGIN POPUP BACK & EXIT FIX
      // Fade out before hiding
      modal.style.opacity = '0';
      
      setTimeout(() => {
        modal.style.display = 'none';
        window.PopupManager?.activePopups?.delete('studentManagerModal');
      }, 250);
      // END POPUP BACK & EXIT FIX
      
      // Close any open editing cards
      document.querySelectorAll('.student-item.editing').forEach(card => {
        card.classList.remove('editing');
      });
    }

    function closeStudentManagerOnOutsideClick(event) {
      if (event.target.id === 'studentManagerModal') {
        closeStudentManager();
      }
    }

    // ===== LOAD GROUPS FROM GROUP MANAGER =====
    function loadGroupsForStudentManager() {
      // Request groups from Group Manager
      window.dispatchEvent(new CustomEvent("groups:request"));
      
      // Load from localStorage if available
      const storedGroups = JSON.parse(localStorage.getItem('group-manager:v2') || '[]');
      if (storedGroups.length > 0) {
        groups = storedGroups;
      }
    }

    // ===== RENDER STUDENTS =====
    function renderStudents() {
      const grid = document.getElementById('studentGrid');
      if (!grid) return;
      
      grid.innerHTML = '';
      const activeStudents = students.filter(s => s.isActive !== false);
      
      // Populate group filter dropdown
      const uniqueGroups = [...new Set(activeStudents.map(s => s.group).filter(g => g))].sort();
      const groupFilter = document.getElementById('filterGroup');
      if (groupFilter) {
        groupFilter.innerHTML = '<option value="">All Groups</option>' +
          '<option value="no-group">No Group</option>' +
          uniqueGroups.map(g => `<option value="${escapeHtml(g)}">Group ${escapeHtml(g)}</option>`).join('');
      }

      // Sort students
      activeStudents.sort((a, b) => {
        if (a.group !== b.group) return (a.group || '').localeCompare(b.group || '');
        return (a.name || '').localeCompare(b.name || '');
      });

      if (activeStudents.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #6b7280; font-size: 18px;">No students found. Click "+ Add Student" to get started.</div>';
        return;
      }

      activeStudents.forEach(student => {
        try {
          grid.appendChild(createStudentCard(student));
        } catch (error) {
          console.error('Error creating card for student:', student.name, error);
        }
      });
      
      // Add click-outside-to-cancel-edit listener
      setupClickOutsideEditListener();
    }
    
    // ===== CLICK OUTSIDE TO CANCEL EDIT =====
    function setupClickOutsideEditListener() {
      // Remove existing listener if any
      if (window._studentEditClickListener) {
        document.removeEventListener('click', window._studentEditClickListener);
      }
      
      // Create new listener
      window._studentEditClickListener = function(event) {
        const editingCards = document.querySelectorAll('.student-item.editing');
        if (editingCards.length === 0) return;
        
        // Check if click is inside any editing card
        const clickedInsideCard = Array.from(editingCards).some(card => card.contains(event.target));
        
        // Check if clicked on any interactive element (button, input, select, etc.)
        const clickedInteractive = event.target.closest('button, input, textarea, select, a, label, .status-pill-single, .mini-toggle, .group-btn');
        
        // If clicked outside all editing cards and not on an interactive element, cancel all edits
        if (!clickedInsideCard && !clickedInteractive) {
          editingCards.forEach(card => {
            // Extract student ID from card ID (format: card-student_123_abc)
            const studentId = card.id.replace('card-', '');
            // Call cancelInlineEdit to properly exit edit mode
            cancelInlineEdit(studentId);
          });
        }
      };
      
      // Attach listener with capture phase to catch events before stopPropagation
      document.addEventListener('click', window._studentEditClickListener, true);
    }

    // ===== CREATE STUDENT CARD =====
    function createStudentCard(student) {
      const card = document.createElement('div');
      card.className = 'student-item';
      card.id = `card-${student.id}`;
      
      // Set data attributes for filtering
      card.setAttribute('data-student-id', student.id);
      card.setAttribute('data-name', (student.name || '').toLowerCase());
      card.setAttribute('data-group', (student.group || '').toLowerCase());
      card.setAttribute('data-phone', (student.phone || '').toLowerCase());
      card.setAttribute('data-email', (student.email || '').toLowerCase());
      card.setAttribute('data-notes', (student.notes || '').toLowerCase());
      card.setAttribute('data-status', normalizeStatus(student.status));
      card.setAttribute('data-pay', student.payPerClass || 0);
      
      const statusDetails = getStatusDetails(student.status);
      const showInGrid = student.showInGrid !== false;
      const aliases = (student.aliases && typeof student.aliases === 'string') 
        ? student.aliases.split(',').map(a => a.trim()).filter(a => a) 
        : (Array.isArray(student.aliases) ? student.aliases : []);
      
      card.innerHTML = `
        <!-- VIEW MODE -->
        <div class="student-view" onclick="toggleInlineEdit('${student.id}', event)">
          <div class="student-header">
            <div style="display: flex; gap: 8px; align-items: center;">
              <span class="status-pill-single status-${normalizeStatus(student.status)}" onclick="event.stopPropagation(); cycleStatus('${student.id}')">
                ${statusDetails.label}
              </span>
            </div>
            <label class="mini-toggle" title="${showInGrid ? 'Shown in calendar' : 'Hidden from calendar'}" onclick="event.stopPropagation()">
              <input type="checkbox" ${showInGrid ? 'checked' : ''} onchange="toggleVisibility('${student.id}', this.checked)">
              <span class="slider"></span>
            </label>
          </div>

          <div class="student-name">${escapeHtml(student.name || 'N/A')}</div>
          <div class="student-group">Group ${escapeHtml(student.group || 'N/A')}</div>

          <!-- BEGIN FEATURE 2 - Instant Group Switch Buttons -->
          <div class="group-buttons" onclick="event.stopPropagation()">
            ${['A','B','C','D','E','F'].map(g => `
              <button 
                class="group-btn ${(student.group || '').toUpperCase() === g ? 'active' : ''}" 
                onclick="changeStudentGroup('${student.id}', '${g}')"
                title="Switch to Group ${g}">${g}</button>
            `).join('')}
          </div>
          <!-- END FEATURE 2 -->

          <div class="student-info">
            <div class="info-row">
              <span class="info-label">PAY/CLASS</span>
              <span class="info-value">${formatCurrency(student.payPerClass || 0, '$')}</span>
            </div>
            <div class="info-column">
              <span class="info-label">PHONE</span>
              <span class="info-text">${escapeHtml(student.phone || 'N/A')}</span>
            </div>
            <div class="info-column">
              <span class="info-label">EMAIL</span>
              <span class="info-text">${escapeHtml(student.email || 'N/A')}</span>
            </div>
            ${aliases.length > 0 ? `
              <div class="info-column">
                <span class="info-label">ALIASES</span>
                <div class="aliases-container">
                  ${(Array.isArray(aliases) ? aliases : (aliases ? String(aliases).split(',') : []))
                    .map(alias => `<span class="alias-badge">${escapeHtml(alias.trim())}</span>`)
                    .join('')}
                </div>
              </div>
            ` : ''}
          </div>

          <div style="text-align: center; margin-top: 12px; color: #6b7280; font-size: 12px; font-style: italic;">
            Click anywhere to edit
          </div>
        </div>

        <!-- EDIT MODE -->
        <div class="student-edit">
          <div class="student-header">
            <div style="display: flex; gap: 8px; align-items: center;">
              <span class="status-pill-single status-${normalizeStatus(student.status)}" onclick="cycleStatus('${student.id}')">
                ${statusDetails.label}
              </span>
            </div>
            <label class="mini-toggle" title="${showInGrid ? 'Shown in calendar' : 'Hidden from calendar'}">
              <input type="checkbox" ${showInGrid ? 'checked' : ''} onchange="toggleVisibility('${student.id}', this.checked)">
              <span class="slider"></span>
            </label>
          </div>

          <div class="inline-form-group">
            <label>Student Name *</label>
            <input type="text" id="inline-name-${student.id}" value="${escapeHtml(student.name || '')}" onkeydown="if(event.key==='Enter'){event.preventDefault();saveInlineEdit('${student.id}');}">
          </div>

          <div class="inline-form-group">
            <label>Group(s)</label>
            <input type="text" id="inline-group-${student.id}" value="${escapeHtml(student.group || '')}" placeholder="A, B, C (optional)" onkeydown="if(event.key==='Enter'){event.preventDefault();saveInlineEdit('${student.id}');}">
          </div>

          <div class="inline-form-group">
            <label>Pay Per Class</label>
            <input type="number" id="inline-pay-${student.id}" value="${student.payPerClass || 0}" onkeydown="if(event.key==='Enter'){event.preventDefault();saveInlineEdit('${student.id}');}">
          </div>

          <div class="inline-form-group">
            <label>Phone</label>
            <input type="tel" id="inline-phone-${student.id}" value="${escapeHtml(student.phone || '')}" onkeydown="if(event.key==='Enter'){event.preventDefault();saveInlineEdit('${student.id}');}">
          </div>

          <div class="inline-form-group">
            <label>Email</label>
            <input type="email" id="inline-email-${student.id}" value="${escapeHtml(student.email || '')}" onkeydown="if(event.key==='Enter'){event.preventDefault();saveInlineEdit('${student.id}');}">
          </div>

          <div class="inline-form-group">
            <label>Aliases (comma-separated)</label>
            <input type="text" id="inline-aliases-${student.id}" value="${escapeHtml(aliases.join(', '))}" onkeydown="if(event.key==='Enter'){event.preventDefault();saveInlineEdit('${student.id}');}">
          </div>

          <div class="inline-form-group">
            <label>Notes (Ctrl+Enter to save)</label>
            <textarea id="inline-notes-${student.id}" onkeydown="if(event.key==='Enter'&&event.ctrlKey){event.preventDefault();saveInlineEdit('${student.id}');}">${escapeHtml(student.notes || '')}</textarea>
          </div>

          <div class="inline-actions">
            <button class="action-btn edit-btn" onclick="saveInlineEdit('${student.id}')" style="flex: 2;">
              Save
            </button>
            <button class="action-btn waiting-btn" onclick="moveToWaitingList('${student.id}')">
              Waiting
            </button>
            <button class="action-btn delete-btn" onclick="deleteStudent('${student.id}')">
              Delete
            </button>
          </div>
          <button class="btn btn-secondary" onclick="cancelInlineEdit('${student.id}')" style="width: 100%; margin-top: 8px; padding: 10px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-weight: 600; cursor: pointer;">
            Cancel
          </button>
        </div>
      `;
      
      return card;
    }

    // ===== FILTER STUDENTS =====
    function filterStudents() {
      const searchTerm = (document.getElementById('studentSearchInput')?.value || '').toLowerCase().trim();
      const groupFilter = document.getElementById('filterGroup')?.value || '';
      const statusFilter = document.getElementById('filterStatus')?.value || '';
      const paymentFilter = document.getElementById('filterPayment')?.value || '';
      const sortPrice = document.getElementById('sortPrice')?.value || '';

      let cards = Array.from(document.querySelectorAll('.student-item'));
      let visibleCount = 0;

      // Filter cards
      cards.forEach(card => {
        const name = card.getAttribute('data-name') || '';
        const group = card.getAttribute('data-group') || '';
        const phone = card.getAttribute('data-phone') || '';
        const email = card.getAttribute('data-email') || '';
        const notes = card.getAttribute('data-notes') || '';
        const status = card.getAttribute('data-status') || '';

        const searchMatch = searchTerm === '' ||
          name.includes(searchTerm) ||
          group.includes(searchTerm) ||
          phone.includes(searchTerm) ||
          email.includes(searchTerm) ||
          notes.includes(searchTerm);

        // Group filter
        let groupMatch = !groupFilter;
        if (groupFilter === 'no-group') {
          groupMatch = !group || group === 'n/a' || group.trim() === '';
        } else if (groupFilter) {
          groupMatch = group === groupFilter.toLowerCase();
        } else {
          groupMatch = true;
        }

        // Status filter
        const statusMatch = !statusFilter || status === statusFilter;

        // Payment filter (placeholder - requires payment data integration)
        const paymentMatch = !paymentFilter;

        if (searchMatch && groupMatch && statusMatch && paymentMatch) {
          card.style.display = 'flex';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });

      // Sort visible cards by price
      if (sortPrice) {
        const grid = document.getElementById('studentGrid');
        const visibleCards = cards.filter(card => card.style.display === 'flex');
        
        visibleCards.sort((a, b) => {
          const priceA = parseInt(a.getAttribute('data-pay') || '0');
          const priceB = parseInt(b.getAttribute('data-pay') || '0');
          
          if (sortPrice === 'highest') {
            return priceB - priceA;
          } else if (sortPrice === 'lowest') {
            return priceA - priceB;
          }
          return 0;
        });

        // Reorder DOM elements
        visibleCards.forEach(card => {
          grid.appendChild(card);
        });
      }
    }

    function clearFilters() {
      const searchInput = document.getElementById('studentSearchInput');
      const filterGroup = document.getElementById('filterGroup');
      const filterStatus = document.getElementById('filterStatus');
      const filterPayment = document.getElementById('filterPayment');
      const sortPrice = document.getElementById('sortPrice');
      
      if (searchInput) searchInput.value = '';
      if (filterGroup) filterGroup.value = '';
      if (filterStatus) filterStatus.value = '';
      if (filterPayment) filterPayment.value = '';
      if (sortPrice) sortPrice.value = '';
      
      filterStudents();
    }

    // ===== INLINE EDITING =====
    // BEGIN FEATURE 2 - Instant Group Switch Function
    function changeStudentGroup(studentId, newGroup) {
      // Prevent event bubbling
      event.stopPropagation();
      
      const student = students.find(s => s.id === studentId);
      if (!student) {
        console.error('Student not found:', studentId);
        return;
      }
      
      // Check if already in this group
      if ((student.group || '').toUpperCase() === newGroup.toUpperCase()) {
        return; // Already in this group, no action needed
      }
      
      // Update student group
      student.group = newGroup;
      
      // Save to localStorage
      saveStudents();
      
      // Show success feedback
      showNotification(`✅ ${student.name} moved to Group ${newGroup}`, 'success');
      
      // Re-render students to update UI
      renderStudents();
    }
    // END FEATURE 2

    function toggleInlineEdit(studentId, event) {
      // Don't open edit if clicking on status badge, toggle, or group buttons
      if (event && (
        event.target.closest('.status-pill-single') || 
        event.target.closest('.mini-toggle') ||
        event.target.closest('.group-btn')
      )) {
        return;
      }

      const card = document.getElementById(`card-${studentId}`);
      if (!card) return;

      // Toggle edit mode
      if (card.classList.contains('editing')) {
        card.classList.remove('editing');
        return;
      }

      // Close any other open edit cards
      document.querySelectorAll('.student-item.editing').forEach(item => {
        if (item.id !== `card-${studentId}`) {
          item.classList.remove('editing');
        }
      });

      card.classList.add('editing');
    }

    function cancelInlineEdit(studentId) {
      const card = document.getElementById(`card-${studentId}`);
      if (card) {
        card.classList.remove('editing');
      }
    }

    async function saveInlineEdit(studentId) {
      console.log('💾 saveInlineEdit called for:', studentId);
      
      const student = students.find(s => s.id === studentId);
      if (!student) {
        console.error('❌ Student not found:', studentId);
        return;
      }

      const nameInput = document.getElementById(`inline-name-${studentId}`);
      const groupInput = document.getElementById(`inline-group-${studentId}`);
      const payInput = document.getElementById(`inline-pay-${studentId}`);
      const phoneInput = document.getElementById(`inline-phone-${studentId}`);
      const emailInput = document.getElementById(`inline-email-${studentId}`);
      const aliasesInputEl = document.getElementById(`inline-aliases-${studentId}`);
      const notesInput = document.getElementById(`inline-notes-${studentId}`);
      
      if (!nameInput) {
        console.error('❌ Input elements not found for student:', studentId);
        return;
      }
      
      const name = nameInput.value.trim();
      const group = groupInput.value.trim();
      const payPerClass = parseFloat(payInput.value) || 0;
      const phone = phoneInput.value.trim();
      const email = emailInput.value.trim();
      const aliasesInput = aliasesInputEl.value.trim();
      const aliases = aliasesInput ? aliasesInput.split(',').map(a => a.trim()).filter(a => a) : [];
      const notes = notesInput.value.trim();

      if (!name) {
        showNotificationSimple('Please enter student name', 'warning');
        nameInput.focus();
        return;
      }

      student.name = name;
      student.group = group;
      student.payPerClass = payPerClass;
      student.phone = phone;
      student.email = email;
      student.aliases = aliases;
      student.notes = notes;

      saveStudents();
      renderStudents();
      showNotificationSimple('Student updated', 'success');
      
      console.log('✅ Student saved successfully');
    }

    // ===== STATUS MANAGEMENT =====
    function cycleStatus(studentId) {
      const student = students.find(s => s.id === studentId);
      if (!student) return;

      const statusCycle = {
        [STUDENT_STATUSES.ACTIVE]: STUDENT_STATUSES.PAUSED,
        [STUDENT_STATUSES.PAUSED]: STUDENT_STATUSES.GRADUATED,
        [STUDENT_STATUSES.GRADUATED]: STUDENT_STATUSES.ACTIVE
      };

      student.status = statusCycle[normalizeStatus(student.status)] || STUDENT_STATUSES.ACTIVE;

      if (student.status === STUDENT_STATUSES.PAUSED || student.status === STUDENT_STATUSES.GRADUATED) {
        student.statusChangedDate = new Date().toISOString();
      } else {
        delete student.statusChangedDate;
      }

      saveStudents();
      renderStudents();
      showNotificationSimple('Status updated', 'success');
    }

    function toggleVisibility(studentId, visible) {
      const student = students.find(s => s.id === studentId);
      if (!student) return;

      student.showInGrid = visible;
      saveStudents();
      showNotificationSimple(visible ? 'Student shown in calendar' : 'Student hidden from calendar', 'success');
    }

    // ===== ADD/EDIT STUDENT MODAL =====
    function openAddStudent() {
      editingStudentId = null;
      document.getElementById('modalTitle').textContent = 'Add New Student';
      document.getElementById('studentName').value = '';
      document.getElementById('customGroups').value = '';
      document.getElementById('studentPay').value = '';
      document.getElementById('studentPhone').value = '';
      document.getElementById('studentEmail').value = '';
      document.getElementById('studentAliases').value = '';
      document.getElementById('studentNotes').value = '';
      document.querySelectorAll('.group-select-btn').forEach(btn => btn.classList.remove('selected'));
      
      const modal = document.getElementById('studentModal');
      
      // BEGIN POPUP BACK & EXIT FIX
      // Register with PopupManager
      window.PopupManager.register('studentModal', {
        hasBackButton: true, // Sub-modal of studentManagerModal
        closeOnOutsideClick: true,
        onBack: closeStudentModal,
        parent: 'studentManagerModal'
      });
      
      // Fade in animation
      modal.style.opacity = '0';
      modal.style.display = 'flex';
      
      requestAnimationFrame(() => {
        modal.style.opacity = '1';
      });
      // END POPUP BACK & EXIT FIX
    }

    function closeStudentModal() {
      const modal = document.getElementById('studentModal');
      
      // BEGIN POPUP BACK & EXIT FIX
      // Fade out before hiding
      modal.style.opacity = '0';
      
      setTimeout(() => {
        modal.style.display = 'none';
        window.PopupManager?.activePopups?.delete('studentModal');
      }, 250);
      // END POPUP BACK & EXIT FIX
      
      editingStudentId = null;
    }

    function toggleGroup(btn, group) {
      btn.classList.toggle('selected');
    }

    async function saveStudentFromModal() {
      const name = document.getElementById('studentName').value.trim();
      const payPerClass = parseFloat(document.getElementById('studentPay').value) || 0;
      const phone = document.getElementById('studentPhone').value.trim();
      const email = document.getElementById('studentEmail').value.trim();
      const notes = document.getElementById('studentNotes').value.trim();
      const aliasesInput = document.getElementById('studentAliases').value.trim();
      const aliases = aliasesInput ? aliasesInput.split(',').map(a => a.trim()).filter(a => a) : [];

      // Get selected groups
      const selectedGroups = Array.from(document.querySelectorAll('.group-select-btn.selected'))
        .map(btn => btn.textContent.trim());
      const customGroups = document.getElementById('customGroups').value.trim();
      const allGroups = customGroups ? customGroups.split(',').map(g => g.trim()).filter(g => g) : selectedGroups;
      const group = allGroups.join(', ');

      if (!name) {
        await customAlert('Please enter student name', {
          title: 'Missing Information',
          icon: '⚠️'
        });
        return;
      }

      let savedStudent;
      
      if (editingStudentId) {
        const student = students.find(s => s.id === editingStudentId);
        if (student) {
          student.name = name;
          student.group = group;
          student.payPerClass = payPerClass;
          student.phone = phone;
          student.email = email;
          student.aliases = aliases;
          student.notes = notes;
          savedStudent = student;
        }
      } else {
        // For new students, create without ID - let Supabase generate it
        const newStudent = {
          name,
          group,
          payPerClass,
          phone,
          email,
          aliases,
          notes,
          status: STUDENT_STATUSES.ACTIVE,
          showInGrid: true,
          isActive: true,
          createdAt: new Date().toISOString()
        };
        savedStudent = newStudent;
      }

      const savedRecord = await saveStudent(savedStudent);

      if (!savedRecord) {
        showNotificationSimple('Error saving student', 'error');
        return;
      }

      console.log('✅ Student saved to Supabase:', savedRecord);
      
      // If this was a new student, update local array with Supabase-generated ID
      if (!editingStudentId) {
        const studentWithId = {
          ...savedStudent,
          id: savedRecord.id, // Use Supabase-generated ID
          group: savedRecord.group_name,
          payPerClass: savedRecord.price_per_class
        };
        students.push(studentWithId);
      }
      
      // Update global cache
      window.studentsCache = students;
      
      // Dispatch event
      window.dispatchEvent(new CustomEvent("students:updated", { detail: students }));
      
      renderStudents();
      closeStudentModal();
      showNotificationSimple(editingStudentId ? 'Student updated' : 'Student added', 'success');
    }

    async function deleteStudent(studentId) {
      const student = students.find(s => s.id === studentId);
      if (!student) return;

      const confirmed = await customConfirm(
        `Delete ${student.name}?\n\nThis will permanently remove all records.`,
        {
          title: 'Delete Student',
          icon: '🗑️',
          okText: 'Delete',
          type: 'danger'
        }
      );
      
      if (!confirmed) return;

      const deleted = await deleteStudentRecord(studentId);
      if (!deleted) {
        showNotificationSimple('Failed to delete student', 'error');
        return;
      }

      students = students.filter(s => s.id !== studentId);
      window.studentsCache = students;
      window.dispatchEvent(new CustomEvent('students:updated', { detail: students }));

      try {
        const payments = await PaymentStore.fetchAll();
        const backupData = {
          timestamp: new Date().toISOString(),
          students,
          payments,
          student_count: students.length,
          payment_count: payments.length,
          source: 'student-delete'
        };
        await createAutoBackup(backupData);
      } catch (error) {
        console.error('Auto-backup after student delete failed:', error);
      }

      renderStudents();
      showNotificationSimple('Student deleted', 'success');
    }

    // BEGIN BULK ADD STUDENTS FEATURE
    // ===== BULK ADD STUDENTS =====
    function openBulkAddStudents() {
      const modal = document.getElementById('bulkAddStudentsModal');
      const input = document.getElementById('bulkStudentInput');
      const validationMsg = document.getElementById('bulkAddValidationMessage');
      
      if (!modal || !input) {
        console.error('Bulk add students modal elements not found');
        return;
      }
      
      // Reset state
      input.value = '';
      validationMsg.style.display = 'none';
      validationMsg.textContent = '';
      
      // Fade in animation
      modal.style.opacity = '0';
      modal.style.display = 'flex';
      
      requestAnimationFrame(() => {
        modal.style.opacity = '1';
      });
      
      // Focus input after modal opens
      setTimeout(() => input.focus(), 100);
    }
    
    function closeBulkAddStudents() {
      const modal = document.getElementById('bulkAddStudentsModal');
      if (!modal) return;
      
      // Fade out animation
      modal.style.opacity = '0';
      
      setTimeout(() => {
        modal.style.display = 'none';
      }, 250);
    }
    
    function parseBulkStudentLine(line) {
      try {
        // BEGIN BULK ADD STUDENTS FEATURE - FLEXIBLE PARSING
        // Support multiple formats:
        // Format 1: Name - John Doe (Alias), Email - john@example.com, Phone N - 123-456-7890, Group N - A, Pay per class - $100
        // Format 2: John Doe, john@example.com, 123-456-7890, A, $100
        // Format 3: John Doe (Alias), john@example.com, (123)456-7890, A, $100
        
        line = line.trim();
        if (!line) return { error: 'Empty line' };
        
        // Try labeled format first
        const labeledNameMatch = line.match(/Name\s*-\s*([^(,]+?)(?:\s*\(([^)]+)\))?(?:,|$)/i);
        const labeledEmailMatch = line.match(/Email\s*-\s*([^,]+)/i);
        const labeledPhoneMatch = line.match(/Phone\s*N?\s*-\s*([^,]+)/i);
        const labeledGroupMatch = line.match(/Group\s*N?\s*-\s*([^,]+)/i);
        const labeledPayMatch = line.match(/Pay\s*per\s*class\s*-\s*\$?([0-9.]+)/i);
        
        if (labeledNameMatch) {
          // Labeled format detected
          const name = labeledNameMatch[1].trim();
          const alias = labeledNameMatch[2] ? labeledNameMatch[2].trim() : '';
          const email = labeledEmailMatch ? labeledEmailMatch[1].trim() : '';
          const phone = labeledPhoneMatch ? labeledPhoneMatch[1].trim() : '';
          const group = labeledGroupMatch ? labeledGroupMatch[1].trim() : '';
          const payPerClass = labeledPayMatch ? parseFloat(labeledPayMatch[1]) : 0;
          
          return { name, alias, email, phone, group, payPerClass, valid: true };
        }
        
        // Try comma-separated format (more flexible)
        const parts = line.split(',').map(p => p.trim());
        
        if (parts.length < 2) {
          return { error: 'Insufficient data - need at least name and one other field' };
        }
        
        // Extract name (first part, may contain alias in parentheses)
        let name = parts[0];
        let alias = '';
        
        const aliasMatch = name.match(/^([^(]+?)\s*\(([^)]+)\)$/);
        if (aliasMatch) {
          name = aliasMatch[1].trim();
          alias = aliasMatch[2].trim();
        }
        
        if (!name) {
          return { error: 'Missing name' };
        }
        
        // Identify remaining parts by pattern matching
        let email = '';
        let phone = '';
        let group = '';
        let payPerClass = 0;
        
        for (let i = 1; i < parts.length; i++) {
          const part = parts[i];
          
          // Check if it's an email (contains @ and .)
          if (part.includes('@') && part.includes('.')) {
            email = part;
            continue;
          }
          
          // Check if it's a price (contains $ or is just a number > 10)
          const priceMatch = part.match(/\$?([0-9.]+)/);
          if (priceMatch) {
            const numValue = parseFloat(priceMatch[1]);
            if (part.includes('$') || numValue >= 10) {
              payPerClass = numValue;
              continue;
            }
          }
          
          // Check if it's a phone number (contains digits and ()-. or is numeric)
          if (/[\d\-\(\)\.]{7,}/.test(part) || /^\+?\d+$/.test(part.replace(/[\s\-\(\)\.]/g, ''))) {
            phone = part;
            continue;
          }
          
          // Check if it's a single letter or short string (likely a group)
          if (part.length <= 3 && /^[A-Za-z0-9]+$/.test(part)) {
            group = part;
            continue;
          }
          
          // If nothing else matched and it's short, assume it's a group
          if (part.length <= 10) {
            group = part;
          }
        }
        
        return {
          name,
          alias,
          email,
          phone,
          group,
          payPerClass,
          valid: true
        };
        // END BULK ADD STUDENTS FEATURE - FLEXIBLE PARSING
      } catch (error) {
        console.error('Error parsing line:', error);
        return { error: 'Parse error: ' + error.message };
      }
    }
    
    function checkDuplicateStudent(newStudent, existingStudents) {
      // Check for duplicates based on name + email + group combination
      return existingStudents.some(existing => {
        const nameMatch = existing.name.toLowerCase() === newStudent.name.toLowerCase();
        const emailMatch = existing.email && newStudent.email && 
                          existing.email.toLowerCase() === newStudent.email.toLowerCase();
        const groupMatch = existing.group === newStudent.group;
        
        return nameMatch && (emailMatch || groupMatch);
      });
    }
    
    async function processBulkAddStudents() {
      const input = document.getElementById('bulkStudentInput');
      const validationMsg = document.getElementById('bulkAddValidationMessage');
      
      if (!input || !validationMsg) {
        console.error('Bulk add input elements not found');
        return;
      }
      
      const rawText = input.value.trim();
      
      if (!rawText) {
        validationMsg.style.display = 'block';
        validationMsg.style.background = 'rgba(239, 68, 68, 0.15)';
        validationMsg.style.border = '1px solid rgba(239, 68, 68, 0.3)';
        validationMsg.style.color = '#ef4444';
        validationMsg.textContent = '⚠️ Please paste student records before clicking Add Students.';
        return;
      }
      
      try {
        // Split by newlines or semicolons
        const lines = rawText.split(/[\n;]/).filter(line => line.trim());
        
        if (lines.length === 0) {
          validationMsg.style.display = 'block';
          validationMsg.style.background = 'rgba(239, 68, 68, 0.15)';
          validationMsg.style.border = '1px solid rgba(239, 68, 68, 0.3)';
          validationMsg.style.color = '#ef4444';
          validationMsg.textContent = '⚠️ No valid student records found.';
          return;
        }
        
        const parsedStudents = [];
        const skippedLines = [];
        const duplicateLines = [];
        
        // Deep clone existing students array to avoid mutations
        const existingStudents = JSON.parse(JSON.stringify(students));
        
        lines.forEach((line, index) => {
          const parsed = parseBulkStudentLine(line);
          
          if (parsed.error || !parsed.valid) {
            skippedLines.push({ line: index + 1, reason: parsed.error || 'Invalid format' });
            return;
          }
          
          // Check for duplicates
          if (checkDuplicateStudent(parsed, existingStudents)) {
            duplicateLines.push({ line: index + 1, name: parsed.name });
            return;
          }
          
          // Add to parsed list
          parsedStudents.push(parsed);
          
          // Add to temporary existing list to check subsequent entries
          existingStudents.push(parsed);
        });
        
        if (parsedStudents.length === 0) {
          let errorMessage = '⚠️ No students could be added.';
          if (skippedLines.length > 0) {
            errorMessage += ` ${skippedLines.length} lines skipped due to errors.`;
          }
          if (duplicateLines.length > 0) {
            errorMessage += ` ${duplicateLines.length} duplicates found.`;
          }
          
          validationMsg.style.display = 'block';
          validationMsg.style.background = 'rgba(239, 68, 68, 0.15)';
          validationMsg.style.border = '1px solid rgba(239, 68, 68, 0.3)';
          validationMsg.style.color = '#ef4444';
          validationMsg.textContent = errorMessage;
          return;
        }
        
        // Atomic batch update - add all students at once
        const newStudents = parsedStudents.map(parsed => ({
          id: generateId(),
          name: parsed.name,
          group: parsed.group,
          payPerClass: parsed.payPerClass,
          phone: parsed.phone,
          email: parsed.email,
          aliases: parsed.alias ? [parsed.alias] : [],
          notes: '',
          status: STUDENT_STATUSES.ACTIVE,
          showInGrid: true,
          isActive: true,
          createdAt: new Date().toISOString()
        }));
        
        // Validate array integrity before writing
        if (!Array.isArray(newStudents) || newStudents.some(s => !s.id || !s.name)) {
          throw new Error('Data validation failed - invalid student records');
        }
        
        // Append to existing students array
        students.push(...newStudents);
        
        // Save to localStorage
        saveStudents();
        
        // Refresh UI
        renderStudents();
        
        // Dispatch custom event for potential external listeners
        window.dispatchEvent(new CustomEvent('bulkAddStudents:complete', { 
          detail: { 
            added: newStudents.length,
            skipped: skippedLines.length,
            duplicates: duplicateLines.length
          } 
        }));
        
        // Show success message
        let successMessage = `✅ Successfully added ${newStudents.length} student${newStudents.length > 1 ? 's' : ''}.`;
        
        if (skippedLines.length > 0 || duplicateLines.length > 0) {
          successMessage += ' ';
          if (skippedLines.length > 0) {
            successMessage += `${skippedLines.length} skipped. `;
          }
          if (duplicateLines.length > 0) {
            successMessage += `${duplicateLines.length} duplicate${duplicateLines.length > 1 ? 's' : ''} ignored.`;
          }
          
          validationMsg.style.display = 'block';
          validationMsg.style.background = 'rgba(251, 146, 60, 0.15)';
          validationMsg.style.border = '1px solid rgba(251, 146, 60, 0.3)';
          validationMsg.style.color = '#fb923c';
          validationMsg.textContent = successMessage;
        } else {
          validationMsg.style.display = 'block';
          validationMsg.style.background = 'rgba(34, 197, 94, 0.15)';
          validationMsg.style.border = '1px solid rgba(34, 197, 94, 0.3)';
          validationMsg.style.color = '#22c55e';
          validationMsg.textContent = successMessage;
        }
        
        showNotificationSimple(`Bulk added ${newStudents.length} students`, 'success');
        
        // Clear input and close modal after success
        setTimeout(() => {
          closeBulkAddStudents();
        }, 1500);
        
      } catch (error) {
        console.error('Bulk add students error:', error);
        
        validationMsg.style.display = 'block';
        validationMsg.style.background = 'rgba(239, 68, 68, 0.15)';
        validationMsg.style.border = '1px solid rgba(239, 68, 68, 0.3)';
        validationMsg.style.color = '#ef4444';
        validationMsg.textContent = `❌ Error: ${error.message}. No students were added.`;
      }
    }
    // END BULK ADD STUDENTS FEATURE

    // ===== WAITING LIST =====
    function openWaitingList() {
      const content = document.getElementById('waitingListContent');

      if (waitingList.length === 0) {
        content.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #6b7280;">No students on waiting list</div>';
      } else {
        content.innerHTML = waitingList.map(student => `
          <div class="student-item" style="background: linear-gradient(135deg, rgba(168,85,247,.08), rgba(147,51,234,.08)); border: 2px solid rgba(168,85,247,.3);">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
              <div style="font-size: 20px; font-weight: 700; color: #f3f4f6;">${escapeHtml(student.fullName || 'N/A')}</div>
              <button onclick="removeFromWaitingList('${student.id}')" style="background: rgba(244,67,54,.15); border: 2px solid #f44336; color: #f44336; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 16px;" title="Remove from waiting list">×</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
              <div class="info-column">
                <span class="info-label">EMAIL</span>
                <span class="info-text">${escapeHtml(student.email || 'N/A')}</span>
              </div>
              <div class="info-column">
                <span class="info-label">PHONE</span>
                <span class="info-text">${escapeHtml(student.phone || 'N/A')}</span>
              </div>
              ${student.language ? `
                <div class="info-column">
                  <span class="info-label">LANGUAGE</span>
                  <span class="info-text">${escapeHtml(student.language)}</span>
                </div>
              ` : ''}
              ${student.startDate ? `
                <div class="info-column">
                  <span class="info-label">START DATE</span>
                  <span class="info-text">${new Date(student.startDate).toLocaleDateString()}</span>
                </div>
              ` : ''}
              ${student.notes ? `
                <div class="info-column">
                  <span class="info-label">NOTES</span>
                  <span class="info-text">${escapeHtml(student.notes)}</span>
                </div>
              ` : ''}
              <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
                Added: ${new Date(student.addedDate).toLocaleDateString()}
              </div>
            </div>
          </div>
        `).join('');
      }

      document.getElementById('waitingListModal').style.display = 'flex';
      
      // BEGIN POPUP BACK & EXIT FIX
      const modal = document.getElementById('waitingListModal');
      
      // Register with PopupManager
      window.PopupManager.register('waitingListModal', {
        hasBackButton: false, // Top-level modal
        closeOnOutsideClick: true,
        onClose: closeWaitingList
      });
      
      // Fade in animation
      modal.style.opacity = '0';
      requestAnimationFrame(() => {
        modal.style.opacity = '1';
      });
      // END POPUP BACK & EXIT FIX
    }

    function closeWaitingList() {
      const modal = document.getElementById('waitingListModal');
      
      // BEGIN POPUP BACK & EXIT FIX
      // Fade out before hiding
      modal.style.opacity = '0';
      
      setTimeout(() => {
        modal.style.display = 'none';
        window.PopupManager?.activePopups?.delete('waitingListModal');
      }, 250);
      // END POPUP BACK & EXIT FIX
    }

    function openAddWaitingList() {
      document.getElementById('waitingListModal').style.display = 'none';
      document.getElementById('waitingListFullName').value = '';
      document.getElementById('waitingListEmail').value = '';
      document.getElementById('waitingListPhone').value = '';
      document.getElementById('waitingListLanguage').value = '';
      document.getElementById('waitingListStartDate').value = '';
      document.getElementById('waitingListNotes').value = '';
      
      const modal = document.getElementById('addWaitingListModal');
      
      // BEGIN POPUP BACK & EXIT FIX
      // Register with PopupManager
      window.PopupManager.register('addWaitingListModal', {
        hasBackButton: true, // Sub-modal of waitingListModal
        closeOnOutsideClick: true,
        onBack: closeAddWaitingList,
        parent: 'waitingListModal'
      });
      
      // Fade in animation
      modal.style.opacity = '0';
      modal.style.display = 'flex';
      
      requestAnimationFrame(() => {
        modal.style.opacity = '1';
      });
      // END POPUP BACK & EXIT FIX
    }

    function closeAddWaitingList() {
      const modal = document.getElementById('addWaitingListModal');
      
      // BEGIN POPUP BACK & EXIT FIX
      // Fade out before hiding
      modal.style.opacity = '0';
      
      setTimeout(() => {
        modal.style.display = 'none';
        window.PopupManager?.activePopups?.delete('addWaitingListModal');
      }, 250);
      // END POPUP BACK & EXIT FIX
    }

    async function saveWaitingListStudent() {
      const fullName = document.getElementById('waitingListFullName').value.trim();
      const email = document.getElementById('waitingListEmail').value.trim();
      const phone = document.getElementById('waitingListPhone').value.trim();
      const language = document.getElementById('waitingListLanguage').value.trim();
      const startDate = document.getElementById('waitingListStartDate').value;
      const notes = document.getElementById('waitingListNotes').value.trim();

      if (!fullName || !email || !phone) {
        await customAlert('Please fill in all required fields (Name, Email, Phone)', {
          title: 'Missing Information',
          icon: '⚠️'
        });
        return;
      }

      waitingList.push({
        id: 'waiting-' + Date.now(),
        fullName,
        email,
        phone,
        language,
        startDate,
        notes,
        addedDate: new Date().toISOString()
      });

      saveWaitingList();
      closeAddWaitingList();
      openWaitingList();
      showNotificationSimple('Student added to waiting list', 'success');
    }

    async function removeFromWaitingList(id) {
      const confirmed = await customConfirm(
        'Remove this student from the waiting list?',
        {
          title: 'Remove from Waiting List',
          icon: '📋',
          okText: 'Remove'
        }
      );
      
      if (!confirmed) return;

      waitingList = waitingList.filter(s => s.id !== id);
      saveWaitingList();
      openWaitingList();
      showNotificationSimple('Student removed from waiting list', 'success');
    }

    async function moveToWaitingList(studentId) {
      const student = students.find(s => s.id === studentId);
      if (!student) return;

      const confirmed = await customConfirm(
        `Move ${student.name} to waiting list?\n\nThis will set their status to Paused.`,
        {
          title: 'Move to Waiting List',
          icon: '📋',
          okText: 'Move'
        }
      );
      
      if (!confirmed) return;

      student.status = STUDENT_STATUSES.PAUSED;
      student.statusChangedDate = new Date().toISOString();

      waitingList.push({
        id: 'waiting-' + Date.now(),
        fullName: student.name,
        email: student.email || '',
        phone: student.phone || '',
        language: '',
        startDate: '',
        notes: student.notes || '',
        addedDate: new Date().toISOString(),
        originalStudentId: student.id
      });

      saveStudents();
      saveWaitingList();
      renderStudents();
      showNotificationSimple(`${student.name} moved to waiting list`, 'success');
    }

    // ===== DUPLICATE DETECTION =====
    function findDuplicates() {
      const duplicateGroups = [];
      const processed = new Set();

      students.filter(s => s.isActive !== false).forEach((student, index, arr) => {
        if (processed.has(student.id)) return;

        const matches = [];

        arr.forEach((otherStudent, otherIndex) => {
          if (index === otherIndex || processed.has(otherStudent.id)) return;

          const name1 = (student.name || '').toLowerCase().trim().replace(/\s+/g, ' ');
          const name2 = (otherStudent.name || '').toLowerCase().trim().replace(/\s+/g, ' ');
          const email1 = (student.email || '').toLowerCase().trim();
          const email2 = (otherStudent.email || '').toLowerCase().trim();

          const namesMatch = name1 === name2 ||
            (name1.includes(name2) && name2.length > 3) ||
            (name2.includes(name1) && name1.length > 3);
          const emailsMatch = email1 && email2 && email1 === email2;

          if (namesMatch || emailsMatch) {
            matches.push(otherStudent);
            processed.add(otherStudent.id);
          }
        });

        if (matches.length > 0) {
          processed.add(student.id);
          duplicateGroups.push({
            primary: student,
            duplicates: matches
          });
        }
      });

      displayDuplicates(duplicateGroups);
    }

    function displayDuplicates(duplicateGroups) {
      const content = document.getElementById('duplicatesContent');

      if (duplicateGroups.length === 0) {
        content.innerHTML = `
          <div style="text-align: center; padding: 60px 20px;">
            <h3 style="color: #8ab4ff; margin-bottom: 10px; font-size: 24px;">No Duplicates Found</h3>
            <p style="color: #6b7280;">All student records appear to be unique.</p>
          </div>
        `;
      } else {
        content.innerHTML = `
          <div style="background: linear-gradient(135deg, rgba(251,146,60,.15), rgba(249,115,22,.15)); padding: 20px; border-radius: 12px; border: 2px solid rgba(251,146,60,.3); margin-bottom: 25px;">
            <h3 style="margin: 0 0 6px 0; color: #fb923c; font-size: 18px;">Found ${duplicateGroups.length} Potential Duplicate${duplicateGroups.length > 1 ? 's' : ''}</h3>
            <p style="margin: 0; color: rgba(255,255,255,0.8); font-size: 14px;">Review and merge duplicate student records to keep your data clean.</p>
          </div>
          ${duplicateGroups.map((group, groupIndex) => `
            <div style="background: rgba(255,255,255,.04); border: 2px solid rgba(138,180,255,.15); border-radius: 16px; padding: 24px; margin-bottom: 20px;">
              <h3 style="color: #8ab4ff; margin: 0 0 20px 0; font-size: 18px;">
                <span style="background: #8ab4ff; color: white; width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; margin-right: 10px;">${groupIndex + 1}</span>
                Duplicate Group
              </h3>

              ${[group.primary, ...group.duplicates].map((student, index) => {
                const isPrimary = index === 0;
                return `
                  <div style="background: ${isPrimary ? 'rgba(138,180,255,.12)' : 'rgba(255,255,255,.03)'}; border: 2px solid ${isPrimary ? '#8ab4ff' : 'rgba(255,255,255,.08)'}; border-radius: 12px; padding: 18px; margin-bottom: 12px; position: relative;">
                    ${isPrimary ? '<div style="position: absolute; top: -10px; left: 20px; background: #8ab4ff; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700;">PRIMARY</div>' : ''}

                    <div style="display: flex; justify-content: space-between; align-items: start; margin-top: ${isPrimary ? '10px' : '0'};">
                      <div style="flex: 1;">
                        <div style="font-size: 18px; font-weight: 700; color: white; margin-bottom: 12px;">${escapeHtml(student.name)}</div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                          <div>
                            <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">GROUP</div>
                            <div style="font-size: 14px; color: white;">${student.group || 'N/A'}</div>
                          </div>
                          <div>
                            <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">EMAIL</div>
                            <div style="font-size: 14px; color: white;">${student.email || 'N/A'}</div>
                          </div>
                          <div>
                            <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">PHONE</div>
                            <div style="font-size: 14px; color: white;">${student.phone || 'N/A'}</div>
                          </div>
                          <div>
                            <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">PAY/CLASS</div>
                            <div style="font-size: 14px; color: white;">${formatCurrency(student.payPerClass || 0, '$')}</div>
                          </div>
                        </div>

                        ${student.notes ? `
                          <div style="margin-top: 12px;">
                            <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 4px;">NOTES</div>
                            <div style="font-size: 13px; color: rgba(255,255,255,0.8);">${escapeHtml(student.notes)}</div>
                          </div>
                        ` : ''}
                      </div>

                      ${!isPrimary ? `
                        <button onclick="mergeDuplicates('${group.primary.id}', '${student.id}')" style="padding: 10px 16px; background: linear-gradient(135deg, #4ade80, #22c55e); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 13px; white-space: nowrap; margin-left: 16px; box-shadow: 0 4px 12px rgba(34,197,94,0.3);">
                          Merge into Primary
                        </button>
                      ` : ''}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `).join('')}
        `;
      }

      document.getElementById('duplicatesModal').style.display = 'flex';
    }

    function closeDuplicatesModal() {
      document.getElementById('duplicatesModal').style.display = 'none';
    }

    async function mergeDuplicates(primaryId, duplicateId) {
      const primary = students.find(s => s.id === primaryId);
      const duplicate = students.find(s => s.id === duplicateId);

      if (!primary || !duplicate) {
        showNotificationSimple('Student not found', 'error');
        return;
      }

      const confirmed = await customConfirm(
        `Merge "${duplicate.name}" into "${primary.name}"?\n\nThis will transfer all information and delete the duplicate entry.\n\nThis action cannot be undone.`,
        {
          title: 'Merge Duplicates',
          icon: '⚠️',
          okText: 'Merge',
          type: 'danger'
        }
      );
      
      if (!confirmed) {
        return;
      }

      // Merge missing information
      if (!primary.email && duplicate.email) primary.email = duplicate.email;
      if (!primary.phone && duplicate.phone) primary.phone = duplicate.phone;
      if (!primary.notes && duplicate.notes) {
        primary.notes = duplicate.notes;
      } else if (duplicate.notes && primary.notes !== duplicate.notes) {
        primary.notes += '\n[Merged]: ' + duplicate.notes;
      }

      // Merge groups
      const primaryGroups = new Set((primary.group || '').split(',').map(g => g.trim()).filter(g => g));
      const duplicateGroups = (duplicate.group || '').split(',').map(g => g.trim()).filter(g => g);
      duplicateGroups.forEach(g => primaryGroups.add(g));
      primary.group = Array.from(primaryGroups).join(', ');

      // Merge aliases
      if (duplicate.aliases && duplicate.aliases.length > 0) {
        if (!primary.aliases) primary.aliases = [];
        duplicate.aliases.forEach(alias => {
          if (!primary.aliases.includes(alias)) {
            primary.aliases.push(alias);
          }
        });
      }

      // Mark duplicate as inactive
      duplicate.isActive = false;

      saveStudents();
      showNotificationSimple(`Merged "${duplicate.name}" into "${primary.name}"`, 'success');

      setTimeout(() => {
        findDuplicates();
      }, 500);
    }

    // ===== EVENT LISTENERS FOR INTEGRATION =====
    
    // Listen for group updates from Group Manager
    window.addEventListener("groups:updated", function(event) {
      if (event.detail) {
        groups = event.detail;
        
        // Refresh student display if Student Manager is open
        if (document.getElementById('studentManagerModal')?.style.display === 'block') {
          renderStudents();
        }
      }
    });

    // Listen for payment updates from Payment Records
    window.addEventListener("payments:updated", function(event) {
      // Can be used to update payment indicators in the future
    });

    // Listen for requests to open student manager with specific filter
    window.addEventListener("openStudentManager:withFilter", function(event) {
      openStudentManager();
      if (event.detail?.name) {
        const searchInput = document.getElementById('studentSearchInput');
        if (searchInput) {
          searchInput.value = event.detail.name;
          filterStudents();
        }
      }
    });

    // Click outside to close editing
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.student-item')) {
        document.querySelectorAll('.student-item.editing').forEach(card => {
          card.classList.remove('editing');
        });
      }
    });

    // ===== INITIALIZE GLOBAL DATA =====
    if (!window.globalData) window.globalData = {};
    window.globalData.students = students;

    // ============================================================================
    let selectedGroupDays = [];
    // ============================================================================
    // 📚 GROUP MANAGER - EXACT STANDALONE VERSION
    // ============================================================================
    
    // Groups will be loaded from Supabase on initialization
    let groups = [];
    let countdownTimer;
    
    // Initialize groups from Supabase when page loads
    (async function initializeGroups() {
      try {
        groups = await loadGroupsFromSupabase();
        console.log(`✅ Loaded ${groups.length} groups from Supabase`);
      } catch (error) {
        console.error('Error loading groups on init:', error);
        groups = [];
      }
    })();

    // ===== OPEN/CLOSE GROUP MANAGER =====
    function openGroupManager() {
      const modal = document.getElementById('groupManagerModal');
      document.getElementById('settingsMenu').style.display = 'none';
      
      // BEGIN POPUP BACK & EXIT FIX
      // Register with PopupManager
      window.PopupManager.register('groupManagerModal', {
        hasBackButton: false, // Top-level modal
        closeOnOutsideClick: true,
        onClose: closeGroupManager
      });
      
      // Fade in animation
      modal.style.opacity = '0';
      modal.style.display = 'block';
      
      requestAnimationFrame(() => {
        modal.style.opacity = '1';
      });
      // END POPUP BACK & EXIT FIX
      
      renderGroups();
    }
    
    function closeGroupManager() {
      const modal = document.getElementById('groupManagerModal');
      
      // BEGIN POPUP BACK & EXIT FIX
      // Fade out before hiding
      modal.style.opacity = '0';
      
      setTimeout(() => {
        modal.style.display = 'none';
        window.PopupManager?.activePopups?.delete('groupManagerModal');
      }, 250);
      // END POPUP BACK & EXIT FIX
      
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
    }
    
    function closeGroupManagerOnOutsideClick(event) {
      if (event.target.id === 'groupManagerModal') {
        closeGroupManager();
      }
    }
    
    // ===== RENDER GROUP CARDS =====
    function renderGroups() {
      const grid = document.getElementById('groupGrid');
      if (!grid) return;
      grid.innerHTML = '';
      
      if (groups.length === 0) {
        grid.innerHTML = '<div style="text-align:center;padding:60px 20px;color:#94a3b8;grid-column:1/-1;"><div style="font-size:48px;margin-bottom:16px;opacity:0.5;">📚</div><p style="font-size:16px;">No groups yet. Click "+ Add Group" to get started.</p></div>';
        return;
      }
      
      // Sort groups alphabetically by name
      const sortedGroups = [...groups].sort((a, b) => {
        const nameA = String(a.name || '').toUpperCase();
        const nameB = String(b.name || '').toUpperCase();
        return nameA.localeCompare(nameB);
      });
      
      sortedGroups.forEach(group => {
        const card = document.createElement('div');
        card.className = 'group-card';
        card.innerHTML = `
          <div class="group-title">
            <span>${escapeHtml(group.name)}</span>
          </div>
          <div class="schedule-display">
            ${group.schedule ? renderScheduleSlots(group.schedule) : '<em style="color:#94a3b8;font-size:0.9rem;">No schedule set</em>'}
          </div>
          <div class="group-actions">
            <button onclick="editGroupSchedule('${escapeHtml(group.name)}')">✏️ Edit Schedule</button>
            <button onclick="deleteGroup('${escapeHtml(group.name)}')">🗑️ Delete</button>
          </div>
        `;
        grid.appendChild(card);
      });
      updateScheduleItemStates();
    }

    // ===== RENDER SLOT CHIPS =====
    function renderScheduleSlots(scheduleStr) {
      return scheduleStr.split(',').map(slot => {
        const parts = slot.trim().split(' ');
        const day = parts[0] || '';
        const time = parts.slice(1).join(' ') || '';
        return `<div class="schedule-item" data-day="${day}" data-time="${time}">
          <div>${slot.trim()}</div>
        </div>`;
      }).join('');
    }

    // ===== ADD GROUP =====
    async function addNewGroup() {
      const name = await customPrompt('Enter group name:', '', {
        title: 'Add Group',
        icon: '➕',
        okText: 'Add Group'
      });
      
      if (!name) return;
      
      if (groups.some(g => g.name === name)) {
        await customAlert('Group name already exists!', {
          title: 'Duplicate Group',
          icon: '⚠️'
        });
        return;
      }
      // Persist only the new group to Supabase to get an id
      const saved = await saveGroup({ name, schedule: '' });
      if (saved && saved.id) {
        groups.push({ id: saved.id, name: saved.group_name || name, schedule: saved.schedule || '' });
        // Update cache and notify
        window.groupsCache = groups;
        window.dispatchEvent(new CustomEvent("groups:updated", { detail: groups }));
        window.dispatchEvent(new CustomEvent("schedules:updated", { detail: groups }));
        showToast('✅ Group Added');
        renderGroups();
      } else {
        await customAlert('Could not save group. Please try again.');
      }
    }

    // ===== DELETE GROUP =====
    async function deleteGroup(name) {
      const confirmed = await customConfirm(
        `Delete group "${name}"?\n\nThis action cannot be undone.`,
        {
          title: 'Delete Group',
          icon: '🗑️',
          okText: 'Delete',
          type: 'danger'
        }
      );
      
      if (!confirmed) return;
      // Collect ids of matching groups to delete exact rows
      const idsToDelete = groups.filter(g => g.name === name && g.id).map(g => g.id);
      try {
        if (idsToDelete.length > 0) {
          const { error } = await supabase.from('groups').delete().in('id', idsToDelete);
          if (error) console.error('❌ Error deleting groups by id:', error);
        } else {
          // Fallback: delete by group_name
          const { error } = await supabase.from('groups').delete().eq('group_name', name);
          if (error) console.error('❌ Error deleting groups by name:', error);
        }
      } catch (e) {
        console.error('❌ Delete operation failed:', e);
      }
      // Update local state
      groups = groups.filter(g => g.name !== name);
      window.groupsCache = groups;
      window.dispatchEvent(new CustomEvent("groups:updated", { detail: groups }));
      window.dispatchEvent(new CustomEvent("schedules:updated", { detail: groups }));
      showToast('🗑️ Group Deleted');
      renderGroups();
    }

    // ===== EDIT SCHEDULE =====
    function editGroupSchedule(groupName) {
      const grid = document.getElementById('groupGrid');
      grid.querySelectorAll('.schedule-editor').forEach(el => el.remove());
      const group = groups.find(g => g.name === groupName);
      if (!group) return;
      
      const card = [...grid.children].find(c => {
        const titleSpan = c.querySelector('.group-title span');
        return titleSpan && titleSpan.textContent === groupName;
      });
      
      if (!card) return;
      
      const editor = document.createElement('div');
      editor.className = 'schedule-editor';
      editor.innerHTML = `
        <h4 style="color:#a855f7;margin:0 0 12px 0;font-size:1rem;">Edit Schedule for ${escapeHtml(groupName)}</h4>
        <div id="scheduleItems"></div>
        <button onclick="addScheduleItem()" style="width:100%;padding:8px;margin:10px 0;background:rgba(168,85,247,0.2);border:2px dashed rgba(168,85,247,0.5);border-radius:8px;color:#a855f7;font-weight:600;cursor:pointer;">+ Add Day/Time</button>
        <div style="display:flex;gap:10px;">
          <button onclick="renderGroups()" style="flex:1;padding:10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-weight:600;cursor:pointer;">Cancel</button>
          <button onclick="saveScheduleEdit('${escapeHtml(groupName)}')" style="flex:2;padding:10px;background:linear-gradient(135deg,#22c55e,#16a34a);border:none;border-radius:8px;color:#fff;font-weight:700;cursor:pointer;">💾 Save</button>
        </div>
      `;
      card.appendChild(editor);
      
      const container = editor.querySelector('#scheduleItems');
      const slots = group.schedule ? parseSchedule(group.schedule) : [{day:'Monday',time:'10:00 AM'}];
      slots.forEach(s => addScheduleItem(s.day, s.time, container));
    }

    // ===== ADD SCHEDULE ITEM =====
    function addScheduleItem(day='Monday', time='10:00 AM', container) {
      const c = container || document.querySelector('#scheduleItems');
      if (!c) return;
      
      // Convert 12h AM/PM to 24h for HTML5 time input
      const time24 = convert12to24(time);
      
      const div = document.createElement('div');
      div.className = 'slot-row';
      div.innerHTML = `
        <select style="flex:1;">
          ${['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'].map(d=>`<option ${d===day?'selected':''}>${d}</option>`).join('')}
        </select>
        <input type="time" value="${time24}" style="flex:1;" onkeydown="if(event.key==='Enter'){event.target.closest('.group-card').querySelector('button[onclick*=saveScheduleEdit]').click();}">
        <button onclick="this.parentElement.remove()">🗑️</button>
      `;
      c.appendChild(div);
    }

    // ===== CONVERT 12H AM/PM TO 24H =====
    function convert12to24(time12) {
      if (!time12) return '10:00';
      
      // If already in 24h format, return as-is
      if (!time12.includes('AM') && !time12.includes('PM')) {
        return time12.length === 5 ? time12 : '10:00';
      }
      
      const match = time12.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
      if (!match) return '10:00';
      
      let hours = parseInt(match[1]);
      const minutes = match[2];
      const period = match[3].toUpperCase();
      
      if (period === 'PM' && hours !== 12) hours += 12;
      if (period === 'AM' && hours === 12) hours = 0;
      
      return `${hours.toString().padStart(2, '0')}:${minutes}`;
    }

    // ===== CONVERT 24H TO 12H AM/PM =====
    function convert24to12(time24) {
      if (!time24) return '';
      const [hours, minutes] = time24.split(':').map(Number);
      if (isNaN(hours) || isNaN(minutes)) return time24;
      
      let period = 'AM';
      let hours12 = hours;
      
      if (hours >= 12) {
        period = 'PM';
        if (hours > 12) hours12 = hours - 12;
      }
      if (hours === 0) hours12 = 12;
      
      return `${hours12}:${minutes.toString().padStart(2, '0')} ${period}`;
    }

    // ===== SAVE SCHEDULE =====
    // BEGIN GROUP MANAGER SCHEDULE FIX
    async function saveScheduleEdit(groupName) {
      const card = event.target.closest('.group-card');
      if (!card) return;
      
      const rows = card.querySelectorAll('.slot-row');
      let schedule = []; // Clear and rebuild schedule array
      
      rows.forEach(r => {
        const d = r.querySelector('select').value.slice(0,3);
        const t = r.querySelector('input').value;
        if (d && t) {
          // Convert 24-hour time to 12-hour AM/PM format
          const time12 = convert24to12(t);
          schedule.push(`${d} ${time12}`);
        }
      });
      
      const group = groups.find(g => g.name === groupName);
      if (!group) return;
      
      // CRITICAL FIX: Replace old schedule entirely (no appending)
      group.schedule = schedule.join(', ');
      
      // Save only this group (not all groups)
      const savedGroup = await saveGroup(group);
      if (savedGroup && savedGroup.id) {
        group.id = savedGroup.id;
        group.name = savedGroup.group_name || group.name;
      }
      
      // Update cache and notify
      window.groupsCache = groups;
      window.dispatchEvent(new CustomEvent("groups:updated", { detail: groups }));
      window.dispatchEvent(new CustomEvent("schedules:updated", { detail: groups }));
      
      // Flash save confirmation
      const saveBtn = card.querySelector('button[onclick*="saveScheduleEdit"]');
      if (saveBtn) {
        const originalBg = saveBtn.style.background;
        saveBtn.style.background = 'linear-gradient(135deg,#10b981,#059669)';
        saveBtn.style.boxShadow = '0 0 20px rgba(16,185,129,0.6)';
        setTimeout(() => {
          saveBtn.style.background = originalBg;
          saveBtn.style.boxShadow = '';
        }, 800);
      }
      
      showToast('✅ Schedule Updated');
      renderGroups();
    }
    // END GROUP MANAGER SCHEDULE FIX

    // ===== PARSE SCHEDULE STRING =====
    // ===== PARSE SCHEDULE STRING =====
    // BEGIN GROUP MANAGER SCHEDULE FIX - Convert day abbreviations to full names
    function convertDayAbbrevToFull(abbrev) {
      const map = {
        'Mon': 'Monday', 'Mon.': 'Monday',
        'Tue': 'Tuesday', 'Tue.': 'Tuesday',
        'Wed': 'Wednesday', 'Wed.': 'Wednesday',
        'Thu': 'Thursday', 'Thu.': 'Thursday',
        'Fri': 'Friday', 'Fri.': 'Friday',
        'Sat': 'Saturday', 'Sat.': 'Saturday',
        'Sun': 'Sunday', 'Sun.': 'Sunday',
        // Lowercase versions
        'mon': 'Monday', 'tue': 'Tuesday', 'wed': 'Wednesday',
        'thu': 'Thursday', 'fri': 'Friday', 'sat': 'Saturday', 'sun': 'Sunday',
        // Already full names
        'Monday': 'Monday', 'Tuesday': 'Tuesday', 'Wednesday': 'Wednesday',
        'Thursday': 'Thursday', 'Friday': 'Friday', 'Saturday': 'Saturday', 'Sunday': 'Sunday'
      };
      return map[abbrev] || abbrev || 'Monday';
    }
    
    function parseSchedule(str) {
      if (!str || !str.trim()) {
        return [{day: 'Monday', time: '10:00 AM'}];
      }
      
      return str.split(',').map(s => {
        const parts = s.trim().split(' ');
        const dayAbbrev = parts[0] || 'Monday';
        const day = convertDayAbbrevToFull(dayAbbrev);
        const time = parts.slice(1).join(' ') || '10:00 AM';
        return { day, time };
      });
    }
    // END GROUP MANAGER SCHEDULE FIX

    // ===== SAVE GROUPS =====
    async function saveGroups() {
      try {
        // Save all groups to Supabase and update with returned IDs
        for (let i = 0; i < groups.length; i++) {
          const savedGroup = await saveGroup(groups[i]);
          if (savedGroup && savedGroup.id) {
            // Update the local group with the id from Supabase
            groups[i].id = savedGroup.id;
            // Also map back group_name to name
            groups[i].name = savedGroup.group_name || groups[i].name;
          }
        }
        
        // Update global cache
        window.groupsCache = groups;
        
        // Dispatch events for Student Manager and Payment Records
        window.dispatchEvent(new CustomEvent("groups:updated", { detail: groups }));
        window.dispatchEvent(new CustomEvent("schedules:updated", { detail: groups }));
        
        console.log(`✅ Saved ${groups.length} groups to Supabase`);
      } catch (error) {
        console.error('Error saving groups:', error);
      }
    }

    // ===== UPDATE COLORS =====
    function updateScheduleItemStates() {
      document.querySelectorAll('.schedule-item').forEach(item => {
        const day = item.dataset.day;
        const time = item.dataset.time;
        if (!day || !time) return;
        
        const mins = getMinutesUntilClass(day, time);
        item.classList.remove('upcoming-green','upcoming-orange','upcoming-red');
        if (mins < 120) item.classList.add('upcoming-red');
        else if (mins < 360) item.classList.add('upcoming-orange');
        else if (mins < 720) item.classList.add('upcoming-green');
        
        item.onmouseenter = e => showCountdownPanel(e, day, time);
        item.onmouseleave = hideCountdownPanel;
      });
    }

    // ===== COUNTDOWN =====
    // BEGIN GROUP MANAGER SCHEDULE FIX - Correct nearest class calculation
    function getMinutesUntilClass(day, time) {
      const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
      const now = getNowLA(); // Use LA timezone
      
      // Parse the day index
      const targetDayIndex = days.findIndex(d => d.startsWith(day));
      if (targetDayIndex === -1) return 10080; // 1 week fallback
      
      // Parse the time (handle both "10:00 AM" and "10:00" formats)
      let targetHours = 0;
      let targetMinutes = 0;
      
      if (time.includes('AM') || time.includes('PM')) {
        // 12-hour format: "10:00 AM" or "3:30 PM"
        const match = time.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
        if (match) {
          targetHours = parseInt(match[1]);
          targetMinutes = parseInt(match[2]);
          const period = match[3].toUpperCase();
          
          if (period === 'PM' && targetHours !== 12) targetHours += 12;
          if (period === 'AM' && targetHours === 12) targetHours = 0;
        }
      } else {
        // 24-hour format: "14:30"
        const [hh, mm] = time.split(':');
        targetHours = parseInt(hh) || 0;
        targetMinutes = parseInt(mm) || 0;
      }
      
      // Create target date for this week
      const target = new Date(now);
      target.setHours(targetHours, targetMinutes, 0, 0);
      
      // Calculate days until target
      const currentDay = now.getDay();
      let daysUntil = targetDayIndex - currentDay;
      
      // If target day is today, check if time has passed
      if (daysUntil === 0) {
        if (target <= now) {
          // Time passed today, move to next week
          daysUntil = 7;
        }
      } else if (daysUntil < 0) {
        // Target day already passed this week, move to next week
        daysUntil += 7;
      }
      
      // Set the correct date
      target.setDate(now.getDate() + daysUntil);
      
      // Calculate minutes difference
      const diffMs = target - now;
      const diffMinutes = Math.floor(diffMs / 60000);
      
      return diffMinutes > 0 ? diffMinutes : 0;
    }
    // END GROUP MANAGER SCHEDULE FIX

    // ===== COUNTDOWN PANEL =====
    // BEGIN GROUP MANAGER SCHEDULE FIX - Better countdown display
    function showCountdownPanel(e, day, time) {
      const panel = document.getElementById('countdownPanel');
      if (!panel) return;
      
      panel.style.display = 'block';
      panel.style.left = (e.pageX+15)+'px';
      panel.style.top = (e.pageY+15)+'px';
      clearInterval(countdownTimer);
      
      const update = () => {
        const mins = getMinutesUntilClass(day, time);
        const totalHours = Math.floor(mins / 60);
        const remainingMins = Math.floor(mins % 60);
        
        // Format display based on time remaining
        let displayText = '';
        if (totalHours >= 24) {
          const days = Math.floor(totalHours / 24);
          const hours = totalHours % 24;
          displayText = `${days}d ${hours}h ${remainingMins}m`;
        } else {
          displayText = `${totalHours}h ${remainingMins}m`;
        }
        
        panel.innerHTML = `Next ${day} at ${time}<br><b style="font-size:1.2rem;">${displayText}</b>`;
      };
      update();
      countdownTimer = setInterval(update, 60000);
    }
    // END GROUP MANAGER SCHEDULE FIX

    function hideCountdownPanel() {
      const panel = document.getElementById('countdownPanel');
      if (panel) panel.style.display = 'none';
      clearInterval(countdownTimer);
    }

    // ===== TOAST =====
    function showToast(msg) {
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2000);
    }

    // ===== LOAD GROUPS ON INIT =====
    if (!window.globalData) window.globalData = {};
    window.globalData.groups = groups;
    
    // For backwards compatibility with Student Manager
    function loadGroups() {
      return loadGroupsFromSupabase();
    }

    // Listen for student updates to refresh group displays
    window.addEventListener('students:updated', function(event) {
      // Refresh group data when students are updated
      if (document.getElementById('groupManagerModal').style.display === 'block') {
        renderGroups();
      }
    });
    
    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    
    async function initialize() {
      console.log('🚀 Initializing ARNOMA app with Supabase...');
      
      // Initialize global data
      if (!window.globalData) {
        window.globalData = {
          groups: [],
          students: [],
          payments: []
        };
      }
      
      // Load data from Supabase into global state
      try {
        const [groups, students, payments] = await Promise.all([
          loadGroups(),
          loadStudents(),
          PaymentStore.fetchAll()
        ]);
        
        window.globalData.groups = groups;
        window.globalData.students = students;
        window.globalData.payments = payments;
        
        console.log(`✅ Loaded: ${students.length} students, ${groups.length} groups, ${payments.length} payments`);
      } catch (error) {
        console.error('❌ Error loading data from Supabase:', error);
      }
      
      // Handle OAuth callback
      handleOAuthCallback();
      
      // Update Gmail button state
      if (gmailAccessToken) {
        const expiry = parseInt(gmailTokenExpiry);
        if (expiry && Date.now() < expiry) {
          updateGmailButtonState(true);
        } else {
          localStorage.removeItem(STORAGE_KEYS.GMAIL_TOKEN);
          localStorage.removeItem(STORAGE_KEYS.GMAIL_EXPIRY);
          gmailAccessToken = null;
        }
      }
      
      // Initialize auto-refresh state
      const autoRefreshBtn = document.getElementById('autoRefreshToggle');
      if (autoRefreshEnabled) {
        autoRefreshBtn.classList.add('auto-refresh-active');
        autoRefreshBtn.title = 'Auto-refresh ON (every 30s) - Click to disable';
        startAutoRefresh();
      }
      
      // Populate month selector
      populateMonthSelector();
      
      // Render payments
      renderPaymentEmailsView();
      
      // Initialize daily auto-backup system
      initializeDailyAutoBackup();
      
      // Add filter change listener
      const filterDropdown = document.getElementById('paymentFilterDropdown');
      if (filterDropdown) {
        filterDropdown.addEventListener('change', renderPaymentEmailsView);
      }
    }
    
    // ============================
    // BEGIN QUICK VIEW FUNCTIONS
    // ============================
    
    let currentQuickViewTab = 'byGroup';
    
    // Open Quick View modal
    function openQuickView() {
      const modal = document.getElementById('quickViewModal');
      if (!modal) return;
      
      // Close Group Manager if open
      const groupModal = document.getElementById('groupManagerModal');
      if (groupModal) groupModal.style.display = 'none';
      
      // Show Quick View modal
      modal.style.display = 'flex';
      
      // Render content
      renderQuickView();
    }
    
    // Close Quick View modal
    function closeQuickView() {
      const modal = document.getElementById('quickViewModal');
      if (!modal) return;
      modal.style.display = 'none';
    }
    
    // Switch between tabs
    function switchQuickViewTab(tab) {
      currentQuickViewTab = tab;
      
      // Update tab button styles
      const tabs = {
        byGroup: document.getElementById('tabByGroup'),
        byWeekday: document.getElementById('tabByWeekday'),
        byWeekdayYerevan: document.getElementById('tabByWeekdayYerevan')
      };
      
      // Reset all tabs to inactive style
      Object.values(tabs).forEach(btn => {
        if (!btn) return;
        btn.style.background = 'rgba(255,255,255,0.1)';
        btn.style.border = '1px solid rgba(255,255,255,0.2)';
        btn.style.color = 'rgba(255,255,255,0.7)';
        btn.style.boxShadow = 'none';
        btn.style.fontWeight = '600';
      });
      
      // Set active tab style
      const activeTab = tabs[tab];
      if (activeTab) {
        activeTab.style.background = 'linear-gradient(135deg, #8ab4ff, #a855f7)';
        activeTab.style.border = 'none';
        activeTab.style.color = 'white';
        activeTab.style.boxShadow = '0 4px 12px rgba(138, 180, 255, 0.3)';
        activeTab.style.fontWeight = '700';
      }
      
      // Re-render content
      renderQuickView();
    }
    
    // BEGIN QUICK VIEW FIX: Convert LA time to Yerevan time
    // BEGIN DAY SHIFT FIX
    function convertLATimeToYerevan(timeStr, returnDayShift = false) {
      if (!timeStr) return returnDayShift ? { time: '', dayShift: 0 } : '';
      
      // Parse time (e.g., "8:00 AM", "10:30 PM")
      const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
      if (!match) return returnDayShift ? { time: timeStr, dayShift: 0 } : timeStr;
      
      let hours = parseInt(match[1]);
      const minutes = match[2];
      const period = match[3].toUpperCase();
      
      // Convert to 24-hour format
      if (period === 'PM' && hours !== 12) hours += 12;
      if (period === 'AM' && hours === 12) hours = 0;
      
      // LA to Yerevan offset: DST (UTC-7) = +11h, Standard (UTC-8) = +12h
      // Check if DST is active (timezone offset is 420 minutes / 7 hours)
      const now = new Date();
      const isDST = now.getTimezoneOffset() === 420;
      const offsetHours = isDST ? 11 : 12;
      
      let yerevanHours = hours + offsetHours;
      
      // Handle day overflow
      let dayShift = 0;
      if (yerevanHours >= 24) {
        yerevanHours -= 24;
        dayShift = 1; // Next day
      }
      
      // Convert back to 12-hour format
      let yerevanPeriod = 'AM';
      if (yerevanHours >= 12) {
        yerevanPeriod = 'PM';
        if (yerevanHours > 12) yerevanHours -= 12;
      }
      if (yerevanHours === 0) yerevanHours = 12;
      
      const timeResult = `${yerevanHours}:${minutes} ${yerevanPeriod}`;
      
      return returnDayShift ? { time: timeResult, dayShift: dayShift } : timeResult;
    }
    
    // Convert Yerevan time back to LA time (for display purposes)
    function convertYerevanTimeToLA(timeStr, returnDayShift = false) {
      if (!timeStr) return returnDayShift ? { time: '', dayShift: 0 } : '';
      
      // Parse time and remove day offset if present
      const cleanTime = timeStr.replace(/\s*\(\+1d\)|\s*\(-1d\)/, '');
      const match = cleanTime.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
      if (!match) return returnDayShift ? { time: timeStr, dayShift: 0 } : timeStr;
      
      let hours = parseInt(match[1]);
      const minutes = match[2];
      const period = match[3].toUpperCase();
      
      // Convert to 24-hour format
      if (period === 'PM' && hours !== 12) hours += 12;
      if (period === 'AM' && hours === 12) hours = 0;
      
      // Yerevan to LA offset: reverse of LA to Yerevan
      const now = new Date();
      const isDST = now.getTimezoneOffset() === 420;
      const offsetHours = isDST ? -11 : -12;
      
      let laHours = hours + offsetHours;
      
      // Handle day underflow
      let dayShift = 0;
      if (laHours < 0) {
        laHours += 24;
        dayShift = -1; // Previous day
      }
      
      // Convert back to 12-hour format
      let laPeriod = 'AM';
      if (laHours >= 12) {
        laPeriod = 'PM';
        if (laHours > 12) laHours -= 12;
      }
      if (laHours === 0) laHours = 12;
      
      const timeResult = `${laHours}:${minutes} ${laPeriod}`;
      
      return returnDayShift ? { time: timeResult, dayShift: dayShift } : timeResult;
    }
    // END DAY SHIFT FIX
    // END QUICK VIEW FIX
    
    // Ensure time is in 12-hour AM/PM format
    function ensureAMPMFormat(timeStr) {
      if (!timeStr) return '';
      
      // If already has AM/PM, return as-is
      if (/AM|PM/i.test(timeStr)) return timeStr;
      
      // Try to parse 24-hour format (e.g., "20:00", "08:00")
      const match24 = timeStr.match(/^(\d{1,2}):(\d{2})$/);
      if (match24) {
        let hours = parseInt(match24[1]);
        const minutes = match24[2];
        
        let period = 'AM';
        if (hours >= 12) {
          period = 'PM';
          if (hours > 12) hours -= 12;
        }
        if (hours === 0) hours = 12;
        
        return `${hours}:${minutes} ${period}`;
      }
      
      // Return as-is if can't parse
      return timeStr;
    }
    
    // Format schedule text into readable chips
    function formatScheduleQuickView(scheduleText, convertToYerevan = false) {
      if (!scheduleText || scheduleText.trim() === '') {
        return '<span style="color: rgba(255,255,255,0.5); font-style: italic;">No schedule</span>';
      }
      
      // Parse schedule: "Mon/Wed 8:00 AM, Fri 9:00 AM"
      const parts = scheduleText.split(',').map(p => p.trim()).filter(p => p);
      if (parts.length === 0) {
        return '<span style="color: rgba(255,255,255,0.5); font-style: italic;">No schedule</span>';
      }
      
      const chips = parts.map(part => {
        // Extract days and time: "Mon/Wed 8:00 AM"
        const match = part.match(/^([\w/]+)\s+(.+)$/);
        if (!match) return null;
        
        const days = match[1];
        const time = match[2];
        // Ensure time is in AM/PM format
        const timeAMPM = ensureAMPMFormat(time);
        // Get clean time without day markers for display
        const displayTime = convertToYerevan 
          ? convertLATimeToYerevan(timeAMPM, true).time 
          : timeAMPM;
        
        return `<span style="display: inline-block; padding: 6px 12px; margin: 4px; background: rgba(138,180,255,0.15); border: 1px solid rgba(138,180,255,0.3); border-radius: 8px; font-size: 13px; color: #8ab4ff; white-space: nowrap;">${days} ${displayTime}</span>`;
      }).filter(c => c);
      
      return chips.join('');
    }
    
    // BEGIN QUICK VIEW FIX: Main render function
    function renderQuickView() {
      const contentEl = document.getElementById('quickViewContent');
      if (!contentEl) return;
      
      try {
        // Load groups from Supabase cache
        const groupsData = window.groupsCache || window.globalData?.groups || [];
        
        if (!Array.isArray(groupsData) || groupsData.length === 0) {
          contentEl.innerHTML = '<div style="text-align: center; padding: 60px; color: rgba(255,255,255,0.5); font-size: 16px;"><div style="font-size: 64px; margin-bottom: 16px;">📚</div><p>No groups found.<br>Add groups in Group Manager to see schedules here.</p></div>';
          return;
        }
        
        let html = '';
        
        if (currentQuickViewTab === 'byGroup') {
          // BY GROUP VIEW
          html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px;">';
          groupsData.forEach(group => {
            const schedule = formatScheduleQuickView(group.schedule || '');
            // Ensure group name starts with "Group" prefix if it's just a letter
            const groupName = group.name && group.name.length === 1 ? `Group ${group.name}` : (group.name || 'Unnamed Group');
            html += `
              <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 18px; transition: all 0.2s;">
                <div style="font-size: 18px; font-weight: 700; color: white; margin-bottom: 8px;">${escapeHtml(groupName)}</div>
                <div style="font-size: 14px; color: rgba(255,255,255,0.5); margin-bottom: 8px; font-weight: 600;">Schedule:</div>
                <div>${schedule}</div>
              </div>
            `;
          });
          html += '</div>';
          
        } else if (currentQuickViewTab === 'byWeekday') {
          // BY WEEKDAY (LA) VIEW
          const weekdays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
          const dayMap = { mon: 'Monday', tue: 'Tuesday', wed: 'Wednesday', thu: 'Thursday', fri: 'Friday', sat: 'Saturday', sun: 'Sunday' };
          const daySchedule = {};
          
          // Parse all schedules and organize by day
          groupsData.forEach(group => {
            const scheduleText = (group.schedule || '').trim();
            if (!scheduleText) return;
            
            const parts = scheduleText.split(',').map(p => p.trim()).filter(p => p);
            parts.forEach(part => {
              const match = part.match(/^([\w/]+)\s+(.+)$/);
              if (!match) return;
              
              const daysStr = match[1].toLowerCase();
              const time = match[2];
              // Ensure time is in AM/PM format before storing
              const timeAMPM = ensureAMPMFormat(time);
              
              // Handle slash-separated days: "mon/wed"
              const dayTokens = daysStr.split('/').map(d => d.trim());
              dayTokens.forEach(token => {
                const fullDay = dayMap[token];
                if (!fullDay) return;
                
                if (!daySchedule[fullDay]) daySchedule[fullDay] = [];
                daySchedule[fullDay].push({ group: escapeHtml(group.name), time: escapeHtml(timeAMPM) });
              });
            });
          });
          
          // Sort sessions by time within each day
          Object.keys(daySchedule).forEach(day => {
            daySchedule[day].sort((a, b) => {
              const timeA = new Date('1970-01-01 ' + a.time);
              const timeB = new Date('1970-01-01 ' + b.time);
              return timeA - timeB;
            });
          });
          
          html = '<div style="display: flex; flex-direction: column; gap: 24px;">';
          weekdays.forEach(day => {
            const sessions = daySchedule[day] || [];
            html += `
              <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 18px;">
                <div style="font-size: 20px; font-weight: 700; color: white; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;">${day}</div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  ${sessions.length === 0 
                    ? '<span style="color: rgba(255,255,255,0.4); font-style: italic;">No sessions scheduled</span>' 
                    : sessions.map(s => {
                        // Get clean Yerevan time without day markers
                        const yerevanResult = convertLATimeToYerevan(s.time, true);
                        const yerevanTime = yerevanResult.time; // Clean time without markers
                        // Ensure group name starts with "Group" prefix if it's just a letter
                        const groupName = s.group.length === 1 ? `Group ${s.group}` : s.group;
                        return `<span style="padding: 8px 14px; background: rgba(138,180,255,0.15); border: 1px solid rgba(138,180,255,0.3); border-radius: 8px; font-size: 12px; color: #8ab4ff;"><strong>${groupName}</strong> — ${s.time} (Los Angeles) <span style="opacity: 0.7;">(${yerevanTime} Yerevan Time)</span></span>`;
                      }).join('')}
                </div>
              </div>
            `;
          });
          html += '</div>';
          
        } else if (currentQuickViewTab === 'byWeekdayYerevan') {
          // BY WEEKDAY (YEREVAN) VIEW
          // BEGIN DAY SHIFT FIX - Calculate next weekday helper
          function getNextWeekday(weekday, offset) {
            const weekdayIndex = {
              'Monday': 0, 'Tuesday': 1, 'Wednesday': 2, 'Thursday': 3,
              'Friday': 4, 'Saturday': 5, 'Sunday': 6
            };
            const indexToDay = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            const currentIndex = weekdayIndex[weekday];
            if (currentIndex === undefined) return weekday;
            
            const newIndex = (currentIndex + offset + 7) % 7; // +7 to handle negative offsets
            return indexToDay[newIndex];
          }
          // END DAY SHIFT FIX
          
          const weekdays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
          const dayMap = { mon: 'Monday', tue: 'Tuesday', wed: 'Wednesday', thu: 'Thursday', fri: 'Friday', sat: 'Saturday', sun: 'Sunday' };
          const daySchedule = {};
          
          // BEGIN DAY SHIFT FIX - Parse schedules with Yerevan weekday calculation
          // Parse all schedules and organize by ACTUAL Yerevan day (not LA day)
          groupsData.forEach(group => {
            const scheduleText = (group.schedule || '').trim();
            if (!scheduleText) return;
            
            const parts = scheduleText.split(',').map(p => p.trim()).filter(p => p);
            parts.forEach(part => {
              const match = part.match(/^([\w/]+)\s+(.+)$/);
              if (!match) return;
              
              const daysStr = match[1].toLowerCase();
              const laTime = match[2];
              // Ensure LA time is in AM/PM format before converting
              const laTimeAMPM = ensureAMPMFormat(laTime);
              const conversionResult = convertLATimeToYerevan(laTimeAMPM, true); // Get day shift info
              
              // Handle slash-separated days: "mon/wed"
              const dayTokens = daysStr.split('/').map(d => d.trim());
              dayTokens.forEach(token => {
                const laWeekday = dayMap[token]; // Original LA weekday
                if (!laWeekday) return;
                
                // Calculate actual Yerevan weekday based on day shift
                const yerevanWeekday = getNextWeekday(laWeekday, conversionResult.dayShift);
                
                if (!daySchedule[yerevanWeekday]) daySchedule[yerevanWeekday] = [];
                daySchedule[yerevanWeekday].push({ 
                  group: escapeHtml(group.name), 
                  yerevanTime: escapeHtml(conversionResult.time), // Clean time without markers
                  laTime: escapeHtml(laTimeAMPM)
                });
              });
            });
          });
          // END DAY SHIFT FIX
          
          // Sort sessions by time within each day (chronological order)
          Object.keys(daySchedule).forEach(day => {
            daySchedule[day].sort((a, b) => {
              // Clean time strings are already without markers
              const timeA = new Date('1970-01-01 ' + a.yerevanTime);
              const timeB = new Date('1970-01-01 ' + b.yerevanTime);
              return timeA - timeB;
            });
          });
          
          html = '<div style="display: flex; flex-direction: column; gap: 24px;">';
          weekdays.forEach(day => {
            const sessions = daySchedule[day] || [];
            html += `
              <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 18px;">
                <div style="font-size: 20px; font-weight: 700; color: white; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;">${day}</div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  ${sessions.length === 0 
                    ? '<span style="color: rgba(255,255,255,0.4); font-style: italic;">No sessions scheduled</span>' 
                    : sessions.map(s => {
                        // Ensure group name starts with "Group" prefix if it's just a letter
                        const groupName = s.group.length === 1 ? `Group ${s.group}` : s.group;
                        return `<span style="padding: 8px 14px; background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); border-radius: 8px; font-size: 12px; color: #10b981;"><strong>${groupName}</strong> — ${s.yerevanTime} (Yerevan) <span style="opacity: 0.7;">(${s.laTime} Los Angeles Time)</span></span>`;
                      }).join('')}
                </div>
              </div>
            `;
          });
          html += '</div>';
        }
        
        contentEl.innerHTML = html;
      } catch (error) {
        console.error('Quick View render error:', error);
        contentEl.innerHTML = '<div style="text-align: center; padding: 60px; color: rgba(255,0,0,0.7); font-size: 16px;"><div style="font-size: 64px; margin-bottom: 16px;">⚠️</div><p>Error loading schedules.<br>Please try again.</p></div>';
      }
    }
    // END QUICK VIEW FIX
    
    // Listen for group updates and refresh Quick View if it's open
    window.addEventListener('groups:updated', function() {
      const quickViewModal = document.getElementById('quickViewModal');
      if (quickViewModal && quickViewModal.style.display !== 'none') {
        renderQuickView();
      }
    });
    
    // ============================
    // END QUICK VIEW FUNCTIONS
    // ============================

    // ========== BEGIN FLOATING NAV FUNCTIONS ==========
    /**
     * Initialize Floating Navigation Bar
     * Ensures idempotent initialization with guard flag
     */
    function initFloatingNav() {
      if (window._floatingNavInitialized) {
        return; // Already initialized, skip
      }
      window._floatingNavInitialized = true;

      const floatingNav = document.getElementById('floatingNav');
      if (!floatingNav) {
        console.warn('Floating Nav: Element not found');
        return;
      }

      // Show the nav bar
      floatingNav.style.display = 'flex';

      // Bind all button handlers with guards
      bindNavBtn('navTopBtn', scrollToTop);
      bindNavBtn('navUndoBtn', undoAction);
      bindNavBtn('navRedoBtn', redoAction);
      bindNavBtn('navRefreshBtn', refreshUIAction);
      bindNavBtn('navTimerBtn', toggleClassCountdown);
      bindNavBtn('navQuickViewBtn', openQuickView);

      console.log('✅ Floating Nav initialized');
    }

    /**
     * Bind button with duplicate prevention
     */
    function bindNavBtn(id, fn) {
      const el = document.getElementById(id);
      if (el && !el.dataset.bound) {
        el.addEventListener('click', fn);
        el.dataset.bound = '1';
      }
    }

    /**
     * Scroll to top smoothly
     */
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /**
     * Undo action (browser history back)
     */
    function undoAction() {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        console.info('Undo: No previous state');
        showNotification('No previous state to undo', 'info');
      }
    }

    /**
     * Redo action (browser history forward)
     */
    function redoAction() {
      // Note: Browser history forward is tricky without state management
      console.info('Redo: Feature requires state tracking');
      showNotification('Redo not available', 'info');
    }

    /**
     * Refresh current UI view
     */
    function refreshUIAction() {
      try {
        document.body.classList.add('refreshing');
        
        // Re-render current view based on what's open
        const studentManager = document.getElementById('studentManagerModal');
        const groupManager = document.getElementById('groupManagerModal');
        const quickView = document.getElementById('quickViewModal');
        
        if (studentManager && studentManager.style.display !== 'none') {
          renderStudents();
        } else if (groupManager && groupManager.style.display !== 'none') {
          renderGroups();
        } else if (quickView && quickView.style.display !== 'none') {
          renderQuickView();
        } else {
          // Refresh main payment grid
          if (typeof renderPaymentEmailsView === 'function') {
            renderPaymentEmailsView();
          }
        }
        
        setTimeout(() => {
          document.body.classList.remove('refreshing');
          showNotification('Refreshed', 'success');
        }, 800);
      } catch (e) {
        console.warn('Refresh failed:', e);
        document.body.classList.remove('refreshing');
        showNotification('Refresh failed', 'error');
      }
    }

    /* BEGIN CLASS COUNTDOWN TIMER */
    /**
     * Toggle Class Countdown Timer overlay - Enhanced version
     * Manages both legacy and enhanced countdown timers
     */
    function toggleClassCountdown() {
      // Check for enhanced timer first
      let enhancedTimer = document.getElementById('enhancedCountdownTimer');
      
      if (enhancedTimer) {
        // Hide enhanced timer
        if (window.ClassCountdownTimer && window.ClassCountdownTimer.destroy) {
          window.ClassCountdownTimer.destroy();
        }
        showNotification('Countdown timer hidden', 'info');
        return;
      }

      // Check for legacy overlay
      let overlay = document.getElementById('classCountdownOverlay');
      
      if (overlay) {
        // Remove legacy overlay
        if (overlay._timer) {
          clearInterval(overlay._timer);
        }
        overlay.remove();
        showNotification('Countdown timer hidden', 'info');
        return;
      }

      // Initialize enhanced countdown timer
      if (window.ClassCountdownTimer && window.ClassCountdownTimer.init) {
        window.ClassCountdownTimer.init();
        showNotification('Countdown timer active', 'success');
      } else {
        // Fallback to legacy implementation
        overlay = document.createElement('div');
        overlay.id = 'classCountdownOverlay';
        document.body.appendChild(overlay);
        startCountdownTimer(overlay);
        showNotification('Countdown timer active (legacy)', 'success');
      }
    }
    /* END CLASS COUNTDOWN TIMER */

    /**
     * Start countdown timer with live updates (legacy function - preserved for compatibility)
     */
    function startCountdownTimer(overlay) {
      function updateCountdown() {
        const nextClass = getNextClassTime();
        if (nextClass) {
          overlay.textContent = `◷ ${nextClass.dayName}: ${nextClass.groupName} in ${nextClass.timeRemaining}`;
        } else {
          overlay.textContent = '◷ No classes scheduled';
        }
      }

      // Initial update
      updateCountdown();

      // Update every minute
      overlay._timer = setInterval(updateCountdown, 60000);
    }

    /**
     * Calculate next upcoming class from schedules (up to 7 days ahead)
     * Returns {groupName, timeRemaining, dayName} or null
     */
    function getNextClassTime() {
      try {
        const groups = JSON.parse(localStorage.getItem('group-manager:v2') || '[]');
        const now = new Date();
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const currentDayIndex = now.getDay();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();

        let nextClass = null;
        let minDiffInMinutes = Infinity;

        // Check up to 7 days ahead
        for (let daysAhead = 0; daysAhead < 7; daysAhead++) {
          const checkDayIndex = (currentDayIndex + daysAhead) % 7;
          const checkDayName = dayNames[checkDayIndex];

          groups.forEach(group => {
            if (!group.schedule || !Array.isArray(group.schedule)) return;

            group.schedule.forEach(slot => {
              if (!slot.days || !slot.time) return;

              slot.days.forEach(day => {
                if (day !== checkDayName) return;

                // Parse time (e.g., "2:00 PM" or "14:00")
                const timeMatch = slot.time.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
                if (!timeMatch) return;

                let hours = parseInt(timeMatch[1]);
                const minutes = parseInt(timeMatch[2]);
                const ampm = timeMatch[3];

                if (ampm) {
                  if (ampm.toUpperCase() === 'PM' && hours !== 12) hours += 12;
                  if (ampm.toUpperCase() === 'AM' && hours === 12) hours = 0;
                }

                const classMinutes = hours * 60 + minutes;
                
                // Calculate total difference in minutes from now
                let totalDiff;
                if (daysAhead === 0) {
                  totalDiff = classMinutes - currentMinutes;
                  // Skip if class already passed today
                  if (totalDiff <= 0) return;
                } else {
                  // For future days, add full days in minutes
                  totalDiff = (daysAhead * 24 * 60) - currentMinutes + classMinutes;
                }

                if (totalDiff > 0 && totalDiff < minDiffInMinutes) {
                  minDiffInMinutes = totalDiff;
                  
                  // Format time remaining
                  const daysLeft = Math.floor(totalDiff / (24 * 60));
                  const hoursLeft = Math.floor((totalDiff % (24 * 60)) / 60);
                  const minsLeft = totalDiff % 60;
                  
                  let timeStr = '';
                  if (daysLeft > 0) {
                    timeStr = `${daysLeft}d ${hoursLeft}h`;
                  } else if (hoursLeft > 0) {
                    timeStr = `${hoursLeft}h ${minsLeft}m`;
                  } else {
                    timeStr = `${minsLeft}m`;
                  }

                  // Determine day label
                  let dayLabel = '';
                  if (daysAhead === 0) {
                    dayLabel = 'Today';
                  } else if (daysAhead === 1) {
                    dayLabel = 'Tomorrow';
                  } else {
                    dayLabel = checkDayName;
                  }

                  nextClass = {
                    groupName: group.name.length === 1 ? `Group ${group.name}` : group.name,
                    timeRemaining: timeStr,
                    dayName: dayLabel
                  };
                }
              });
            });
          });
        }

        return nextClass;
      } catch (error) {
        console.error('Error calculating next class:', error);
        return null;
      }
    }

    /* BEGIN CLASS COUNTDOWN TIMER */
    /**
     * Enhanced Class Countdown Timer
     * A comprehensive, self-contained timer system with:
     * - Live per-minute updates
     * - Full LA/Yerevan timezone display (DST-aware)
     * - State-based visual feedback (<15m warning, <5m urgent)
     * - 2-hour class duration with automatic skip to next class
     * - Continuous rolling countdown without "in progress" pauses
     * - Zero side effects on existing code
     * 
     * TIMEZONE SYNCHRONIZATION (Yerevan ⇄ Los Angeles):
     * - Los Angeles: America/Los_Angeles (PST UTC-8 or PDT UTC-7)
     * - Yerevan: Asia/Yerevan (AMT UTC+4, no DST)
     * - Time difference between Yerevan and Los Angeles is usually 11 hours (during PDT),
     *   but 12 hours during U.S. Standard Time (November → March).
     * - All calculations are done in UTC internally, then converted to local time for display.
     * - NEVER hard-code timezone offsets - always retrieve them dynamically.
     */
    window.ClassCountdownTimer = (function() {
      // Private state
      let timerElement = null;
      let updateInterval = null;
      let currentClassData = null;
      let isPinned = false;

      /**
       * Timezone Utilities
       * All time calculations use UTC internally, with dynamic timezone conversion
       */
      const TimezoneUtils = {
        /**
         * Get current time in a specific timezone
         * @param {string} timezone - IANA timezone string (e.g., 'America/Los_Angeles')
         * @returns {Date} Date object representing current time in that timezone
         */
        getCurrentTimeInZone(timezone) {
          const now = new Date();
          const localString = now.toLocaleString('en-US', { timeZone: timezone });
          return new Date(localString);
        },

        /**
         * Get the UTC offset for a timezone in hours (dynamically calculated)
         * @param {string} timezone - IANA timezone string
         * @returns {number} Offset in hours (e.g., -8 for PST, +4 for Yerevan)
         */
        getTimezoneOffset(timezone) {
          const now = new Date();
          const utcDate = new Date(now.toLocaleString('en-US', { timeZone: 'UTC' }));
          const zoneDate = new Date(now.toLocaleString('en-US', { timeZone: timezone }));
          return (zoneDate - utcDate) / (1000 * 60 * 60);
        },

        /**
         * Convert a time from LA timezone to Yerevan timezone
         * @param {string} laTimeStr - Time in LA (e.g., "8:00 PM")
         * @param {Date} referenceDate - Reference date for the conversion (defaults to today)
         * @returns {Object} { time: string, dayShift: number }
         */
        convertLATimeToYerevan(laTimeStr, referenceDate = new Date()) {
          if (!laTimeStr) return { time: '', dayShift: 0 };
          
          const match = laTimeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
          if (!match) return { time: laTimeStr, dayShift: 0 };
          
          let hours = parseInt(match[1]);
          const minutes = match[2];
          const period = match[3].toUpperCase();
          
          // Convert to 24-hour
          if (period === 'PM' && hours !== 12) hours += 12;
          if (period === 'AM' && hours === 12) hours = 0;
          
          // Create a date object in LA timezone
          const laDate = new Date(referenceDate);
          const laString = laDate.toLocaleDateString('en-US', { timeZone: 'America/Los_Angeles' });
          const [month, day, year] = laString.split('/');
          
          // Create UTC date with LA time components
          // Get LA's current UTC offset dynamically
          const laOffset = this.getTimezoneOffset('America/Los_Angeles');
          const utcHours = hours - laOffset;
          
          const utcDate = new Date(Date.UTC(
            parseInt(year),
            parseInt(month) - 1,
            parseInt(day),
            utcHours,
            parseInt(minutes)
          ));
          
          // Convert to Yerevan time
          const yerevanString = utcDate.toLocaleString('en-US', { 
            timeZone: 'Asia/Yerevan',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });
          
          // Calculate day shift
          const yerevanDate = new Date(utcDate.toLocaleString('en-US', { timeZone: 'Asia/Yerevan' }));
          const dayShift = yerevanDate.getDate() - laDate.getDate();
          
          return {
            time: yerevanString,
            dayShift: dayShift
          };
        }
      };

      // Time conversion helper (reuses existing convertLATimeToYerevan function)
      function ensureAMPMFormatLocal(timeStr) {
        if (!timeStr) return '';
        if (/AM|PM/i.test(timeStr)) return timeStr;
        
        const match = timeStr.match(/^(\d{1,2}):(\d{2})$/);
        if (!match) return timeStr;
        
        let hours = parseInt(match[1]);
        const minutes = match[2];
        const period = hours >= 12 ? 'PM' : 'AM';
        
        if (hours > 12) hours -= 12;
        if (hours === 0) hours = 12;
        
        return `${hours}:${minutes} ${period}`;
      }

      // DST-aware LA to Yerevan conversion (legacy - kept for compatibility)
      // NOTE: This uses dynamic offset calculation via TimezoneUtils
      function convertLAToYerevanTime(laTimeStr) {
        return TimezoneUtils.convertLATimeToYerevan(laTimeStr);
      }

      // Original implementation preserved below for reference
      /*
      function convertLAToYerevanTime(laTimeStr) {
        if (!laTimeStr) return { time: '', dayShift: 0 };
        
        const match = laTimeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
        if (!match) return { time: laTimeStr, dayShift: 0 };
        
        let hours = parseInt(match[1]);
        const minutes = match[2];
        const period = match[3].toUpperCase();
        
        // Convert to 24-hour
        if (period === 'PM' && hours !== 12) hours += 12;
        if (period === 'AM' && hours === 12) hours = 0;
        
        // DST detection: Check if LA is in daylight saving time
        const now = new Date();
        const jan = new Date(now.getFullYear(), 0, 1);
        const jul = new Date(now.getFullYear(), 6, 1);
        const stdOffset = Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
        const isDST = now.getTimezoneOffset() < stdOffset;
        
        // LA: UTC-8 (PST) or UTC-7 (PDT)
        // Yerevan: UTC+4 (year-round, no DST)
        // Difference: 12 hours (PST) or 11 hours (PDT)
        const offsetHours = isDST ? 11 : 12;
        
        let yerevanHours = hours + offsetHours;
        let dayShift = 0;
        
        if (yerevanHours >= 24) {
          yerevanHours -= 24;
          dayShift = 1;
        }
        
        // Convert back to 12-hour
        let yerevanPeriod = 'AM';
        let displayHours = yerevanHours;
        
        if (yerevanHours >= 12) {
          yerevanPeriod = 'PM';
          if (yerevanHours > 12) displayHours = yerevanHours - 12;
        }
        if (yerevanHours === 0) displayHours = 12;
        
        return {
          time: `${displayHours}:${minutes} ${yerevanPeriod}`,
          dayShift: dayShift
        };
      }
      */

      // Parse schedule string format: "Mon/Wed 8:00 AM, Fri 9:30 PM"
      function parseScheduleString(scheduleStr) {
        if (!scheduleStr || typeof scheduleStr !== 'string') return [];
        
        const sessions = [];
        const parts = scheduleStr.split(',').map(p => p.trim()).filter(p => p);
        
        parts.forEach(part => {
          const match = part.match(/^([\w/]+)\s+(.+)$/);
          if (!match) return;
          
          const daysStr = match[1];
          const timeStr = match[2];
          const days = daysStr.split('/').map(d => d.trim().toLowerCase());
          
          const dayMap = {
            'mon': 'Monday', 'tue': 'Tuesday', 'wed': 'Wednesday',
            'thu': 'Thursday', 'fri': 'Friday', 'sat': 'Saturday', 'sun': 'Sunday'
          };
          
          days.forEach(dayAbbr => {
            const fullDay = dayMap[dayAbbr];
            if (fullDay) {
              sessions.push({
                day: fullDay,
                time: ensureAMPMFormatLocal(timeStr)
              });
            }
          });
        });
        
        return sessions;
      }

      // BEGIN CLASS COUNTDOWN TIMER FIX - Remove "Class in Progress" & Auto-Jump to Next Class
      // Find next class across all groups (up to 7 days ahead)
      // Classes last 2 hours - automatically skip to next class after 2-hour window ends
      function findNextClass() {
        try {
          const groups = window.groupsCache || window.globalData?.groups || [];
          
          // Get current time in LA timezone using UTC-based calculation
          // CRITICAL: All time calculations use UTC internally for accuracy
          // Time difference between Yerevan and Los Angeles is usually 11 hours (PDT),
          // but 12 hours during U.S. Standard Time (November → March). Always retrieve dynamically.
          const now = TimezoneUtils.getCurrentTimeInZone('America/Los_Angeles');
          const laOffset = TimezoneUtils.getTimezoneOffset('America/Los_Angeles');
          
          const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
          const currentDayIndex = now.getDay();
          const currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();

          console.log('[ClassCountdownTimer] Current LA time:', now.toLocaleString('en-US'), 'Day:', dayNames[currentDayIndex], '(UTC offset:', laOffset, 'hours)');

          let nextClass = null;
          let minDiffInSeconds = Infinity;

          // Check up to 7 days ahead
          for (let daysAhead = 0; daysAhead < 7; daysAhead++) {
            const checkDayIndex = (currentDayIndex + daysAhead) % 7;
            const checkDayName = dayNames[checkDayIndex];

            groups.forEach(group => {
              let sessions = [];
              
              // Handle both old array format and new string format
              if (Array.isArray(group.schedule)) {
                // Legacy array format
                group.schedule.forEach(slot => {
                  if (slot.days && slot.time) {
                    slot.days.forEach(day => {
                      sessions.push({ day, time: ensureAMPMFormatLocal(slot.time) });
                    });
                  }
                });
              } else if (typeof group.schedule === 'string') {
                // New string format
                sessions = parseScheduleString(group.schedule);
              }

              sessions.forEach(session => {
                if (session.day !== checkDayName) return;

                // Parse time
                const match = session.time.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                if (!match) return;

                let hours = parseInt(match[1]);
                const minutes = parseInt(match[2]);
                const period = match[3].toUpperCase();

                if (period === 'PM' && hours !== 12) hours += 12;
                if (period === 'AM' && hours === 12) hours = 0;

                const classTimeInSeconds = hours * 3600 + minutes * 60;
                
                // Calculate time difference in seconds
                let totalDiffSeconds;
                if (daysAhead === 0) {
                  totalDiffSeconds = classTimeInSeconds - currentTime;
                  console.log(`[ClassCountdownTimer] Checking ${group.name} on ${checkDayName} at ${session.time}: totalDiff=${totalDiffSeconds}s (${(totalDiffSeconds/3600).toFixed(1)}h)`);
                  // Skip if more than 2 hours (7200 seconds) past - class is over
                  if (totalDiffSeconds < -7200) return;
                } else {
                  totalDiffSeconds = (daysAhead * 86400) - currentTime + classTimeInSeconds;
                }

                // Skip classes currently in progress (started but not yet 2 hours past)
                // Only count future classes (totalDiffSeconds > 0)
                if (totalDiffSeconds > 0 && totalDiffSeconds < minDiffInSeconds) {
                  console.log(`[ClassCountdownTimer] ✅ New next class: ${group.name} on ${checkDayName} at ${session.time} (${(totalDiffSeconds/3600).toFixed(1)}h away)`);
                  minDiffInSeconds = totalDiffSeconds;
                  
                  // Determine day label
                  let dayLabel = '';
                  if (daysAhead === 0) {
                    dayLabel = 'Today';
                  } else if (daysAhead === 1) {
                    dayLabel = 'Tomorrow';
                  } else {
                    dayLabel = checkDayName;
                  }

                  nextClass = {
                    groupName: group.name && group.name.length === 1 ? `Group ${group.name}` : (group.name || 'Unknown Group'),
                    dayName: dayLabel,
                    laTime: session.time,
                    secondsRemaining: totalDiffSeconds,
                    actualDay: checkDayName
                  };
                }
              });
            });
          }

          return nextClass;
        } catch (error) {
          console.error('[ClassCountdownTimer] Error finding next class:', error);
          return null;
        }
      }
      // END CLASS COUNTDOWN TIMER FIX

      // BEGIN CLASS COUNTDOWN TIMER FIX - Remove "Class in Progress" & Auto-Jump to Next Class
      // Format seconds into readable countdown (no "in progress" state)
      function formatCountdown(seconds) {
        const absSeconds = Math.abs(seconds);
        const days = Math.floor(absSeconds / 86400);
        const hours = Math.floor((absSeconds % 86400) / 3600);
        const mins = Math.floor((absSeconds % 3600) / 60);

        if (days > 0) {
          return `${days}d ${hours}h ${mins}m`;
        } else if (hours > 0) {
          return `${hours}h ${mins}m`;
        } else if (mins > 0) {
          return `${mins}m`;
        } else {
          return `<1m`;
        }
      }
      // END CLASS COUNTDOWN TIMER FIX

      // Create timer element as popup
      function createElement() {
        // Prevent duplicate creation
        const existingTimer = document.getElementById('enhancedCountdownTimer');
        if (existingTimer) {
          timerElement = existingTimer;
          return existingTimer;
        }

        const timer = document.createElement('div');
        timer.id = 'enhancedCountdownTimer';
        timer.innerHTML = `
          <div class="timer-header">
            <div style="display: flex; align-items: center; gap: 6px;">
              <span class="timer-icon">🕒</span>
              <span class="timer-title">Upcoming Classes</span>
            </div>
            <button class="timer-close" title="Close timer">×</button>
          </div>
          <div class="timer-classes-list"></div>
        `;

        const closeBtn = timer.querySelector('.timer-close');
        closeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          destroy();
        });

        // Add click-outside-to-close functionality
        setTimeout(() => {
          setupTimerClickOutsideListener(timer);
        }, 100);

        document.body.appendChild(timer);
        timerElement = timer;
        
        return timer;
      }
      
      // Setup click outside to close timer
      function setupTimerClickOutsideListener(timer) {
        // Remove existing listener if any
        if (window._timerClickOutsideListener) {
          document.removeEventListener('click', window._timerClickOutsideListener);
        }
        
        // Create new listener
        window._timerClickOutsideListener = function(event) {
          // Check if timer exists and is visible
          if (!timer || !document.body.contains(timer)) {
            // Cleanup listener if timer is gone
            document.removeEventListener('click', window._timerClickOutsideListener);
            window._timerClickOutsideListener = null;
            return;
          }
          
          // Check if click is inside timer
          const clickedInsideTimer = timer.contains(event.target);
          
          // Check if click is on a button or interactive element
          const clickedButton = event.target.closest('button');
          const clickedInput = event.target.closest('input, textarea, select');
          
          // If clicked outside timer and not on a button/input, close timer
          if (!clickedInsideTimer && !clickedButton && !clickedInput) {
            destroy();
          }
        };
        
        // Attach listener with slight delay to prevent immediate trigger
        setTimeout(() => {
          document.addEventListener('click', window._timerClickOutsideListener);
        }, 200);
      }

      // Get all classes for the next 7 days
      function getAllUpcomingClasses() {
        try {
          const allClasses = [];
          
          // Load groups from Supabase cache or global groups variable
          const groups = window.groupsCache || window.globalData?.groups || [];
          
          if (!groups || groups.length === 0) {
            console.log('[ClassCountdownTimer] No groups found in cache');
            return [];
          }

          console.log('[ClassCountdownTimer] Found', groups.length, 'groups');

          // Get current LA time using UTC-based calculation
          // CRITICAL: All time calculations use UTC internally for accuracy
          // Time difference between Yerevan and Los Angeles is usually 11 hours (PDT),
          // but 12 hours during U.S. Standard Time (November → March). Always retrieve dynamically.
          const nowLA = TimezoneUtils.getCurrentTimeInZone('America/Los_Angeles');
          const laOffset = TimezoneUtils.getTimezoneOffset('America/Los_Angeles');
          
          console.log('[ClassCountdownTimer] Current LA time:', nowLA.toLocaleString('en-US'), '(UTC offset:', laOffset, 'hours)');
          
          // Check each day for the next 7 days
          for (let daysAhead = 0; daysAhead <= 7; daysAhead++) {
            const checkDate = new Date(nowLA.getTime() + daysAhead * 86400000);
            const checkDayName = checkDate.toLocaleDateString('en-US', { weekday: 'long', timeZone: 'America/Los_Angeles' });

            groups.forEach(group => {
              let sessions = [];

              const normalizeDay = (day) => {
                if (!day || typeof day !== 'string') return '';
                const map = {
                  'sun': 'Sunday', 'sunday': 'Sunday',
                  'mon': 'Monday', 'monday': 'Monday',
                  'tue': 'Tuesday', 'tues': 'Tuesday', 'tuesday': 'Tuesday',
                  'wed': 'Wednesday', 'weds': 'Wednesday', 'wednesday': 'Wednesday',
                  'thu': 'Thursday', 'thur': 'Thursday', 'thurs': 'Thursday', 'thursday': 'Thursday',
                  'fri': 'Friday', 'friday': 'Friday',
                  'sat': 'Saturday', 'saturday': 'Saturday'
                };
                return map[day.toLowerCase()] || day;
              };

              if (Array.isArray(group.schedule)) {
                // Legacy array format with { days: [], time: '' }
                group.schedule.forEach(slot => {
                  if (!slot || !slot.days || !slot.time) return;
                  const timeFormatted = ensureAMPMFormatLocal(slot.time);
                  slot.days.forEach(day => {
                    if (day) {
                      sessions.push({
                        day: normalizeDay(day),
                        time: timeFormatted
                      });
                    }
                  });
                });
              } else if (Array.isArray(group.sessions)) {
                // Some imports might store sessions separately
                sessions = group.sessions
                  .filter(s => s && s.day && s.time)
                  .map(s => ({
                    day: normalizeDay(s.day),
                    time: ensureAMPMFormatLocal(s.time)
                  }));
              } else if (typeof group.schedule === 'string') {
                // Primary format: "Mon/Wed 8:00 AM, Fri 9:30 PM"
                sessions = parseScheduleString(group.schedule);
              }

              if (!sessions.length) return;
              
              sessions.forEach(session => {
                if (session.day !== checkDayName) return;

                // Parse time
                const match = session.time.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                if (!match) return;

                let hours = parseInt(match[1]);
                const minutes = parseInt(match[2]);
                const period = match[3].toUpperCase();

                if (period === 'PM' && hours !== 12) hours += 12;
                if (period === 'AM' && hours === 12) hours = 0;

                // Create exact class datetime
                const classDate = new Date(checkDate);
                classDate.setHours(hours, minutes, 0, 0);
                
                // Calculate time difference in seconds
                const totalDiffSeconds = Math.floor((classDate - nowLA) / 1000);
                
                if (daysAhead === 0) {
                  console.log(`[ClassCountdownTimer] ${group.name} ${checkDayName} ${session.time}: ${(totalDiffSeconds/3600).toFixed(1)}h away`);
                }
                
                // BEGIN CLASS COUNTDOWN TIMER FIX
                // Skip if more than 2 hours (7200 seconds) past - class is over
                if (totalDiffSeconds < -7200) return;

                // Skip classes currently in progress (between 0 and -7200 seconds)
                // Only show future classes (totalDiffSeconds > 0)
                if (totalDiffSeconds > 0) {
                // END CLASS COUNTDOWN TIMER FIX
                  let dayLabel = '';
                  if (daysAhead === 0) {
                    dayLabel = 'Today';
                  } else if (daysAhead === 1) {
                    dayLabel = 'Tomorrow';
                  } else {
                    dayLabel = checkDayName;
                  }

                  allClasses.push({
                    groupName: group.name && group.name.length === 1 ? `Group ${group.name}` : (group.name || 'Unknown Group'),
                    dayName: dayLabel,
                    laTime: session.time,
                    secondsRemaining: totalDiffSeconds,
                    actualDay: checkDayName,
                    sortTime: totalDiffSeconds
                  });
                }
              });
            });
          }

          // BEGIN CLASS COUNTDOWN TIMER FIX
          // Sort by time chronologically (no special "in-progress" sorting)
          allClasses.sort((a, b) => a.sortTime - b.sortTime);
          // END CLASS COUNTDOWN TIMER FIX

          // Remove duplicates based on group name + time + day
          const uniqueClasses = [];
          const seenKeys = new Set();
          
          allClasses.forEach(classItem => {
            const key = `${classItem.groupName}|${classItem.laTime}|${classItem.actualDay}`;
            if (!seenKeys.has(key)) {
              seenKeys.add(key);
              uniqueClasses.push(classItem);
            }
          });

          console.log('[ClassCountdownTimer] Found', uniqueClasses.length, 'unique upcoming classes (removed', allClasses.length - uniqueClasses.length, 'duplicates)');
          return uniqueClasses;
        } catch (error) {
          console.error('[ClassCountdownTimer] Error getting all classes:', error);
          return [];
        }
      }

      // Update timer display with all classes
      function updateDisplay() {
        if (!timerElement) return;

        const allClasses = getAllUpcomingClasses();
        const listContainer = timerElement.querySelector('.timer-classes-list');
        const titleEl = timerElement.querySelector('.timer-title');
        
        if (!allClasses || allClasses.length === 0) {
          titleEl.textContent = 'Upcoming Classes';
          listContainer.innerHTML = '<div class="timer-no-classes">No upcoming classes in the next 7 days</div>';
          return;
        }

        // BEGIN CLASS COUNTDOWN TIMER FIX - Remove "Class in Progress" title
        // Update title based on content (never show "Class in Progress")
        if (allClasses.length === 1) {
          titleEl.textContent = `Next Class: ${allClasses[0].groupName}`;
        } else {
          titleEl.textContent = `${allClasses.length} Upcoming Classes`;
        }
        // END CLASS COUNTDOWN TIMER FIX

        let html = '';
        allClasses.forEach((classData, index) => {
          const yerevanData = convertLAToYerevanTime(classData.laTime);
          const countdown = formatCountdown(classData.secondsRemaining);
          
          // BEGIN CLASS COUNTDOWN TIMER FIX - Remove "in-progress" state
          // Determine card tint class based on time remaining
          let cardTintClass = '';
          let stateClass = '';
          let stateIcon = '';
          
          const hoursRemaining = classData.secondsRemaining / 3600;
          
          // Apply per-class tinting based on urgency
          if (hoursRemaining > 24) {
            cardTintClass = 'class-safe'; // Green
          } else if (hoursRemaining > 12) {
            cardTintClass = 'class-upcoming'; // Yellow
          } else if (hoursRemaining > 6) {
            cardTintClass = 'class-warning'; // Orange
          } else {
            cardTintClass = 'class-critical'; // Red with pulse
          }
          
          // State icons based on urgency
          if (classData.secondsRemaining < 900) { // <15m
            stateClass = 'urgent';
            stateIcon = '🔴';
          } else if (classData.secondsRemaining < 3600) { // <60m
            stateClass = 'warning';
            stateIcon = '🟡';
          } else {
            stateIcon = '⏱️';
          }
          // END CLASS COUNTDOWN TIMER FIX

          const isNext = index === 0;

          html += `
            <div class="timer-class-item ${cardTintClass} ${stateClass} ${isNext ? 'next-class' : ''}">
              <div class="timer-class-header">
                <span class="timer-class-icon">${stateIcon}</span>
                <span class="timer-class-group">${classData.groupName}</span>
                <span class="timer-class-countdown">${countdown}</span>
              </div>
              <div class="timer-class-details">
                <span class="timer-class-day">${classData.dayName}</span>
                <span class="timer-class-separator">•</span>
                <span class="timer-class-time">${classData.laTime} LA</span>
                <span class="timer-class-separator">•</span>
                <span class="timer-class-time">${yerevanData.time} Yerevan</span>
              </div>
            </div>
          `;
        });

        listContainer.innerHTML = html;
      }

      // Initialize timer
      function init() {
        // Prevent duplicate initialization
        if (updateInterval) {
          console.warn('[ClassCountdownTimer] Already initialized - reusing existing instance');
          return;
        }

        createElement();
        updateDisplay();

        // Start live updates (every minute)
        updateInterval = setInterval(() => {
          updateDisplay();
        }, 60000);

        console.log('[ClassCountdownTimer] Initialized once — Active (1 interval)');
      }

      // Destroy timer
      function destroy() {
        // Clear interval first
        if (updateInterval) {
          clearInterval(updateInterval);
          updateInterval = null;
          console.log('[ClassCountdownTimer] Interval cleared');
        }

        // Remove click-outside listener
        if (window._timerClickOutsideListener) {
          document.removeEventListener('click', window._timerClickOutsideListener);
          window._timerClickOutsideListener = null;
        }

        // Remove element
        if (timerElement) {
          timerElement.remove();
          timerElement = null;
        }

        currentClassData = null;
        console.log('[ClassCountdownTimer] Destroyed');
      }

      // Toggle pin mode (above modals)
      function togglePin() {
        isPinned = !isPinned;
        if (timerElement) {
          if (isPinned) {
            timerElement.classList.add('pinned');
          } else {
            timerElement.classList.remove('pinned');
          }
        }
        return isPinned;
      }

      // Public API
      return {
        init,
        destroy,
        togglePin,
        getCurrentClass: () => currentClassData,
        isActive: () => timerElement !== null
      };
    })();
    
    // Reinitialize countdown timer when groups/schedules are updated
    window.addEventListener('groups:updated', () => {
      if (window.ClassCountdownTimer) {
        window.ClassCountdownTimer.destroy();
        setTimeout(() => {
          window.ClassCountdownTimer.init();
        }, 500);
      }
    });
    
    window.addEventListener('schedules:updated', () => {
      if (window.ClassCountdownTimer) {
        window.ClassCountdownTimer.destroy();
        setTimeout(() => {
          window.ClassCountdownTimer.init();
        }, 500);
      }
    });
    
    /* END CLASS COUNTDOWN TIMER */

    // Initialize Floating Nav on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFloatingNav);
    } else {
      // DOM already loaded
      initFloatingNav();
    }
    // ========== END FLOATING NAV FUNCTIONS ==========
    
    // ============================================================================
    // BEGIN EARNING FORECAST SYSTEM
    // ============================================================================
    
    function openEarningsForecast() {
      const modal = document.getElementById('earningsForecastModal');
      if (!modal) return;
      
      modal.style.display = 'block';
      requestAnimationFrame(() => {
        modal.style.opacity = '1';
      });
      
      // Calculate and display forecast
      updateForecastData();
    }
    
    function closeEarningsForecast() {
      const modal = document.getElementById('earningsForecastModal');
      if (!modal) return;
      
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.display = 'none';
      }, 250);
    }
    
    function updateForecastData() {
      // Load students data from Supabase cache
      const students = window.studentsCache || window.globalData?.students || [];
      
      // Safety check: ensure students is an array
      if (!Array.isArray(students)) {
        console.warn('⚠️ Students data is not an array:', students);
        document.getElementById('forecastActiveCount').textContent = '0';
        document.getElementById('forecastWeekly').textContent = formatCurrency(0, '$');
        document.getElementById('forecastMonthly').textContent = formatCurrency(0, '$');
        document.getElementById('forecastActual').textContent = formatCurrency(0, '$');
        return;
      }
      
      // Filter active students only (exclude paused, graduated, inactive)
      const activeStudents = students.filter(s => {
        const status = (s.status || 'active').toLowerCase();
        return status === 'active' && s.isActive !== false;
      });
      
      // Calculate weekly and monthly projections
      let totalWeekly = 0;
      let activeCount = 0;
      
      activeStudents.forEach(student => {
        // Get student's per-class payment rate
        const pricePerClass = parseFloat(student.payPerClass) || 0;
        
        // Skip if no price set
        if (pricePerClass <= 0) return;
        
        const groupName = student.group || '';
        
        // Skip if no group assigned
        if (!groupName.trim()) return;
        
        // Count weekly classes for this student's group
        const weeklyClasses = countWeeklyClasses(groupName);
        
        // Skip if group has no schedule
        if (weeklyClasses <= 0) return;
        
        // Calculate: student's weekly earning = price per class × weekly classes
        const studentWeekly = pricePerClass * weeklyClasses;
        
        // Add to total
        totalWeekly += studentWeekly;
        activeCount++;
      });
      
      // Calculate monthly projection (weekly × 4)
      const totalMonthly = totalWeekly * 4;
      
      // Calculate actual earnings for current month
      const actualEarnings = calculateActualMonthlyEarnings();
      
      // Update UI with formatted values
      document.getElementById('forecastActiveCount').textContent = activeCount;
      document.getElementById('forecastWeekly').textContent = formatCurrency(totalWeekly, '$');
      document.getElementById('forecastMonthly').textContent = formatCurrency(totalMonthly, '$');
      document.getElementById('forecastActual').textContent = formatCurrency(actualEarnings, '$');
    }
    
    function countWeeklyClasses(groupName) {
      // Return 0 if no group name provided
      if (!groupName || !groupName.trim()) return 0;
      
      // Load groups from Supabase cache
      const groups = window.groupsCache || window.globalData?.groups || [];
      
      // Find the group by name
      const group = groups.find(g => g.name === groupName);
      
      // Return 0 if group not found or no schedule
      if (!group || !group.schedule) return 0;
      
      // Parse schedule string (e.g., "Mon 8:00 AM, Wed 8:00 PM, Fri 8:00 PM")
      // Count comma-separated day-time slots
      const scheduleString = group.schedule.trim();
      
      if (!scheduleString) return 0;
      
      // Split by comma and count non-empty slots
      const slots = scheduleString.split(',').filter(slot => slot.trim() !== '');
      
      return slots.length;
    }
    
    function calculateActualMonthlyEarnings() {
      // Load payments from localStorage
      const payments = PaymentStore.getAll();
      
      // Get current month and year
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      let total = 0;
      
      payments.forEach(payment => {
        // Skip ignored payments
        if (payment.ignoredOnce || payment.ignorePermanently) return;
        
        // Get payment date (try multiple date fields)
        const dateString = payment.emailDate || payment.transactionDate || payment.createdAt;
        
        if (!dateString) return;
        
        const paymentDate = new Date(dateString);
        
        // Validate date
        if (isNaN(paymentDate.getTime())) return;
        
        // Check if payment is from current month and year
        if (paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear) {
          const amount = parseFloat(payment.amount) || 0;
          total += amount;
        }
      });
      
      return total;
    }
    
    // Listen for data updates to refresh forecast automatically
    window.addEventListener('students:updated', () => {
      const modal = document.getElementById('earningsForecastModal');
      if (modal && modal.style.display === 'block') {
        updateForecastData();
      }
    });
    
    window.addEventListener('payments:updated', () => {
      const modal = document.getElementById('earningsForecastModal');
      if (modal && modal.style.display === 'block') {
        updateForecastData();
      }
    });
    
    window.addEventListener('groups:updated', () => {
      const modal = document.getElementById('earningsForecastModal');
      if (modal && modal.style.display === 'block') {
        updateForecastData();
      }
    });
    
    window.addEventListener('schedules:updated', () => {
      const modal = document.getElementById('earningsForecastModal');
      if (modal && modal.style.display === 'block') {
        updateForecastData();
      }
    });
    
    // ============================================================================
    // STUDENT BREAKDOWN MODAL
    // ============================================================================
    
    function openStudentBreakdown() {
      const modal = document.getElementById('studentBreakdownModal');
      if (!modal) return;
      
      // Calculate and display breakdown
      updateStudentBreakdown();
      
      modal.style.display = 'block';
      requestAnimationFrame(() => {
        modal.style.opacity = '1';
      });
    }
    
    function closeStudentBreakdown() {
      const modal = document.getElementById('studentBreakdownModal');
      if (!modal) return;
      
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.display = 'none';
      }, 250);
    }
    
    function updateStudentBreakdown() {
      const students = window.studentsCache || window.globalData?.students || [];
      const container = document.getElementById('studentBreakdownList');
      
      if (!container) return;
      
      // Safety check
      if (!Array.isArray(students)) {
        console.warn('⚠️ Students data is not an array in breakdown:', students);
        container.innerHTML = '<div class="no-data">No student data available</div>';
        return;
      }
      
      // Filter active students
      const activeStudents = students.filter(s => {
        const status = (s.status || 'active').toLowerCase();
        return status === 'active' && s.isActive !== false;
      });
      
      let totalWeekly = 0;
      let html = '';
      
      // Build list of students with their earnings
      const studentData = [];
      
      activeStudents.forEach(student => {
        const pricePerClass = parseFloat(student.payPerClass) || 0;
        if (pricePerClass <= 0) return;
        
        const groupName = student.group || '';
        if (!groupName.trim()) return;
        
        const weeklyClasses = countWeeklyClasses(groupName);
        if (weeklyClasses <= 0) return;
        
        const studentWeekly = pricePerClass * weeklyClasses;
        const studentMonthly = studentWeekly * 4;
        
        totalWeekly += studentWeekly;
        
        studentData.push({
          name: student.name,
          group: groupName,
          pricePerClass,
          weeklyClasses,
          studentWeekly,
          studentMonthly
        });
      });
      
      // Sort by name
      studentData.sort((a, b) => a.name.localeCompare(b.name));
      
      // Generate HTML
      studentData.forEach(data => {
        html += `
          <div style="padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='rgba(255,255,255,0.03)'">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div>
                <div style="font-size: 16px; font-weight: 700; color: white; margin-bottom: 4px;">${escapeHtml(data.name)}</div>
                <div style="font-size: 12px; color: #94a3b8;">Group ${escapeHtml(data.group)} • ${data.weeklyClasses} classes/week • ${formatCurrency(data.pricePerClass, '$')}/class</div>
              </div>
            </div>
            <div style="display: flex; gap: 16px; margin-top: 12px;">
              <div style="flex: 1; padding: 10px; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px;">
                <div style="font-size: 10px; font-weight: 700; color: #22c55e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Weekly</div>
                <div style="font-size: 18px; font-weight: 900; color: white;">${formatCurrency(data.studentWeekly, '$')}</div>
              </div>
              <div style="flex: 1; padding: 10px; background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.4); border-radius: 8px;">
                <div style="font-size: 10px; font-weight: 700; color: #22c55e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Monthly</div>
                <div style="font-size: 18px; font-weight: 900; color: white;">${formatCurrency(data.studentMonthly, '$')}</div>
              </div>
            </div>
          </div>
        `;
      });
      
      // Show message if no students
      if (studentData.length === 0) {
        html = '<div style="padding: 40px; text-align: center; color: #94a3b8; font-style: italic;">No active students with pricing and schedules</div>';
      }
      
      container.innerHTML = html;
      
      // Update totals
      const totalMonthly = totalWeekly * 4;
      document.getElementById('breakdownTotalWeekly').textContent = formatCurrency(totalWeekly, '$');
      document.getElementById('breakdownTotalMonthly').textContent = formatCurrency(totalMonthly, '$');
    }
    
    // ============================================================================
    // SMART CALENDAR PAYMENT SYSTEM
    // ============================================================================
    
    let currentCalendarDate = new Date();
    let studentBalances = {}; // Track advance payments per student
    
    // Storage key for balances
    const BALANCE_STORAGE_KEY = 'firestone:student-balances:v1';
    
    // Load balances from localStorage
    function loadStudentBalances() {
      const stored = localStorage.getItem(BALANCE_STORAGE_KEY);
      return stored ? JSON.parse(stored) : {};
    }
    
    // Save balances to localStorage
    function saveStudentBalances(balances) {
      localStorage.setItem(BALANCE_STORAGE_KEY, JSON.stringify(balances));
      studentBalances = balances;
    }
    
    // Initialize balances
    studentBalances = loadStudentBalances();
    
    function openSmartCalendar() {
      const modal = document.getElementById('smartCalendarModal');
      if (!modal) return;
      
      currentCalendarDate = new Date();
      renderCalendar();
      
      modal.style.display = 'block';
      requestAnimationFrame(() => {
        modal.style.opacity = '1';
      });
    }
    
    function closeSmartCalendar() {
      const modal = document.getElementById('smartCalendarModal');
      if (!modal) return;
      
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }
    
    function changeCalendarMonth(delta) {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
      renderCalendar();
    }
    
    function renderCalendar() {
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      
      // Update header
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                         'July', 'August', 'September', 'October', 'November', 'December'];
      document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;
      
      // Get calendar data
      const calendarData = generateCalendarData(year, month);
      
      // Update subtitle
      const totalClasses = calendarData.totalScheduledClasses;
      const activeStudentCount = calendarData.activeStudents.length;
      document.getElementById('calendarSubtitle').textContent = 
        `${activeStudentCount} active student${activeStudentCount !== 1 ? 's' : ''} • ${totalClasses} scheduled class${totalClasses !== 1 ? 'es' : ''}`;
      
      // Render grid
      renderCalendarGrid(calendarData);
    }
    
    function generateCalendarData(year, month) {
      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      // Load data
      const students = loadStudents();
      const groups = JSON.parse(localStorage.getItem('group-manager:v2') || '[]');
      const payments = PaymentStore.getAll();
      
      // Filter active students
      const activeStudents = students.filter(s => {
        const status = (s.status || 'active').toLowerCase();
        return status === 'active' && s.isActive !== false;
      });
      
      // Map students to their schedules
      const scheduleMap = {};
      let totalScheduledClasses = 0;
      
      activeStudents.forEach(student => {
        const groupName = student.group || '';
        if (!groupName.trim()) return;
        
        const group = groups.find(g => g.name === groupName);
        if (!group || !group.schedule) return;
        
        // Parse schedule (e.g., "Monday 8:00 PM, Wednesday 8:00 PM")
        const scheduleDays = parseScheduleDays(group.schedule);
        
        if (!scheduleMap[student.id]) {
          scheduleMap[student.id] = {
            student: student,
            scheduleDays: scheduleDays,
            pricePerClass: parseFloat(student.payPerClass) || 0
          };
        }
      });
      
      // Build day data
      const days = [];
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dayOfWeek = date.getDay();
        const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek];
        
        // Check which students have class on this day
        const studentsWithClass = [];
        
        Object.values(scheduleMap).forEach(({ student, scheduleDays, pricePerClass }) => {
          if (scheduleDays.includes(dayName)) {
            const paymentStatus = checkPaymentStatus(student, date, pricePerClass, payments);
            studentsWithClass.push({
              student,
              pricePerClass,
              ...paymentStatus
            });
            totalScheduledClasses++;
          }
        });
        
        days.push({
          day,
          date,
          dayName,
          studentsWithClass
        });
      }
      
      return {
        firstDay,
        daysInMonth,
        days,
        activeStudents,
        totalScheduledClasses
      };
    }
    
    function parseScheduleDays(scheduleString) {
      // Parse "Monday 8:00 PM, Wednesday 8:00 PM" → ["Monday", "Wednesday"]
      if (!scheduleString || !scheduleString.trim()) return [];
      
      const days = [];
      const slots = scheduleString.split(',');
      
      slots.forEach(slot => {
        const trimmed = slot.trim();
        const dayMatch = trimmed.match(/^(Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday)/i);
        if (dayMatch) {
          days.push(dayMatch[1]);
        }
      });
      
      return days;
    }
    
    function checkPaymentStatus(student, classDate, pricePerClass, payments) {
      const dateStr = formatDateYYYYMMDD(classDate);
      const studentId = student.id;
      
      // Check if student has balance
      const balance = studentBalances[studentId] || 0;
      
      // Check for payment on this specific date
      const paymentOnDate = payments.find(p => {
        if (p.ignored) return false;
        
        const paymentDate = new Date(p.timestamp);
        const paymentDateStr = formatDateYYYYMMDD(paymentDate);
        
        // Check if payment matches student
        const matchesStudent = p.studentName === student.name || 
                              (student.aliases && student.aliases.includes(p.payerName));
        
        return matchesStudent && paymentDateStr === dateStr;
      });
      
      if (paymentOnDate) {
        const paymentAmount = parseFloat(paymentOnDate.amount) || 0;
        
        // Check if this is an advance payment (more than one class)
        if (paymentAmount > pricePerClass) {
          const newBalance = balance + paymentAmount;
          studentBalances[studentId] = newBalance;
          saveStudentBalances(studentBalances);
          
          return {
            status: 'deposit',
            paid: true,
            amount: paymentAmount,
            balance: newBalance,
            message: `Paid ${formatCurrency(paymentAmount, '$')} (Deposit: ${formatCurrency(newBalance, '$')})`
          };
        } else {
          return {
            status: 'paid',
            paid: true,
            amount: paymentAmount,
            balance: 0,
            message: `Paid ${formatCurrency(paymentAmount, '$')}`
          };
        }
      }
      
      // Check if can deduct from balance
      if (balance >= pricePerClass && classDate <= new Date()) {
        const newBalance = balance - pricePerClass;
        studentBalances[studentId] = newBalance;
        saveStudentBalances(studentBalances);
        
        // Check if low balance alert needed
        const lowBalance = newBalance > 0 && newBalance <= pricePerClass;
        
        return {
          status: lowBalance ? 'low-balance' : 'deducted',
          paid: true,
          amount: pricePerClass,
          balance: newBalance,
          message: `Deducted ${formatCurrency(pricePerClass, '$')} (Remaining: ${formatCurrency(newBalance, '$')})`,
          alert: lowBalance ? `⚠️ Only 1 class remaining` : null
        };
      }
      
      // Check if marked absent
      const absentKey = `absent:${studentId}:${dateStr}`;
      const isAbsent = localStorage.getItem(absentKey) === 'true';
      
      if (isAbsent) {
        return {
          status: 'absent',
          paid: false,
          amount: 0,
          balance: balance,
          message: 'Marked Absent'
        };
      }
      
      // Unpaid
      return {
        status: 'unpaid',
        paid: false,
        amount: 0,
        balance: balance,
        message: 'Not Paid',
        showActions: classDate <= new Date() // Only show actions for past/current dates
      };
    }
    
    function formatDateYYYYMMDD(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    function renderCalendarGrid(calendarData) {
      const grid = document.getElementById('calendarGrid');
      if (!grid) return;
      
      let html = '';
      
      // Empty cells before first day
      for (let i = 0; i < calendarData.firstDay; i++) {
        html += '<div style="min-height: 100px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 8px;"></div>';
      }
      
      // Day cells
      calendarData.days.forEach(dayData => {
        const isToday = isDateToday(dayData.date);
        const hasClasses = dayData.studentsWithClass.length > 0;
        
        html += `
          <div style="min-height: 100px; background: ${isToday ? 'rgba(138,180,255,0.08)' : 'rgba(255,255,255,0.02)'}; border: 1px solid ${isToday ? 'rgba(138,180,255,0.3)' : 'rgba(255,255,255,0.05)'}; border-radius: 8px; padding: 8px; display: flex; flex-direction: column; overflow: hidden;">
            <div style="font-size: 14px; font-weight: 700; color: ${isToday ? '#8ab4ff' : 'white'}; margin-bottom: 6px;">
              ${dayData.day}
              ${isToday ? '<span style="font-size: 9px; color: #8ab4ff; margin-left: 4px;">TODAY</span>' : ''}
            </div>
            <div style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px;">
              ${hasClasses ? renderDayClasses(dayData) : ''}
            </div>
          </div>
        `;
      });
      
      grid.innerHTML = html;
    }
    
    function renderDayClasses(dayData) {
      let html = '';
      
      dayData.studentsWithClass.forEach(classInfo => {
        const { student, status, message, balance, alert, showActions } = classInfo;
        
        let bgColor, borderColor, icon;
        
        switch (status) {
          case 'paid':
            bgColor = 'rgba(34,197,94,0.15)';
            borderColor = 'rgba(34,197,94,0.4)';
            icon = '✅';
            break;
          case 'deposit':
            bgColor = 'rgba(234,179,8,0.15)';
            borderColor = 'rgba(234,179,8,0.4)';
            icon = '💰';
            break;
          case 'deducted':
            bgColor = 'rgba(34,197,94,0.12)';
            borderColor = 'rgba(34,197,94,0.3)';
            icon = '✓';
            break;
          case 'low-balance':
            bgColor = 'rgba(234,179,8,0.15)';
            borderColor = 'rgba(234,179,8,0.4)';
            icon = '⚠️';
            break;
          case 'absent':
            bgColor = 'rgba(100,116,139,0.15)';
            borderColor = 'rgba(100,116,139,0.4)';
            icon = '🚫';
            break;
          case 'unpaid':
          default:
            bgColor = 'rgba(239,68,68,0.15)';
            borderColor = 'rgba(239,68,68,0.4)';
            icon = '❌';
            break;
        }
        
        const dateStr = formatDateYYYYMMDD(dayData.date);
        
        html += `
          <div style="padding: 6px; background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 6px; font-size: 10px; transition: all 0.2s; cursor: pointer;" 
               onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)';" 
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';"
               onclick="showClassDetails('${student.id}', '${dateStr}', ${JSON.stringify(classInfo).replace(/"/g, '&quot;')})">
            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 3px;">
              <span>${icon}</span>
              <span style="font-weight: 700; color: white; font-size: 9px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(student.name)}</span>
            </div>
            <div style="font-size: 8px; color: rgba(255,255,255,0.7);">${message}</div>
            ${alert ? `<div style="font-size: 8px; color: #eab308; margin-top: 2px; font-weight: 700;">${alert}</div>` : ''}
          </div>
        `;
      });
      
      return html;
    }
    
    function isDateToday(date) {
      const today = new Date();
      return date.getDate() === today.getDate() &&
             date.getMonth() === today.getMonth() &&
             date.getFullYear() === today.getFullYear();
    }
    
    function showClassDetails(studentId, dateStr, classInfo) {
      const student = classInfo.student;
      const dateObj = new Date(dateStr);
      const dateDisplay = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      
      let actionsHTML = '';
      
      if (classInfo.showActions && classInfo.status === 'unpaid') {
        actionsHTML = `
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 12px; font-weight: 600;">Quick Actions:</div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="event.stopPropagation(); quickAddPayment('${studentId}', '${dateStr}', ${classInfo.pricePerClass})" style="padding: 8px 14px; background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.4); border-radius: 8px; color: #22c55e; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(34,197,94,0.3)'" onmouseout="this.style.background='rgba(34,197,94,0.2)'">
                ➕ Add Payment
              </button>
              <button onclick="event.stopPropagation(); markAsAbsent('${studentId}', '${dateStr}')" style="padding: 8px 14px; background: rgba(100,116,139,0.2); border: 1px solid rgba(100,116,139,0.4); border-radius: 8px; color: #94a3b8; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(100,116,139,0.3)'" onmouseout="this.style.background='rgba(100,116,139,0.2)'">
                🚫 Mark Absent
              </button>
            </div>
          </div>
        `;
      }
      
      if (classInfo.status === 'absent') {
        actionsHTML = `
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
            <button onclick="event.stopPropagation(); unmarkAbsent('${studentId}', '${dateStr}')" style="padding: 8px 14px; background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.4); border-radius: 8px; color: #ef4444; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(239,68,68,0.3)'" onmouseout="this.style.background='rgba(239,68,68,0.2)'">
              ↩️ Unmark Absent
            </button>
          </div>
        `;
      }
      
      const balanceInfo = classInfo.balance > 0 ? `
        <div style="margin-top: 12px; padding: 12px; background: rgba(234,179,8,0.1); border: 1px solid rgba(234,179,8,0.3); border-radius: 8px;">
          <div style="font-size: 11px; color: #eab308; font-weight: 700; margin-bottom: 4px;">BALANCE</div>
          <div style="font-size: 18px; color: white; font-weight: 900;">${formatCurrency(classInfo.balance, '$')}</div>
          <div style="font-size: 10px; color: rgba(255,255,255,0.6); margin-top: 4px;">≈ ${Math.floor(classInfo.balance / classInfo.pricePerClass)} class${Math.floor(classInfo.balance / classInfo.pricePerClass) !== 1 ? 'es' : ''} remaining</div>
        </div>
      ` : '';
      
      const detailHTML = `
        <div onclick="event.stopPropagation()" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 28000; background: linear-gradient(135deg, rgba(30,30,46,0.98) 0%, rgba(42,42,62,0.98) 100%); border: 2px solid rgba(138,180,255,0.3); border-radius: 16px; padding: 24px; min-width: 400px; max-width: 500px; backdrop-filter: blur(20px); box-shadow: 0 20px 60px rgba(0,0,0,0.7);">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
            <div>
              <h3 style="margin: 0 0 4px 0; font-size: 20px; font-weight: 900; color: white;">${escapeHtml(student.name)}</h3>
              <p style="margin: 0; font-size: 12px; color: #94a3b8;">Group ${escapeHtml(student.group || 'N/A')}</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove(); document.getElementById('calendarDetailOverlay').remove();" style="width: 32px; height: 32px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
          </div>
          
          <div style="padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 16px;">
            <div style="font-size: 11px; color: #8ab4ff; font-weight: 700; margin-bottom: 6px;">CLASS DATE</div>
            <div style="font-size: 14px; color: white; font-weight: 700;">${dateDisplay}</div>
          </div>
          
          <div style="padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 16px;">
            <div style="font-size: 11px; color: #8ab4ff; font-weight: 700; margin-bottom: 6px;">STATUS</div>
            <div style="font-size: 14px; color: white; font-weight: 700;">${classInfo.message}</div>
          </div>
          
          <div style="padding: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px;">
            <div style="font-size: 11px; color: #8ab4ff; font-weight: 700; margin-bottom: 6px;">PRICE PER CLASS</div>
            <div style="font-size: 14px; color: white; font-weight: 700;">${formatCurrency(classInfo.pricePerClass, '$')}</div>
          </div>
          
          ${balanceInfo}
          ${actionsHTML}
        </div>
      `;
      
      // Add overlay
      const overlay = document.createElement('div');
      overlay.id = 'calendarDetailOverlay';
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 27500; backdrop-filter: blur(4px);';
      overlay.onclick = function() {
        this.remove();
        document.querySelector('[onclick*="calendarDetailOverlay"]').parentElement.remove();
      };
      
      document.body.insertAdjacentHTML('beforeend', detailHTML);
      document.body.appendChild(overlay);
    }
    
    function quickAddPayment(studentId, dateStr, amount) {
      // Close detail popup
      const overlay = document.getElementById('calendarDetailOverlay');
      if (overlay) overlay.click();
      
      // Open main payment modal or create quick payment
      const confirmed = confirm(`Add payment of ${formatCurrency(amount, '$')} for this class?`);
      if (!confirmed) return;
      
      const students = loadStudents();
      const student = students.find(s => s.id === studentId);
      if (!student) return;
      
      const payment = {
        id: 'cal_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        payerName: student.name,
        studentName: student.name,
        amount: amount.toString(),
        timestamp: new Date(dateStr).toISOString(),
        note: 'Added from Calendar',
        ignored: false,
        source: 'calendar'
      };
      
      const payments = PaymentStore.getAll();
      payments.push(payment);
      PaymentStore.save(payments);
      
      showToast('✅ Payment added successfully', 'success');
      renderCalendar();
    }
    
    function markAsAbsent(studentId, dateStr) {
      // Close detail popup
      const overlay = document.getElementById('calendarDetailOverlay');
      if (overlay) overlay.click();
      
      const absentKey = `absent:${studentId}:${dateStr}`;
      localStorage.setItem(absentKey, 'true');
      
      showToast('🚫 Marked as absent', 'success');
      renderCalendar();
    }
    
    function unmarkAbsent(studentId, dateStr) {
      // Close detail popup
      const overlay = document.getElementById('calendarDetailOverlay');
      if (overlay) overlay.click();
      
      const absentKey = `absent:${studentId}:${dateStr}`;
      localStorage.removeItem(absentKey);
      
      showToast('↩️ Unmarked absent', 'success');
      renderCalendar();
    }
    
    // Listen for payment/student updates to refresh calendar
    window.addEventListener('payments:updated', () => {
      if (document.getElementById('smartCalendarModal').style.display !== 'none') {
        renderCalendar();
      }
    });
    
    window.addEventListener('students:updated', () => {
      if (document.getElementById('smartCalendarModal').style.display !== 'none') {
        renderCalendar();
      }
    });
    
    window.addEventListener('groups:updated', () => {
      if (document.getElementById('smartCalendarModal').style.display !== 'none') {
        renderCalendar();
      }
    });
    
    window.addEventListener('schedules:updated', () => {
      if (document.getElementById('smartCalendarModal').style.display !== 'none') {
        renderCalendar();
      }
    });
    
    // ============================================================================
    // END SMART CALENDAR PAYMENT SYSTEM
    // ============================================================================
    
    // ============================================================================
    // END EARNING FORECAST SYSTEM
    // ============================================================================
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initialize);
    
    console.log('✅ ARNOMA app loaded - Using Supabase cloud database');
  </script>
</body>
</html>