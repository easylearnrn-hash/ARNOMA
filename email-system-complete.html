<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ARNOMA Email System v2.0 - Supabase</title>

    <style>
      :root {
        --primary: #a5b4fc;
        --primary-bright: #c7d2fe;
        --secondary: #94a3b8;
        --ink: #f8fafc;
        --ink-dim: #cbd5e1;
        --bg-dark: #1e293b;
        --bg-darker: #0f172a;
        --text: #f8fafc;
        --stroke: rgba(255, 255, 255, 0.2);
        --success: #4ade80;
        --warning: #fbbf24;
        --error: #f87171;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: var(--ink);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 24px 32px;
        border-radius: 16px;
        margin-bottom: 32px;
        display: flex;
        align-items: center;
        gap: 16px;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.08) 0%, transparent 70%);
        border-radius: 50%;
      }

      .header-icon {
        background: rgba(255, 255, 255, 0.2);
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        backdrop-filter: blur(10px);
        position: relative;
        z-index: 1;
      }

      .header h1 {
        font-size: 28px;
        font-weight: 700;
        color: white;
        position: relative;
        z-index: 1;
      }

      .header p {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.85);
        margin-top: 4px;
      }

      .btn {
        padding: 14px 28px;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 28px rgba(102, 126, 234, 0.5);
      }

      .btn-secondary {
        background: linear-gradient(135deg, rgba(165, 180, 252, 0.2), rgba(165, 180, 252, 0.3));
        border: 2px solid rgba(165, 180, 252, 0.5);
        color: var(--primary-bright);
      }

      .btn-secondary:hover {
        background: linear-gradient(135deg, rgba(165, 180, 252, 0.3), rgba(165, 180, 252, 0.4));
        border-color: var(--primary-bright);
      }

      .template-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }

      @media (max-width: 900px) {
        .template-grid {
          grid-template-columns: 1fr;
        }
      }

      .template-card {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.6), rgba(30, 41, 59, 0.8));
        backdrop-filter: blur(20px);
        border: 2px solid rgba(165, 180, 252, 0.25);
        border-radius: 16px;
        padding: 24px;
        transition: all 0.3s;
        cursor: pointer;
        min-width: 0;
        width: 100%;
      }

      .template-card:hover {
        border-color: var(--primary-bright);
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.7), rgba(30, 41, 59, 0.9));
        box-shadow: 0 12px 32px rgba(165, 180, 252, 0.3);
        transform: translateY(-3px);
      }

      .notification {
        position: fixed;
        top: 24px;
        right: 24px;
        padding: 16px 24px;
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border: 2px solid var(--primary-bright);
        border-radius: 14px;
        color: var(--ink);
        font-weight: 600;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        box-shadow:
          0 10px 30px rgba(0, 0, 0, 0.6),
          0 0 0 1px rgba(165, 180, 252, 0.2);
      }

      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--ink);
        font-size: 14px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px 16px;
        background: rgba(248, 250, 252, 0.08);
        border: 2px solid rgba(165, 180, 252, 0.3);
        border-radius: 12px;
        color: var(--ink);
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-bright);
        background: rgba(248, 250, 252, 0.12);
        box-shadow: 0 0 0 3px rgba(165, 180, 252, 0.15);
      }

      .form-group textarea {
        min-height: 200px;
        resize: vertical;
        line-height: 1.6;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(8px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .modal.active {
        display: flex;
      }

      /* Ensure preview modal appears above sent emails modal */
      #sentEmailsModal {
        z-index: 1000;
      }

      #previewModal {
        z-index: 1001;
      }

      .modal-content {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border: 2px solid rgba(165, 180, 252, 0.4);
        border-radius: 20px;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      }

      .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px 24px;
        position: relative;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      }

      .modal-header h2 {
        font-size: 24px;
        color: white;
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 0;
      }

      .modal-close {
        position: absolute;
        top: 12px;
        right: 16px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: bold;
        transition: all 0.2s;
      }

      .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
      }

      .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
      }

      .info-banner {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
        padding: 16px 20px;
        border-radius: 12px;
        border: 2px solid rgba(138, 180, 255, 0.3);
        margin-bottom: 24px;
        display: flex;
        gap: 12px;
      }

      .info-icon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
      }

      .btn-icon {
        background: rgba(165, 180, 252, 0.2);
        border: 2px solid rgba(165, 180, 252, 0.35);
        color: var(--ink);
        width: 38px;
        height: 38px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.2s;
      }

      .btn-icon:hover {
        background: rgba(165, 180, 252, 0.3);
        border-color: var(--primary-bright);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(165, 180, 252, 0.25);
      }
    </style>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-icon">üìß</div>
        <div>
          <h1>ARNOMA Email System</h1>
          <p>Professional automated email templates with HTML formatting</p>
        </div>
        <button
          id="gmailConnectBtn"
          class="btn btn-secondary"
          onclick="connectGmail()"
          style="margin-left: auto; margin-right: 12px"
        >
          üìß Connect Gmail
        </button>
        <button class="btn btn-secondary" onclick="openSentEmails()" style="margin-right: 12px">üì® Sent Emails</button>
        <button class="btn btn-secondary" onclick="openAutomations()" style="margin-right: 12px">‚öôÔ∏è Automations</button>
        <button class="btn btn-primary" onclick="openEditor()">‚ú® Create Template</button>
      </div>

      <!-- Email Testing Section -->
      <div
        style="
          background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
          padding: 24px 32px;
          border-radius: 16px;
          margin-bottom: 32px;
        "
      >
        <h2 style="color: white; margin-bottom: 16px; display: flex; align-items: center; gap: 12px">
          <span style="font-size: 32px">üß™</span>
          <span>Email Handler Testing</span>
        </h2>
        <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 20px">
          Click any button to send a test email to your inbox
        </p>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px">
          <button onclick="testProfileUpdate()" class="btn" style="background: #8b5cf6; color: white">
            üìù Profile Update
          </button>
          <button onclick="testAliasAdded()" class="btn" style="background: #8b5cf6; color: white">
            üë• Alias Added
          </button>
          <button onclick="testScheduleUpdate()" class="btn" style="background: #8b5cf6; color: white">
            üìÖ Schedule Update
          </button>
          <button onclick="testGroupEnrollment()" class="btn" style="background: #8b5cf6; color: white">
            üéì Group Enrollment
          </button>
          <button onclick="testCreditAdded()" class="btn" style="background: #10b981; color: white">
            üí∞ Credit Added
          </button>
          <button onclick="testCreditApplied()" class="btn" style="background: #10b981; color: white">
            üí≥ Credit Applied
          </button>
          <button onclick="testCreditEdit()" class="btn" style="background: #10b981; color: white">
            ‚úèÔ∏è Credit Edit
          </button>
          <button onclick="testStatusPaused()" class="btn" style="background: #ef4444; color: white">
            ‚è∏Ô∏è Status Paused
          </button>
          <button onclick="testStatusActive()" class="btn" style="background: #22c55e; color: white">
            ‚ñ∂Ô∏è Status Active
          </button>
          <button onclick="testStatusGraduated()" class="btn" style="background: #06b6d4; color: white">
            üéì Graduated
          </button>
          <button onclick="testAbsence()" class="btn" style="background: #f59e0b; color: white">‚ùå Absence</button>
          <button onclick="testScheduleChange()" class="btn" style="background: #3b82f6; color: white">
            üîÑ Schedule Change
          </button>
        </div>

        <div style="margin-top: 16px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px">
          <label style="color: white; display: block; margin-bottom: 8px">Test Email Address:</label>
          <input
            type="email"
            id="testEmailAddress"
            placeholder="your@email.com"
            style="width: 100%; padding: 10px; border-radius: 6px; border: none; background: rgba(255, 255, 255, 0.9)"
          />
        </div>
      </div>

      <div class="template-grid" id="templatesGrid">
        <div style="text-align: center; padding: 80px 20px; color: var(--secondary)">
          <div style="font-size: 72px; opacity: 0.3; margin-bottom: 20px">üìß</div>
          <p style="font-size: 18px">Loading templates...</p>
        </div>
      </div>
    </div>

    <!-- Automations Manager Modal -->
    <div id="automationsModal" class="modal">
      <div class="modal-content" style="max-width: 1000px">
        <div class="modal-header">
          <h2>
            <span>‚öôÔ∏è</span>
            <span>Email Automations</span>
          </h2>
          <span class="modal-close" onclick="closeAutomations()">&times;</span>
        </div>

        <div class="modal-body">
          <div id="automationsList">
            <div style="text-align: center; padding: 60px 20px; color: var(--secondary)">
              <div style="font-size: 64px; opacity: 0.3; margin-bottom: 16px">‚öôÔ∏è</div>
              <p style="font-size: 16px">No automations configured yet</p>
              <button class="btn btn-primary" onclick="openAutomationEditor()" style="margin-top: 16px">
                Create First Automation
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Automation Editor Modal -->
    <div id="automationEditorModal" class="modal">
      <div class="modal-content" style="max-width: 900px">
        <div class="modal-header">
          <h2>
            <span>‚ö°</span>
            <span id="automationModalTitle">Create Automation</span>
          </h2>
          <span class="modal-close" onclick="closeAutomationEditor()">&times;</span>
        </div>

        <div class="modal-body">
          <form id="automationForm" onsubmit="saveAutomation(event)">
            <input type="hidden" id="automationId" />

            <div class="form-group">
              <label>Automation Name *</label>
              <input type="text" id="automationName" required placeholder="e.g., Weekly Class Reminder" />
            </div>

            <div class="form-group">
              <label>Select Email Template *</label>
              <select id="automationTemplate" required>
                <option value="">-- Choose Template --</option>
              </select>
            </div>

            <div
              style="
                background: rgba(165, 180, 252, 0.12);
                padding: 20px;
                border-radius: 14px;
                border: 2px solid rgba(165, 180, 252, 0.35);
                margin-bottom: 20px;
              "
            >
              <h3
                style="
                  margin: 0 0 16px 0;
                  color: var(--primary-bright);
                  font-size: 16px;
                  font-weight: 700;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                "
              >
                <span style="font-size: 20px">üë•</span>
                Recipients
                <span style="font-size: 12px; font-weight: 400; color: rgba(255, 255, 255, 0.6); margin-left: 8px">
                  (Select one or more)
                </span>
              </h3>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 14px">
                <label
                  id="groupsToggleBtn"
                  style="
                    background: rgba(255, 255, 255, 0.05);
                    padding: 12px;
                    border-radius: 10px;
                    border: 2px solid rgba(255, 255, 255, 0.1);
                    cursor: pointer;
                    transition: all 0.2s;
                    text-align: center;
                  "
                >
                  <input
                    type="checkbox"
                    id="includeGroups"
                    onchange="toggleRecipientSections()"
                    style="display: none"
                  />
                  <span style="font-weight: 600; color: white">Groups</span>
                </label>
                <label
                  id="allStudentsToggleBtn"
                  style="
                    background: rgba(255, 255, 255, 0.05);
                    padding: 12px;
                    border-radius: 10px;
                    border: 2px solid rgba(255, 255, 255, 0.1);
                    cursor: pointer;
                    transition: all 0.2s;
                    text-align: center;
                  "
                >
                  <input
                    type="checkbox"
                    id="includeAllStudents"
                    onchange="toggleRecipientSections()"
                    style="display: none"
                  />
                  <span style="font-weight: 600; color: white">All Students</span>
                </label>
                <label
                  id="individualToggleBtn"
                  style="
                    background: rgba(255, 255, 255, 0.05);
                    padding: 12px;
                    border-radius: 10px;
                    border: 2px solid rgba(255, 255, 255, 0.1);
                    cursor: pointer;
                    transition: all 0.2s;
                    text-align: center;
                  "
                >
                  <input
                    type="checkbox"
                    id="includeIndividual"
                    onchange="toggleRecipientSections()"
                    style="display: none"
                  />
                  <span style="font-weight: 600; color: white">Individual Emails</span>
                </label>
                <label
                  id="teacherToggleBtn"
                  style="
                    background: rgba(255, 255, 255, 0.05);
                    padding: 12px;
                    border-radius: 10px;
                    border: 2px solid rgba(255, 255, 255, 0.1);
                    cursor: pointer;
                    transition: all 0.2s;
                    text-align: center;
                  "
                >
                  <input
                    type="checkbox"
                    id="includeTeacher"
                    onchange="toggleRecipientSections()"
                    style="display: none"
                  />
                  <span style="font-weight: 600; color: white">Teacher</span>
                </label>
              </div>

              <div id="groupSelection" style="display: none; margin-bottom: 14px">
                <div
                  id="groupList"
                  style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px"
                >
                  <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--secondary)">
                    Loading groups...
                  </div>
                </div>
              </div>

              <div id="individualSelection" style="display: none; margin-bottom: 14px">
                <div style="margin-bottom: 12px">
                  <label
                    style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--ink); font-size: 13px"
                  >
                    Add Email Address
                  </label>
                  <div style="display: flex; gap: 8px">
                    <input
                      type="email"
                      id="emailInput"
                      placeholder="student@example.com"
                      style="
                        flex: 1;
                        padding: 12px;
                        background: rgba(248, 250, 252, 0.08);
                        border: 2px solid rgba(165, 180, 252, 0.3);
                        border-radius: 10px;
                        color: white;
                        font-size: 14px;
                      "
                    />
                    <button
                      type="button"
                      onclick="addEmailToList()"
                      class="btn btn-primary"
                      style="padding: 12px 20px; white-space: nowrap"
                    >
                      Add
                    </button>
                  </div>
                </div>
                <div
                  id="emailList"
                  style="
                    max-height: 200px;
                    overflow-y: auto;
                    background: rgba(15, 23, 42, 0.4);
                    border-radius: 10px;
                    padding: 12px;
                    border: 1px solid rgba(165, 180, 252, 0.2);
                  "
                >
                  <div id="emailListContent" style="display: flex; flex-direction: column; gap: 8px">
                    <div style="color: var(--secondary); font-size: 13px; text-align: center; padding: 20px">
                      No email addresses added yet
                    </div>
                  </div>
                </div>
              </div>

              <div id="teacherSelection" style="display: none; margin-bottom: 14px">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--ink); font-size: 13px">
                  Teacher Email
                </label>
                <input
                  type="email"
                  id="teacherEmail"
                  placeholder="teacher@example.com"
                  style="
                    width: 100%;
                    padding: 12px;
                    background: rgba(248, 250, 252, 0.08);
                    border: 2px solid rgba(245, 158, 11, 0.4);
                    border-radius: 10px;
                    color: white;
                    font-size: 14px;
                  "
                />
              </div>
            </div>

            <div
              style="
                background: rgba(59, 130, 246, 0.08);
                padding: 18px;
                border-radius: 12px;
                border: 2px solid rgba(59, 130, 246, 0.3);
                margin-bottom: 20px;
              "
            >
              <h3
                style="
                  margin: 0 0 14px 0;
                  color: #3b82f6;
                  font-size: 16px;
                  font-weight: 700;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                "
              >
                <span style="font-size: 20px">‚è∞</span>
                Schedule
              </h3>

              <div class="form-group" style="margin-bottom: 14px">
                <label>Frequency</label>
                <select id="automationFrequency" onchange="toggleFrequencyOptions()">
                  <option value="once">One Time</option>
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                  <option value="before_class">Before Class</option>
                </select>
              </div>

              <div id="onceOptions" style="display: block">
                <div class="form-group">
                  <label>Date & Time</label>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
                    <input type="date" id="onceDate" />
                    <input type="time" id="onceTime" value="09:00" />
                  </div>
                </div>
              </div>

              <div id="dailyOptions" style="display: none">
                <div class="form-group">
                  <label>Send at</label>
                  <input type="time" id="dailyTime" value="09:00" />
                </div>
              </div>

              <div id="weeklyOptions" style="display: none">
                <div class="form-group">
                  <label>Days of Week</label>
                  <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px">
                    <label
                      style="
                        background: rgba(255, 255, 255, 0.05);
                        padding: 8px 4px;
                        border-radius: 6px;
                        text-align: center;
                        font-size: 12px;
                        cursor: pointer;
                      "
                    >
                      <input type="checkbox" name="weekdays" value="0" style="display: block; margin: 0 auto 4px" />
                      Sun
                    </label>
                    <label
                      style="
                        background: rgba(255, 255, 255, 0.05);
                        padding: 8px 4px;
                        border-radius: 6px;
                        text-align: center;
                        font-size: 12px;
                        cursor: pointer;
                      "
                    >
                      <input type="checkbox" name="weekdays" value="1" style="display: block; margin: 0 auto 4px" />
                      Mon
                    </label>
                    <label
                      style="
                        background: rgba(255, 255, 255, 0.05);
                        padding: 8px 4px;
                        border-radius: 6px;
                        text-align: center;
                        font-size: 12px;
                        cursor: pointer;
                      "
                    >
                      <input type="checkbox" name="weekdays" value="2" style="display: block; margin: 0 auto 4px" />
                      Tue
                    </label>
                    <label
                      style="
                        background: rgba(255, 255, 255, 0.05);
                        padding: 8px 4px;
                        border-radius: 6px;
                        text-align: center;
                        font-size: 12px;
                        cursor: pointer;
                      "
                    >
                      <input type="checkbox" name="weekdays" value="3" style="display: block; margin: 0 auto 4px" />
                      Wed
                    </label>
                    <label
                      style="
                        background: rgba(255, 255, 255, 0.05);
                        padding: 8px 4px;
                        border-radius: 6px;
                        text-align: center;
                        font-size: 12px;
                        cursor: pointer;
                      "
                    >
                      <input type="checkbox" name="weekdays" value="4" style="display: block; margin: 0 auto 4px" />
                      Thu
                    </label>
                    <label
                      style="
                        background: rgba(255, 255, 255, 0.05);
                        padding: 8px 4px;
                        border-radius: 6px;
                        text-align: center;
                        font-size: 12px;
                        cursor: pointer;
                      "
                    >
                      <input type="checkbox" name="weekdays" value="5" style="display: block; margin: 0 auto 4px" />
                      Fri
                    </label>
                    <label
                      style="
                        background: rgba(255, 255, 255, 0.05);
                        padding: 8px 4px;
                        border-radius: 6px;
                        text-align: center;
                        font-size: 12px;
                        cursor: pointer;
                      "
                    >
                      <input type="checkbox" name="weekdays" value="6" style="display: block; margin: 0 auto 4px" />
                      Sat
                    </label>
                  </div>
                </div>
                <div class="form-group">
                  <label>Send at</label>
                  <input type="time" id="weeklyTime" value="09:00" />
                </div>
              </div>

              <div id="monthlyOptions" style="display: none">
                <div class="form-group">
                  <label>Day of Month</label>
                  <select id="monthlyDay">
                    <option value="1">1st</option>
                    <option value="5">5th</option>
                    <option value="10">10th</option>
                    <option value="15">15th</option>
                    <option value="20">20th</option>
                    <option value="25">25th</option>
                    <option value="last">Last day</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Send at</label>
                  <input type="time" id="monthlyTime" value="09:00" />
                </div>
              </div>

              <div id="beforeClassOptions" style="display: none">
                <div class="form-group">
                  <label>Send before class</label>
                  <select id="beforeClassTime">
                    <option value="15">15 minutes</option>
                    <option value="30">30 minutes</option>
                    <option value="60">1 hour</option>
                    <option value="120">2 hours</option>
                    <option value="180">3 hours</option>
                    <option value="360">6 hours</option>
                    <option value="720">12 hours</option>
                    <option value="1440">1 day</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 10px">
                <input type="checkbox" id="automationActive" checked style="width: 18px; height: 18px" />
                <span>Active (automation will run automatically)</span>
              </label>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px">
              <button type="submit" class="btn btn-primary" style="flex: 1">üíæ Save Automation</button>
              <button type="button" class="btn btn-secondary" onclick="closeAutomationEditor()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
      <div class="modal-content" style="max-width: 700px">
        <div class="modal-header">
          <h2>
            <span>üëÅÔ∏è</span>
            <span>Email Preview</span>
          </h2>
          <span class="modal-close" onclick="closePreviewModal()">&times;</span>
        </div>
        <div class="modal-body" style="padding: 0">
          <iframe
            id="previewFrame"
            style="width: 100%; height: 70vh; border: none; border-radius: 0 0 16px 16px"
          ></iframe>
        </div>
      </div>
    </div>

    <!-- Sent Emails Modal -->
    <div id="sentEmailsModal" class="modal">
      <div class="modal-content" style="max-width: 1000px">
        <div class="modal-header">
          <h2>
            <span>üì®</span>
            <span>Sent Emails History</span>
          </h2>
          <span class="modal-close" onclick="closeSentEmails()">&times;</span>
        </div>
        <div class="modal-body">
          <div class="info-banner" style="margin-bottom: 24px">
            <div class="info-icon">üìä</div>
            <div>
              <div style="font-weight: 700; color: var(--primary); font-size: 14px; margin-bottom: 4px">
                Email History
              </div>
              <div style="font-size: 13px; color: rgba(255, 255, 255, 0.85); line-height: 1.6">
                View all emails sent through the ARNOMA email system
              </div>
            </div>
          </div>

          <div id="sentEmailsList" style="display: flex; flex-direction: column; gap: 12px">
            <div style="text-align: center; padding: 60px 20px; color: var(--secondary)">
              <div style="font-size: 64px; opacity: 0.3; margin-bottom: 16px">üìß</div>
              <p style="font-size: 16px">Loading sent emails...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Editor Modal -->
    <div id="editorModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>
            <span>‚úâÔ∏è</span>
            <span id="modalTitle">Create Email Template</span>
          </h2>
          <span class="modal-close" onclick="closeEditor()">&times;</span>
        </div>

        <div class="modal-body">
          <form id="templateForm" onsubmit="saveTemplate(event)">
            <input type="hidden" id="templateId" />

            <div class="form-group">
              <label>Template Name *</label>
              <input type="text" id="templateName" required placeholder="e.g., Welcome Email, Payment Reminder" />
            </div>

            <div class="form-group">
              <label>Subject Line *</label>
              <input type="text" id="templateSubject" required placeholder="e.g., Welcome to {{Group}}!" />
            </div>

            <div class="form-group">
              <label>Email Content *</label>
              <p style="font-size: 12px; color: var(--secondary); margin-bottom: 8px">
                Write your email content here. It will automatically be wrapped in the professional ARNOMA template with
                header, footer, and styling.
              </p>
              <textarea
                id="templateBody"
                required
                placeholder="Dear <strong>{{StudentName}}</strong>,

Welcome to ARNOMA NCLEX-RN! We're excited to have you join our program.

Your next class is on {{NextClass}} at {{ClassTime}}.

Best regards,
ARNOMA Team"
              ></textarea>

              <div
                style="
                  margin-top: 12px;
                  padding: 12px;
                  background: rgba(102, 126, 234, 0.08);
                  border-radius: 8px;
                  border-left: 4px solid #667eea;
                "
              >
                <div style="font-size: 11px; font-weight: 600; color: #a5b4fc; margin-bottom: 6px">
                  ‚ú® Variables & Formatting:
                </div>
                <div
                  style="
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 8px;
                    font-size: 11px;
                    color: #94a3b8;
                  "
                >
                  <div>{{StudentName}} - Student's name</div>
                  <div>{{Group}} - Student's group</div>
                  <div>{{NextClass}} - Next class date</div>
                  <div>{{ClassTime}} - Class time</div>
                  <div>{{PaymentAmount}} - Payment amount</div>
                  <div>{{UnpaidClasses}} - Unpaid classes list</div>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>Trigger Type</label>
              <select id="templateTrigger">
                <option value="manual">Manual Send Only</option>
                <option value="new_student">When New Student Added</option>
                <option value="before_class">Before Class</option>
                <option value="after_class">After Class</option>
                <option value="payment_due">Payment Due</option>
                <option value="countdown">Countdown Timer</option>
              </select>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px">
              <button type="submit" class="btn btn-primary" style="flex: 1">üíæ Save Template</button>
              <button type="button" class="btn btn-secondary" onclick="closeEditor()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // ============================================================================
      // EMAIL SENDING CONFIGURATION
      // ============================================================================
      // ============================================================================

      // Supabase + Resend Configuration (Production Email System)
      const SUPABASE_URL = 'https://zlvnxvrzotamhpezqedr.supabase.co';
      const SUPABASE_ANON_KEY =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpsdm54dnJ6b3RhbWhwZXpxZWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MTEzMTcsImV4cCI6MjA3ODM4NzMxN30.-IoSqKhDrA9NuG4j3GufIbfmodWqCoppEklE1nTmw38';
      const EMAIL_FROM = 'ARNOMA <info@mail.arnoma.us>';

      // Expose Supabase config to window for diagnostic testing
      window.SUPABASE_URL = SUPABASE_URL;
      window.SUPABASE_ANON_KEY = SUPABASE_ANON_KEY;

      // Initialize Supabase client
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('‚úÖ Supabase client initialized');

      // Email sending method preference
      let useSupabaseEmail = true; // Set to false to use Gmail instead

      // ============================================================================
      // GMAIL API INTEGRATION (Fallback)

      const GMAIL_CLIENT_ID = '67231383915-4kpdv0k6u517admvhl7jlejku7qtbsjj.apps.googleusercontent.com';
      const GMAIL_SCOPES = 'https://www.googleapis.com/auth/gmail.send';
      const GMAIL_CONNECTION_KEY = 'gmail-connection';

      let gmailAccessToken = null;
      let gmailTokenExpiry = null;

      // Get Gmail connection from parent window or localStorage
      function getGmailConnectionFromParent() {
        console.log('üîç Looking for Gmail connection...');

        // Try parent window first
        try {
          if (window.parent && window.parent !== window) {
            const parentConnection = window.parent.getGmailConnection?.();
            if (parentConnection && parentConnection.access_token) {
              console.log('‚úÖ Found token from parent window');
              gmailAccessToken = parentConnection.access_token;
              gmailTokenExpiry = parentConnection.expiry_date;
              return true;
            }
          }
        } catch (e) {
          console.log('‚ö†Ô∏è Cannot access parent window, trying localStorage:', e);
        }

        // Fallback to localStorage (same origin as parent)
        try {
          const stored = localStorage.getItem(GMAIL_CONNECTION_KEY);
          console.log('LocalStorage check:', stored ? 'Found' : 'Not found');
          if (stored) {
            const connection = JSON.parse(stored);
            console.log(
              'Connection expiry:',
              connection.expiry_date ? new Date(connection.expiry_date).toLocaleString() : 'none'
            );
            // Check if token is expired
            if (connection.expiry_date && Date.now() >= connection.expiry_date) {
              console.log('‚ùå Gmail token expired');
              localStorage.removeItem(GMAIL_CONNECTION_KEY);
              return false;
            }
            if (connection.access_token) {
              console.log('‚úÖ Found valid token from localStorage');
              gmailAccessToken = connection.access_token;
              gmailTokenExpiry = connection.expiry_date;
              return true;
            }
          }
        } catch (e) {
          console.error('‚ùå Error reading Gmail connection from localStorage:', e);
        }

        console.log('‚ùå No Gmail connection found');
        return false;
      }

      // Connect to Gmail
      async function connectGmail() {
        // Try to get token from parent window first
        if (getGmailConnectionFromParent()) {
          showNotification('‚úÖ Connected to Gmail from main app', 'success');
          updateGmailButtonState(true);
          return;
        }

        // Otherwise, initiate OAuth flow
        const redirectUri = window.location.origin + window.location.pathname;
        const authUrl =
          `https://accounts.google.com/o/oauth2/v2/auth?` +
          `client_id=${GMAIL_CLIENT_ID}&` +
          `redirect_uri=${encodeURIComponent(redirectUri)}&` +
          `response_type=token&` +
          `scope=${encodeURIComponent(GMAIL_SCOPES)}&` +
          `prompt=consent`;

        window.location.href = authUrl;
      }

      // Handle OAuth callback
      function handleGmailOAuthCallback() {
        const hash = window.location.hash;
        if (hash && hash.includes('access_token')) {
          const params = new URLSearchParams(hash.substring(1));
          gmailAccessToken = params.get('access_token');
          const expiresIn = parseInt(params.get('expires_in') || '3600');
          gmailTokenExpiry = Date.now() + expiresIn * 1000;

          // Save to localStorage
          const connection = {
            access_token: gmailAccessToken,
            expiry_date: gmailTokenExpiry,
          };
          localStorage.setItem(GMAIL_CONNECTION_KEY, JSON.stringify(connection));

          // Clear hash from URL
          window.history.replaceState(null, null, window.location.pathname);

          showNotification('‚úÖ Gmail connected successfully!', 'success');
          updateGmailButtonState(true);
        }
      }

      // Check if Gmail is connected
      function isGmailConnected() {
        if (!gmailAccessToken) {
          return getGmailConnectionFromParent();
        }

        if (gmailTokenExpiry && Date.now() > gmailTokenExpiry) {
          gmailAccessToken = null;
          return false;
        }

        return true;
      }

      // Update Gmail button state
      function updateGmailButtonState(connected) {
        const btn = document.getElementById('gmailConnectBtn');
        if (btn) {
          btn.textContent = connected ? '‚úÖ Gmail Connected' : 'üìß Connect Gmail';
          btn.style.background = connected
            ? 'linear-gradient(135deg, #4ade80, #22c55e)'
            : 'linear-gradient(135deg, #667eea, #764ba2)';
        }
      }

      // Send email via Gmail API
      async function sendEmailViaGmail(to, subject, htmlBody) {
        if (!useSupabaseEmail && !isGmailConnected()) {
          showNotification('‚ùå Please connect Gmail first', 'error');
          return false;
        }

        // Log token status for debugging
        console.log('üìß Attempting to send email...');
        console.log('Token exists:', !!gmailAccessToken);
        console.log('Token length:', gmailAccessToken?.length);
        console.log('Token expiry:', gmailTokenExpiry ? new Date(gmailTokenExpiry).toLocaleString() : 'none');
        console.log('Token expired:', gmailTokenExpiry ? Date.now() > gmailTokenExpiry : 'N/A');

        if (!gmailAccessToken) {
          showNotification('‚ùå No Gmail token found. Please click "Connect Gmail" button above.', 'error');
          return false;
        }

        try {
          // Create email in RFC 2822 format
          const email = [
            'Content-Type: text/html; charset="UTF-8"',
            'MIME-Version: 1.0',
            'From: ARNOMA <info@arnoma.us>',
            `To: ${to}`,
            `Subject: ${subject}`,
            '',
            htmlBody,
          ].join('\n');

          // Base64 encode the email
          const encodedEmail = btoa(unescape(encodeURIComponent(email)))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+$/, '');

          // Send via Gmail API
          const response = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${gmailAccessToken}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              raw: encodedEmail,
            }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error?.message || 'Failed to send email');
          }

          return true;
        } catch (error) {
          console.error('Gmail send error:', error);
          showNotification(`‚ùå Failed to send: ${error.message}`, 'error');
          return false;
        }
      }

      // Send email via Supabase + Resend
      async function sendEmailViaSupabase(to, subject, htmlBody) {
        try {
          console.log('üìß Sending email via Supabase + Resend...');

          const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify({
              to: to,
              subject: subject,
              html: htmlBody,
              from: EMAIL_FROM,
            }),
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || 'Failed to send email');
          }

          console.log('‚úÖ Email sent successfully:', result);
          return true;
        } catch (error) {
          console.error('Supabase send error:', error);
          showNotification(`‚ùå Failed to send: ${error.message}`, 'error');
          return false;
        }
      }

      // Universal email sending function
      async function sendEmail(to, subject, htmlBody) {
        if (useSupabaseEmail) {
          return await sendEmailViaSupabase(to, subject, htmlBody);
        } else {
          return await sendEmailViaGmail(to, subject, htmlBody);
        }
      }
      // Send email to multiple recipients
      async function sendBulkEmails(recipients, subject, htmlBody, templateName = 'Unknown') {
        if (!useSupabaseEmail && !isGmailConnected()) {
          showNotification('‚ùå Please connect Gmail first', 'error');
          return;
        }

        let successCount = 0;
        let failCount = 0;

        for (const email of recipients) {
          const success = await sendEmail(email, subject, htmlBody);
          if (success) {
            successCount++;
            // Track sent email in Supabase with full HTML content
            await trackSentEmail(email, subject, templateName, htmlBody);
          } else {
            failCount++;
          }

          // Small delay to avoid rate limiting
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        showNotification(
          `üìß Sent ${successCount} email${successCount !== 1 ? 's' : ''}` +
            (failCount > 0 ? ` (${failCount} failed)` : ''),
          failCount > 0 ? 'warning' : 'success'
        );
      }

      // ============================================================================
      // EMAIL TEMPLATE GENERATOR
      // ============================================================================

      // Email template generator function (from your index.html design)
      function generateEmailHTML(title, bodyContent) {
        return `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARNOMA NCLEX-RN Email</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px 20px;
    }
    .email-wrapper {
      max-width: 600px;
      margin: 0 auto;
    }
    .email-container {
      background-color: #ffffff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .email-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 45px 35px 35px;
      text-align: center;
    }
    .email-header img {
      width: 140px;
      height: 140px;
      margin-bottom: 15px;
      filter: drop-shadow(0 0 6px rgba(255,255,255,0.7))
              drop-shadow(0 0 12px rgba(255,255,255,0.4))
              drop-shadow(0 0 3px rgba(255,255,255,0.8));
      animation: fadeIn 1.5s ease-in-out;
    }
    .email-header h1 {
      color: #fff;
      margin: 0;
      font-size: 28px;
      letter-spacing: -0.5px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .email-body {
      padding: 35px;
      color: #333;
      font-size: 16px;
      line-height: 1.6;
    }
    .email-body p {
      margin: 0 0 16px 0;
    }
    .email-body img {
      display: block;
      max-width: 100%;
      height: auto;
      margin: 20px auto;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .payment-frame {
      background-color: #f8f9fc;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin: 24px 0;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .payment-frame img {
      margin: 12px auto;
      border-radius: 8px;
      box-shadow: none;
    }
    .info-box {
      background-color: #f6f8fe;
      border-left: 3px solid #3b82f6;
      border-radius: 10px;
      padding: 14px 18px;
      font-size: 15px;
      line-height: 1.5;
      color: #1e293b;
      margin: 20px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .info-box p {
      margin: 6px 0;
      text-align: left;
    }
    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(255,255,255,0.3) 20%, rgba(255,255,255,0.3) 80%, transparent);
      margin: 24px 0;
      border: none;
    }
    .email-footer {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      text-align: center;
      padding: 30px 20px;
    }
    .email-footer img {
      width: 100px;
      height: 100px;
      margin: 10px 0;
      filter: drop-shadow(0 0 5px rgba(255,255,255,0.6))
              drop-shadow(0 0 10px rgba(255,255,255,0.3))
              drop-shadow(0 0 2px rgba(255,255,255,0.8));
    }
    .email-footer p {
      margin: 6px 0;
      font-size: 13px;
    }
    @media (max-width: 600px) {
      body { padding: 20px 10px; }
      .email-body { padding: 25px 20px; font-size: 15px; }
      .email-header img { width: 110px; height: 110px; }
    }
  </style>
</head>
<body>
  <div class="email-wrapper">
    <div class="email-container">
      <div class="email-header">
        <img src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png" alt="ARNOMA Logo">
        <h1>${title}</h1>
      </div>

      <div class="email-body">
        ${bodyContent}
      </div>

      <div class="email-footer">
        <img src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/richyfesta-logo.png" alt="ARNOMA Logo">
        <p><strong style="font-size: 18px;">ARNOMA ‚Äì NCLEX RN</strong></p>
        <p style="font-size: 14px;">Professional NCLEX Preparation & Medical Education</p>
        <p style="font-size: 13px;">
          nclex.rn@arnoma.us<br>
          richy@arnoma.us<br>
          909-808-1818
        </p>
        <p style="font-size: 12px; color: #95a5a6;">
          ¬© 2025 ARNOMA. All rights reserved.
        </p>
        <p style="font-size: 12px; color: #7f8c8d;">
          This is an automated notification from your ARNOMA NCLEX prep program.
        </p>
      </div>
    </div>
  </div>
</body>
</html>`;
      }

      // EmailSystem object (matches index.html exactly)
      const emailSystem = {
        _templates: [],
        _storageKey: 'arnoma-email-templates-v7',

        init() {
          this.loadTemplates();
          this.renderTemplates();
        },

        loadTemplates() {
          try {
            const stored = localStorage.getItem(this._storageKey);
            if (stored) {
              this._templates = JSON.parse(stored);
            } else {
              this._templates = this.getDefaultTemplates();
              this.saveTemplates();
            }
          } catch (e) {
            console.error('Error loading templates:', e);
            this._templates = this.getDefaultTemplates();
          }
        },

        saveTemplates() {
          try {
            localStorage.setItem(this._storageKey, JSON.stringify(this._templates));
            return true;
          } catch (e) {
            console.error('Error saving templates:', e);
            showNotification('Failed to save template', 'error');
            return false;
          }
        },

        getDefaultTemplates() {
          const timestamp = Date.now();
          return [
            {
              id: `${timestamp}_payment`,
              name: 'Payment Reminder',
              subject: 'Payment Reminder - ARNOMA NCLEX-RN',
              body: generateEmailHTML(
                'Payment Reminder',
                `<p>Hello <strong>{{StudentName}}</strong>,</p>
              <p>This is a quick, automated check regarding your recent classes:</p>
              <div class="info-box">
                <p><strong>{{UnpaidClasses}}</strong></p>
              </div>
              <p>Our records show that your payment hasn't been posted yet.</p>
              <p><strong>If you have already paid:</strong> Great! Please simply reply with the screenshot of your transfer. That's all we need to update our log and ensure you don't receive any more reminders.</p>
              <p><strong>If you still plan to pay:</strong> Please submit the payment at your earliest convenience. The system can only process and send your notes once payment is confirmed.</p>
              <div class="payment-frame">
                <p style="margin: 0 0 8px 0; font-size: 16px; color: #4b5563;">
                  <strong>Send Money with <span style="color: #764ba2;">Zelle¬Æ</span></strong>
                </p>
                <p style="margin: 0 0 12px 0; font-size: 14px; color: #6b7280;">
                  Scan in your banking app to pay.
                </p>
                <div style="margin: 12px 0;">
                  <p style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600; color: #1f2937;">Arnoma</p>
                  <p style="margin: 0 0 12px 0; font-size: 14px; color: #4b5563;">909-300-5155</p>
                </div>
                <img src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/Arnoma%20Zelle.JPG" alt="Zelle QR Code" style="max-width:180px;height:auto;border:0;display:block;margin:0 auto" />
                <p style="margin: 12px 0 0 0; font-size: 16px; color: #9ca3af;">
                  <strong style="color: #764ba2;">Zelle</strong>
                </p>
              </div>
              <p>Thank you for your prompt attention to this!</p>
              <p>Best regards,<br><strong>ARNOMA Team</strong></p>`
              ),
              trigger: 'manual',
              active: true,
            },
            {
              id: `${timestamp}_receipt`,
              name: 'Payment Receipt',
              subject: 'Payment Received - ARNOMA NCLEX-RN',
              body: generateEmailHTML(
                'Payment Receipt',
                `<p>Dear <strong>{{StudentName}}</strong>,</p>
              <p>Thank you for your payment of <strong>{{PaymentAmount}}</strong>. Your payment has been successfully registered.</p>
              <p>You're in <strong>Group {{GroupName}}</strong>. Class times: <strong>{{GroupSchedule}}</strong>.</p>
              <p>You can expect your notes to be posted on <em>Google Classroom</em> within 30 minutes of your payment receipt.</p>
              <p>Best regards,<br><strong>ARNOMA NCLEX-RN</strong></p>`
              ),
              trigger: 'manual',
              active: true,
            },
            {
              id: `${timestamp}_classreminder`,
              name: 'Class Reminder (Automated)',
              subject: 'Reminder: Your {{GroupName}} Class {{TimeOfDay}} at {{ClassTime}}',
              body: generateEmailHTML(
                'Class Reminder',
                `<p>Hello <strong>{{StudentName}}</strong>,</p>
              <p>This is a friendly reminder that you have a class <strong>{{TimeOfDay}}</strong>:</p>
              <div class="info-box">
                <p style="margin: 4px 0;"><strong>Group:</strong> {{GroupName}}</p>
                <p style="margin: 4px 0;"><strong>Time:</strong> {{ClassTime}}</p>
                <p style="margin: 4px 0;"><strong>Date:</strong> {{ClassDate}}</p>
              </div>
              {{PaymentMessage}}
              <p>The Zoom link will be emailed to you approximately <strong>30 minutes before class starts</strong>. Please be ready!</p>
              <p>We look forward to seeing you in class!</p>
              <p>Best regards,<br><strong>ARNOMA Team</strong></p>`
              ),
              trigger: 'automatic',
              active: true,
            },
            {
              id: `${timestamp}_startingsoon`,
              name: 'Class Starting Soon (Automated)',
              subject: 'Class Starting Soon - {{GroupName}} at {{ClassTime}}',
              body: generateEmailHTML(
                'Class Starting Soon',
                `<p>Hello <strong>{{StudentName}}</strong>,</p>
              <p>Your class is starting in approximately <strong>30 minutes</strong>!</p>
              <div class="info-box">
                <p style="margin: 4px 0;"><strong>Group:</strong> {{GroupName}}</p>
                <p style="margin: 4px 0;"><strong>Time:</strong> {{ClassTime}}</p>
                <p style="margin: 4px 0;"><strong>Date:</strong> {{ClassDate}}</p>
              </div>
              <p style="text-align: center; margin: 24px 0;">
                <a href="{{ZoomLink}}" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 28px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">
                  Join Zoom Meeting
                </a>
              </p>
              <p style="font-size: 13px; color: #6b7280; text-align: center;">Click the button above or use this link:<br><a href="{{ZoomLink}}" style="color: #764ba2;">{{ZoomLink}}</a></p>
              <p>Please join on time and be ready to participate. See you soon!</p>
              <p>Best regards,<br><strong>ARNOMA Team</strong></p>`
              ),
              trigger: 'automatic',
              active: true,
            },
            {
              id: `${timestamp}_welcome`,
              name: 'Welcome Email',
              subject: 'Welcome to ARNOMA NCLEX-RN',
              body: generateEmailHTML(
                'Welcome to Your Nursing Classroom',
                `<p>Dear <strong>{{StudentName}}</strong>,</p>
              <p>Welcome to your all-in-one nursing classroom! You are enrolled in <strong>Group {{Group}}</strong>, and your group schedule is <strong>{{GroupSchedule}}</strong>.</p>
              <p>Please make sure to complete your payment before class so that all your notes and materials will be accessible once the class ends.</p>
              <div class="payment-frame">
                <p style="margin: 0 0 8px 0; font-size: 16px; color: #4b5563;">
                  <strong>Send Money with <span style="color: #764ba2;">Zelle¬Æ</span></strong>
                </p>
                <p style="margin: 0 0 12px 0; font-size: 14px; color: #6b7280;">
                  Scan in your banking app to pay.
                </p>
                <div style="margin: 12px 0;">
                  <p style="margin: 0 0 4px 0; font-size: 16px; font-weight: 600; color: #1f2937;">Arnoma</p>
                  <p style="margin: 0 0 12px 0; font-size: 14px; color: #4b5563;">909-300-5155</p>
                </div>
                <img src="https://raw.githubusercontent.com/easylearnrn-hash/ARNOMA/main/Arnoma%20Zelle.JPG" alt="Zelle QR Code" style="max-width:180px;height:auto;border:0;display:block;margin:0 auto" />
                <p style="margin: 12px 0 0 0; font-size: 16px; color: #9ca3af;">
                  <strong style="color: #764ba2;">Zelle</strong>
                </p>
              </div>
              <p>Here, you'll find everything you need for NCLEX-RN success ‚Äî including structured notes, detailed study guides, recorded lectures, and practice questions covering all major topics, from Fundamentals to Pharmacology and every body system.</p>
              <div class="info-box">
                <p style="margin-bottom: 8px;"><strong>You'll be able to:</strong></p>
                <p style="margin: 4px 0;">‚Ä¢ Stay organized</p>
                <p style="margin: 4px 0;">‚Ä¢ Track your learning progress</p>
                <p style="margin: 4px 0;">‚Ä¢ Access class materials anytime</p>
                <p style="margin: 4px 0;">‚Ä¢ Prepare for the NCLEX with clarity and confidence</p>
              </div>
              <p style="font-size: 17px; font-weight: 600; color: #764ba2; text-align: center; margin: 24px 0;">Let's study smart, support one another, and achieve success together! üöÄ</p>
              <p>Best regards,<br><strong>ARNOMA NCLEX-RN Team</strong></p>`
              ),
              trigger: 'student_created',
              active: true,
            },
          ];
        },

        renderTemplates() {
          const grid = document.getElementById('templatesGrid');

          // Always show "Create Template" card first
          let html = `
          <div class="template-card" onclick="openEditor()" style="cursor: pointer; border: 2px dashed rgba(165,180,252,.4); background: linear-gradient(135deg, rgba(102,126,234,.1), rgba(118,75,162,.1)); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; padding: 16px;">
            <div style="font-size: 48px; opacity: 0.6; margin-bottom: 10px;">‚ú®</div>
            <h3 style="margin: 0 0 4px 0; font-size: 16px; color: var(--primary-bright);">Create New Template</h3>
            <p style="font-size: 12px; color: var(--secondary); margin: 0;">Click to add a new email template</p>
          </div>
        `;

          if (this._templates.length === 0) {
            grid.innerHTML = html;
            return;
          }

          // Add existing templates
          html += this._templates
            .map(template => {
              const isHTML = template.body.includes('<!DOCTYPE html>');
              const bodyPreview = isHTML ? 'Full HTML Email Template' : template.body.substring(0, 150);

              return `
            <div class="template-card" style="padding: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div style="flex: 1;">
                  <h3 style="margin: 0 0 4px 0; font-size: 16px; color: var(--primary);">${template.name}</h3>
                  <div style="font-size: 10px; color: var(--secondary); text-transform: uppercase; font-weight: 600;">
                    ${this.getTriggerLabel(template.trigger)}
                  </div>
                </div>
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                  <input type="checkbox" ${template.active ? 'checked' : ''} onchange="emailSystem.toggleActive('${template.id}')" style="width: 16px; height: 16px;">
                  <span style="font-size: 11px; color: var(--secondary);">Active</span>
                </label>
              </div>

              <div style="background: rgba(0,0,0,.2); padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid var(--primary);">
                <div style="font-weight: 600; color: white; font-size: 11px; margin-bottom: 4px;">Subject:</div>
                <div style="color: var(--ink-dim); font-size: 12px;">${template.subject}</div>
              </div>

              <div style="background: rgba(0,0,0,.2); padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                <div style="font-weight: 600; color: white; font-size: 11px; margin-bottom: 4px;">Content:</div>
                <div style="color: var(--ink-dim); font-size: 11px; line-height: 1.4; max-height: 80px; overflow-y: auto;">
                  ${isHTML ? 'üìÑ Professional HTML Email Template' : bodyPreview}...
                </div>
              </div>

              <div style="display: flex; gap: 8px;">
                ${
                  isHTML
                    ? `
                  <button onclick="emailSystem.previewTemplate('${template.id}')" class="btn" style="flex: 1; background: rgba(74,222,128,.2); color: var(--success); border: 2px solid rgba(74,222,128,.4); padding: 8px; font-size: 12px;">
                    üëÅÔ∏è Preview
                  </button>
                `
                    : ''
                }
                <button onclick="emailSystem.editTemplate('${template.id}')" class="btn" style="flex: 1; background: rgba(165,180,252,.2); color: var(--primary-bright); border: 2px solid rgba(165,180,252,.4); padding: 8px; font-size: 12px;">
                  ‚úèÔ∏è Edit
                  </button>
                <button onclick="emailSystem.deleteTemplate('${template.id}')" class="btn" style="flex: 1; background: rgba(248,113,113,.2); color: var(--error); border: 2px solid rgba(248,113,113,.4); padding: 8px; font-size: 12px;">
                  üóëÔ∏è Delete
                </button>
              </div>
            </div>
          `;
            })
            .join('');

          grid.innerHTML = html;
        },

        getTriggerLabel(trigger) {
          const labels = {
            manual: 'Manual Send',
            new_student: 'New Student',
            before_class: 'Before Class',
            after_class: 'After Class',
            payment_due: 'Payment Due',
            countdown: 'Countdown',
          };
          return labels[trigger] || trigger;
        },

        toggleActive(id) {
          const template = this._templates.find(t => t.id === id);
          if (template) {
            template.active = !template.active;
            this.saveTemplates();
            this.renderTemplates();
            showNotification(template.active ? 'Template activated' : 'Template deactivated', 'success');
          }
        },

        editTemplate(id) {
          const template = this._templates.find(t => t.id === id);
          if (!template) return;

          editingId = id;
          document.getElementById('modalTitle').textContent = 'Edit Email Template';
          document.getElementById('templateId').value = id;
          document.getElementById('templateName').value = template.name;
          document.getElementById('templateSubject').value = template.subject;

          // Extract body content from HTML if it's a full template
          if (template.body.includes('<!DOCTYPE html>')) {
            const bodyMatch = template.body.match(
              /<div class="email-body">([\s\S]*?)<\/div>\s*<div class="email-footer">/
            );
            if (bodyMatch) {
              document.getElementById('templateBody').value = bodyMatch[1].trim();
            } else {
              document.getElementById('templateBody').value = template.body;
            }
          } else {
            document.getElementById('templateBody').value = template.body;
          }

          document.getElementById('templateTrigger').value = template.trigger;
          openEditor();
        },

        deleteTemplate(id) {
          if (!confirm('Delete this template? This cannot be undone.')) return;

          this._templates = this._templates.filter(t => t.id !== id);
          this.saveTemplates();
          this.renderTemplates();
          showNotification('Template deleted', 'success');
        },

        previewTemplate(id) {
          const template = this._templates.find(t => t.id === id);
          if (!template) return;

          // Replace variables with sample data
          let previewHTML = template.body
            .replace(/\{\{StudentName\}\}/g, 'John Doe')
            .replace(/\{\{Group\}\}/g, 'Group A - Monday 6PM')
            .replace(/\{\{NextClass\}\}/g, 'Monday, November 11, 2025')
            .replace(/\{\{ClassTime\}\}/g, '6:00 PM PST')
            .replace(/\{\{PaymentAmount\}\}/g, '$120.00')
            .replace(/\{\{UnpaidClasses\}\}/g, 'Nov 4, Nov 6, Nov 8 (3 classes)');

          // Add Group Name + Group Schedule box after greeting
          const groupInfoBox = `
              <div class="info-box" style="background-color: rgba(255,255,255,0.9); border-left: 3px solid #764ba2; border-radius: 10px; padding: 14px 18px; font-size: 15px; line-height: 1.5; color: #1e293b; margin: 20px 0; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
                <p style="margin: 6px 0;"><strong>Group:</strong> Group E</p>
                <p style="margin: 6px 0;"><strong>Schedule:</strong> Monday & Wednesday ‚Äî 8:00 PM (Los Angeles Time)</p>
              </div>`;

          // Find the first <p> tag after greeting and insert the box
          const firstParagraphMatch = previewHTML.match(/(<p[^>]*>.*?<\/p>)/i);
          if (firstParagraphMatch) {
            const insertPosition = previewHTML.indexOf(firstParagraphMatch[0]) + firstParagraphMatch[0].length;
            previewHTML = previewHTML.slice(0, insertPosition) + groupInfoBox + previewHTML.slice(insertPosition);
          }

          openPreviewModal(previewHTML);
        },
      };

      let editingId = null;
      let currentEmails = [];

      function addEmailToList() {
        const emailInput = document.getElementById('emailInput');
        const email = emailInput.value.trim();

        if (!email) {
          showNotification('Please enter an email address', 'error');
          return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showNotification('Please enter a valid email address', 'error');
          return;
        }

        if (currentEmails.includes(email)) {
          showNotification('Email already added', 'error');
          return;
        }

        currentEmails.push(email);
        emailInput.value = '';
        renderEmailList();
        showNotification('Email added', 'success');
      }

      function removeEmailFromList(email) {
        currentEmails = currentEmails.filter(e => e !== email);
        renderEmailList();
        showNotification('Email removed', 'success');
      }

      function renderEmailList() {
        const container = document.getElementById('emailListContent');

        if (currentEmails.length === 0) {
          container.innerHTML = `
          <div style="color: var(--secondary); font-size: 13px; text-align: center; padding: 20px;">
            No email addresses added yet
          </div>
        `;
          return;
        }

        container.innerHTML = currentEmails
          .map(
            email => `
        <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(165,180,252,.15); padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(165,180,252,.3);">
          <span style="color: var(--ink); font-size: 13px; font-weight: 500;">${email}</span>
          <button onclick="removeEmailFromList('${email}')" style="background: rgba(248,113,113,.2); border: 1px solid rgba(248,113,113,.4); color: var(--error); padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
            Remove
          </button>
        </div>
      `
          )
          .join('');
      }

      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.style.borderColor =
          type === 'error' ? 'var(--error)' : type === 'success' ? 'var(--success)' : 'var(--primary-bright)';
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3500);
      }

      function openPreviewModal(htmlContent) {
        console.log('üîµ openPreviewModal called');
        const modal = document.getElementById('previewModal');
        const iframe = document.getElementById('previewFrame');

        if (!modal) {
          console.error('‚ùå previewModal element not found!');
          return;
        }
        if (!iframe) {
          console.error('‚ùå previewFrame element not found!');
          return;
        }

        console.log('‚úÖ Modal and iframe found, writing content...');
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(htmlContent);
        iframeDoc.close();

        console.log('‚úÖ Content written, adding active class...');
        modal.classList.add('active');

        // DEBUG: Check if modal is actually visible
        const computedStyle = window.getComputedStyle(modal);
        console.log('üîç Modal display style:', computedStyle.display);
        console.log('üîç Modal z-index:', computedStyle.zIndex);
        console.log('üîç Modal has active class:', modal.classList.contains('active'));

        console.log('‚úÖ Modal should now be visible with active class');
      }

      function closePreviewModal() {
        document.getElementById('previewModal').classList.remove('active');
      }

      function openEditor() {
        console.log('üîµ Opening editor modal...');
        const modal = document.getElementById('editorModal');
        if (!modal) {
          console.error('‚ùå Editor modal not found!');
          return;
        }
        console.log('‚úÖ Modal found, adding active class');
        modal.classList.add('active');
      }

      function closeEditor() {
        document.getElementById('editorModal').classList.remove('active');
        document.getElementById('templateForm').reset();
        document.getElementById('templateId').value = '';
        editingId = null;
      }

      function saveTemplate(e) {
        e.preventDefault();

        const isEditing = Boolean(editingId);
        const existingIndex = isEditing ? emailSystem._templates.findIndex(t => t.id === editingId) : -1;
        const existingTemplate = existingIndex >= 0 ? emailSystem._templates[existingIndex] : null;

        const id = existingTemplate ? existingTemplate.id : `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const name = document.getElementById('templateName').value.trim();
        const subject = document.getElementById('templateSubject').value.trim();
        const bodyContent = document.getElementById('templateBody').value;
        const trigger = document.getElementById('templateTrigger').value;

        const emailTitle = name || 'ARNOMA NCLEX-RN';
        const fullHTML = generateEmailHTML(emailTitle, bodyContent);

        const template = {
          ...(existingTemplate || {}),
          id,
          name,
          subject,
          body: fullHTML,
          trigger,
          active: existingTemplate ? existingTemplate.active : true,
          updatedAt: new Date().toISOString(),
        };

        if (!template.createdAt) {
          template.createdAt = new Date().toISOString();
        }

        if (existingTemplate) {
          emailSystem._templates[existingIndex] = template;
        } else {
          emailSystem._templates.push(template);
        }

        emailSystem.saveTemplates();
        emailSystem.renderTemplates();

        const notificationMessage = existingTemplate ? 'Template updated' : 'Template created';
        closeEditor();
        showNotification(notificationMessage, 'success');
      }

      // Click outside to close - handles all modals
      document.addEventListener('click', function (event) {
        if (event.target.classList.contains('modal') && event.target.classList.contains('active')) {
          event.target.classList.remove('active');

          // Clean up based on which modal was closed
          if (event.target.id === 'editorModal') {
            document.getElementById('templateForm').reset();
            document.getElementById('templateId').value = '';
            editingId = null;
          } else if (event.target.id === 'automationEditorModal') {
            document.getElementById('automationForm').reset();
            document.getElementById('automationId').value = '';
          }
          // automationsModal doesn't need cleanup
        }
      });

      // ===== AUTOMATION SYSTEM =====
      const automationSystem = {
        _automations: [],

        // Get system-managed automations (running in parent window)
        getSystemAutomations() {
          return [
            {
              id: 'system_payment_reminder',
              name: 'Payment Reminder (Auto)',
              description: 'Sends automatic payment reminders every 24 hours to students with unpaid classes',
              templateName: 'Payment Reminder',
              type: 'system',
              frequency: 'every_24_hours',
              active: true,
              isSystem: true,
              checkInterval: '24 hours',
              trigger: 'Unpaid classes detected',
              lastRun: localStorage.getItem('payment_reminder_last_check') || 'Never',
              managedBy: 'PaymentReminderManager (index.html)',
            },
            {
              id: 'system_class_reminder_12h',
              name: 'Class Reminder (12 Hours Before)',
              description: 'Sends class reminders 12 hours before each scheduled class',
              templateName: 'Class Reminder (Automated)',
              type: 'system',
              frequency: 'before_class',
              minutesBefore: 720, // 12 hours
              active: true,
              isSystem: true,
              checkInterval: '1 hour',
              trigger: '12 hours before class',
              lastRun: localStorage.getItem('class_reminder_last_check') || 'Never',
              managedBy: 'ClassReminderManager (index.html)',
            },
            {
              id: 'system_class_starting_soon',
              name: 'Class Starting Soon (30 Minutes Before)',
              description: 'Sends Zoom link 30 minutes before class starts',
              templateName: 'Class Starting Soon (Automated)',
              type: 'system',
              frequency: 'before_class',
              minutesBefore: 30,
              active: true,
              isSystem: true,
              checkInterval: '10 minutes',
              trigger: '30 minutes before class (25-35 min window)',
              lastRun: localStorage.getItem('class_starting_soon_last_check') || 'Never',
              managedBy: 'ClassStartingSoonManager (index.html)',
            },
          ];
        },

        // Toggle system automation on/off
        toggleSystemAutomation(automationId) {
          const storageKey = `automation_${automationId}_paused`;
          const isPaused = localStorage.getItem(storageKey) === 'true';

          if (isPaused) {
            localStorage.removeItem(storageKey);
            showNotification(`Resumed: ${automationId}`, 'success');

            // Notify parent window
            window.parent.postMessage(
              {
                action: 'resumeAutomation',
                automationId: automationId,
              },
              '*'
            );
          } else {
            localStorage.setItem(storageKey, 'true');
            showNotification(`Paused: ${automationId}`, 'info');

            // Notify parent window
            window.parent.postMessage(
              {
                action: 'pauseAutomation',
                automationId: automationId,
              },
              '*'
            );
          }

          this.renderAutomations();
        },

        // Check if system automation is paused
        isSystemAutomationPaused(automationId) {
          return localStorage.getItem(`automation_${automationId}_paused`) === 'true';
        },

        loadAutomations() {
          try {
            const stored = localStorage.getItem('arnoma-automations-v3');
            if (stored) {
              this._automations = JSON.parse(stored);
            }
          } catch (e) {
            console.error('Error loading automations:', e);
          }
          this.renderAutomations();
        },

        saveAutomations() {
          try {
            localStorage.setItem('arnoma-automations-v3', JSON.stringify(this._automations));
          } catch (e) {
            console.error('Failed to save automations:', e);
            showNotification('Failed to save automations.', 'error');
          }
        },

        renderAutomations() {
          const container = document.getElementById('automationsList');

          // Get system automations (hardcoded, always active)
          const systemAutomations = this.getSystemAutomations();

          // Combine system and custom automations
          const allAutomations = [...systemAutomations, ...this._automations];

          if (allAutomations.length === 0) {
            container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: var(--secondary);">
              <div style="font-size: 64px; opacity: 0.3; margin-bottom: 16px;">‚öôÔ∏è</div>
              <p style="font-size: 16px;">No automations configured yet</p>
              <button class="btn btn-primary" onclick="openAutomationEditor()" style="margin-top: 16px;">
                Create First Automation
              </button>
            </div>
          `;
            return;
          }

          const activeCount =
            systemAutomations.filter(a => !this.isSystemAutomationPaused(a.id)).length +
            this._automations.filter(a => a.active).length;

          const html = `
          <div style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0;">System Automations (${systemAutomations.length})</h3>
              <span style="font-size: 13px; color: var(--secondary);">Built-in & always running</span>
            </div>
            <div style="display: grid; gap: 12px;">
              ${systemAutomations
                .map(automation => {
                  const isPaused = this.isSystemAutomationPaused(automation.id);

                  return `
              <div class="template-card" style="border-left: 4px solid ${isPaused ? '#f59e0b' : '#22c55e'}; background: rgba(255,255,255,0.02);">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                      <h3 style="margin: 0; color: white; font-size: 15px; font-weight: 600;">
                        ${isPaused ? '‚è∏Ô∏è' : '‚úÖ'} ${automation.name}
                      </h3>
                      <span style="font-size: 10px; background: rgba(139,92,246,.25); padding: 3px 8px; border-radius: 4px; color: #c4b5fd; font-weight: 600; text-transform: uppercase;">
                        SYSTEM
                      </span>
                    </div>
                    <div style="font-size: 12px; color: var(--secondary); margin-bottom: 8px; line-height: 1.5;">
                      ${automation.description}
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; font-size: 11px;">
                      <span style="background: rgba(165,180,252,.15); padding: 4px 8px; border-radius: 4px; color: var(--primary-bright);">
                        ÔøΩ ${automation.templateName}
                      </span>
                      <span style="background: rgba(59,130,246,.15); padding: 4px 8px; border-radius: 4px; color: #bfdbfe;">
                        ‚è∞ Checks ${automation.checkInterval}
                      </span>
                      <span style="background: rgba(34,197,94,.15); padding: 4px 8px; border-radius: 4px; color: #86efac;">
                        üéØ ${automation.trigger}
                      </span>
                      <span style="background: rgba(100,116,139,.15); padding: 4px 8px; border-radius: 4px; color: #cbd5e1; font-family: monospace;">
                        ${automation.managedBy}
                      </span>
                    </div>
                  </div>
                  <div style="display: flex; gap: 6px;">
                    <button class="btn-icon" onclick="automationSystem.toggleSystemAutomation('${automation.id}')" title="${isPaused ? 'Resume' : 'Pause'}" style="background: rgba(${isPaused ? '34,197,94' : '251,191,36'},.2); border-color: rgba(${isPaused ? '34,197,94' : '251,191,36'},.4); color: ${isPaused ? '#86efac' : '#fde68a'};">
                      ${isPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è'}
                    </button>
                  </div>
                </div>
              </div>
            `;
                })
                .join('')}
            </div>
          </div>

          ${
            this._automations.length > 0
              ? `
          <div style="margin-top: 32px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0;">Custom Automations (${this._automations.length})</h3>
              <button class="btn btn-primary btn-sm" onclick="openAutomationEditor()">
                ‚ûï New Automation
              </button>
            </div>
            <div style="display: grid; gap: 12px;">
              ${this._automations
                .map(automation => {
                  const nextRun = this.getNextRunTime(automation);
                  const countdown = this.formatCountdown(nextRun);

                  return `
              <div class="template-card" style="border-left: 4px solid ${automation.active ? '#3b82f6' : '#64748b'};">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div style="flex: 1;">
                    <h3 style="margin: 0 0 8px 0; color: white; font-size: 15px; font-weight: 600;">
                      ${automation.active ? '‚úÖ' : '‚è∏Ô∏è'} ${automation.name}
                    </h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; font-size: 11px;">
                      <span style="background: rgba(165,180,252,.2); padding: 4px 8px; border-radius: 4px; color: var(--primary-bright);">
                        üìß ${automation.templateName}
                      </span>
                      <span style="background: rgba(59,130,246,.2); padding: 4px 8px; border-radius: 4px; color: #bfdbfe;">
                        ‚è∞ ${this.getScheduleLabel(automation)}
                      </span>
                      ${
                        automation.active && nextRun
                          ? `
                      <span id="countdown-${automation.id}" style="background: rgba(34,197,94,.2); padding: 4px 8px; border-radius: 4px; color: #86efac; font-weight: 600;">
                        ‚è±Ô∏è ${countdown}
                      </span>
                      `
                          : ''
                      }
                    </div>
                  </div>
                  <div style="display: flex; gap: 6px;">
                    <button class="btn-icon" onclick="toggleAutomation('${automation.id}')" title="${automation.active ? 'Pause' : 'Activate'}">
                      ${automation.active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                    </button>
                    <button class="btn-icon" onclick="editAutomation('${automation.id}')" title="Edit">
                      ‚úèÔ∏è
                    </button>
                    <button class="btn-icon" onclick="deleteAutomation('${automation.id}')" title="Delete">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              </div>
            `;
                })
                .join('')}
            </div>
          </div>
          `
              : `
          <div style="text-align: center; padding: 40px 20px; border: 2px dashed rgba(165,180,252,.2); border-radius: 12px; margin-top: 24px;">
            <div style="font-size: 48px; opacity: 0.4; margin-bottom: 12px;">‚ûï</div>
            <p style="font-size: 14px; color: var(--secondary); margin-bottom: 16px;">Create custom automations for your workflow</p>
            <button class="btn btn-primary" onclick="openAutomationEditor()">
              Create Custom Automation
            </button>
          </div>
          `
          }
        `;

          container.innerHTML = html;

          // Start countdown timer updates for custom automations
          if (this._automations.length > 0) {
            this.startCountdownUpdates();
          }
        },

        startCountdownUpdates() {
          // Clear any existing interval
          if (this._countdownInterval) {
            clearInterval(this._countdownInterval);
          }

          // Update countdowns every second
          this._countdownInterval = setInterval(() => {
            this._automations.forEach(automation => {
              if (!automation.active) return;

              const countdownEl = document.getElementById(`countdown-${automation.id}`);
              if (!countdownEl) return;

              const nextRun = this.getNextRunTime(automation);
              const countdown = this.formatCountdown(nextRun);

              // Update only the countdown text, preserve the rest
              countdownEl.textContent = `‚è±Ô∏è ${countdown}`;
            });
          }, 1000);
        },

        getRecipientLabel(automation) {
          const parts = [];

          if (automation.groups && automation.groups.length > 0) {
            parts.push(`Groups: ${automation.groups.join(', ')}`);
          }

          if (automation.includeAllStudents) {
            parts.push('All Students');
          }

          if (automation.emails && automation.emails.length > 0) {
            parts.push(`${automation.emails.length} Email${automation.emails.length !== 1 ? 's' : ''}`);
          }

          if (automation.teacherEmail) {
            parts.push(`üë®‚Äçüè´ ${automation.teacherEmail}`);
          }

          // Backward compatibility for old single-type automations
          if (parts.length === 0) {
            if (automation.recipientType === 'all') return 'All Students';
            if (automation.recipientType === 'group' && automation.groups) {
              return `Groups: ${automation.groups.join(', ')}`;
            }
            if (automation.recipientType === 'individual' && automation.emails) {
              return `${automation.emails.length} Email${automation.emails.length !== 1 ? 's' : ''}`;
            }
            if (automation.recipientType === 'teacher' && automation.teacherEmail) {
              return `üë®‚Äçüè´ ${automation.teacherEmail}`;
            }
            return `${automation.students ? automation.students.length : 0} Individual Students`;
          }

          return parts.join(' + ');
        },

        getScheduleLabel(automation) {
          const freq = automation.frequency;
          if (freq === 'once') return `Once on ${automation.onceDate} at ${automation.onceTime}`;
          if (freq === 'daily') return `Daily at ${automation.dailyTime}`;
          if (freq === 'weekly') {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const selectedDays = automation.weekdays.map(d => days[d]).join(', ');
            return `Weekly on ${selectedDays} at ${automation.weeklyTime}`;
          }
          if (freq === 'monthly') return `Monthly on ${automation.monthlyDay} at ${automation.monthlyTime}`;
          if (freq === 'before_class') return `${automation.beforeClassTime} min before class`;
          return freq;
        },

        getNextRunTime(automation) {
          if (!automation.active) return null;

          const now = new Date();
          const laTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));

          const freq = automation.frequency;

          if (freq === 'once') {
            const runDate = new Date(`${automation.onceDate}T${automation.onceTime}`);
            return runDate > laTime ? runDate : null;
          }

          if (freq === 'daily') {
            const [hours, minutes] = automation.dailyTime.split(':').map(Number);
            const nextRun = new Date(laTime);
            nextRun.setHours(hours, minutes, 0, 0);

            if (nextRun <= laTime) {
              nextRun.setDate(nextRun.getDate() + 1);
            }
            return nextRun;
          }

          if (freq === 'weekly') {
            const [hours, minutes] = automation.weeklyTime.split(':').map(Number);
            const currentDay = laTime.getDay();
            let daysUntilNext = Infinity;

            for (const targetDay of automation.weekdays) {
              let diff = targetDay - currentDay;
              if (diff < 0) diff += 7;
              if (diff === 0) {
                const todayRun = new Date(laTime);
                todayRun.setHours(hours, minutes, 0, 0);
                if (todayRun > laTime) {
                  daysUntilNext = 0;
                  break;
                } else {
                  diff = 7;
                }
              }
              if (diff < daysUntilNext) daysUntilNext = diff;
            }

            if (daysUntilNext === Infinity) return null;

            const nextRun = new Date(laTime);
            nextRun.setDate(nextRun.getDate() + daysUntilNext);
            nextRun.setHours(hours, minutes, 0, 0);
            return nextRun;
          }

          if (freq === 'monthly') {
            const [hours, minutes] = automation.monthlyTime.split(':').map(Number);
            const nextRun = new Date(laTime);
            nextRun.setDate(automation.monthlyDay);
            nextRun.setHours(hours, minutes, 0, 0);

            if (nextRun <= laTime) {
              nextRun.setMonth(nextRun.getMonth() + 1);
            }
            return nextRun;
          }

          if (freq === 'before_class') {
            // Get groups data from global variable (populated by message listener)
            const availableGroups =
              typeof window.groupsData !== 'undefined' && window.groupsData ? window.groupsData : [];
            const selectedGroups = automation.groups || automation.selectedGroups || [];

            if (selectedGroups.length === 0 || availableGroups.length === 0) return null;

            // Parse schedule for selected groups and find next class
            let earliestClass = null;

            for (const groupName of selectedGroups) {
              const group = availableGroups.find(g => g.name === groupName);
              if (!group || !group.schedule) {
                continue;
              }

              // Parse schedule (e.g., "Mon 10:00 AM, Wed 2:00 PM")
              const scheduleSlots = this.parseGroupSchedule(group.schedule);

              for (const slot of scheduleSlots) {
                const nextClass = this.getNextClassTime(slot.day, slot.time, laTime);
                if (nextClass && (!earliestClass || nextClass < earliestClass)) {
                  earliestClass = nextClass;
                }
              }
            }

            if (!earliestClass) return null;

            // Subtract the "before" time (e.g., 30 minutes)
            const minutesBefore = automation.beforeClassTime || 30;
            const reminderTime = new Date(earliestClass.getTime() - minutesBefore * 60 * 1000);

            return reminderTime > laTime ? reminderTime : null;
          }

          return null;
        },

        parseGroupSchedule(scheduleStr) {
          // Parse "Mon 10:00 AM, Wed 2:00 PM" format
          if (!scheduleStr) return [];

          const dayMap = {
            mon: 'Monday',
            tue: 'Tuesday',
            wed: 'Wednesday',
            thu: 'Thursday',
            fri: 'Friday',
            sat: 'Saturday',
            sun: 'Sunday',
            monday: 'Monday',
            tuesday: 'Tuesday',
            wednesday: 'Wednesday',
            thursday: 'Thursday',
            friday: 'Friday',
            saturday: 'Saturday',
            sunday: 'Sunday',
          };

          const slots = [];
          const parts = scheduleStr.split(',');

          for (const part of parts) {
            const match = part.trim().match(/(\w+)\s+(\d+:\d+\s*[AP]M)/i);
            if (match) {
              const dayKey = match[1].toLowerCase();
              const day = dayMap[dayKey] || match[1];
              const time = match[2];
              slots.push({ day, time });
            }
          }

          return slots;
        },

        getNextClassTime(dayName, timeStr, fromDate) {
          // Convert day name to day number (0=Sunday, 1=Monday, etc.)
          const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
          const targetDay = dayNames.indexOf(dayName);
          if (targetDay === -1) return null;

          // Parse time (e.g., "10:00 AM")
          const match = timeStr.match(/(\d+):(\d+)\s*([AP]M)/i);
          if (!match) return null;

          let hours = parseInt(match[1]);
          const minutes = parseInt(match[2]);
          const ampm = match[3].toUpperCase();

          if (ampm === 'PM' && hours !== 12) hours += 12;
          if (ampm === 'AM' && hours === 12) hours = 0;

          // Find next occurrence of this day
          const currentDay = fromDate.getDay();
          let daysUntil = targetDay - currentDay;
          if (daysUntil < 0) daysUntil += 7;

          // If it's today, check if time has passed
          if (daysUntil === 0) {
            const todayClass = new Date(fromDate);
            todayClass.setHours(hours, minutes, 0, 0);
            if (todayClass > fromDate) {
              return todayClass;
            }
            daysUntil = 7; // Next week
          }

          const nextClass = new Date(fromDate);
          nextClass.setDate(nextClass.getDate() + daysUntil);
          nextClass.setHours(hours, minutes, 0, 0);
          return nextClass;
        },

        formatCountdown(nextRunTime) {
          if (!nextRunTime) return 'Calculating...';

          const now = new Date();
          const laTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
          const diff = nextRunTime - laTime;

          if (diff <= 0) return 'Running soon...';

          const days = Math.floor(diff / (1000 * 60 * 60 * 24));
          const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((diff % (1000 * 60)) / 1000);

          if (days > 0) return `Next in ${days}d ${hours}h ${minutes}m`;
          if (hours > 0) return `Next in ${hours}h ${minutes}m ${seconds}s`;
          if (minutes > 0) return `Next in ${minutes}m ${seconds}s`;
          return `Next in ${seconds}s`;
        },
      };

      // Expose automationSystem to window for diagnostic testing and automation engine
      window.automationSystem = automationSystem;
      console.log('üîç Exposed automationSystem to window for diagnostics');

      // Automation Modal Functions
      function openAutomations() {
        document.getElementById('automationsModal').classList.add('active');

        // Request fresh data from parent
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ action: 'requestGroupsData' }, '*');
        }

        // If we already have groups data, render immediately
        if (window.groupsData && window.groupsData.length > 0) {
          automationSystem.loadAutomations();
        } else {
          // Wait for groups data to arrive, then render
          const checkData = setInterval(() => {
            if (window.groupsData && window.groupsData.length > 0) {
              clearInterval(checkData);
              automationSystem.loadAutomations();
            }
          }, 50);

          // Timeout after 2 seconds and render anyway
          setTimeout(() => {
            clearInterval(checkData);
            if (!automationSystem._automations || automationSystem._automations.length === 0) {
              automationSystem.loadAutomations();
            }
          }, 2000);
        }
      }

      function closeAutomations() {
        // Clear countdown interval when closing
        if (automationSystem._countdownInterval) {
          clearInterval(automationSystem._countdownInterval);
          automationSystem._countdownInterval = null;
        }
        document.getElementById('automationsModal').classList.remove('active');
      }

      async function openSentEmails() {
        document.getElementById('sentEmailsModal').classList.add('active');
        await renderSentEmails();
      }

      function closeSentEmails() {
        document.getElementById('sentEmailsModal').classList.remove('active');
      }

      // View exact email that was sent
      async function viewSentEmail(emailId) {
        console.log('üëÅÔ∏è viewSentEmail called with emailId:', emailId);

        // Try cache first
        let emails = window._sentEmailsCache || [];
        console.log('üìß Cached emails:', emails.length);

        let email = emails.find(e => e.id == emailId);

        // If not in cache, fetch directly from Supabase
        if (!email) {
          console.log('üì• Email not in cache, fetching from Supabase...');
          try {
            const { data, error } = await supabase.from('sent_emails').select('*').eq('id', emailId).single();

            if (error) throw error;
            email = data;
            console.log('‚úÖ Fetched email from Supabase:', email);
          } catch (error) {
            console.error('‚ùå Error fetching email from Supabase:', error);
            showNotification('Email not found', 'error');
            return;
          }
        }

        if (!email) {
          console.error('‚ùå Email not found with id:', emailId);
          showNotification('Email not found', 'error');
          return;
        }

        console.log('‚úÖ Found email:', email);

        if (!email.html_content) {
          console.warn('‚ö†Ô∏è Email has no html_content');
          showNotification('Email content not available', 'error');
          return;
        }

        console.log('‚úÖ Sending email preview to parent window via postMessage');
        try {
          // Send to parent window to open preview
          window.parent.postMessage(
            {
              action: 'openEmailPreview',
              htmlContent: email.html_content,
              subject: email.subject,
            },
            '*'
          );
          console.log('‚úÖ Posted message to parent window');
        } catch (error) {
          console.error('‚ùå Error posting message to parent:', error);
          showNotification('Error opening email preview', 'error');
        }
      }

      async function renderSentEmails() {
        const container = document.getElementById('sentEmailsList');
        container.innerHTML =
          '<div style="text-align: center; padding: 60px 20px; color: var(--secondary);"><div style="font-size: 64px; opacity: 0.3; margin-bottom: 16px;">‚è≥</div><p style="font-size: 16px;">Loading sent emails...</p></div>';

        const emails = await loadSentEmails();

        if (emails.length === 0) {
          container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: var(--secondary);">
            <div style="font-size: 64px; opacity: 0.3; margin-bottom: 16px;">üì≠</div>
            <p style="font-size: 16px;">No sent emails yet</p>
            <p style="font-size: 14px; margin-top: 8px;">Emails sent through this system will appear here</p>
          </div>
        `;
          return;
        }

        // Store emails globally for viewSentEmail function
        window._sentEmailsCache = emails;

        container.innerHTML = emails
          .map(email => {
            const date = new Date(email.sent_at);
            const dateStr = date.toLocaleDateString('en-US', {
              month: 'short',
              day: 'numeric',
              year: 'numeric',
              timeZone: 'America/Los_Angeles',
            });
            const timeStr = date.toLocaleTimeString('en-US', {
              hour: 'numeric',
              minute: '2-digit',
              timeZone: 'America/Los_Angeles',
            });

            // Extract recipient info from metadata if available
            let recipientDisplay = email.recipient_email;
            if (email.metadata) {
              try {
                const metadata = typeof email.metadata === 'string' ? JSON.parse(email.metadata) : email.metadata;
                if (metadata.recipientName) {
                  recipientDisplay = `${metadata.recipientName} <${email.recipient_email}>`;
                } else if (metadata.recipientType) {
                  recipientDisplay = `${metadata.recipientType} <${email.recipient_email}>`;
                }
              } catch (e) {
                // Use email only if metadata parsing fails
              }
            }

            return `
          <div style="background: rgba(255,255,255,.05); border: 2px solid rgba(255,255,255,.1); border-radius: 12px; padding: 16px; transition: all 0.2s;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: var(--ink); font-size: 15px; margin-bottom: 4px;">
                  üìß ${recipientDisplay}
                </div>
                <div style="color: var(--primary); font-size: 13px; font-weight: 600;">
                  ${email.template_name || 'Email'}
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 12px; color: var(--secondary);">${dateStr}</div>
                <div style="font-size: 12px; color: var(--secondary);">${timeStr} LA</div>
              </div>
            </div>
            <div style="background: rgba(0,0,0,.2); padding: 10px 12px; border-radius: 8px; border-left: 3px solid var(--primary); margin-bottom: 12px;">
              <div style="font-size: 12px; color: var(--secondary); margin-bottom: 4px; font-weight: 600;">Subject:</div>
              <div style="color: var(--ink-dim); font-size: 13px;">${email.subject}</div>
            </div>
            ${
              email.html_content
                ? `
              <button onclick="viewSentEmail('${email.id}')" class="btn btn-secondary" style="width: 100%; padding: 10px; font-size: 13px;">
                üëÅÔ∏è View Exact Email Sent
              </button>
            `
                : `
              <div style="text-align: center; padding: 8px; color: var(--secondary); font-size: 12px; font-style: italic;">
                Email content not stored (sent before Nov 15, 2025)
              </div>
            `
            }
          </div>
        `;
          })
          .join('');
      }

      function openAutomationEditor(automationId = null) {
        const modal = document.getElementById('automationEditorModal');
        const form = document.getElementById('automationForm');
        const title = document.getElementById('automationModalTitle');

        form.reset();
        document.getElementById('automationId').value = '';
        document.getElementById('automationActive').checked = true;
        currentEmails = [];

        // Populate template dropdown
        const templateSelect = document.getElementById('automationTemplate');
        templateSelect.innerHTML =
          '<option value="">-- Choose Template --</option>' +
          emailSystem._templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

        // Reset selection states
        const groupCheckboxes = document.querySelectorAll('input[name="groups"]');
        groupCheckboxes.forEach(cb => {
          cb.checked = false;
        });
        const weekdayCheckboxes = document.querySelectorAll('input[name="weekdays"]');
        weekdayCheckboxes.forEach(cb => {
          cb.checked = false;
        });

        // Reset recipient checkboxes
        document.getElementById('includeGroups').checked = false;
        document.getElementById('includeAllStudents').checked = false;
        document.getElementById('includeIndividual').checked = false;
        document.getElementById('includeTeacher').checked = false;
        document.getElementById('teacherEmail').value = '';

        document.getElementById('automationFrequency').value = 'once';
        toggleFrequencyOptions();
        toggleRecipientSections();

        renderEmailList();

        if (automationId) {
          const automation = automationSystem._automations.find(a => a.id === automationId);
          if (automation) {
            title.textContent = 'Edit Automation';
            document.getElementById('automationId').value = automation.id;
            document.getElementById('automationName').value = automation.name;
            document.getElementById('automationTemplate').value = automation.templateId;

            // Handle multiple recipient types
            if (automation.groups && automation.groups.length > 0) {
              document.getElementById('includeGroups').checked = true;
              automation.groups.forEach(group => {
                const checkbox = document.querySelector(`input[name="groups"][value="${group}"]`);
                if (checkbox) checkbox.checked = true;
              });
            }

            if (automation.includeAllStudents) {
              document.getElementById('includeAllStudents').checked = true;
            }

            if (automation.emails && automation.emails.length > 0) {
              document.getElementById('includeIndividual').checked = true;
              currentEmails = [...automation.emails];
              renderEmailList();
            }

            if (automation.teacherEmail) {
              document.getElementById('includeTeacher').checked = true;
              document.getElementById('teacherEmail').value = automation.teacherEmail;
            }

            toggleRecipientSections();

            document.getElementById('automationFrequency').value = automation.frequency;
            toggleFrequencyOptions();

            if (automation.frequency === 'once') {
              document.getElementById('onceDate').value = automation.onceDate;
              document.getElementById('onceTime').value = automation.onceTime;
            } else if (automation.frequency === 'daily') {
              document.getElementById('dailyTime').value = automation.dailyTime;
            } else if (automation.frequency === 'weekly') {
              (automation.weekdays || []).forEach(day => {
                const checkbox = document.querySelector(`input[name="weekdays"][value="${day}"]`);
                if (checkbox) checkbox.checked = true;
              });
              document.getElementById('weeklyTime').value = automation.weeklyTime;
            } else if (automation.frequency === 'monthly') {
              document.getElementById('monthlyDay').value = automation.monthlyDay;
              document.getElementById('monthlyTime').value = automation.monthlyTime;
            } else if (automation.frequency === 'before_class') {
              document.getElementById('beforeClassTime').value = automation.beforeClassTime;
            }

            document.getElementById('automationActive').checked = automation.active;
          }
        } else {
          title.textContent = 'Create Automation';
        }

        modal.classList.add('active');
      }

      function closeAutomationEditor() {
        document.getElementById('automationEditorModal').classList.remove('active');
      }

      function toggleRecipientSections() {
        const includeGroups = document.getElementById('includeGroups').checked;
        const includeAll = document.getElementById('includeAllStudents').checked;
        const includeIndividual = document.getElementById('includeIndividual').checked;
        const includeTeacher = document.getElementById('includeTeacher').checked;

        document.getElementById('groupSelection').style.display = includeGroups ? 'block' : 'none';
        document.getElementById('individualSelection').style.display = includeIndividual ? 'block' : 'none';
        document.getElementById('teacherSelection').style.display = includeTeacher ? 'block' : 'none';

        // Update button highlighting
        const groupsBtn = document.getElementById('groupsToggleBtn');
        const allBtn = document.getElementById('allStudentsToggleBtn');
        const individualBtn = document.getElementById('individualToggleBtn');
        const teacherBtn = document.getElementById('teacherToggleBtn');

        if (groupsBtn) {
          groupsBtn.style.background = includeGroups ? 'rgba(99,102,241,.3)' : 'rgba(255,255,255,.05)';
          groupsBtn.style.borderColor = includeGroups ? 'rgba(99,102,241,.6)' : 'rgba(255,255,255,.1)';
        }
        if (allBtn) {
          allBtn.style.background = includeAll ? 'rgba(34,197,94,.3)' : 'rgba(255,255,255,.05)';
          allBtn.style.borderColor = includeAll ? 'rgba(34,197,94,.6)' : 'rgba(255,255,255,.1)';
        }
        if (individualBtn) {
          individualBtn.style.background = includeIndividual ? 'rgba(59,130,246,.3)' : 'rgba(255,255,255,.05)';
          individualBtn.style.borderColor = includeIndividual ? 'rgba(59,130,246,.6)' : 'rgba(255,255,255,.1)';
        }
        if (teacherBtn) {
          teacherBtn.style.background = includeTeacher ? 'rgba(245,158,11,.3)' : 'rgba(255,255,255,.05)';
          teacherBtn.style.borderColor = includeTeacher ? 'rgba(245,158,11,.6)' : 'rgba(255,255,255,.1)';
        }
      }

      function toggleFrequencyOptions() {
        const freq = document.getElementById('automationFrequency').value;
        document.getElementById('onceOptions').style.display = freq === 'once' ? 'block' : 'none';
        document.getElementById('dailyOptions').style.display = freq === 'daily' ? 'block' : 'none';
        document.getElementById('weeklyOptions').style.display = freq === 'weekly' ? 'block' : 'none';
        document.getElementById('monthlyOptions').style.display = freq === 'monthly' ? 'block' : 'none';
        document.getElementById('beforeClassOptions').style.display = freq === 'before_class' ? 'block' : 'none';
      }

      function saveAutomation(event) {
        event.preventDefault();

        const automationIdField = document.getElementById('automationId');
        const isEditing = Boolean(automationIdField.value);
        const existingIndex = isEditing
          ? automationSystem._automations.findIndex(a => a.id === automationIdField.value)
          : -1;
        const existingAutomation = existingIndex >= 0 ? automationSystem._automations[existingIndex] : null;

        const id = existingAutomation ? existingAutomation.id : Date.now().toString();
        const name = document.getElementById('automationName').value.trim();
        if (!name) {
          showNotification('‚ö†Ô∏è Automation name is required.', 'error');
          return;
        }
        const templateId = document.getElementById('automationTemplate').value;
        const template = emailSystem._templates.find(t => t.id === templateId);

        if (!template) {
          showNotification('‚ö†Ô∏è Please select a valid email template.', 'error');
          return;
        }

        const frequency = document.getElementById('automationFrequency').value;
        const active = document.getElementById('automationActive').checked;

        // Check which recipient types are selected
        const includeGroups = document.getElementById('includeGroups').checked;
        const includeAllStudents = document.getElementById('includeAllStudents').checked;
        const includeIndividual = document.getElementById('includeIndividual').checked;
        const includeTeacher = document.getElementById('includeTeacher').checked;

        // Validate at least one recipient type is selected
        if (!includeGroups && !includeAllStudents && !includeIndividual && !includeTeacher) {
          showNotification('‚ö†Ô∏è Please select at least one recipient type.', 'error');
          return;
        }

        const automation = {
          ...(existingAutomation || {}),
          id,
          name,
          templateId,
          templateName: template.name,
          frequency,
          active,
          updatedAt: new Date().toISOString(),
        };

        if (!automation.createdAt) {
          automation.createdAt = new Date().toISOString();
        }

        // Clear previous recipient data
        delete automation.groups;
        delete automation.emails;
        delete automation.teacherEmail;
        delete automation.includeAllStudents;
        delete automation.recipientType; // Remove old single-type field

        // Handle Groups
        if (includeGroups) {
          const groups = Array.from(document.querySelectorAll('input[name="groups"]:checked')).map(cb => cb.value);
          if (groups.length === 0) {
            showNotification('‚ö†Ô∏è Please select at least one group.', 'error');
            return;
          }
          automation.groups = groups;
        }

        // Handle All Students
        if (includeAllStudents) {
          automation.includeAllStudents = true;
        }

        // Handle Individual Emails
        if (includeIndividual) {
          if (currentEmails.length === 0) {
            showNotification('‚ö†Ô∏è Please add at least one email address.', 'error');
            return;
          }
          automation.emails = [...currentEmails];
        }

        // Handle Teacher
        if (includeTeacher) {
          const teacherEmail = document.getElementById('teacherEmail').value.trim();
          if (!teacherEmail) {
            showNotification('‚ö†Ô∏è Please enter a teacher email address.', 'error');
            return;
          }
          if (!teacherEmail.includes('@')) {
            showNotification('‚ö†Ô∏è Please enter a valid email address.', 'error');
            return;
          }
          automation.teacherEmail = teacherEmail;
        }

        // Clear previous schedule state
        delete automation.onceDate;
        delete automation.onceTime;
        delete automation.dailyTime;
        delete automation.weekdays;
        delete automation.weeklyTime;
        delete automation.monthlyDay;
        delete automation.monthlyTime;
        delete automation.beforeClassTime;

        if (frequency === 'once') {
          const onceDate = document.getElementById('onceDate').value;
          const onceTime = document.getElementById('onceTime').value;
          if (!onceDate || !onceTime) {
            showNotification('‚ö†Ô∏è Please set date and time for one-time automation.', 'error');
            return;
          }
          automation.onceDate = onceDate;
          automation.onceTime = onceTime;
        } else if (frequency === 'daily') {
          const dailyTime = document.getElementById('dailyTime').value;
          if (!dailyTime) {
            showNotification('‚ö†Ô∏è Please set time for daily automation.', 'error');
            return;
          }
          automation.dailyTime = dailyTime;
        } else if (frequency === 'weekly') {
          const weekdays = Array.from(document.querySelectorAll('input[name="weekdays"]:checked')).map(cb =>
            parseInt(cb.value, 10)
          );
          const weeklyTime = document.getElementById('weeklyTime').value;
          if (!weekdays.length) {
            showNotification('‚ö†Ô∏è Please select at least one day of the week.', 'error');
            return;
          }
          if (!weeklyTime) {
            showNotification('‚ö†Ô∏è Please set time for weekly automation.', 'error');
            return;
          }
          automation.weekdays = weekdays;
          automation.weeklyTime = weeklyTime;
        } else if (frequency === 'monthly') {
          const monthlyDay = document.getElementById('monthlyDay').value;
          const monthlyTime = document.getElementById('monthlyTime').value;
          if (!monthlyDay || !monthlyTime) {
            showNotification('‚ö†Ô∏è Please set day and time for monthly automation.', 'error');
            return;
          }
          automation.monthlyDay = monthlyDay;
          automation.monthlyTime = monthlyTime;
        } else if (frequency === 'before_class') {
          const beforeClassTime = document.getElementById('beforeClassTime').value;
          if (!beforeClassTime) {
            showNotification('‚ö†Ô∏è Please set time before class.', 'error');
            return;
          }
          automation.beforeClassTime = beforeClassTime;
        }

        if (existingAutomation) {
          automationSystem._automations[existingIndex] = automation;
        } else {
          automationSystem._automations.push(automation);
        }

        automationSystem.saveAutomations();
        automationSystem.renderAutomations();
        closeAutomationEditor();

        showNotification(`Automation "${name}" saved successfully!`, 'success');
      }

      function editAutomation(id) {
        openAutomationEditor(id);
      }

      function toggleAutomation(id) {
        const automation = automationSystem._automations.find(a => a.id === id);
        if (automation) {
          automation.active = !automation.active;
          automationSystem.saveAutomations();
          automationSystem.renderAutomations();
        }
      }

      function deleteAutomation(id) {
        const automation = automationSystem._automations.find(a => a.id === id);
        if (automation && confirm(`Delete automation "${automation.name}"?`)) {
          automationSystem._automations = automationSystem._automations.filter(a => a.id !== id);
          automationSystem.saveAutomations();
          automationSystem.renderAutomations();
          showNotification('Automation deleted', 'success');
        }
      }

      function toggleTemplate(id) {
        const template = emailSystem._templates.find(t => t.id === id);
        if (template) {
          template.active = !template.active;
          emailSystem.saveTemplates();
          emailSystem.renderTemplates();
        }
      }

      // Send automation emails now
      async function sendAutomationNow(automationId) {
        if (!useSupabaseEmail && !isGmailConnected()) {
          showNotification('‚ùå Please connect Gmail first', 'error');
          return;
        }

        const automation = automationSystem._automations.find(a => a.id === automationId);
        if (!automation) {
          showNotification('‚ùå Automation not found', 'error');
          return;
        }

        const template = emailSystem._templates.find(t => t.id === automation.templateId);
        if (!template) {
          showNotification('‚ùå Template not found', 'error');
          return;
        }

        // Get recipient emails from all selected types
        let recipients = [];

        // Add individual emails
        if (automation.emails && automation.emails.length > 0) {
          recipients.push(...automation.emails);
        }

        // Add teacher email
        if (automation.teacherEmail) {
          recipients.push(automation.teacherEmail);
        }

        // Add group students
        if (automation.groups && automation.groups.length > 0) {
          try {
            const { data: students, error } = await supabase
              .from('students')
              .select('email, group_name, status')
              .in('group_name', automation.groups)
              .eq('status', 'active');

            if (error) throw error;
            const groupEmails = students.map(s => s.email).filter(email => email);
            recipients.push(...groupEmails);
          } catch (error) {
            console.error('‚ùå Error fetching students from groups:', error);
            showNotification('‚ùå Error fetching students from groups', 'error');
            return;
          }
        }

        // Add all students
        if (automation.includeAllStudents) {
          try {
            const { data: students, error } = await supabase
              .from('students')
              .select('email, status')
              .eq('status', 'active');

            if (error) throw error;
            const allEmails = students.map(s => s.email).filter(email => email);
            recipients.push(...allEmails);
          } catch (error) {
            console.error('‚ùå Error fetching all students:', error);
            showNotification('‚ùå Error fetching all students', 'error');
            return;
          }
        }

        // Remove duplicates
        recipients = [...new Set(recipients)];

        if (recipients.length === 0) {
          showNotification('‚ùå No recipients found', 'error');
          return;
        }

        // Confirm before sending
        if (
          !confirm(`Send "${template.name}" to ${recipients.length} recipient${recipients.length !== 1 ? 's' : ''}?`)
        ) {
          return;
        }

        showNotification(`üìß Sending emails...`, 'info');
        await sendBulkEmails(recipients, template.subject, template.body, template.name);
      }

      // Load groups from Supabase and populate group selection
      async function loadGroupsFromSupabase() {
        try {
          const { data: groups, error } = await supabase.from('groups').select('group_name').order('group_name');

          if (error) throw error;

          const groupList = document.getElementById('groupList');
          if (!groups || groups.length === 0) {
            groupList.innerHTML =
              '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--secondary);">No groups found. Please add groups in Group Manager.</div>';
            return;
          }

          groupList.innerHTML = groups
            .map(
              g => `
          <label style="background: rgba(255,255,255,.05); padding: 10px; border-radius: 8px; border: 2px solid rgba(255,255,255,.1); cursor: pointer; text-align: center;">
            <input type="checkbox" name="groups" value="${g.group_name}" style="margin-right: 6px;">
            <span style="font-weight: 600; color: white;">${g.group_name}</span>
          </label>
        `
            )
            .join('');

          console.log('‚úÖ Loaded', groups.length, 'groups from Supabase');
        } catch (error) {
          console.error('‚ùå Error loading groups:', error);
          const groupList = document.getElementById('groupList');
          groupList.innerHTML =
            '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--error);">Error loading groups</div>';
        }
      }

      // Track sent emails in Supabase with full HTML content
      async function trackSentEmail(recipient, subject, template_name, htmlContent = null, metadata = {}) {
        try {
          const { data, error } = await supabase
            .from('sent_emails')
            .insert([
              {
                recipient_email: recipient,
                subject: subject,
                template_name: template_name,
                html_content: htmlContent,
                sent_at: new Date().toISOString(),
              },
            ])
            .select();

          if (error) throw error;
          console.log(
            '‚úÖ Tracked sent email to',
            recipient,
            metadata.recipientName ? `(${metadata.recipientName})` : ''
          );

          // Return the inserted email record (includes id)
          return data && data[0] ? data[0] : null;
        } catch (error) {
          console.error('‚ùå Error tracking sent email:', error);
          return null;
        }
      }

      // Load sent emails history
      async function loadSentEmails() {
        try {
          const { data: emails, error } = await supabase
            .from('sent_emails')
            .select('*')
            .order('sent_at', { ascending: false })
            .limit(100);

          if (error) throw error;
          return emails || [];
        } catch (error) {
          console.error('‚ùå Error loading sent emails:', error);
          return [];
        }
      }

      // Initialize
      // Clear old cache versions
      ['arnoma-email-templates-v2', 'arnoma-email-templates-v3', 'arnoma-automations-v2'].forEach(key => {
        if (localStorage.getItem(key)) {
          localStorage.removeItem(key);
          console.log('üßπ Cleared old cache:', key);
        }
      });

      emailSystem.init();
      loadGroupsFromSupabase();

      // Check Gmail connection on load
      if (!useSupabaseEmail) {
        handleGmailOAuthCallback();
      } else {
        console.log('‚úÖ Using Supabase + Resend email system (no Gmail required)');
      }
      if (!useSupabaseEmail && isGmailConnected()) {
        updateGmailButtonState(true);
      }

      // Listen for auto-reminder requests from parent window
      // Track recent sends to prevent duplicates
      const recentSends = new Map(); // key: student_email+action+timestamp, value: timestamp

      window.addEventListener('message', async function (event) {
        // Security check - only accept messages from same origin
        if (event.origin !== window.location.origin) return;

        const {
          action,
          student,
          classDate,
          changes,
          specialMessage,
          emailType,
          groupName,
          oldSchedule,
          newSchedule,
          students,
          manual,
          unpaidClasses,
        } = event.data;

        // Handle request for payment reminder template
        if (action === 'getPaymentReminderTemplate') {
          console.log('üìã Request for payment reminder template received');

          const templates = emailSystem._templates || [];
          const reminderTemplate = templates.find(
            t => t.name.toLowerCase().includes('payment') && t.name.toLowerCase().includes('reminder') && t.active
          );

          if (reminderTemplate) {
            window.parent.postMessage(
              {
                action: 'paymentReminderTemplate',
                template: {
                  subject: reminderTemplate.subject,
                  body: reminderTemplate.body,
                },
              },
              '*'
            );
            console.log('‚úÖ Sent payment reminder template to parent');
          } else {
            console.error('‚ùå No active Payment Reminder template found');
          }
          return;
        }

        if (action === 'sendAutoReminder') {
          console.log('üìß Received auto-reminder request:', student?.name, classDate);
          const isManual = manual === true; // Check if this is a manual send
          const hasUnpaidList = unpaidClasses && unpaidClasses.length > 0; // Check if we have list of unpaid classes

          if (isManual) {
            console.log('üöÄ Manual send - bypassing duplicate check');
          }

          if (hasUnpaidList) {
            console.log('üìã Unpaid classes list provided:', unpaidClasses.length, 'classes');
          }

          try {
            console.log('üîç Looking for Payment Reminder template...');

            // Find Payment Reminder template
            const templates = emailSystem._templates || [];
            const reminderTemplate = templates.find(
              t => t.name.toLowerCase().includes('payment') && t.name.toLowerCase().includes('reminder') && t.active
            );

            if (!reminderTemplate) {
              console.error('‚ùå No active Payment Reminder template found');
              console.log(
                'Available templates:',
                templates.map(t => t.name)
              );
              window.parent.postMessage(
                {
                  action: 'emailError',
                  error: 'No active Payment Reminder template found',
                },
                '*'
              );
              return;
            }

            console.log('‚úÖ Found template:', reminderTemplate.name);

            if (!student.email) {
              console.error('‚ùå Student has no email address:', student?.name);
              window.parent.postMessage(
                {
                  action: 'emailError',
                  error: 'Student has no email address',
                },
                '*'
              );
              return;
            }

            console.log('üìß Student email:', student.email);

            // Format date nicely: "Wednesday, November 16, 2025"
            const formatClassDate = dateStr => {
              const date = new Date(dateStr + 'T00:00:00');
              const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
              return date.toLocaleDateString('en-US', options);
            };

            const formattedDate = formatClassDate(classDate);

            // Calculate total unpaid amount from unpaid classes list
            let totalUnpaidAmount = 0;
            if (hasUnpaidList && unpaidClasses.length > 0) {
              // Calculate from unpaid classes array (each class has its own pricePerClass)
              totalUnpaidAmount = unpaidClasses.reduce((sum, c) => sum + parseFloat(c.pricePerClass || 0), 0);
            } else {
              // Fallback: If no unpaid list, use student.payPerClass (or balance as last resort)
              // This assumes single unpaid class
              const pricePerClass = parseFloat(student.payPerClass || student.balance || 0);
              totalUnpaidAmount = pricePerClass;
            }

            // Build unpaid classes list if available
            let unpaidClassesList = `<div style="background: linear-gradient(135deg, rgba(138, 180, 255, 0.08), rgba(167, 139, 250, 0.08)); border-left: 4px solid #8ab4ff; padding: 16px; border-radius: 8px; margin: 16px 0;">
              <div style="font-size: 15px; color: #333; margin-bottom: 8px;">
                <strong>üìÖ ${formattedDate}</strong>
              </div>
              <div style="font-size: 18px; color: #8ab4ff; font-weight: 600;">
                Amount Due: $${totalUnpaidAmount.toFixed(2)}
              </div>
            </div>`;

            if (hasUnpaidList && unpaidClasses.length > 1) {
              // Multiple unpaid classes - build detailed list with beautiful formatting
              const totalUnpaid = totalUnpaidAmount;

              const classItems = unpaidClasses
                .map((c, index) => {
                  const formattedClassDate = formatClassDate(c.date);
                  const isHighlighted = c.isClickedDate;
                  const bgColor = isHighlighted ? 'rgba(138, 180, 255, 0.15)' : 'rgba(138, 180, 255, 0.05)';
                  const borderColor = isHighlighted ? '#8ab4ff' : '#e0e7ff';
                  const icon = isHighlighted ? 'üëâ' : 'üìÖ';

                  return `
                  <div style="background: ${bgColor}; border-left: 3px solid ${borderColor}; padding: 12px 16px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                      <div style="font-size: 14px; color: #666; margin-bottom: 4px;">Class ${index + 1}</div>
                      <div style="font-size: 15px; color: #333; font-weight: 500;">
                        ${icon} ${formattedClassDate}
                      </div>
                    </div>
                    <div style="font-size: 18px; color: #8ab4ff; font-weight: 600; min-width: 80px; text-align: right;">
                      $${parseFloat(c.pricePerClass).toFixed(2)}
                    </div>
                  </div>
                `;
                })
                .join('');

              unpaidClassesList = `
                <div style="background: linear-gradient(135deg, rgba(138, 180, 255, 0.08), rgba(167, 139, 250, 0.08)); border: 2px solid #8ab4ff; padding: 20px; border-radius: 12px; margin: 20px 0;">
                  <div style="font-size: 16px; color: #555; font-weight: 600; margin-bottom: 16px; text-align: center;">
                    üí≥ Outstanding Classes
                  </div>
                  ${classItems}
                  <div style="border-top: 2px solid #8ab4ff; margin-top: 16px; padding-top: 16px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 17px; color: #333; font-weight: 600;">
                      Total Amount Due:
                    </div>
                    <div style="font-size: 24px; color: #8ab4ff; font-weight: 700;">
                      $${totalUnpaid.toFixed(2)}
                    </div>
                  </div>
                </div>
              `;
            }

            // Replace variables in template (case-insensitive to match template)
            let subject = reminderTemplate.subject
              .replace(/\{\{StudentName\}\}/gi, student.name)
              .replace(/\{\{studentName\}\}/gi, student.name)
              .replace(/\{\{balance\}\}/gi, `$${student.balance}`);

            let body = reminderTemplate.body
              .replace(/\{\{StudentName\}\}/gi, student.name)
              .replace(/\{\{studentName\}\}/gi, student.name)
              .replace(/\{\{balance\}\}/gi, `$${student.balance}`)
              .replace(/\{\{Balance\}\}/gi, `$${student.balance}`)
              .replace(/\{\{classDate\}\}/gi, formattedDate)
              .replace(/\{\{ClassDate\}\}/gi, formattedDate)
              .replace(/\{\{UnpaidClasses\}\}/gi, unpaidClassesList);

            // Send email via Supabase Edge Function
            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                to: student.email,
                subject: subject,
                html: body,
              }),
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Failed to send email: ${response.statusText} - ${errorText}`);
            }

            // Track sent email with full HTML content
            await trackSentEmail(
              student.email,
              subject,
              isManual ? 'Manual Payment Reminder' : 'Auto Payment Reminder',
              body
            );

            // Send success message back to parent with email content
            window.parent.postMessage(
              {
                action: 'emailSent',
                success: true,
                manual: isManual,
                student: student,
                classDate: classDate,
                emailContent: {
                  subject: subject,
                  body: body,
                },
              },
              '*'
            );

            console.log('‚úÖ Payment reminder sent successfully to:', student.name);
          } catch (error) {
            console.error('‚ùå Error sending payment reminder:', error);

            // Send error message back to parent
            window.parent.postMessage(
              {
                action: 'emailError',
                error: error.message,
                student: student,
              },
              '*'
            );
          }
        }

        // Handle class reminder requests
        if (action === 'sendClassReminder') {
          console.log('üìß Received class reminder request:', student?.name, classDate);

          try {
            console.log('üîç Looking for Class Reminder template...');

            // Find Class Reminder template
            const templates = emailSystem._templates || [];
            const reminderTemplate = templates.find(
              t => t.name.toLowerCase().includes('class') && t.name.toLowerCase().includes('reminder') && t.active
            );

            if (!reminderTemplate) {
              console.error('‚ùå No active Class Reminder template found');
              console.log(
                'Available templates:',
                templates.map(t => t.name)
              );
              window.parent.postMessage(
                {
                  action: 'classReminderError',
                  error: 'No active Class Reminder template found',
                },
                '*'
              );
              return;
            }

            console.log('‚úÖ Found template:', reminderTemplate.name);

            if (!student.email) {
              console.error('‚ùå Student has no email address:', student?.name);
              window.parent.postMessage(
                {
                  action: 'classReminderError',
                  error: 'Student has no email address',
                },
                '*'
              );
              return;
            }

            console.log('üìß Student email:', student.email);

            // Replace variables in template
            let subject = reminderTemplate.subject
              .replace(/\{\{StudentName\}\}/gi, student.name)
              .replace(/\{\{GroupName\}\}/gi, groupName)
              .replace(/\{\{ClassTime\}\}/gi, classTime)
              .replace(/\{\{TimeOfDay\}\}/gi, timeOfDay);

            let body = reminderTemplate.body
              .replace(/\{\{StudentName\}\}/gi, student.name)
              .replace(/\{\{GroupName\}\}/gi, groupName)
              .replace(/\{\{ClassTime\}\}/gi, classTime)
              .replace(/\{\{ClassDate\}\}/gi, classDate)
              .replace(/\{\{TimeOfDay\}\}/gi, timeOfDay)
              .replace(/\{\{PaymentMessage\}\}/gi, paymentMessage);

            // Send email via Supabase Edge Function
            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                to: student.email,
                subject: subject,
                html: body,
                emailType: 'class_reminder',
              }),
            });

            const result = await response.json();

            if (result.error) {
              console.error('‚ùå Error from Supabase:', result.error);
              window.parent.postMessage(
                {
                  action: 'classReminderError',
                  error: result.error,
                  student: student,
                },
                '*'
              );
              return;
            }

            // Track sent email
            await trackSentEmail(student.email, subject, 'Class Reminder (Automated)', body);

            // Send success message back to parent with email content
            window.parent.postMessage(
              {
                action: 'classReminderSent',
                success: true,
                student: student,
                classDate: classDate,
                emailContent: {
                  subject: subject,
                  body: body,
                },
              },
              '*'
            );

            console.log('‚úÖ Class reminder sent successfully to:', student.name);
          } catch (error) {
            console.error('‚ùå Error sending class reminder:', error);

            // Send error message back to parent
            window.parent.postMessage(
              {
                action: 'classReminderError',
                error: error.message,
                student: student,
              },
              '*'
            );
          }
        }

        // Handle class starting soon requests
        if (action === 'sendClassStartingSoon') {
          console.log('üìß Received class starting soon request:', student?.name, classDate);

          try {
            console.log('üîç Looking for Class Starting Soon template...');

            // Find Class Starting Soon template
            const templates = emailSystem._templates || [];
            const startingSoonTemplate = templates.find(
              t => t.name.toLowerCase().includes('starting') && t.name.toLowerCase().includes('soon') && t.active
            );

            if (!startingSoonTemplate) {
              console.error('‚ùå No active Class Starting Soon template found');
              console.log(
                'Available templates:',
                templates.map(t => t.name)
              );
              window.parent.postMessage(
                {
                  action: 'classStartingSoonError',
                  error: 'No active Class Starting Soon template found',
                },
                '*'
              );
              return;
            }

            console.log('‚úÖ Found template:', startingSoonTemplate.name);

            if (!student.email) {
              console.error('‚ùå Student has no email address:', student?.name);
              window.parent.postMessage(
                {
                  action: 'classStartingSoonError',
                  error: 'Student has no email address',
                },
                '*'
              );
              return;
            }

            console.log('üìß Student email:', student.email);

            // Replace variables in template
            let subject = startingSoonTemplate.subject
              .replace(/\{\{StudentName\}\}/gi, student.name)
              .replace(/\{\{GroupName\}\}/gi, groupName)
              .replace(/\{\{ClassTime\}\}/gi, classTime);

            let body = startingSoonTemplate.body
              .replace(/\{\{StudentName\}\}/gi, student.name)
              .replace(/\{\{GroupName\}\}/gi, groupName)
              .replace(/\{\{ClassTime\}\}/gi, classTime)
              .replace(/\{\{ClassDate\}\}/gi, classDate)
              .replace(/\{\{ZoomLink\}\}/gi, zoomLink || 'https://zoom.us/j/YOUR_MEETING_ID');

            // Send email via Supabase Edge Function
            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                to: student.email,
                subject: subject,
                html: body,
                emailType: 'class_starting_soon',
              }),
            });

            const result = await response.json();

            if (result.error) {
              console.error('‚ùå Error from Supabase:', result.error);
              window.parent.postMessage(
                {
                  action: 'classStartingSoonError',
                  error: result.error,
                  student: student,
                },
                '*'
              );
              return;
            }

            // Track sent email
            await trackSentEmail(student.email, subject, 'Class Starting Soon (Automated)', body);

            // Send success message back to parent with email content
            window.parent.postMessage(
              {
                action: 'classStartingSoonSent',
                success: true,
                student: student,
                classDate: classDate,
                emailContent: {
                  subject: subject,
                  body: body,
                },
              },
              '*'
            );

            console.log('‚úÖ Class starting soon email sent successfully to:', student.name);
          } catch (error) {
            console.error('‚ùå Error sending class starting soon email:', error);

            // Send error message back to parent
            window.parent.postMessage(
              {
                action: 'classStartingSoonError',
                error: error.message,
                student: student,
              },
              '*'
            );
          }
        }

        // Handle welcome email requests
        if (action === 'sendWelcomeEmail') {
          console.log('üìß Received welcome email request:', student.name);

          try {
            if (!student.email) {
              console.error('‚ùå Student has no email address:', student.name);
              return;
            }

            // Parse multiple emails (comma-separated)
            const emailAddresses = student.email
              .split(',')
              .map(e => e.trim())
              .filter(e => e.length > 0);

            if (emailAddresses.length === 0) {
              console.error('‚ùå No valid email addresses found:', student.name);
              return;
            }

            console.log(`üìß Sending welcome email to ${emailAddresses.length} address(es):`, emailAddresses);

            // Find Welcome Email template
            const templates = emailSystem._templates || [];
            const welcomeTemplate = templates.find(t => t.name.toLowerCase().includes('welcome') && t.active);

            let subject, body;

            if (!welcomeTemplate) {
              console.warn('‚ö†Ô∏è No active Welcome Email template found, using default');

              // Use default welcome email with template function
              subject = `Welcome to ARNOMA NCLEX-RN`;

              const bodyContent = `
              <p>Dear <strong>${student.name}</strong>,</p>

              <div class="info-box" style="background-color: #faf5ff; border-left: 4px solid #9333ea; padding: 16px; margin: 20px 0; border-radius: 8px;">
                <p style="margin: 4px 0; color: #1f2937; font-size: 15px;"><strong>Group:</strong> ${student.group || 'Not assigned yet'}</p>
                <p style="margin: 4px 0; color: #1f2937; font-size: 15px;"><strong>Schedule:</strong> ${student.groupSchedule || 'To be determined'}</p>
                <p style="margin: 4px 0; color: #1f2937; font-size: 15px;"><strong>Pay Per Class:</strong> $${student.payPerClass || 0}</p>
              </div>

              <p>Welcome to your all-in-one nursing classroom! You are enrolled in <strong>${student.group || 'your group'} - ${student.groupSchedule ? student.groupSchedule.split('‚Äî')[0].trim() : 'TBD'}</strong>, and your group schedule is <strong>${student.groupSchedule || 'to be determined'}</strong>.</p>

              <p><strong>Your payment amount is $${student.payPerClass || 0} per class.</strong> Please make sure to complete your payment before class so that all your notes and materials will be accessible once the class ends.</p>

              <div class="payment-frame">
                <p style="margin: 0 0 15px 0; color: #4b5563; font-size: 18px; font-weight: 600;">
                  Send Money with Zelle¬Æ
                </p>
                <p style="margin: 0 0 20px 0; color: #6b7280; font-size: 14px;">
                  Scan in your banking app to pay.
                </p>
                <p style="margin: 0 0 15px 0; color: #111827; font-size: 16px; font-weight: 600;">
                  Arnoma
                </p>
                <p style="margin: 0 0 20px 0; color: #4b5563; font-size: 14px;">
                  909-300-5155
                </p>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=909-300-5155" alt="Zelle QR Code" style="width: 150px; height: 150px;" />
              </div>

              <p style="color: #6b7280; font-size: 14px;">If you have any questions, please don't hesitate to reach out.</p>
            `;

              body = generateEmailHTML('Welcome to ARNOMA', bodyContent);
            } else {
              // Replace variables in template
              subject = welcomeTemplate.subject
                .replace(/\{\{StudentName\}\}/g, student.name)
                .replace(/\{\{Group\}\}/g, student.group || 'Not assigned')
                .replace(/\{\{GroupName\}\}/g, student.group || 'Not assigned');

              body = welcomeTemplate.body
                .replace(/\{\{StudentName\}\}/g, student.name)
                .replace(/\{\{Group\}\}/g, student.group || 'Not assigned')
                .replace(/\{\{GroupName\}\}/g, student.group || 'Not assigned')
                .replace(/\{\{GroupSchedule\}\}/g, student.groupSchedule || 'To be determined')
                .replace(/\{\{NextClass\}\}/g, student.groupSchedule || 'To be determined')
                .replace(/\{\{ClassTime\}\}/g, student.classTime || 'TBD');
            }

            console.log('üì§ Sending welcome email to:', emailAddresses);
            console.log('üîë Using Supabase URL:', SUPABASE_URL);
            console.log('üì¨ Request payload:', {
              to: emailAddresses,
              subject: subject,
              htmlLength: body.length,
            });

            // Send email via Supabase Edge Function (supports array of emails)
            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                to: emailAddresses,
                subject: subject,
                html: body,
              }),
            });

            console.log('üìä Response status:', response.status, response.statusText);

            const responseData = await response.json();
            console.log('üì¨ Supabase response:', responseData);

            if (!response.ok) {
              console.error('‚ùå Response not OK:', response.status, response.statusText);
              throw new Error(`Failed to send email: ${response.statusText} - ${JSON.stringify(responseData)}`);
            }

            if (responseData.error) {
              console.error('‚ùå Error in response data:', responseData.error);
              throw new Error(`Supabase returned error: ${responseData.error}`);
            }

            // Track sent email with full HTML content
            const emailRecord = await trackSentEmail(student.email, subject, 'Welcome Email', body);

            console.log('‚úÖ Welcome email sent successfully to:', student.name);

            // Send notification to parent window
            window.parent.postMessage(
              {
                action: 'addNotification',
                notification: {
                  type: 'email',
                  title: 'Welcome Email Sent',
                  description: `Sent to ${student.name}`,
                  groupName: student.group || 'No group',
                  metadata: {
                    recipientName: student.name,
                    recipientEmail: student.email,
                    emailType: 'welcome',
                    emailId: emailRecord?.id,
                  },
                },
              },
              '*'
            );
          } catch (error) {
            console.error('‚ùå Error sending welcome email:', error);
            console.error('‚ùå Full error details:', JSON.stringify(error, null, 2));
          }
        }

        // Handle profile update email requests
        if (action === 'sendProfileUpdateEmail') {
          console.log('üìß Received profile update email request:', student.name);
          console.log('üìù Changes:', changes);
          console.log('üìß Email type:', emailType || 'current');

          // Prevent duplicate sends (within 2 seconds)
          const dedupeKey = `${student.email}_profileUpdate_${emailType || 'current'}`;
          const lastSend = recentSends.get(dedupeKey);
          const now = Date.now();

          if (lastSend && now - lastSend < 2000) {
            console.warn('‚ö†Ô∏è Duplicate profile update email blocked (sent', now - lastSend, 'ms ago)');
            return;
          }

          recentSends.set(dedupeKey, now);

          // Clean up old entries (older than 5 seconds)
          for (const [key, timestamp] of recentSends.entries()) {
            if (now - timestamp > 5000) {
              recentSends.delete(key);
            }
          }

          try {
            if (!student.email) {
              console.error('‚ùå Student has no email address:', student.name);
              return;
            }

            // Build changes list HTML with detailed explanations
            let changesHTML = '';
            changes.forEach(change => {
              let explanation = '';

              // Add contextual explanation based on field type
              if (change.field === 'Name') {
                explanation =
                  '<br><small style="color: #6b7280; font-style: italic;">Your name has been updated in our system.</small>';
              } else if (change.field === 'Email') {
                explanation =
                  '<br><small style="color: #6b7280; font-style: italic;">Your email address for all future communications has been changed.</small>';
              } else if (change.field === 'Phone') {
                explanation =
                  '<br><small style="color: #6b7280; font-style: italic;">Your contact phone number has been updated.</small>';
              } else if (change.field === 'Group') {
                explanation =
                  '<br><small style="color: #6b7280; font-style: italic;">You have been moved to a different class group.</small>';
              } else if (change.field === 'Amount per Class') {
                explanation =
                  '<br><small style="color: #6b7280; font-style: italic;">Your payment amount per class has been adjusted.</small>';
              } else if (change.field === 'Balance') {
                explanation =
                  '<br><small style="color: #6b7280; font-style: italic;">Your account balance has been updated.</small>';
              } else if (change.field === 'Aliases') {
                explanation =
                  '<br><small style="color: #6b7280; font-style: italic;">Your alternative names/nicknames have been updated.</small>';
              }

              changesHTML += `
              <p style="margin: 8px 0; padding: 10px; background-color: #f6f8fe; border-left: 3px solid #3b82f6; border-radius: 6px;">
                <strong style="color: #4f46e5;">${change.field}:</strong>
                <span style="color: #6b7280;">${change.old}</span>
                <span style="color: #059669;">‚Üí ${change.new}</span>
                ${explanation}
              </p>
            `;
            });

            // Add special message for old email notification
            const specialNotice = specialMessage
              ? `
            <div class="info-box" style="background-color: #fef3c7; border-left-color: #f59e0b;">
              <p style="margin: 0; color: #92400e;">
                <strong>‚ö†Ô∏è Important:</strong> ${specialMessage}
              </p>
            </div>
          `
              : '';

            // Build current profile info
            const profileInfo = `
            <div class="info-box">
              <p style="margin: 0 0 8px 0;"><strong>üìã Current Profile:</strong></p>
              <p style="margin: 4px 0;"><strong>Group:</strong> ${student.group}</p>
              <p style="margin: 4px 0;"><strong>Schedule:</strong> ${student.groupSchedule}</p>
              ${student.phone !== 'Not set' ? `<p style="margin: 4px 0;"><strong>Phone:</strong> ${student.phone}</p>` : ''}
              ${student.aliases !== 'None' ? `<p style="margin: 4px 0;"><strong>Aliases:</strong> ${student.aliases}</p>` : ''}
            </div>
          `;

            const bodyContent = `
            <p>Hi <strong>${student.name}</strong>,</p>

            ${specialNotice}

            <p>We wanted to let you know that your profile information has been updated. Here are the changes:</p>

            ${changesHTML}

            ${profileInfo}

            <p style="color: #6b7280; font-size: 14px;">If you have any questions about these changes, please contact us.</p>
          `;

            const subject = `Profile Updated - ARNOMA NCLEX-RN`;
            const body = generateEmailHTML('Profile Updated', bodyContent);

            // Send email via Supabase Edge Function
            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                to: student.email,
                subject: subject,
                html: body,
              }),
            });

            if (!response.ok) {
              throw new Error(`Failed to send email: ${response.statusText}`);
            }

            // Track sent email with metadata
            const emailRecord = await trackSentEmail(student.email, subject, 'Profile Update', body, {
              recipientName: student.name,
              recipientType: 'student',
              changesCount: changes.length,
              automationName: 'Profile Update Notification',
            });

            console.log('‚úÖ Profile update email sent successfully to:', student.name);

            // Send notification to parent window
            window.parent.postMessage(
              {
                action: 'addNotification',
                notification: {
                  type: 'email',
                  title: 'Profile Updated',
                  description: `${changes.length} change${changes.length !== 1 ? 's' : ''} sent to ${student.name}`,
                  groupName: student.group || 'No group',
                  metadata: {
                    recipientName: student.name,
                    emailId: emailRecord?.id,
                    recipientEmail: student.email,
                    changesCount: changes.length,
                    emailType: 'profile_update',
                    emailBody: body,
                    emailSubject: subject,
                  },
                },
              },
              '*'
            );
          } catch (error) {
            console.error('‚ùå Error sending profile update email:', error);
          }
        }

        // Handle schedule update email requests
        if (action === 'sendScheduleUpdateEmail') {
          console.log('üìÖ Received schedule update email request');
          console.log('üìù Group:', groupName, 'Old:', oldSchedule, 'New:', newSchedule);
          console.log('üë• Students to notify:', students.length);

          try {
            let lastEmailBody = '';
            const subject = `Class Schedule Updated - ARNOMA NCLEX-RN`;

            // Send email to each student in the group
            for (const student of students) {
              if (!student.email) {
                console.warn('‚ö†Ô∏è Student has no email address:', student.name);
                continue;
              }

              const scheduleComparison =
                oldSchedule !== 'Not set' && oldSchedule !== newSchedule
                  ? `
              <p style="margin: 8px 0; padding: 12px; background-color: #fef2f2; border-left: 4px solid #ef4444; border-radius: 6px;">
                <strong style="color: #991b1b;">‚ùå Previous Schedule:</strong><br>
                <span style="color: #991b1b; text-decoration: line-through;">${oldSchedule}</span>
              </p>
            `
                  : '';

              const bodyContent = `
              <p>Hi <strong>${student.name}</strong>,</p>

              <p>We wanted to let you know that the schedule for <strong>${groupName}</strong> has been updated.</p>

              ${scheduleComparison}

              <p style="margin: 8px 0; padding: 12px; background-color: #f0fdf4; border-left: 4px solid #22c55e; border-radius: 6px;">
                <strong style="color: #166534;">‚úÖ New Schedule:</strong><br>
                <span style="color: #166534; font-size: 18px; font-weight: 600;">${newSchedule}</span>
              </p>

              <div class="info-box" style="background-color: #fef3c7; border-left-color: #f59e0b;">
                <p style="margin: 0; color: #92400e;">
                  <strong>‚ö†Ô∏è Important:</strong> Please make sure to update your calendar and plan accordingly. If you have any conflicts with the new schedule, please contact us immediately.
                </p>
              </div>

              <p style="color: #6b7280; font-size: 14px;">If you have any questions about this change, please don't hesitate to reach out.</p>
            `;

              const body = generateEmailHTML('üìÖ Schedule Updated', bodyContent);
              lastEmailBody = body; // Store for notification

              // Send email via Supabase Edge Function
              const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
                },
                body: JSON.stringify({
                  to: student.email,
                  subject: subject,
                  html: body,
                }),
              });

              if (!response.ok) {
                const errorText = await response.text();
                console.error(`‚ùå Failed to send schedule update email to ${student.name}:`, errorText);
                continue;
              }

              // Track sent email
              const emailRecord = await trackSentEmail(student.email, subject, 'Schedule Update', body, {
                recipientName: student.name,
                recipientType: 'student',
                groupName: groupName,
                oldSchedule: oldSchedule,
                newSchedule: newSchedule,
                automationName: 'Schedule Update Notification',
              });

              console.log('‚úÖ Schedule update email sent to:', student.name);
            }

            // Send notification to parent window
            window.parent.postMessage(
              {
                action: 'addNotification',
                notification: {
                  type: 'schedule_update',
                  title: 'Schedule Updated',
                  description: `${groupName}: Schedule changed to ${newSchedule}`,
                  groupName: groupName,
                  metadata: {
                    groupName: groupName,
                    oldSchedule: oldSchedule,
                    newSchedule: newSchedule,
                    studentsNotified: students.length,
                    emailType: 'schedule_update',
                    emailBody: lastEmailBody,
                    emailSubject: subject,
                  },
                },
              },
              '*'
            );

            console.log(`‚úÖ Schedule update emails sent to ${students.length} students in ${groupName}`);
          } catch (error) {
            console.error('‚ùå Error sending schedule update emails:', error);
          }
        }

        // ============================================================
        // Handle alias added email requests
        // ============================================================
        if (action === 'sendAliasAddedEmail') {
          console.log(
            '[AliasEmail] üìß Received alias added email request:',
            student?.name,
            'Alias:',
            event.data.aliasAdded
          );

          try {
            if (!student || !student.email) {
              console.error('[AliasEmail] ‚ùå Student has no email address');
              window.parent.postMessage(
                {
                  action: 'aliasEmailError',
                  error: 'Student has no email address',
                },
                '*'
              );
              return;
            }

            const aliasAdded = event.data.aliasAdded || 'Unknown';
            const timestamp = event.data.timestamp ? new Date(event.data.timestamp) : new Date();
            const formattedDate = timestamp.toLocaleDateString('en-US', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
            });

            // Create email content
            const subject = `New Alias Added to Your ARNOMA Account`;

            const bodyContent = `
              <p>Dear <strong>${student.name}</strong>,</p>

              <div style="background: linear-gradient(135deg, rgba(138, 180, 255, 0.1), rgba(167, 139, 250, 0.1)); border-left: 4px solid #8ab4ff; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 16px; color: #333; font-weight: 600; margin-bottom: 12px;">
                  ‚úÖ Payment Name Added
                </div>
                <div style="font-size: 15px; color: #555; margin-bottom: 8px;">
                  We've added a new payment name to your account:
                </div>
                <div style="background: rgba(255, 255, 255, 0.7); padding: 12px; border-radius: 6px; margin: 12px 0;">
                  <div style="font-size: 18px; color: #8ab4ff; font-weight: 700;">
                    ${aliasAdded}
                  </div>
                </div>
                <div style="font-size: 14px; color: #666; margin-top: 12px;">
                  <strong>What this means:</strong> Future payments made under the name "${aliasAdded}" will now be automatically recognized and linked to your account.
                </div>
              </div>

              <div style="background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); padding: 16px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 14px; color: #166534; font-weight: 600; margin-bottom: 8px;">
                  ‚ÑπÔ∏è No Action Required
                </div>
                <div style="font-size: 13px; color: #15803d;">
                  This is just a notification to keep you informed. Your account settings have been updated automatically.
                </div>
              </div>

              <div style="font-size: 12px; color: #9ca3af; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                <p style="margin: 0;">Alias added on: ${formattedDate}</p>
                <p style="margin: 8px 0 0 0;">Student: ${student.name}</p>
              </div>

              <p style="margin-top: 24px;">If you have any questions about this change, please don't hesitate to reach out to us.</p>
            `;

            const body = generateEmailHTML('New Alias Added', bodyContent);

            console.log('[AliasEmail] üì§ Sending email to:', student.email);

            // Send email via Supabase Edge Function
            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                to: student.email,
                subject: subject,
                html: body,
              }),
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Failed to send email: ${response.statusText} - ${errorText}`);
            }

            // Track sent email
            const emailRecord = await trackSentEmail(student.email, subject, 'Alias Added Notification', body);

            console.log('[AliasEmail] ‚úÖ Alias email sent successfully to:', student.name);

            // Send success confirmation back to parent
            window.parent.postMessage(
              {
                action: 'aliasEmailSent',
                success: true,
                student: student,
                aliasAdded: aliasAdded,
              },
              '*'
            );

            // Also send notification to notification center
            window.parent.postMessage(
              {
                action: 'addNotification',
                notification: {
                  type: 'email',
                  title: 'Alias Added Email Sent',
                  description: `Sent to ${student.name} for alias: ${aliasAdded}`,
                  metadata: {
                    recipientName: student.name,
                    recipientEmail: student.email,
                    emailType: 'alias_added',
                    aliasAdded: aliasAdded,
                    emailId: emailRecord?.id,
                  },
                },
              },
              '*'
            );
          } catch (error) {
            console.error('[AliasEmail] ‚ùå Error sending alias email:', error);

            // Send error back to parent
            window.parent.postMessage(
              {
                action: 'aliasEmailError',
                error: error.message,
                student: student,
              },
              '*'
            );
          }
        }
        // ============================================================

        // ============================================================
        // CREDIT ADDED EMAIL HANDLER
        // ============================================================
        if (action === 'sendCreditAddedEmail') {
          console.log(
            '[CreditEmail] üìß Received credit added email request:',
            student?.name,
            'Amount:',
            event.data.creditAmount
          );

          try {
            if (!student || !student.email) {
              console.error('[CreditEmail] ‚ùå Student has no email address');
              window.parent.postMessage(
                {
                  action: 'creditAddedEmailError',
                  error: 'Student has no email address',
                },
                '*'
              );
              return;
            }

            const creditAmount = parseFloat(event.data.creditAmount) || 0;
            const newBalance = parseFloat(event.data.newBalance) || 0;
            const reason = event.data.reason || 'Extra payment received';
            const timestamp = event.data.timestamp ? new Date(event.data.timestamp) : new Date();
            const formattedDate = timestamp.toLocaleDateString('en-US', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
            });

            // Create email content
            const subject = `Credit Added to Your Account`;

            const bodyContent = `
              <p>Dear <strong>${student.name}</strong>,</p>

              <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)); border-left: 4px solid #22c55e; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 16px; color: #333; font-weight: 600; margin-bottom: 12px;">
                  üí≥ Credit Added to Your Account
                </div>
                <div style="font-size: 15px; color: #555; margin-bottom: 8px;">
                  We've added credit to your account:
                </div>
                <div style="background: rgba(255, 255, 255, 0.7); padding: 16px; border-radius: 6px; margin: 12px 0;">
                  <div style="font-size: 24px; color: #22c55e; font-weight: 700; margin-bottom: 8px;">
                    +$${creditAmount.toFixed(2)}
                  </div>
                  <div style="font-size: 14px; color: #666;">
                    <strong>New Balance:</strong> <span style="color: #22c55e; font-weight: 600;">$${newBalance.toFixed(2)}</span>
                  </div>
                </div>
                <div style="font-size: 14px; color: #666; margin-top: 12px;">
                  <strong>Reason:</strong> ${reason}
                </div>
              </div>

              <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); padding: 16px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 14px; color: #1e40af; font-weight: 600; margin-bottom: 8px;">
                  ‚ÑπÔ∏è How Credits Work
                </div>
                <div style="font-size: 13px; color: #1e3a8a;">
                  Your credit balance will be automatically applied to future classes. You don't need to take any action - we'll deduct from your credit when you attend classes.
                </div>
              </div>

              <div style="font-size: 12px; color: #9ca3af; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                <p style="margin: 0;">Credit added on: ${formattedDate}</p>
                <p style="margin: 8px 0 0 0;">Student: ${student.name}</p>
              </div>

              <p style="margin-top: 24px;">Thank you for your payment!</p>
            `;

            const body = generateEmailHTML('Credit Added', bodyContent);

            console.log('[CreditEmail] üì§ Sending email to:', student.email);

            // Send email via Supabase Edge Function
            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                to: student.email,
                subject: subject,
                html: body,
              }),
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Failed to send email: ${response.statusText} - ${errorText}`);
            }

            // Track sent email
            const emailRecord = await trackSentEmail(student.email, subject, 'Credit Added', body);

            console.log('[CreditEmail] ‚úÖ Credit added email sent successfully to:', student.name);

            // Send success confirmation back to parent
            window.parent.postMessage(
              {
                action: 'creditAddedEmailSent',
                success: true,
                student: student,
                creditAmount: creditAmount,
              },
              '*'
            );

            // Also send notification to notification center
            window.parent.postMessage(
              {
                action: 'addNotification',
                notification: {
                  type: 'email',
                  title: 'Credit Added Email Sent',
                  description: `Sent to ${student.name} for $${creditAmount.toFixed(2)} credit`,
                  metadata: {
                    recipientName: student.name,
                    recipientEmail: student.email,
                    emailType: 'credit_added',
                    creditAmount: creditAmount,
                    emailId: emailRecord?.id, // Add emailId for opening email on click
                  },
                },
              },
              '*'
            );
          } catch (error) {
            console.error('[CreditEmail] ‚ùå Error sending credit added email:', error);

            // Send error back to parent
            window.parent.postMessage(
              {
                action: 'creditAddedEmailError',
                error: error.message,
                student: student,
              },
              '*'
            );
          }
        }

        // ============================================================
        // CREDIT APPLIED EMAIL HANDLER
        // ============================================================
        if (action === 'sendCreditAppliedEmail') {
          console.log(
            '[CreditEmail] üìß Received credit applied email request:',
            student?.name,
            'Class:',
            event.data.classDate
          );

          try {
            if (!student || !student.email) {
              console.error('[CreditEmail] ‚ùå Student has no email address');
              window.parent.postMessage(
                {
                  action: 'creditAppliedEmailError',
                  error: 'Student has no email address',
                },
                '*'
              );
              return;
            }

            const classDate = event.data.classDate || 'Unknown';
            const amountDeducted = parseFloat(event.data.amountDeducted) || 0;
            const newBalance = parseFloat(event.data.newBalance) || 0;
            const timestamp = event.data.timestamp ? new Date(event.data.timestamp) : new Date();
            const formattedDate = timestamp.toLocaleDateString('en-US', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
            });

            // Format class date
            const classDateObj = new Date(classDate + 'T00:00:00');
            const formattedClassDate = classDateObj.toLocaleDateString('en-US', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            });

            // Create email content
            const subject = `Credit Applied to Your Class`;

            const bodyContent = `
              <p>Dear <strong>${student.name}</strong>,</p>

              <div style="background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(251, 191, 36, 0.1)); border-left: 4px solid #eab308; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 16px; color: #333; font-weight: 600; margin-bottom: 12px;">
                  üí≥ Credit Applied to Class
                </div>
                <div style="font-size: 15px; color: #555; margin-bottom: 8px;">
                  We've applied credit from your account to pay for this class:
                </div>
                <div style="background: rgba(255, 255, 255, 0.7); padding: 16px; border-radius: 6px; margin: 12px 0;">
                  <div style="font-size: 16px; color: #333; margin-bottom: 12px;">
                    <strong>Class Date:</strong> ${formattedClassDate}
                  </div>
                  <div style="font-size: 20px; color: #eab308; font-weight: 700; margin-bottom: 8px;">
                    -$${amountDeducted.toFixed(2)}
                  </div>
                  <div style="font-size: 14px; color: #666;">
                    <strong>Remaining Balance:</strong> <span style="color: ${newBalance >= 0 ? '#22c55e' : '#ef4444'}; font-weight: 600;">$${newBalance.toFixed(2)}</span>
                  </div>
                </div>
              </div>

              <div style="background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); padding: 16px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 14px; color: #166534; font-weight: 600; margin-bottom: 8px;">
                  ‚úÖ Class Marked as PAID
                </div>
                <div style="font-size: 13px; color: #15803d;">
                  This class has been marked as paid using your credit balance. You're all set!
                </div>
              </div>

              <div style="font-size: 12px; color: #9ca3af; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                <p style="margin: 0;">Credit applied on: ${formattedDate}</p>
                <p style="margin: 8px 0 0 0;">Student: ${student.name}</p>
              </div>

              <p style="margin-top: 24px;">If you have any questions about this transaction, please let us know.</p>
            `;

            const body = generateEmailHTML('Credit Applied', bodyContent);

            console.log('[CreditEmail] üì§ Sending email to:', student.email);

            // Send email via Supabase Edge Function
            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                to: student.email,
                subject: subject,
                html: body,
              }),
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Failed to send email: ${response.statusText} - ${errorText}`);
            }

            // Track sent email
            const emailRecord = await trackSentEmail(student.email, subject, 'Credit Applied', body);

            console.log('[CreditEmail] ‚úÖ Credit applied email sent successfully to:', student.name);

            // Send success confirmation back to parent
            window.parent.postMessage(
              {
                action: 'creditAppliedEmailSent',
                success: true,
                student: student,
                classDate: classDate,
              },
              '*'
            );

            // Also send notification to notification center
            window.parent.postMessage(
              {
                action: 'addNotification',
                notification: {
                  type: 'email',
                  title: 'Credit Applied Email Sent',
                  description: `Sent to ${student.name} for class on ${formattedClassDate}`,
                  metadata: {
                    recipientName: student.name,
                    recipientEmail: student.email,
                    emailType: 'credit_applied',
                    classDate: classDate,
                    emailId: emailRecord?.id,
                  },
                },
              },
              '*'
            );
          } catch (error) {
            console.error('[CreditEmail] ‚ùå Error sending credit applied email:', error);

            // Send error back to parent
            window.parent.postMessage(
              {
                action: 'creditAppliedEmailError',
                error: error.message,
                student: student,
              },
              '*'
            );
          }
        }

        // ============================================================
        // MANUAL CREDIT EDIT EMAIL HANDLER
        // ============================================================
        if (action === 'sendCreditManualEditEmail') {
          console.log('[CreditEmail] üìß Received manual credit edit email request:', student?.name);

          try {
            if (!student || !student.email) {
              console.error('[CreditEmail] ‚ùå Student has no email address');
              window.parent.postMessage(
                {
                  action: 'creditManualEditEmailError',
                  error: 'Student has no email address',
                },
                '*'
              );
              return;
            }

            const oldBalance = parseFloat(event.data.oldBalance) || 0;
            const newBalance = parseFloat(event.data.newBalance) || 0;
            const difference = newBalance - oldBalance;
            const timestamp = event.data.timestamp ? new Date(event.data.timestamp) : new Date();
            const formattedDate = timestamp.toLocaleDateString('en-US', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
            });

            // Create email content
            const subject = `Your Credit Balance Was Updated`;

            const bodyContent = `
              <table width="100%" cellpadding="0" cellspacing="0" border="0" style="margin: 0; padding: 0;">
                <tr>
                  <td align="center" style="padding: 0;">
                    <table width="600" cellpadding="0" cellspacing="0" border="0" style="max-width: 600px; width: 100%; margin: 0 auto;">
                      <tr>
                        <td style="padding: 0 20px;">

                          <!-- Greeting -->
                          <p style="font-size: 16px; color: #333; margin: 24px 0 20px 0; padding: 0;">Dear <strong>${student.name}</strong>,</p>

                          <!-- Header Block -->
                          <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background: linear-gradient(135deg, #8B7ECC, #6B63B5); border-radius: 12px; margin: 20px 0;">
                            <tr>
                              <td style="padding: 24px; text-align: center;">
                                <div style="font-size: 22px; color: #ffffff; font-weight: 700; margin: 0;">üí∞ Credit Balance Updated</div>
                              </td>
                            </tr>
                          </table>

                          <!-- Balance Details White Box -->
                          <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; margin: 20px 0;">
                            <tr>
                              <td style="padding: 24px;">

                                <p style="font-size: 15px; color: #555; margin: 0 0 16px 0; text-align: center;">Your credit balance has been adjusted:</p>

                                <!-- Balance Row -->
                                <table width="100%" cellpadding="0" cellspacing="0" border="0">
                                  <tr>
                                    <td width="42%" align="center" style="padding: 12px; vertical-align: middle;">
                                      <div style="font-size: 12px; color: #666; margin-bottom: 6px;">Previous Balance</div>
                                      <div style="font-size: 24px; color: ${oldBalance >= 0 ? '#22c55e' : '#ef4444'}; font-weight: 700;">$${oldBalance.toFixed(2)}</div>
                                    </td>
                                    <td width="16%" align="center" style="padding: 12px; vertical-align: middle;">
                                      <div style="font-size: 28px; color: #8B7ECC; font-weight: 700;">‚Üí</div>
                                    </td>
                                    <td width="42%" align="center" style="padding: 12px; vertical-align: middle;">
                                      <div style="font-size: 12px; color: #666; margin-bottom: 6px;">New Balance</div>
                                      <div style="font-size: 24px; color: ${newBalance >= 0 ? '#22c55e' : '#ef4444'}; font-weight: 700;">$${newBalance.toFixed(2)}</div>
                                    </td>
                                  </tr>
                                </table>

                                <!-- Amount Change -->
                                <table width="100%" cellpadding="0" cellspacing="0" border="0" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                                  <tr>
                                    <td align="center" style="padding: 8px 0;">
                                      <div style="font-size: 20px; color: ${difference >= 0 ? '#22c55e' : '#ef4444'}; font-weight: 700;">${difference >= 0 ? '+' : ''}$${difference.toFixed(2)}</div>
                                    </td>
                                  </tr>
                                </table>

                              </td>
                            </tr>
                          </table>

                          <!-- What This Means Box -->
                          <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; margin: 20px 0;">
                            <tr>
                              <td style="padding: 20px;">
                                <div style="font-size: 15px; color: #1e40af; font-weight: 700; margin: 0 0 10px 0;">‚ÑπÔ∏è What This Means</div>
                                <div style="font-size: 14px; color: #1e3a8a; line-height: 1.5; margin: 0;">This adjustment has been made to your account balance. Your credit will ${newBalance > 0 ? 'automatically apply to upcoming classes' : 'be updated accordingly'}.</div>
                              </td>
                            </tr>
                          </table>

                          <!-- Footer Details -->
                          <table width="100%" cellpadding="0" cellspacing="0" border="0" style="margin: 24px 0 0 0; padding: 16px 0 0 0; border-top: 1px solid #e5e7eb;">
                            <tr>
                              <td>
                                <p style="font-size: 12px; color: #9ca3af; margin: 0 0 6px 0;">Balance updated on: ${formattedDate}</p>
                                <p style="font-size: 12px; color: #9ca3af; margin: 0;">Student: ${student.name}</p>
                              </td>
                            </tr>
                          </table>

                          <!-- Contact -->
                          <p style="font-size: 14px; color: #555; margin: 24px 0 0 0;">If you have any questions about this adjustment, please contact us.</p>

                        </td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            `;

            const body = generateEmailHTML('Credit Balance Updated', bodyContent);

            console.log('[CreditEmail] üì§ Sending email to:', student.email);

            // Send email via Supabase Edge Function
            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({
                to: student.email,
                subject: subject,
                html: body,
              }),
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Failed to send email: ${response.statusText} - ${errorText}`);
            }

            // Track sent email
            const emailRecord = await trackSentEmail(student.email, subject, 'Credit Balance Updated', body);

            console.log('[CreditEmail] ‚úÖ Manual credit edit email sent successfully to:', student.name);

            // Send success confirmation back to parent
            window.parent.postMessage(
              {
                action: 'creditManualEditEmailSent',
                success: true,
                student: student,
                oldBalance: oldBalance,
                newBalance: newBalance,
              },
              '*'
            );

            // Also send notification to notification center
            window.parent.postMessage(
              {
                action: 'addNotification',
                notification: {
                  type: 'email',
                  title: 'Credit Balance Update Email Sent',
                  description: `Sent to ${student.name} - Balance changed from $${oldBalance.toFixed(2)} to $${newBalance.toFixed(2)}`,
                  metadata: {
                    recipientName: student.name,
                    recipientEmail: student.email,
                    emailType: 'credit_manual_edit',
                    oldBalance: oldBalance,
                    emailId: emailRecord?.id,
                    newBalance: newBalance,
                  },
                },
              },
              '*'
            );
          } catch (error) {
            console.error('[CreditEmail] ‚ùå Error sending manual credit edit email:', error);

            // Send error back to parent
            window.parent.postMessage(
              {
                action: 'creditManualEditEmailError',
                error: error.message,
                student: student,
              },
              '*'
            );
          }
        }
        // ============================================================

        // ============================================================
        // NEW STATUS CHANGE & NOTIFICATION EMAIL HANDLERS
        // ============================================================

        // HANDLER 1: Status Change - Active ‚Üí Paused
        if (action === 'sendStatusChangeToPausedEmail') {
          try {
            const student = event.data.student;
            const groupName = event.data.groupName;

            const subject = 'Update to Your ARNOMA Class Status';
            const bodyContent = `
              <p>Dear <strong>${student.name}</strong>,</p>

              <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1)); border-left: 4px solid #fbbf24; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 16px; color: #333; font-weight: 600; margin-bottom: 12px;">
                  ‚è∏Ô∏è Status Updated: Active ‚Üí Paused
                </div>
                <div style="font-size: 15px; color: #555; margin-bottom: 8px;">
                  Your class status for <strong>Group ${groupName}</strong> has been updated from <strong>Active</strong> to <strong>Paused</strong>.
                </div>
              </div>

              <div style="background: rgba(249, 115, 22, 0.05); border: 1px solid rgba(249, 115, 22, 0.2); padding: 16px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 14px; color: #9a3412; font-weight: 600; margin-bottom: 12px;">
                  While Paused:
                </div>
                <ul style="margin: 0; padding-left: 20px; color: #7c2d12;">
                  <li style="margin-bottom: 8px;">You will not appear in the active roster</li>
                  <li style="margin-bottom: 8px;">You will not be counted toward sessions</li>
                  <li style="margin-bottom: 8px;">You will not receive email notifications, notes, reminders, or class communication</li>
                  <li>Your profile remains inactive until you return</li>
                </ul>
              </div>

              <p style="font-size: 14px; color: #666;">
                If this was done intentionally, no action is needed. If this is unexpected, please reply and we will assist you.
              </p>

              <p style="margin-top: 24px;">Thank you,<br><strong>ARNOMA Learning Center</strong></p>
            `;

            const body = generateEmailHTML('Status Update', bodyContent);

            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${SUPABASE_ANON_KEY}` },
              body: JSON.stringify({ to: student.email, subject: subject, html: body }),
            });

            if (!response.ok) throw new Error('Failed to send email');

            await trackSentEmail(student.email, subject, 'Status Change', body, {
              recipientName: student.name,
              groupName: groupName,
            });

            window.parent.postMessage({ action: 'statusChangeToPausedEmailSent', success: true }, '*');
          } catch (error) {
            window.parent.postMessage({ action: 'statusChangeToPausedEmailError', error: error.message }, '*');
          }
        }

        // HANDLER 2: Status Change - Paused ‚Üí Active
        if (action === 'sendStatusChangeToActiveEmail') {
          try {
            const student = event.data.student;
            const groupName = event.data.groupName;

            const subject = 'Welcome Back to ARNOMA!';
            const bodyContent = `
              <p>Dear <strong>${student.name}</strong>,</p>

              <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)); border-left: 4px solid #22c55e; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 16px; color: #333; font-weight: 600; margin-bottom: 12px;">
                  ‚úÖ Status Updated: Paused ‚Üí Active
                </div>
                <div style="font-size: 15px; color: #555; margin-bottom: 8px;">
                  Your class status for <strong>Group ${groupName}</strong> has been updated from <strong>Paused</strong> to <strong>Active</strong>.
                </div>
              </div>

              <div style="background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); padding: 16px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 14px; color: #166534; font-weight: 600; margin-bottom: 8px;">
                  üéâ You're Back!
                </div>
                <div style="font-size: 13px; color: #15803d;">
                  You are now fully reactivated and will receive reminders, notes, and class notifications again.
                </div>
              </div>

              <p style="margin-top: 24px;">Thank you,<br><strong>ARNOMA Learning Center</strong></p>
            `;

            const body = generateEmailHTML('Welcome Back', bodyContent);

            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${SUPABASE_ANON_KEY}` },
              body: JSON.stringify({ to: student.email, subject: subject, html: body }),
            });

            if (!response.ok) throw new Error('Failed to send email');

            await trackSentEmail(student.email, subject, 'Status Change', body, {
              recipientName: student.name,
              groupName: groupName,
            });

            window.parent.postMessage({ action: 'statusChangeToActiveEmailSent', success: true }, '*');
          } catch (error) {
            window.parent.postMessage({ action: 'statusChangeToActiveEmailError', error: error.message }, '*');
          }
        }

        // HANDLER 3: Status Change - Active ‚Üí Graduated
        if (action === 'sendStatusChangeToGraduatedEmail') {
          try {
            const student = event.data.student;
            const groupName = event.data.groupName;

            const subject = 'Congratulations on Completing Your ARNOMA Course!';
            const bodyContent = `
              <p>Dear <strong>${student.name}</strong>,</p>

              <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(147, 51, 234, 0.1)); border-left: 4px solid #a855f7; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 16px; color: #333; font-weight: 600; margin-bottom: 12px;">
                  üéì Status Updated: Active ‚Üí Graduated
                </div>
                <div style="font-size: 15px; color: #555; margin-bottom: 8px;">
                  Your ARNOMA class status for <strong>Group ${groupName}</strong> has been updated from <strong>Active</strong> to <strong>Graduated</strong>.
                </div>
              </div>

              <div style="background: rgba(168, 85, 247, 0.05); border: 1px solid rgba(168, 85, 247, 0.2); padding: 16px; border-radius: 8px; margin: 20px 0; text-align: center;">
                <div style="font-size: 24px; margin-bottom: 12px;">üéâ</div>
                <div style="font-size: 16px; color: #7e22ce; font-weight: 700; margin-bottom: 8px;">
                  Congratulations!
                </div>
                <div style="font-size: 14px; color: #6b21a8;">
                  You have successfully completed your ARNOMA course.
                </div>
              </div>

              <p style="font-size: 14px; color: #666;">
                You will no longer appear in active rosters or receive class notifications.
              </p>

              <p style="margin-top: 24px;">Thank you for being part of ARNOMA!<br><strong>ARNOMA Learning Center</strong></p>
            `;

            const body = generateEmailHTML('Congratulations', bodyContent);

            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${SUPABASE_ANON_KEY}` },
              body: JSON.stringify({ to: student.email, subject: subject, html: body }),
            });

            if (!response.ok) throw new Error('Failed to send email');

            await trackSentEmail(student.email, subject, 'Status Change', body, {
              recipientName: student.name,
              groupName: groupName,
            });

            window.parent.postMessage({ action: 'statusChangeToGraduatedEmailSent', success: true }, '*');
          } catch (error) {
            window.parent.postMessage({ action: 'statusChangeToGraduatedEmailError', error: error.message }, '*');
          }
        }

        // HANDLER 4: Absence Notification
        if (action === 'sendAbsenceNotificationEmail') {
          try {
            const student = event.data.student;
            const groupName = event.data.groupName;
            const classDate = event.data.classDate;

            const subject = 'You Were Marked Absent Today';
            const bodyContent = `
              <p>Dear <strong>${student.name}</strong>,</p>

              <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1)); border-left: 4px solid #ef4444; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 16px; color: #333; font-weight: 600; margin-bottom: 12px;">
                  üö´ Marked Absent
                </div>
                <div style="font-size: 15px; color: #555; margin-bottom: 8px;">
                  You were marked <strong>Absent</strong> from today's <strong>Group ${groupName}</strong> class.
                </div>
                <div style="font-size: 14px; color: #666; margin-top: 12px;">
                  <strong>Date:</strong> ${classDate}
                </div>
              </div>

              <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); padding: 16px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 14px; color: #1e40af; font-weight: 600; margin-bottom: 8px;">
                  üìö Access Class Notes
                </div>
                <div style="font-size: 13px; color: #1e3a8a;">
                  To unlock today's notes, simply make your class payment ‚Äî notes will appear automatically once payment is received.
                </div>
              </div>

              <p style="font-size: 14px; color: #666;">
                If this was a mistake, please reply and we will correct it.
              </p>

              <p style="margin-top: 24px;">Thank you,<br><strong>ARNOMA Learning Center</strong></p>
            `;

            const body = generateEmailHTML('Absence Notice', bodyContent);

            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${SUPABASE_ANON_KEY}` },
              body: JSON.stringify({ to: student.email, subject: subject, html: body }),
            });

            if (!response.ok) throw new Error('Failed to send email');

            await trackSentEmail(student.email, subject, 'Absence Notification', body, {
              recipientName: student.name,
              groupName: groupName,
              classDate: classDate,
            });

            window.parent.postMessage({ action: 'absenceNotificationEmailSent', success: true }, '*');
          } catch (error) {
            window.parent.postMessage({ action: 'absenceNotificationEmailError', error: error.message }, '*');
          }
        }

        // HANDLER 5: Schedule Change
        if (action === 'sendScheduleChangeEmail') {
          try {
            const student = event.data.student;
            const groupName = event.data.groupName;
            const oldSchedule = event.data.oldSchedule;
            const newSchedule = event.data.newSchedule;

            const subject = 'Update to Your Class Schedule';
            const bodyContent = `
              <p>Dear <strong>${student.name}</strong>,</p>

              <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1)); border-left: 4px solid #3b82f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 16px; color: #333; font-weight: 600; margin-bottom: 12px;">
                  üìÖ Schedule Updated
                </div>
                <div style="font-size: 15px; color: #555; margin-bottom: 12px;">
                  Your class schedule for <strong>Group ${groupName}</strong> has been updated.
                </div>

                <div style="background: rgba(255, 255, 255, 0.7); padding: 16px; border-radius: 6px; margin: 12px 0;">
                  <div style="margin-bottom: 12px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Previous Schedule:</div>
                    <div style="font-size: 14px; color: #ef4444; font-weight: 600; text-decoration: line-through;">${oldSchedule}</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">New Schedule:</div>
                    <div style="font-size: 16px; color: #22c55e; font-weight: 700;">${newSchedule}</div>
                  </div>
                </div>
              </div>

              <p style="font-size: 14px; color: #666;">
                If this change affects your availability, please reply and we'll work with you.
              </p>

              <p style="margin-top: 24px;">Thank you,<br><strong>ARNOMA Learning Center</strong></p>
            `;

            const body = generateEmailHTML('Schedule Update', bodyContent);

            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${SUPABASE_ANON_KEY}` },
              body: JSON.stringify({ to: student.email, subject: subject, html: body }),
            });

            if (!response.ok) throw new Error('Failed to send email');

            await trackSentEmail(student.email, subject, 'Schedule Change', body, {
              recipientName: student.name,
              groupName: groupName,
              oldSchedule,
              newSchedule,
            });

            window.parent.postMessage({ action: 'scheduleChangeEmailSent', success: true }, '*');
          } catch (error) {
            window.parent.postMessage({ action: 'scheduleChangeEmailError', error: error.message }, '*');
          }
        }

        // HANDLER 6: Group Enrollment
        if (action === 'sendGroupEnrollmentEmail') {
          try {
            const student = event.data.student;
            const groupName = event.data.groupName;
            const groupSchedule = event.data.groupSchedule;
            const payPerClass = event.data.payPerClass || student.payPerClass || 0;

            const subject = 'Welcome to Your New ARNOMA Group!';
            const bodyContent = `
              <p>Dear <strong>${student.name}</strong>,</p>

              <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)); border-left: 4px solid #22c55e; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 16px; color: #333; font-weight: 600; margin-bottom: 12px;">
                  üéâ Successfully Enrolled!
                </div>
                <div style="font-size: 15px; color: #555; margin-bottom: 8px;">
                  You have been successfully enrolled in <strong>Group ${groupName}</strong>.
                </div>
              </div>

              <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); padding: 16px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 14px; color: #1e40af; font-weight: 600; margin-bottom: 12px;">
                  What This Means:
                </div>
                <ul style="margin: 0; padding-left: 20px; color: #1e3a8a; font-size: 13px;">
                  <li style="margin-bottom: 8px;">You will appear in the active roster</li>
                  <li style="margin-bottom: 8px;">You will receive class notifications</li>
                  <li>You will get notes after each class once payment is made</li>
                </ul>
              </div>

              <div style="background: rgba(255, 255, 255, 0.5); border: 1px solid rgba(0, 0, 0, 0.1); padding: 16px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 14px; color: #333; font-weight: 600; margin-bottom: 8px;">
                  üìÖ Your Class Schedule:
                </div>
                <div style="font-size: 15px; color: #555; font-weight: 600;">
                  ${groupSchedule}
                </div>
              </div>

              <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); padding: 16px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 14px; color: #92400e; font-weight: 600; margin-bottom: 8px;">
                  üí∞ Payment Amount:
                </div>
                <div style="font-size: 18px; color: #78350f; font-weight: 700;">
                  $${payPerClass} per class
                </div>
              </div>                <div style="font-size: 14px; color: #333; font-weight: 600; margin-bottom: 8px;">
                  üìÖ Your Class Schedule:
                </div>
                <div style="font-size: 15px; color: #555; font-weight: 600;">
                  ${groupSchedule}
                </div>
              </div>

              <p style="margin-top: 24px;">Thank you,<br><strong>ARNOMA Learning Center</strong></p>
            `;

            const body = generateEmailHTML('Welcome', bodyContent);

            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${SUPABASE_ANON_KEY}` },
              body: JSON.stringify({ to: student.email, subject: subject, html: body }),
            });

            if (!response.ok) throw new Error('Failed to send email');

            await trackSentEmail(student.email, subject, 'Group Enrollment', body, {
              recipientName: student.name,
              groupName: groupName,
              groupSchedule,
            });

            window.parent.postMessage({ action: 'groupEnrollmentEmailSent', success: true }, '*');
          } catch (error) {
            window.parent.postMessage({ action: 'groupEnrollmentEmailError', error: error.message }, '*');
          }
        }

        // HANDLER 7: Payment Receipt (AUTO-SEND)
        if (action === 'sendPaymentReceiptEmail') {
          try {
            const student = event.data.student;
            const paymentAmount = event.data.paymentAmount;
            const paymentDate = event.data.paymentDate;
            const newBalance = event.data.newBalance;

            const subject = 'Payment Received - Thank You!';
            const bodyContent = `
              <p>Dear <strong>${student.name}</strong>,</p>

              <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)); border-left: 4px solid #22c55e; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 16px; color: #333; font-weight: 600; margin-bottom: 12px;">
                  ‚úÖ Payment Confirmed
                </div>
                <div style="font-size: 15px; color: #555; margin-bottom: 8px;">
                  We have successfully received your payment.
                </div>
              </div>

              <div style="background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(0, 0, 0, 0.1); padding: 16px; border-radius: 8px; margin: 20px 0;">
                <table style="width: 100%; border-collapse: collapse;">
                  <tr>
                    <td style="padding: 8px 0; font-size: 14px; color: #666;">Payment Amount:</td>
                    <td style="padding: 8px 0; font-size: 16px; color: #333; font-weight: 700; text-align: right;">$${paymentAmount.toFixed(2)}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; font-size: 14px; color: #666;">Date:</td>
                    <td style="padding: 8px 0; font-size: 14px; color: #333; font-weight: 600; text-align: right;">${paymentDate}</td>
                  </tr>
                  <tr style="border-top: 2px solid #22c55e;">
                    <td style="padding: 12px 0 8px; font-size: 14px; color: #666; font-weight: 600;">Current Balance:</td>
                    <td style="padding: 12px 0 8px; font-size: 18px; color: #22c55e; font-weight: 700; text-align: right;">$${newBalance.toFixed(2)}</td>
                  </tr>
                </table>
              </div>

              <div style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); padding: 16px; border-radius: 8px; margin: 20px 0;">
                <div style="font-size: 14px; color: #1e40af; font-weight: 600; margin-bottom: 8px;">
                  üìö Class Notes Available
                </div>
                <div style="font-size: 13px; color: #1e3a8a;">
                  Your class notes for this session will be available shortly after your class ends.
                </div>
              </div>

              <p style="margin-top: 24px;">Thank you for your payment!<br><strong>ARNOMA Learning Center</strong></p>
            `;

            const body = generateEmailHTML('Payment Received', bodyContent);

            const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${SUPABASE_ANON_KEY}` },
              body: JSON.stringify({ to: student.email, subject: subject, html: body }),
            });

            if (!response.ok) throw new Error('Failed to send email');

            await trackSentEmail(student.email, subject, 'Payment Receipt', body, {
              recipientName: student.name,
              paymentAmount,
              paymentDate,
              newBalance,
            });

            window.parent.postMessage({ action: 'paymentReceiptEmailSent', success: true }, '*');
          } catch (error) {
            window.parent.postMessage({ action: 'paymentReceiptEmailError', error: error.message }, '*');
          }
        }

        // ============================================================
        // END NEW EMAIL HANDLERS
        // ============================================================
      });

      // ============================================
      // AUTOMATION ENGINE - Class Reminder System
      // ============================================

      // Use localStorage to persist groups data across iframe reloads
      function loadGroupsDataFromStorage() {
        try {
          const stored = localStorage.getItem('arnoma-groups-cache');
          if (stored) {
            const data = JSON.parse(stored);
            // Check if data is less than 5 minutes old
            if (data.timestamp && Date.now() - data.timestamp < 5 * 60 * 1000) {
              return data.groups || [];
            }
          }
        } catch (e) {
          console.error('Error loading groups from storage:', e);
        }
        return [];
      }

      function saveGroupsDataToStorage(groups) {
        try {
          localStorage.setItem(
            'arnoma-groups-cache',
            JSON.stringify({
              groups: groups,
              timestamp: Date.now(),
            })
          );
        } catch (e) {
          console.error('Error saving groups to storage:', e);
        }
      }

      // Initialize globals - try to load from localStorage first
      if (typeof window.groupsData === 'undefined') {
        window.groupsData = loadGroupsDataFromStorage();
      }
      if (typeof window.studentsData === 'undefined') {
        window.studentsData = [];
      }
      let sentReminders = new Set(); // Track sent reminders to avoid duplicates
      window.__automationDataReceived = window.__automationDataReceived || false; // Guard duplicate payloads
      window.__automationDataReceivedAt = window.__automationDataReceivedAt || null;
      window.__automationEngineInitialized = window.__automationEngineInitialized || false;
      let automationDataRequestInterval = null;

      // Listen for data from parent window (index.html)
      window.addEventListener('message', function (event) {
        if (event.data.action === 'updateGroupsData') {
          if (window.__automationDataReceived) {
            console.log('[AutomationEngine] üîÅ Duplicate automation payload ignored');
            return;
          }
          window.groupsData = event.data.groups || [];
          window.studentsData = event.data.students || [];
          window.__automationDataReceived = true; // Mark that we've received data (GLOBAL)
          window.__automationDataReceivedAt = Date.now();
          if (automationDataRequestInterval) {
            clearInterval(automationDataRequestInterval);
            automationDataRequestInterval = null;
          }

          console.log(
            `üì® Received data from parent: ${window.groupsData.length} groups, ${window.studentsData.length} students`
          );
          if (window.studentsData.length > 0) {
            console.log(
              `üë• Student names:`,
              window.studentsData.slice(0, 3).map(s => s.name || s.student_name)
            );
          } else {
            console.warn('‚ö†Ô∏è Received 0 students from parent window!');
          }

          // Save to localStorage for persistence across iframe reloads
          saveGroupsDataToStorage(window.groupsData);

          // Re-render automations now that we have groups data for countdown calculations
          const modalOpen = document.getElementById('automationsModal')?.classList.contains('active');
          if (modalOpen && typeof automationSystem !== 'undefined' && automationSystem._automations) {
            automationSystem.renderAutomations();
          }
        }
      });

      // Request initial data from parent
      function requestDataFromParent() {
        if (window.__automationDataReceived) {
          return;
        }
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ action: 'requestGroupsData' }, '*');
        }
      }

      // Parse schedule string like "Mon/Wed 8:00 PM, Fri 9:30 PM"
      function parseScheduleString(schedule) {
        if (!schedule || typeof schedule !== 'string') return [];

        const sessions = [];
        const parts = schedule.split(',').map(s => s.trim());

        parts.forEach(part => {
          const match = part.match(/((?:[A-Za-z]+(?:\/[A-Za-z]+)*)\s+)?(\d{1,2}:\d{2}\s*(?:AM|PM))/i);
          if (!match) return;

          const daysStr = match[1]?.trim() || '';
          const time = match[2].trim();

          const dayMap = {
            mon: 'Monday',
            monday: 'Monday',
            tue: 'Tuesday',
            tues: 'Tuesday',
            tuesday: 'Tuesday',
            wed: 'Wednesday',
            weds: 'Wednesday',
            wednesday: 'Wednesday',
            thu: 'Thursday',
            thur: 'Thursday',
            thurs: 'Thursday',
            thursday: 'Thursday',
            fri: 'Friday',
            friday: 'Friday',
            sat: 'Saturday',
            saturday: 'Saturday',
            sun: 'Sunday',
            sunday: 'Sunday',
          };

          const days = daysStr
            .split('/')
            .map(d => {
              const normalized = dayMap[d.toLowerCase()];
              return normalized || d;
            })
            .filter(Boolean);

          days.forEach(day => {
            sessions.push({ day, time });
          });
        });

        return sessions;
      }

      // Get current Los Angeles time
      function getCurrentLATime() {
        const now = new Date();
        const laTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
        return laTime;
      }

      // Parse time string to minutes since midnight
      function parseTimeToMinutes(timeStr) {
        const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
        if (!match) return null;

        let hours = parseInt(match[1]);
        const minutes = parseInt(match[2]);
        const period = match[3].toUpperCase();

        if (period === 'PM' && hours !== 12) hours += 12;
        if (period === 'AM' && hours === 12) hours = 0;

        return hours * 60 + minutes;
      }

      // Check if automation should trigger
      async function checkAutomations() {
        try {
          // Silent check - only log when emails are actually sent
          const automations = automationSystem._automations.filter(a => a.active && a.frequency === 'before_class');

          if (automations.length === 0) {
            return;
          }

          const laTime = getCurrentLATime();
          const currentDay = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][
            laTime.getDay()
          ];
          const currentMinutes = laTime.getHours() * 60 + laTime.getMinutes();

          let totalEmailsSent = 0;
          let totalEmailsFailed = 0;

          // Check each automation
          for (const automation of automations) {
            const selectedGroups = automation.groups || automation.selectedGroups || [];
            const triggerMinutes = parseInt(automation.beforeClassTime);

            // Check only the selected groups for this automation
            for (const groupName of selectedGroups) {
              const group = window.groupsData.find(g => g.name === groupName);
              if (!group || !group.schedule) {
                continue;
              }

              const sessions = parseScheduleString(group.schedule);

              for (const session of sessions) {
                if (session.day !== currentDay) continue;

                const classMinutes = parseTimeToMinutes(session.time);
                if (classMinutes === null) continue;

                const minutesUntilClass = classMinutes - currentMinutes;

                // Trigger window: within 2 minutes of the target time to account for check intervals
                if (Math.abs(minutesUntilClass - triggerMinutes) <= 2) {
                  const reminderKey = `${automation.id}_${group.name}_${session.day}_${session.time}_${triggerMinutes}`;

                  // Check if already sent today
                  if (sentReminders.has(reminderKey)) {
                    continue;
                  }

                  console.log(
                    `[AutomationEngine] üöÄ SENDING: "${automation.name}" for Group ${group.name} (${minutesUntilClass} min until class)`
                  );

                  // Collect all recipients from multiple sources
                  let recipients = [];

                  // Get ACTIVE students in this group
                  const groupStudents = window.studentsData.filter(
                    s =>
                      s.group &&
                      s.group
                        .split(',')
                        .map(g => g.trim())
                        .includes(group.name) &&
                      s.email &&
                      (!s.status || s.status === 'active') // Only active students
                  );

                  // Add students from groups (if groups are selected)
                  if (automation.groups && automation.groups.includes(group.name)) {
                    recipients.push(...groupStudents);
                  }

                  // Add all active students (if includeAllStudents is true)
                  if (automation.includeAllStudents) {
                    recipients.push(...groupStudents);
                  }

                  // Add individual emails (if any)
                  if (automation.emails && automation.emails.length > 0) {
                    automation.emails.forEach(email => {
                      recipients.push({ email: email, name: 'Student' });
                    });
                  }

                  // Add teacher (if teacher email exists)
                  if (automation.teacherEmail) {
                    recipients.push({ email: automation.teacherEmail, name: 'Teacher' });
                  }

                  // Remove duplicates based on email
                  const uniqueRecipients = [];
                  const seenEmails = new Set();
                  for (const recipient of recipients) {
                    if (!seenEmails.has(recipient.email)) {
                      seenEmails.add(recipient.email);
                      uniqueRecipients.push(recipient);
                    }
                  }
                  recipients = uniqueRecipients;

                  console.log(`[AutomationEngine]    ‚îú‚îÄ üìß Recipients: ${recipients.length}`);

                  if (recipients.length === 0) {
                    continue;
                  }

                  // Find the template
                  const template = emailSystem._templates.find(t => t.id === automation.templateId);
                  if (!template) {
                    console.error(`[AutomationEngine]    ‚îú‚îÄ ‚ùå Template not found: ${automation.templateName}`);
                    totalEmailsFailed++;
                    continue;
                  }

                  // Send to each recipient
                  let successCount = 0;
                  let failCount = 0;

                  for (const recipient of recipients) {
                    const success = await sendClassReminderEmail(recipient, group, session, template);
                    if (success) {
                      successCount++;
                      totalEmailsSent++;
                    } else {
                      failCount++;
                      totalEmailsFailed++;
                    }
                  }

                  console.log(`[AutomationEngine]    ‚îú‚îÄ ‚úÖ Sent: ${successCount}, ‚ùå Failed: ${failCount}`);

                  // Notify parent window to add notification
                  if (successCount > 0 && window.parent && window.parent !== window) {
                    // Ensure fields don't exceed Supabase constraints (50 chars each)
                    const titleText =
                      automation.name.length > 50 ? automation.name.substring(0, 47) + '...' : automation.name;

                    const descText = `Sent ${successCount} email${successCount !== 1 ? 's' : ''} for ${group.name}`;
                    const description = descText.length > 50 ? descText.substring(0, 47) + '...' : descText;

                    const groupNameText = group.name.length > 50 ? group.name.substring(0, 47) + '...' : group.name;

                    window.parent.postMessage(
                      {
                        action: 'addNotification',
                        notification: {
                          type: 'email',
                          title: titleText,
                          description: description,
                          groupName: groupNameText,
                          metadata: {
                            automationId: automation.id,
                            automationName: automation.name,
                            recipientCount: successCount,
                            sessionDay: session.day,
                            sessionTime: session.time,
                          },
                        },
                      },
                      '*'
                    );
                  }

                  // Mark as sent
                  sentReminders.add(reminderKey);
                }
              }
            }
          }

          // Only log summary if emails were actually sent
          if (totalEmailsSent > 0 || totalEmailsFailed > 0) {
            console.log(`[AutomationEngine] üìä Sent ${totalEmailsSent} emails, Failed ${totalEmailsFailed}`);
          }
        } catch (error) {
          console.error('[AutomationEngine] ‚ùå ERROR:', error);
        }
      }

      // Send class reminder email
      async function sendClassReminderEmail(recipient, group, session, template) {
        try {
          console.log(`[AutomationEngine] üì§ Sending to ${recipient.name} <${recipient.email}>...`);

          const recipientName = recipient.name || 'Teacher';

          let subject = template.subject
            .replace(/\\{\\{StudentName\\}\\}/g, recipientName)
            .replace(/\\{\\{Group\\}\\}/g, group.name)
            .replace(/\\{\\{GroupName\\}\\}/g, group.name);

          let body = template.body
            .replace(/\\{\\{StudentName\\}\\}/g, recipientName)
            .replace(/\\{\\{Group\\}\\}/g, group.name)
            .replace(/\\{\\{GroupName\\}\\}/g, group.name)
            .replace(/\\{\\{ClassTime\\}\\}/g, session.time)
            .replace(/\\{\\{NextClass\\}\\}/g, `${session.day}, ${session.time}`);

          const response = await fetch(`${SUPABASE_URL}/functions/v1/send-email`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            },
            body: JSON.stringify({
              to: recipient.email,
              subject: subject,
              html: body,
            }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error(`[AutomationEngine] ‚ùå Email API error (${response.status}): ${errorText}`);
            throw new Error(`Failed to send email: ${response.statusText}`);
          }

          // Track sent email with full HTML content and recipient metadata
          await trackSentEmail(recipient.email, subject, 'Class Reminder (Auto)', body, {
            recipientName: recipientName,
            recipientType: recipient.type || 'Unknown',
            groupName: group.name,
            automationName: automation.name,
          });
          console.log(`[AutomationEngine] ‚úÖ Email sent successfully to ${recipientName}`);

          return true;
        } catch (error) {
          console.error(`[AutomationEngine] ‚ùå Failed to send email to ${recipient.name}:`, error.message);
          return false;
        }
      }

      // Reset sent reminders at midnight
      function resetDailyReminders() {
        const laTime = getCurrentLATime();
        const nextMidnight = new Date(laTime);
        nextMidnight.setHours(24, 0, 0, 0);
        const msUntilMidnight = nextMidnight - laTime;

        setTimeout(() => {
          console.log('üåô Midnight - Resetting sent reminders');
          sentReminders.clear();
          resetDailyReminders(); // Schedule next reset
        }, msUntilMidnight);
      }

      // Initialize automation engine
      function initAutomationEngine() {
        if (window.__automationEngineInitialized) {
          console.log('[AutomationEngine] ‚ö†Ô∏è Already initialized, skipping duplicate init');
          return;
        }
        window.__automationEngineInitialized = true;
        console.log('[AutomationEngine] ‚ö° Initialized');

        // Load automations from localStorage
        automationSystem.loadAutomations();

        // Request data from parent immediately
        requestDataFromParent();

        // Request data every 30 seconds until the first payload arrives
        if (!automationDataRequestInterval) {
          automationDataRequestInterval = setInterval(() => {
            if (!window.__automationDataReceived) {
              requestDataFromParent();
            }
          }, 30000);
        }

        // Check automations every 60 seconds
        setInterval(checkAutomations, 60000);

        // Run first check after data is received (max wait: 30 seconds)
        let firstCheckAttempts = 0;
        const waitForDataAndCheck = () => {
          firstCheckAttempts++;
          if (window.__automationDataReceived || firstCheckAttempts >= 30) {
            if (!window.__automationDataReceived) {
              console.warn('[AutomationEngine] ‚ö†Ô∏è No data received after 30s');
            }
            checkAutomations();
          } else {
            setTimeout(waitForDataAndCheck, 1000);
          }
        };
        setTimeout(waitForDataAndCheck, 1000);

        // Setup midnight reset
        resetDailyReminders();
      }

      // Start engine when page loads
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAutomationEngine);
      } else {
        initAutomationEngine();
      }

      // ============================================================================
      // EMAIL TESTING FUNCTIONS
      // ============================================================================

      function getTestEmail() {
        const input = document.getElementById('testEmailAddress');
        return input && input.value ? input.value : 'hrachfilm@gmail.com';
      }

      function getTestStudent() {
        if (!window.studentsData || window.studentsData.length === 0) {
          alert('‚ö†Ô∏è No students loaded yet. Wait for data to sync.');
          return null;
        }
        return window.studentsData[0];
      }

      async function testProfileUpdate() {
        const student = getTestStudent();
        if (!student) return;

        const testData = {
          student: { name: student.name, email: getTestEmail() },
          changes: 'Phone number updated to (123) 456-7890',
          emailType: 'current',
        };

        window.postMessage({ action: 'sendProfileUpdateEmail', ...testData }, '*');
        alert('‚úÖ Profile Update email sent!');
      }

      async function testAliasAdded() {
        const student = getTestStudent();
        if (!student) return;

        const testData = {
          mainStudent: { name: student.name, email: getTestEmail() },
          aliasName: 'Test Alias Student',
        };

        window.postMessage({ action: 'sendAliasAddedEmail', ...testData }, '*');
        alert('‚úÖ Alias Added email sent!');
      }

      async function testScheduleUpdate() {
        const student = getTestStudent();
        if (!student) return;

        const testData = {
          student: { name: student.name, email: getTestEmail(), group: student.group || 'Test Group' },
          oldSchedule: 'Monday 6:00 PM',
          newSchedule: 'Tuesday 7:00 PM',
        };

        window.postMessage({ action: 'sendScheduleUpdateEmail', ...testData }, '*');
        alert('‚úÖ Schedule Update email sent!');
      }

      async function testGroupEnrollment() {
        const student = getTestStudent();
        if (!student) return;

        const testData = {
          student: { name: student.name, email: getTestEmail(), group: student.group || 'Test Group' },
          groupName: student.group || 'Test Group',
          schedule: 'Monday 6:00 PM',
        };

        window.postMessage({ action: 'sendGroupEnrollmentEmail', ...testData }, '*');
        alert('‚úÖ Group Enrollment email sent!');
      }

      async function testCreditAdded() {
        const student = getTestStudent();
        if (!student) return;

        const testData = {
          student: { name: student.name, email: getTestEmail() },
          creditAmount: 50,
          reason: 'Testing credit addition',
          newBalance: 150,
        };

        window.postMessage({ action: 'sendCreditAddedEmail', ...testData }, '*');
        alert('‚úÖ Credit Added email sent!');
      }

      async function testCreditApplied() {
        const student = getTestStudent();
        if (!student) return;

        const testData = {
          student: { name: student.name, email: getTestEmail() },
          creditAmount: 50,
          classDate: '2025-11-20',
          remainingBalance: 100,
        };

        window.postMessage({ action: 'sendCreditAppliedEmail', ...testData }, '*');
        alert('‚úÖ Credit Applied email sent!');
      }

      async function testCreditEdit() {
        const student = getTestStudent();
        if (!student) return;

        const testData = {
          student: { name: student.name, email: getTestEmail() },
          oldBalance: 100,
          newBalance: 150,
          reason: 'Manual adjustment for testing',
        };

        window.postMessage({ action: 'sendCreditManualEditEmail', ...testData }, '*');
        alert('‚úÖ Credit Manual Edit email sent!');
      }

      async function testStatusPaused() {
        const student = getTestStudent();
        if (!student) return;

        const testData = {
          student: { name: student.name, email: getTestEmail() },
          reason: 'Testing pause status',
        };

        window.postMessage({ action: 'sendStatusChangeToPausedEmail', ...testData }, '*');
        alert('‚úÖ Status Changed to Paused email sent!');
      }

      async function testStatusActive() {
        const student = getTestStudent();
        if (!student) return;

        const testData = {
          student: { name: student.name, email: getTestEmail() },
        };

        window.postMessage({ action: 'sendStatusChangeToActiveEmail', ...testData }, '*');
        alert('‚úÖ Status Changed to Active email sent!');
      }

      async function testStatusGraduated() {
        const student = getTestStudent();
        if (!student) return;

        const testData = {
          student: { name: student.name, email: getTestEmail() },
          graduationDate: '2025-11-19',
        };

        window.postMessage({ action: 'sendStatusChangeToGraduatedEmail', ...testData }, '*');
        alert('‚úÖ Status Changed to Graduated email sent!');
      }

      async function testAbsence() {
        const student = getTestStudent();
        if (!student) return;

        const testData = {
          student: { name: student.name, email: getTestEmail() },
          classDate: '2025-11-19',
          reason: 'Testing absence notification',
        };

        window.postMessage({ action: 'sendAbsenceNotificationEmail', ...testData }, '*');
        alert('‚úÖ Absence Notification email sent!');
      }

      async function testScheduleChange() {
        const student = getTestStudent();
        if (!student) return;

        const testData = {
          student: { name: student.name, email: getTestEmail(), group: student.group || 'Test Group' },
          groupName: student.group || 'Test Group',
          oldSchedule: 'Monday 6:00 PM',
          newSchedule: 'Tuesday 7:00 PM',
          effectiveDate: '2025-11-20',
        };

        window.postMessage({ action: 'sendScheduleChangeEmail', ...testData }, '*');
        alert('‚úÖ Schedule Change email sent!');
      }
    </script>
  </body>
</html>
